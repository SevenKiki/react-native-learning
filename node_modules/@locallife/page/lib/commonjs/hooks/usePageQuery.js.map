{"version":3,"names":["usePageQuery","key","queryFn","options","infinite","isHit","prefetchQueryState","CustomQueryClient","get","getQueryState","predicate","query","meta","current","data","error","initialData","refetchOnMount","onSuccess","onError","onSettled","fn","useInfiniteQuery","useQuery"],"sources":["usePageQuery.ts"],"sourcesContent":["import { CustomQueryClient } from '@locallife/page';\nimport {\n    QueryFunction,\n    QueryKey,\n    useInfiniteQuery,\n    useQuery,\n    UseQueryOptions,\n} from 'react-query';\nimport { useLayoutEffect, useRef } from 'react';\nimport { pageLog } from '../log';\n\nexport function usePageQuery<T>(\n    key: any,\n    queryFn: QueryFunction<T, any>,\n    options?: UseQueryOptions<unknown, unknown, T, QueryKey>,\n    infinite = false,\n) {\n    const isHit = useRef(false);\n    const prefetchQueryState = CustomQueryClient.get().getQueryState<T>(key, {\n        predicate: (query) => {\n            return query.meta?.['prefetch'] === 1 && isHit.current === false;\n        },\n    });\n    if (\n        (prefetchQueryState?.data || prefetchQueryState?.error) &&\n        !isHit.current\n    ) {\n        options = {\n            ...options,\n            initialData: prefetchQueryState?.data,\n            refetchOnMount: false,\n        };\n        isHit.current = true;\n    }\n    useLayoutEffect(() => {\n        if (prefetchQueryState?.data && options?.onSuccess) {\n            pageLog('命中复用优化', 'onSuccess');\n            options?.onSuccess(prefetchQueryState?.data);\n        }\n        if (prefetchQueryState?.error && options?.onError) {\n            pageLog('命中复用优化', 'onError');\n            options?.onError(prefetchQueryState?.error);\n        }\n        if (\n            (prefetchQueryState?.error || prefetchQueryState?.data) &&\n            options?.onSettled\n        ) {\n            pageLog('命中复用优化', 'onSettled');\n            options?.onSettled(\n                prefetchQueryState?.data,\n                prefetchQueryState?.error,\n            );\n        }\n    }, []);\n    const fn = infinite ? useInfiniteQuery : useQuery;\n    // @ts-ignore\n    return fn<T>(key, queryFn, options);\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AAOA;;AACA;;AAEO,SAASA,YAAT,CACHC,GADG,EAEHC,OAFG,EAGHC,OAHG,EAKL;EAAA,IADEC,QACF,uEADa,KACb;EACE,MAAMC,KAAK,GAAG,mBAAO,KAAP,CAAd;;EACA,MAAMC,kBAAkB,GAAGC,wBAAkBC,GAAlB,GAAwBC,aAAxB,CAAyCR,GAAzC,EAA8C;IACrES,SAAS,EAAGC,KAAD,IAAW;MAAA;;MAClB,OAAO,gBAAAA,KAAK,CAACC,IAAN,4DAAa,UAAb,OAA6B,CAA7B,IAAkCP,KAAK,CAACQ,OAAN,KAAkB,KAA3D;IACH;EAHoE,CAA9C,CAA3B;;EAKA,IACI,CAACP,kBAAkB,SAAlB,IAAAA,kBAAkB,WAAlB,IAAAA,kBAAkB,CAAEQ,IAApB,IAA4BR,kBAA5B,aAA4BA,kBAA5B,eAA4BA,kBAAkB,CAAES,KAAjD,KACA,CAACV,KAAK,CAACQ,OAFX,EAGE;IACEV,OAAO,GAAG,EACN,GAAGA,OADG;MAENa,WAAW,EAAEV,kBAAF,aAAEA,kBAAF,uBAAEA,kBAAkB,CAAEQ,IAF3B;MAGNG,cAAc,EAAE;IAHV,CAAV;IAKAZ,KAAK,CAACQ,OAAN,GAAgB,IAAhB;EACH;;EACD,4BAAgB,MAAM;IAAA;;IAClB,IAAIP,kBAAkB,SAAlB,IAAAA,kBAAkB,WAAlB,IAAAA,kBAAkB,CAAEQ,IAApB,gBAA4BX,OAA5B,qCAA4B,SAASe,SAAzC,EAAoD;MAAA;;MAChD,kBAAQ,QAAR,EAAkB,WAAlB;MACA,aAAAf,OAAO,UAAP,8CAASe,SAAT,CAAmBZ,kBAAnB,aAAmBA,kBAAnB,uBAAmBA,kBAAkB,CAAEQ,IAAvC;IACH;;IACD,IAAIR,kBAAkB,SAAlB,IAAAA,kBAAkB,WAAlB,IAAAA,kBAAkB,CAAES,KAApB,iBAA6BZ,OAA7B,sCAA6B,UAASgB,OAA1C,EAAmD;MAAA;;MAC/C,kBAAQ,QAAR,EAAkB,SAAlB;MACA,aAAAhB,OAAO,UAAP,8CAASgB,OAAT,CAAiBb,kBAAjB,aAAiBA,kBAAjB,uBAAiBA,kBAAkB,CAAES,KAArC;IACH;;IACD,IACI,CAACT,kBAAkB,SAAlB,IAAAA,kBAAkB,WAAlB,IAAAA,kBAAkB,CAAES,KAApB,IAA6BT,kBAA7B,aAA6BA,kBAA7B,eAA6BA,kBAAkB,CAAEQ,IAAlD,kBACAX,OADA,sCACA,UAASiB,SAFb,EAGE;MAAA;;MACE,kBAAQ,QAAR,EAAkB,WAAlB;MACA,aAAAjB,OAAO,UAAP,8CAASiB,SAAT,CACId,kBADJ,aACIA,kBADJ,uBACIA,kBAAkB,CAAEQ,IADxB,EAEIR,kBAFJ,aAEIA,kBAFJ,uBAEIA,kBAAkB,CAAES,KAFxB;IAIH;EACJ,CAnBD,EAmBG,EAnBH;EAoBA,MAAMM,EAAE,GAAGjB,QAAQ,GAAGkB,4BAAH,GAAsBC,oBAAzC,CAtCF,CAuCE;;EACA,OAAOF,EAAE,CAAIpB,GAAJ,EAASC,OAAT,EAAkBC,OAAlB,CAAT;AACH"}