{"version":3,"names":["CustomQueryClient","useInfiniteQuery","useQuery","useLayoutEffect","useRef","pageLog","usePageQuery","key","queryFn","options","infinite","isHit","prefetchQueryState","get","getQueryState","predicate","query","meta","current","data","error","initialData","refetchOnMount","onSuccess","onError","onSettled","fn"],"sources":["usePageQuery.ts"],"sourcesContent":["import { CustomQueryClient } from '@locallife/page';\nimport {\n    QueryFunction,\n    QueryKey,\n    useInfiniteQuery,\n    useQuery,\n    UseQueryOptions,\n} from 'react-query';\nimport { useLayoutEffect, useRef } from 'react';\nimport { pageLog } from '../log';\n\nexport function usePageQuery<T>(\n    key: any,\n    queryFn: QueryFunction<T, any>,\n    options?: UseQueryOptions<unknown, unknown, T, QueryKey>,\n    infinite = false,\n) {\n    const isHit = useRef(false);\n    const prefetchQueryState = CustomQueryClient.get().getQueryState<T>(key, {\n        predicate: (query) => {\n            return query.meta?.['prefetch'] === 1 && isHit.current === false;\n        },\n    });\n    if (\n        (prefetchQueryState?.data || prefetchQueryState?.error) &&\n        !isHit.current\n    ) {\n        options = {\n            ...options,\n            initialData: prefetchQueryState?.data,\n            refetchOnMount: false,\n        };\n        isHit.current = true;\n    }\n    useLayoutEffect(() => {\n        if (prefetchQueryState?.data && options?.onSuccess) {\n            pageLog('命中复用优化', 'onSuccess');\n            options?.onSuccess(prefetchQueryState?.data);\n        }\n        if (prefetchQueryState?.error && options?.onError) {\n            pageLog('命中复用优化', 'onError');\n            options?.onError(prefetchQueryState?.error);\n        }\n        if (\n            (prefetchQueryState?.error || prefetchQueryState?.data) &&\n            options?.onSettled\n        ) {\n            pageLog('命中复用优化', 'onSettled');\n            options?.onSettled(\n                prefetchQueryState?.data,\n                prefetchQueryState?.error,\n            );\n        }\n    }, []);\n    const fn = infinite ? useInfiniteQuery : useQuery;\n    // @ts-ignore\n    return fn<T>(key, queryFn, options);\n}\n"],"mappings":"AAAA,SAASA,iBAAT,QAAkC,iBAAlC;AACA,SAGIC,gBAHJ,EAIIC,QAJJ,QAMO,aANP;AAOA,SAASC,eAAT,EAA0BC,MAA1B,QAAwC,OAAxC;AACA,SAASC,OAAT,QAAwB,QAAxB;AAEA,OAAO,SAASC,YAAT,CACHC,GADG,EAEHC,OAFG,EAGHC,OAHG,EAKL;EAAA,IADEC,QACF,uEADa,KACb;EACE,MAAMC,KAAK,GAAGP,MAAM,CAAC,KAAD,CAApB;EACA,MAAMQ,kBAAkB,GAAGZ,iBAAiB,CAACa,GAAlB,GAAwBC,aAAxB,CAAyCP,GAAzC,EAA8C;IACrEQ,SAAS,EAAGC,KAAD,IAAW;MAAA;;MAClB,OAAO,gBAAAA,KAAK,CAACC,IAAN,4DAAa,UAAb,OAA6B,CAA7B,IAAkCN,KAAK,CAACO,OAAN,KAAkB,KAA3D;IACH;EAHoE,CAA9C,CAA3B;;EAKA,IACI,CAACN,kBAAkB,SAAlB,IAAAA,kBAAkB,WAAlB,IAAAA,kBAAkB,CAAEO,IAApB,IAA4BP,kBAA5B,aAA4BA,kBAA5B,eAA4BA,kBAAkB,CAAEQ,KAAjD,KACA,CAACT,KAAK,CAACO,OAFX,EAGE;IACET,OAAO,GAAG,EACN,GAAGA,OADG;MAENY,WAAW,EAAET,kBAAF,aAAEA,kBAAF,uBAAEA,kBAAkB,CAAEO,IAF3B;MAGNG,cAAc,EAAE;IAHV,CAAV;IAKAX,KAAK,CAACO,OAAN,GAAgB,IAAhB;EACH;;EACDf,eAAe,CAAC,MAAM;IAAA;;IAClB,IAAIS,kBAAkB,SAAlB,IAAAA,kBAAkB,WAAlB,IAAAA,kBAAkB,CAAEO,IAApB,gBAA4BV,OAA5B,qCAA4B,SAASc,SAAzC,EAAoD;MAAA;;MAChDlB,OAAO,CAAC,QAAD,EAAW,WAAX,CAAP;MACA,aAAAI,OAAO,UAAP,8CAASc,SAAT,CAAmBX,kBAAnB,aAAmBA,kBAAnB,uBAAmBA,kBAAkB,CAAEO,IAAvC;IACH;;IACD,IAAIP,kBAAkB,SAAlB,IAAAA,kBAAkB,WAAlB,IAAAA,kBAAkB,CAAEQ,KAApB,iBAA6BX,OAA7B,sCAA6B,UAASe,OAA1C,EAAmD;MAAA;;MAC/CnB,OAAO,CAAC,QAAD,EAAW,SAAX,CAAP;MACA,aAAAI,OAAO,UAAP,8CAASe,OAAT,CAAiBZ,kBAAjB,aAAiBA,kBAAjB,uBAAiBA,kBAAkB,CAAEQ,KAArC;IACH;;IACD,IACI,CAACR,kBAAkB,SAAlB,IAAAA,kBAAkB,WAAlB,IAAAA,kBAAkB,CAAEQ,KAApB,IAA6BR,kBAA7B,aAA6BA,kBAA7B,eAA6BA,kBAAkB,CAAEO,IAAlD,kBACAV,OADA,sCACA,UAASgB,SAFb,EAGE;MAAA;;MACEpB,OAAO,CAAC,QAAD,EAAW,WAAX,CAAP;MACA,aAAAI,OAAO,UAAP,8CAASgB,SAAT,CACIb,kBADJ,aACIA,kBADJ,uBACIA,kBAAkB,CAAEO,IADxB,EAEIP,kBAFJ,aAEIA,kBAFJ,uBAEIA,kBAAkB,CAAEQ,KAFxB;IAIH;EACJ,CAnBc,EAmBZ,EAnBY,CAAf;EAoBA,MAAMM,EAAE,GAAGhB,QAAQ,GAAGT,gBAAH,GAAsBC,QAAzC,CAtCF,CAuCE;;EACA,OAAOwB,EAAE,CAAInB,GAAJ,EAASC,OAAT,EAAkBC,OAAlB,CAAT;AACH"}