import { useEffect, useMemo, useRef } from 'react';
import { NativeEventEmitter, NativeModules } from 'react-native';
import { publishRubas } from '../log';
import { getRubasTime } from '../utils';
export const useLcpCollect = () => {
  const lcpImages = useMemo(() => [], []);
  const isCollectFinish = useRef(false);

  const collectLPCEvent = () => {
    if (isCollectFinish.current === false) {
      let renderTimestamp = 0;
      let maxRenderTimestamp = 0;
      let maxSize = 0;

      for (const idx in lcpImages) {
        const image = lcpImages[idx];

        if (image) {
          if (maxSize < image.imageSize) {
            maxSize = image.imageSize;
            renderTimestamp = image.renderTimestamp;
          }

          if (maxRenderTimestamp < image.renderTimestamp) {
            maxRenderTimestamp = image.renderTimestamp;
          }
        }
      }

      if (renderTimestamp !== 0 && maxSize > 0) {
        publishRubas({
          event: 'local_life_page_lcp_render',
          payload: getRubasTime(renderTimestamp)
        });
        publishRubas({
          event: 'local_life_page_llt_render',
          payload: getRubasTime(maxRenderTimestamp)
        });
        isCollectFinish.current = true;
      }
    }
  };

  useEffect(() => {
    // 监听页面可见
    const listener = new NativeEventEmitter(NativeModules.KRNAppState).addListener('krnAppStateDidChange', _ref => {
      let {
        appState
      } = _ref;

      if (appState === 'hide' || appState === 'inactive' || appState === 'background' || appState === 'destroy') {
        collectLPCEvent();
      }
    });
    return () => {
      collectLPCEvent();
      listener.remove();
    };
  }, [lcpImages]);
  return {
    lcpImages
  };
};
//# sourceMappingURL=useLcpCollect.js.map