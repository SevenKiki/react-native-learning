import { CustomQueryClient } from '@locallife/page';
import { useInfiniteQuery, useQuery } from 'react-query';
import { useLayoutEffect, useRef } from 'react';
import { pageLog } from '../log';
export function usePageQuery(key, queryFn, options) {
  let infinite = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
  const isHit = useRef(false);
  const prefetchQueryState = CustomQueryClient.get().getQueryState(key, {
    predicate: query => {
      var _query$meta;

      return ((_query$meta = query.meta) === null || _query$meta === void 0 ? void 0 : _query$meta['prefetch']) === 1 && isHit.current === false;
    }
  });

  if ((prefetchQueryState !== null && prefetchQueryState !== void 0 && prefetchQueryState.data || prefetchQueryState !== null && prefetchQueryState !== void 0 && prefetchQueryState.error) && !isHit.current) {
    options = { ...options,
      initialData: prefetchQueryState === null || prefetchQueryState === void 0 ? void 0 : prefetchQueryState.data,
      refetchOnMount: false
    };
    isHit.current = true;
  }

  useLayoutEffect(() => {
    var _options, _options3, _options5;

    if (prefetchQueryState !== null && prefetchQueryState !== void 0 && prefetchQueryState.data && (_options = options) !== null && _options !== void 0 && _options.onSuccess) {
      var _options2;

      pageLog('命中复用优化', 'onSuccess');
      (_options2 = options) === null || _options2 === void 0 ? void 0 : _options2.onSuccess(prefetchQueryState === null || prefetchQueryState === void 0 ? void 0 : prefetchQueryState.data);
    }

    if (prefetchQueryState !== null && prefetchQueryState !== void 0 && prefetchQueryState.error && (_options3 = options) !== null && _options3 !== void 0 && _options3.onError) {
      var _options4;

      pageLog('命中复用优化', 'onError');
      (_options4 = options) === null || _options4 === void 0 ? void 0 : _options4.onError(prefetchQueryState === null || prefetchQueryState === void 0 ? void 0 : prefetchQueryState.error);
    }

    if ((prefetchQueryState !== null && prefetchQueryState !== void 0 && prefetchQueryState.error || prefetchQueryState !== null && prefetchQueryState !== void 0 && prefetchQueryState.data) && (_options5 = options) !== null && _options5 !== void 0 && _options5.onSettled) {
      var _options6;

      pageLog('命中复用优化', 'onSettled');
      (_options6 = options) === null || _options6 === void 0 ? void 0 : _options6.onSettled(prefetchQueryState === null || prefetchQueryState === void 0 ? void 0 : prefetchQueryState.data, prefetchQueryState === null || prefetchQueryState === void 0 ? void 0 : prefetchQueryState.error);
    }
  }, []);
  const fn = infinite ? useInfiniteQuery : useQuery; // @ts-ignore

  return fn(key, queryFn, options);
}
//# sourceMappingURL=usePageQuery.js.map