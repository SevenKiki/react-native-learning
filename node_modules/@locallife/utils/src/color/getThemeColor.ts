import { memoize } from 'lodash-es';
import { safeParse } from '@kid-ui/krn/lib/utils';
import { NativeModules } from 'react-native';
import { TDarkModel, TTheme } from './types';

const { KIDBridge, KSAppearance } = NativeModules;

/**
 * 获取主题颜色,eg.
 * getColor('cs_common_background_secondary')
 * getColor({ light: '#EFEFEFFF', dark: '#FFFFFF33' })
 */
export const getThemeColor = memoize(function (
    kidKey: string | TDarkModel,
    theme?: TTheme,
) {
    if (!theme) {
        theme = KSAppearance.getColorScheme();
    }
    if (typeof kidKey === 'object' && kidKey[theme]) {
        return kidKey[theme];
    }
    if (typeof kidKey === 'string' && /^#[0-9A-F]{3,8}$/i.test(kidKey)) {
        return kidKey;
    }
    let value;
    const KidValue = safeParse(KIDBridge.getColorConfig(kidKey));
    if (!KidValue) {
        return '';
    }
    if (typeof KidValue === 'string') {
        value = KidValue;
    } else {
        value = KidValue[theme] || KidValue.normal || '';
    }
    return value;
});

/**
 * 获取主题颜色func
 */
export const getColorFunc = memoize(function (
    kidKey: string | TDarkModel,
    theme?: TTheme,
) {
    return () => getThemeColor(kidKey, theme);
});
