import { NativeModules } from 'react-native';
import { IRequestParam, RequestMethod } from '../model/IRequestParam';

/**
 * 导入公共参数
 */
function setCommonParams(requestParam: IRequestParam) {
    if (requestParam.commonRequestParams?.params) {
        // @ts-ignore
        requestParam.params = {
            ...requestParam.commonRequestParams?.params,
            ...requestParam.params,
        };
    }
    if (requestParam.commonRequestParams?.headers) {
        // @ts-ignore
        requestParam.headers = {
            ...requestParam.commonRequestParams?.headers,
            ...requestParam.headers,
        };
    }

    if (requestParam.commonRequestParams?.queryParams) {
        requestParam.queryParams = {
            ...requestParam.commonRequestParams?.queryParams,
            ...requestParam.queryParams,
        };
    }

    requestParam.businessName =
        requestParam.businessName ??
        requestParam.commonRequestParams?.businessName;

    requestParam.responseType =
        requestParam.responseType ??
        requestParam.commonRequestParams?.responseType ??
        'string';

    requestParam.timeout =
        requestParam.timeout ?? requestParam.commonRequestParams?.timeout;

    requestParam.commonRequestParams = undefined;
}

// 通用请求方法
export async function execute(requestParam: IRequestParam): Promise<string> {
    // method 兜底
    requestParam.method = requestParam.method ?? RequestMethod.GET;

    setCommonParams(requestParam);

    console.log(
        `@locallife/base-request: start request params=${JSON.stringify(
            requestParam,
        )}`,
    );
    return await NativeModules.KSURCTNetworkInterface.request(
        // @ts-ignore
        requestParam,
    );
}
