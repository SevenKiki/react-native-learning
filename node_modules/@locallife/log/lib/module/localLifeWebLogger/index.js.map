{"version":3,"names":["Weblog","AutoPV","AutoTrack","Radar","LoggerError","LocalLifeTaskLogger","yoda","LocalLifeWebBaseLogger","constructor","options","weblogExtraInfo","baseInfo","projectId","env","useAutoPv","autoPvOptions","useAutoTrack","autoTrackOptions","biz","app","plugins","push","fcp","weblogger","proto","bindAutoEvent","radar","that","setTaskLogFn","name","extra_info","other","event","sendLog","key","value","setErrorLogFn","error","addFMP","hasSendFMP","fmp","Date","now","update","url","referUrl","commonPackage","updateCurrentUrlPackage","updateReferUrlPackage","Object","keys","length","updateCommonPackage","type","sendImmediately","pv","show","click","err","captureException","task","isAsync","maxLifeTimeBetweenSteps","asyncTask","config","errorHandler","window","addEventListener","e","reason","preventDefault","logger","LocalLifeWebLogger","args"],"sources":["index.ts"],"sourcesContent":["/* eslint-disable camelcase */\nimport { Weblog } from '@ks/weblogger/lib/log.bridge';\nimport AutoPV from '@ks/weblogger/lib/plugins/autopv';\nimport AutoTrack from '@ks/weblogger/lib/plugins/autotrack';\nimport Radar from '@ks-radar/radar';\nimport LoggerError from '../types';\nimport LocalLifeTaskLogger from '../LocalLifeTaskLogger';\nimport * as yoda from '@yoda/bridge';\n\ninterface Options {\n    /** 雷达报警需要 */\n    projectId?: string;\n    /** 上报环境，默认production */\n    env?: any;\n    /** 是否启动autoPv，默认启用 */\n    useAutoPv?: boolean;\n    /** 启用autoPv时，插件参数 */\n    autoPvOptions?: any;\n    /** 是否启用autoTrack，默认启用*/\n    useAutoTrack?: boolean;\n    /** 启用autoTrack时，插件参数 */\n    autoTrackOptions?: object;\n    /** 业务标识，默认'LOCALLIFE' */\n    biz?: string;\n    /** vue示例 */\n    app?: any;\n    /** 其他 */\n    [key: string]: any;\n}\n\nexport class LocalLifeWebBaseLogger {\n    radar = null;\n    weblogger = null as null | Weblog;\n\n    /**\n     *\n     * @param options 基本配置参数\n     * @param weblogExtraInfo 补充配置参数，将会与基本配置完成weblogger的初始化\n     * @param baseInfo 埋点基础信息配置\n     */\n    constructor(options: Options, weblogExtraInfo = {} as any, baseInfo) {\n        const {\n            projectId,\n            env = 'production',\n            useAutoPv = true,\n            autoPvOptions,\n            useAutoTrack = true,\n            autoTrackOptions = {},\n            biz = 'LOCALLIFE',\n            app,\n        } = options;\n\n        // plugins\n        let plugins = (weblogExtraInfo?.plugins || []) as any[];\n        if (useAutoPv) {\n            plugins.push(new AutoPV(autoPvOptions));\n        }\n\n        if (useAutoTrack) {\n            // https://component.corp.kuaishou.com/docs/weblogger/views/docs/plugins.html#autotrack%E6%8F%92%E4%BB%B6\n            plugins.push(new AutoTrack(autoTrackOptions));\n        }\n\n        if (projectId) {\n            plugins.push(\n                new Radar({\n                    // 上报fcp指标数据\n                    fcp: true,\n                    // 雷达平台唯一标识\n                    projectId,\n                }),\n            );\n        }\n\n        this.weblogger = new Weblog(\n            {\n                env,\n                // 新业务埋点，落库 ks_client_log_v3；端内【桥接上报】无需配置\n                proto: 'v3',\n                // 在端内http 上报时传入 yoda 桥接 SDK，可以使雷达数据上报更多的 webview 信息，并会校正 js 默认获取的设备信息等。\n                // 端内【桥接上报】无需配置\n                yoda,\n                plugins,\n                ...weblogExtraInfo,\n            },\n            baseInfo,\n        );\n\n        this.bindAutoEvent({ app });\n        this.radar = this.weblogger.plugins.radar;\n\n        const that = this;\n        LocalLifeTaskLogger.setTaskLogFn(\n            this.radar\n                ? ({ name, extra_info, ...other }) =>\n                      that.radar.event({ name, extra_info, ...other })\n                : ({ name, extra_info, ...other }) =>\n                      that.sendLog('CUSTOM_EVENT', {\n                          biz,\n                          key: name,\n                          value: { extra_info, ...other },\n                      }),\n        );\n        LocalLifeTaskLogger.setErrorLogFn(this.error);\n    }\n\n    // 上报FMP\n    private hasSendFMP = false;\n    addFMP(): void {\n        if (this.hasSendFMP) {\n            return;\n        }\n\n        this.hasSendFMP = true;\n        // weblog 是异步加载且不影响首屏的，所以时间可以提前计算\n        this.radar?.fmp?.(Date.now());\n    }\n\n    // 更新上报信息\n    update({ url, referUrl, ...commonPackage }) {\n        url && this.weblogger.updateCurrentUrlPackage(url);\n        referUrl && this.weblogger.updateReferUrlPackage(referUrl);\n        if (Object.keys(commonPackage).length) {\n            this.weblogger.updateCommonPackage(commonPackage);\n        }\n    }\n\n    // 发埋点啦\n    private sendLog(type: any, options: any) {\n        this.weblogger.sendImmediately(type, options);\n    }\n\n    // 页面PV事件用这个\n    pv(options: any) {\n        this.sendLog('PV', options);\n    }\n    // 元素SHOW事件用这个\n    show(options: any) {\n        this.sendLog('SHOW', options);\n    }\n    // 点击事件用这个\n    click(options: any) {\n        this.sendLog('CLICK', options);\n    }\n\n    error(err: Error | LoggerError | string) {\n        this.radar?.captureException?.(err);\n    }\n\n    /**\n     * options第一层可包含status，若options.extra_info无status字段，外层status字段将会包含在options.extra_info进行埋点发送\n     * @param options: {name: string, extra_info: any, status?: string, ...other}\n     * @param isAsync\n     * @param maxLifeTimeBetweenSteps 如果异步，两次任务之间最大保留时间，默认30s\n     * @returns\n     */\n    task(options, isAsync?: boolean, maxLifeTimeBetweenSteps?: number) {\n        return LocalLifeTaskLogger.task(\n            options,\n            isAsync,\n            maxLifeTimeBetweenSteps,\n        );\n    }\n\n    asyncTask(options, maxLifeTimeBetweenSteps?: number) {\n        return this.task(options, true, maxLifeTimeBetweenSteps);\n    }\n\n    // 绑定事件\n    private bindAutoEvent({ app }) {\n        // vue\n        app?.config &&\n            (app.config.errorHandler = (error: Error) => {\n                this.error(\n                    new LoggerError({\n                        name: '@locallife/log-vue-error',\n                        error,\n                    }),\n                );\n            });\n\n        // unhandled rejection\n        const that = this;\n        window &&\n            window.addEventListener(\n                'unhandledrejection',\n                function (e: PromiseRejectionEvent) {\n                    that.error(\n                        new LoggerError({\n                            name: '@locallife/log-unhandledrejection',\n                            error: e.reason,\n                        }),\n                    );\n                    e.preventDefault();\n                },\n            );\n    }\n}\n\nlet logger: LocalLifeWebBaseLogger;\nexport default function LocalLifeWebLogger(...args: [Options?, any?, any?]) {\n    return logger || (logger = new LocalLifeWebBaseLogger(...args));\n}\n"],"mappings":"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"}