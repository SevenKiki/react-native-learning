

[@locallife/biz-request](https://git.corp.kuaishou.com/localkrn/locallife/biz-request)

## 介绍
KRN网络库(业务库)

[【技术方案】请求库下沉](https://docs.corp.kuaishou.com/k/home/VDqa-GtBR9Qc/fcAATKrTxQAnuEkBoJ8ZveWQQ)

## 安装

```sh
yarn add @locallife/biz-request
```

## 引入

```typescript
import { bizRequest } from '@locallife/biz-request';
```

## 用法

基础用法请参考 [base-request 使用文档](https://docs.corp.kuaishou.com/k/home/VT8iQORttiVk/fcAAEGWivBjBHdPP4mhRR0cO_)

在 base-request 库基础上提供了以下能力
1. 请求耗时统计（支持初始化时配置）
2. 请求错误上报
3. 请求参数校验（支持初始化时配置）
4. 返回参数校验（支持初始化时配置）
5. 提供 bizInit 方法，支持拦截器相关全局配置

高阶用法
1. userQuery 等集成，待续...

## 使用样例

1. 见根目录下 example 子目录

初始化逻辑，全局执行一次

```typescript
import {
    CommonRequestParams,
    Interceptor,
    InterceptorModel,
    RequestMethod,
} from '@locallife/base-request';

useEffect(() => {
    const requestVerifyParams = new Map([
        ['channelPage', 'string'],
        ['bundleVersionCode', 'number'],
    ]);
    bizRequest.bizInit(
        {
            params: { bundleVersionCode: -1, channelPage: 'channelPage' },
            headers: {
                'X-Client-Type': 1,
            },
            responseType: 'string',
            businessName: 'api',
            timeout: 3,
        } as CommonRequestParams,
        {
            customInnerRequestInterceptors: [new Test()], // 请求拦截器
            customInnerResponseInterceptors: [new Test()], // 响应拦截器，eg：自定义错误处理逻辑、登录状态失效逻辑
            enableRequestParamsVerify: true, // 开启请求参数校验
            requestVerifyParams, // 参数校验列表
            enableResponseBaseVerify: true, // 是否开启返回状态参数校验
            responseBaseVerifyFunc: (response) => {
                if (response.result === 1) {
                    return true;
                }
                return false;
            }, // 返回状态参数校验，自定义校验规则： true —— 校验成功，false —— 校验失败
            disableLogTimeCost: false, // 是否关闭耗时统计上报
            disableReportMonitorLog: false, // 是否关闭上报接口监控日志
        } as InterceptorParams,
    );
}, []);
```

执行网络请求

```typescript
import { BizRequestConfig, bizRequest } from '@locallife/biz-request';


bizRequest(
        {
            url: '/rest/n/nearby/localfood/topcard',
            params: { channelPage: 'channelPage' },
            businessName: 'api',
        },
        {
            enableResponseBaseVerify: false,
            ...DefaultBizRequestConfig,
        } as BizRequestConfig,
    )
    .then()
    .catch();
```

2. 运行demo

```sh
cd example
yarn
yarn start
```

## 参数说明

1. InterceptorParams

|参数名	| 说明	                                           | 类型	       |必填	| 默认值 |
| ----------- |-----------------------------------------------|-----------| ----------- |-----|
|customInnerRequestInterceptors	| 请求拦截器 | Array<Interceptor>	   |否	| -   |
|customInnerResponseInterceptors	| 请求类型   | Array<Interceptor>	   |否	| -   |
|enableRequestParamsVerify| 	是否开启请求参数校验 | boolean	   |否	| -   |
|requestVerifyParams	| 参数校验列表 | Map<string, string>	   |否	| -   |
|enableResponseBaseVerify| 	是否开启返回状态参数校验	| boolean	   |否	| -   |
|responseBaseVerifyFunc	| 返回状态参数校验，自定义校验规则： true —— 校验成功，false —— 校验失败	 | (response: KSBaseResponse) => boolean	 |否| 	-  |
|disableLogTimeCost	| 是否关闭耗时统计上报	 | boolean	  |否	| -   |
|disableReportMonitorLog	| 是否关闭上报接口监控日志	 | boolean	  |否	| -   |
