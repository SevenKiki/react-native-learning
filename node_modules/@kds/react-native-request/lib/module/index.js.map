{"version":3,"sources":["index.ts"],"names":["NativeModules","Platform","getAppVersion","versionCompare","VersionIs","KSURCTNetworkInterface","requestV2","nativeRequestV2","request","nativeRequest","undefined","originOptions","success","fail","complete","returnPromise","requestInterceptors","responseInterceptors","otherOptions","options","reduce","ret","reqInterceptor","resolve","reject","timeout","OS","timer","hasResult","successCallback","res","clearTimeout","result","resInterceptor","failCallback","err","businessName","test","url","appVersion","LessThan","replace","headers","contentType","contentType2","mergedContentType","indexOf","isIosLessThan10_5_10","isAndroidAndReponseTypeStringAndLessThan11_0_30","responseType","useRequestV2","parsedRes","JSON","parse","parsedErr","then","data","compatibleRes","statusCode","cookies","catch","code","message","apiErrorInfo","setTimeout","Promise","rej"],"mappings":"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","sourcesContent":["import type {\n  ExportRequestOptions,\n  FailParams,\n  RequestOptions,\n  SuccessParams,\n} from './types';\nexport * from './types';\nimport { NativeModules, Platform } from 'react-native';\nimport { getAppVersion, versionCompare, VersionIs } from './utils';\n\nconst {\n  KSURCTNetworkInterface: {\n    requestV2: nativeRequestV2,\n    request: nativeRequest,\n  } = { requestV2: undefined, request: undefined },\n} = NativeModules;\nasync function request<R = Record<string, any>, P = Record<string, any>>(\n  originOptions: ExportRequestOptions<R, P>\n): Promise<SuccessParams<R>> {\n  const {\n    success,\n    fail,\n    complete,\n    returnPromise = true,\n    requestInterceptors = [],\n    responseInterceptors = [],\n    ...otherOptions\n  } = originOptions;\n  const options = requestInterceptors.reduce((ret, reqInterceptor) => {\n    return reqInterceptor(ret) || ret;\n  }, otherOptions);\n  let resolve: any;\n  let reject: any;\n  const timeout = options.timeout || (Platform.OS === 'android' ? 10 : 15);\n  let timer: any;\n  let hasResult = false;\n  const successCallback = (res: SuccessParams<R>) => {\n    clearTimeout(timer);\n    if (hasResult) {\n      return;\n    }\n    hasResult = true;\n    const result = responseInterceptors.reduce((ret, resInterceptor) => {\n      return resInterceptor(ret) || ret;\n    }, res);\n    success?.(result);\n    resolve?.(result);\n    complete?.(result);\n  };\n  const failCallback = (err: FailParams) => {\n    clearTimeout(timer);\n    if (hasResult) {\n      return;\n    }\n    hasResult = true;\n    fail?.(err);\n    reject?.(err);\n    complete?.(err);\n  };\n  // 如果是版本号小于 9.10.40，且 businessName 为 web_merchant，对于 url 中没有带 host 的补上 https://app.kwaixiaodian.com\n  if (\n    options.businessName === 'web_merchant' &&\n    !/^https?:\\/\\//.test(options.url || '')\n  ) {\n    const appVersion = getAppVersion();\n    if (versionCompare(appVersion, '9.10.40') === VersionIs.LessThan) {\n      options.url = `https://app.kwaixiaodian.com/${(options.url || '').replace(\n        /^\\//,\n        ''\n      )}`;\n    }\n  }\n\n  // 兼容安卓 9.8.50 之前的 Content-Type\n  if (\n    options.headers &&\n    (options.headers['content-type'] || options.headers['Content-Type']) &&\n    Platform.OS === 'android'\n  ) {\n    const {\n      headers: { 'content-type': contentType, 'Content-Type': contentType2 },\n    } = options;\n    const mergedContentType = contentType || contentType2;\n    const appVersion = getAppVersion();\n    if (\n      versionCompare(appVersion, '9.8.50') === VersionIs.LessThan &&\n      mergedContentType.indexOf('application/json') !== -1\n    ) {\n      if (contentType) {\n        options.headers['content-type'] = 'application/json';\n      }\n      if (contentType2) {\n        options.headers['Content-Type'] = 'application/json';\n      }\n    }\n  }\n  // 兼容IOS 10.1.30 之前的 Content-Type\n  if (\n    options.headers &&\n    options.headers['content-type'] &&\n    Platform.OS === 'ios'\n  ) {\n    const {\n      headers: { 'content-type': contentType },\n    } = options;\n    const appVersion = getAppVersion();\n    if (versionCompare(appVersion, '10.1.30') === VersionIs.LessThan) {\n      delete options.headers['content-type'];\n      options.headers['Content-Type'] = contentType;\n    }\n  }\n  // IOS 10.5.10 以下不应该使用 V2 接口\n  const isIosLessThan10_5_10 =\n    Platform.OS === 'ios' &&\n    versionCompare(getAppVersion(), '10.5.10') === VersionIs.LessThan;\n\n  // Android 11.0.30 以下且 responseType 等于 string 时不应该使用 V2 接口\n  const isAndroidAndReponseTypeStringAndLessThan11_0_30 =\n    options.responseType === 'string' &&\n    Platform.OS === 'android' &&\n    versionCompare(getAppVersion(), '11.0.30') === VersionIs.LessThan;\n  const useRequestV2 =\n    !!nativeRequestV2 &&\n    !isIosLessThan10_5_10 &&\n    !isAndroidAndReponseTypeStringAndLessThan11_0_30;\n\n  if (useRequestV2) {\n    nativeRequestV2(\n      {\n        ...options,\n      } as RequestOptions<P>,\n      (res: string) => {\n        const parsedRes: SuccessParams<R> = JSON.parse(res);\n        successCallback(parsedRes);\n      },\n      (err: string) => {\n        const parsedErr: FailParams = JSON.parse(err);\n        failCallback(parsedErr);\n      }\n    );\n  } else if (nativeRequest) {\n    nativeRequest(options)\n      .then((data: R) => {\n        const compatibleRes: SuccessParams<R> = {\n          data,\n          headers: {},\n          statusCode: 200,\n          cookies: [],\n        };\n        successCallback(compatibleRes);\n      })\n      .catch(\n        ({\n          code,\n          message,\n        }: {\n          code: number;\n          message: string;\n          [key: string]: any;\n        }) => {\n          failCallback({\n            code,\n            message,\n          });\n        }\n      );\n  } else {\n    // 没有原生请求模块暂时直接返回失败\n    failCallback({\n      code: -1,\n      message: '',\n      apiErrorInfo: {},\n    });\n  }\n  // 如果规定时间没响应自动超时\n  timer = setTimeout(() => {\n    failCallback({\n      code: -2,\n      message: '请求接口超时',\n      apiErrorInfo: {},\n    });\n  }, timeout * 1000);\n  return returnPromise\n    ? new Promise((res, rej) => {\n        resolve = res;\n        reject = rej;\n      })\n    : (undefined as any);\n}\n\nexport default request;\n"]}