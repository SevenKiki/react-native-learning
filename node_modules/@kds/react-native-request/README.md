# @kds/react-native-request

KDS React Native 原生网络库（基于原生 KSURCTNetworkInterface.request(requestV2) 封装）

## 安装

```sh
yarn add @kds/react-native-request
```

## 用法

```js
import request from '@kds/react-native-request';

// ...
request({
  url: 'https://run.mocky.io/v3/46ced360-0e74-40db-b892-a4fee7ddc25f',
  method: 'GET',
})
  .then(({ data, statusCode, headers, cookies }) => {
    console.log(data, statusCode, headers, cookies);
  })
  .catch((err) => {
    console.log('请求出错', err);
  });
```

## 处理含 bigInt 类型的返回值

```sh
yarn add json-bigint
```

```js
import request from '@kds/react-native-request';
import JSONbig from 'json-bigint';

request({
  url: 'https://run.mocky.io/v3/18391188-f50d-49b7-bbe8-8ad070bcc62f',
  method: 'GET',
  requestInterceptors: [
    (req) => {
      req.responseType = 'string';
      return req;
    },
  ],
  responseInterceptors: [
    (res) => {
      const bigIntJson = JSONbig.parse(res.data);
      const Json = JSON.parse(res.data);
      console.log('JSONbig parse value ==>', bigIntJson.data.value);
      console.log('JSON parse value ==>', Json.data.value);
      res.data = bigIntJson;
      return res;
    },
  ],
})
  .then(({ data, statusCode, headers, cookies }) => {
    console.log(data, statusCode, headers, cookies);
  })
  .catch((err) => {
    console.log('请求出错', err);
  });
```

## API 说明文档

```ts
// 请求参数
type ExportRequestOptions<R, P> = {
  /**
   * 请求 url，必须是带域名的完整 url，暂时不支持只传 path
   * @type {string}
   */
  url: string;

  /**
   * 主站特殊的字段，用来确定host 和做dns,默认的 businessName 为 api
   * @type {string}
   */
  businessName?: string;

  /**
   * 请求方法
   * @type {('GET' | 'POST')}
   */
  method: 'GET' | 'POST';

  /**
   * 超时时间，单位为秒，格式为正整数，Android 默认为 10s，IOS 默认为 15s
   * @type {number}
   */
  timeout?: number;

  /**
   * 请求头，格式为对象
   * @type {Record<string, any>}
   */
  headers?: Record<string, any>;

  /**
   * 请求参数，GET请求放到 query 区域， POST 放到 requestBody
   * @type {P}
   */
  params?: P;

  /**
   * 指定 query 参数，只在 POST 请求下生效
   * @type {Record<string, any>}
   */
  queryParams?: Record<string, any>;

  /**
   * 0 或 1，代表是否携带主站公共参数，默认为 1
   * @type {number}
   */
  isAddCommonParameters?: number;

  /**
   * 响应类型，默认为 json
   * @type {('string' | 'json')}
   */
  responseType?: 'string' | 'json';

  /**
   * 是否返回 Promise 对象，默认为 true
   * @type {boolean}
   */
  returnPromise?: boolean;

  /**
   * 请求完成时执行的回调，无论是否成功或失败都会执行
   */
  complete?: (params: SuccessParams<R> | FailParams) => void;

  /**
   * 请求成功时执行的回调
   * @type {SuccessHander<R>}
   */
  success?: SuccessHander<R>;

  /**
   * 请求失败时执行的回调
   * @type {FailHander}
   */
  fail?: FailHander;

  /**
   * 请求拦截器
   * @type {Array<(options: ExportRequestOptions<R, P>) => ExportRequestOptions<R, P>>}
   */
  requestInterceptors?: Array<
    (options: ExportRequestOptions<R, P>) => ExportRequestOptions<R, P>
  >;

  /**
   * 响应拦截器
   * @type {Array<(options: SuccessParams<R>) => SuccessParams<any>>}
   */
  responseInterceptors?: Array<
    (response: SuccessParams<R>) => SuccessParams<any>
  >;
};

// 成功参数
type SuccessParams<T> = {
  /**
   * 响应的 header 头
   * @type {Record<string, any>}
   */
  headers: Record<string, any>;

  /**
   * 状态码
   * @type {number}
   */
  statusCode: number;

  /**
   * 响应数据
   * @type {T}
   */
  data: T;

  /**
   * 响应时携带的 cookie
   * @type {Array<string>}
   */
  cookies: Array<string>;
};

// 错误参数
type FailParams = {
  /**
   * 请求错误码
   * @type {number}
   */
  code: number;

  /**
   * 请求错误信息
   * @type {string}
   */
  message: string;

  /**
   * 原生的请求错误信息对象，原来的老版本 request 方法此字段为空
   * @type {Record<string, any>}
   */
  apiErrorInfo?: Record<string, any>;
};

// 成功回调
type SuccessHander<T> = (params: SuccessParams<T>) => void;

// 失败回调
type FailHander = (params: FailParams) => void;
```

## 开发

1、从 master 切出新分支做问题修复或功能开发

2、在 example 目录进行示例预览、自测通过

3、向 master 发送 MR，请求合并

4、CR 通过后，在所在分支，执行 npm version patch/minor/major 更新版本号

5、合并入 master

6、使用 https://halo.corp.kuaishou.com/devcloud/pipeline/detail/600320 发布

## License

MIT
