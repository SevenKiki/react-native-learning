# @kds/image

自研的 RN 图片组件，将从以下方面进行介绍：

- [简介](#简介)
- [安装](#安装)
- [特性](#特性)
- [使用](#使用)
- [属性](#属性)
- [方法](#方法)
- [**常见问题速查**](#常见问题速查)
- [迭代记录](#迭代记录)
- [Licenses](#licenses)

## 简介

`@kds/image` 是 RN 官方 `Image` 组件的升级版本，主要解决了`动图加载`，`webp 支持`等问题，详细的差异参考[对比官方Image](./docs/对比官方Image.md)。

## 安装

```sh
npm install @kds/image
yarn add @kds/image   # 推荐使用yarn
```
> 注意：该组件之前更换了包名，之前的包名为 `@ks/image`（已经不维护）。如果你的 js 工程中已经使用了 `@ks/image`，建议替换为我们正在维护的  `@kds/image`，从而可以支持更多的特性

## 特性
### Android 
安卓端的实现主要基于 `facebook fresco` 模块，目前支持以下特性

- [x] **kpg 图片**
- [x] **webp 图片**
- [x] **gif 图片**
- [x] 图片缓存
- [x] 添加认证 headers.
- [x] 图片加载优先级.
- [x] 预加载图片.
- [x] 圆角.
- [x] 支持 cdnURLs.

### iOS
iOS 端的实现主要基于快手的 `KSWebImage` 模块，目前支持以下特性

- [x] **kpg 图片**
- [x] **webp 图片**
- [x] **gif 图片**
- [x] 图片缓存
- [x] 添加认证 headers.
- [x] 图片加载优先级.
- [x] 预加载图片.
- [x] 圆角.
- [x] refreshCache（刷新缓存）
- [x] useDefaultCacheKey（缓存 key）
- [x] requestUseCookie
- [x] 支持 cdnURLs.

### **支持图片格式(对比 RN Image)**

参考[支持图片格式](./docs/对比官方Image.md#图片格式)

## 使用

**注意: 你必须使用 React Native 0.62.2 版本**

`单 Url Demo`
```jsx
import KwaiImage from '@kds/image'

const YourImage = () => (
    <KwaiImage
        style={{ width: 200, height: 200 }}
        source={{
          uri:
            'http://tx3.a.yximgs.com/upic/2020/11/16/10/BMjAyMDExMTYxMDE5MDVfNDAzMDAwNDVfMzkzMTI0NTQwMThfMF8z_hd_B9673129efd57cb943de385b472b5e18b.kpg?tag=1-1605528664-h-0-mq7bxsicmf-321fd2d0d937a1e7&di=45ac5fa2&bp=10252'
        }}
    />
)
```

`CdnURLs Demo`
```jsx
      <KwaiImage
        style={styles.imageKpg}
        source={{
          uri:
            'http://tx2.a.yximgs.com/upic/2020/10/16/18/BMjAyMDEwMTYxODQ3MDNfMTg4ODg4ODgwXzM3NzczMTI1OTUwXzFfMw==_low_B93c4659d7b0cc4c96e5f1792399829e4.webp?tag=1-1603070599-bs-0-xe9lwte343-7063eebe5d31cb0e&type=hot&di=676bd8e6&bp=10332',
          uris: [
            {
              cdn: 'tx2.a.yximgs.com',
              url:
                'http://tx2.a.yximgs.com/2020/10/16/18/BMjAyMDEwMTYxODQ3MDNfMTg4ODg4ODgwXzM3NzczMTI1OTUwXzFfMw==_low_B93c4659d7b0cc4c96e5f1792399829e4.webp?tag=1-1603070599-bs-0-xe9lwte343-7063eebe5d31cb0e&type=hot&di=676bd8e6&bp=10332',
            },
            {
              cdn: 'ali2.a.yximgs.com',
              url:
                'http://ali2.a.yximgs.com/upic/2020/10/16/18/BMjAyMDEwMTYxODQ3MDNfMTg4ODg4ODgwXzM3NzczMTI1OTUwXzFfMw==_low_B93c4659d7b0cc4c96e5f1792399829e4.webp?tag=1-1603070599-bs-1-sspx4pcxcb-90965aadd9ea9e25&type=hot&di=676bd8e6&bp=10332',
            },
          ],
        }}
      />
```

## 属性

### `source?: object`

加载的图片源（支持本地，远程以及 cdn）

---

### `source.uri?: string`

图片源为远程 uri，例如 [logo](https://git.corp.kuaishou.com/krn/custom-component/react-native-kwai-image/-/blob/master/example/src/images/logo.png).

---

### `source.uris?: object`
图片源为 cdn uris，例如 
`[{"url":url1}, {"url":url3}, {"url":url3}, ...]`.

---
### `source.headers?: object`

图片请求的 Header，例如
```
{
   Authorization: 'someAuthToken', 
  'accept': 'image/*,*/*;q=0.8', 
  'content-type': 'image/kpg',
  'bitmapConfig': 'RGB_565'
  ...
}
```

其中重点介绍下 `bitmapConfig`，如下：
- **属性说明：** 用于控制图片的颜色编码格式（色深）。不同的编码格式会直接影响图片每个像素所占用的内存大小，仅对 Android 生效：iOS 系统（UIImage、SDImage 等）会自动处理好图片编码格式，一般不需要开发者关心
- **适用场景：** 针对非透明图片的内存优化，常用的格式有ARGB_8888、RGB_565，使用ARGB_8888格式时，图像质量高，而使用RGB_565则可直接降低一半内存占用

> 注意：上述 `bitmapConfig` 参数可以优化安卓端图片内存大小，`@kds/image` 还提供了 `cropSize` 属性可以支持双端的图片裁剪以减小内存大小。除此之外，其他常见的图片内存优化手段可以参考[图片内存优化最佳实践](https://kds.corp.kuaishou.com/kds-react/document/practice-new/05-rn-image-memory.html#%E5%9B%BE%E7%89%87%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5)

---
### `source.decodeFirstFrameOnly?: boolean`
用于 `webp`，`gif` 等动图，表示只解码动图第一帧，默认值为 `false`。

**todo: iOS bug:**
```
设置为 true 时, 当图片加载完成, webp 动图将开始运行动画。
设置为 false 时, 无论图片是否加载完成，都会开始运行动画。
安卓一直运行动画
```
---

### `source.priority?: enum`
图片加载优先级，该属性表示图片加载顺序的优先级

- `KwaiImage.priority.low` - 低优先级，将放在队列的后面加载
- `KwaiImage.priority.normal` **(默认)** - 正常优先级，按顺序加载
- `KwaiImage.priority.high` - 高优先级，将移到队列的前面加载

---

### `source.cache?: enum`
缓存策略，有以下三个值可选：

-   `KwaiImage.cacheControl.immutable` - **(默认)** - 只在 url 变化时更新图片.
-   `KwaiImage.cacheControl.web` - 使用 headers 并遵循正常的缓存步骤
-   `KwaiImage.cacheControl.cacheOnly` - 不做任何网络请求，只显示缓存中的图片

---

### `defaultSource?: source | number`
默认图：在下面两种情况下会展示：
1. 原 source 加载失败
2. 加载 source 直到 source 图片加载完成期间

可以通过以下两种方式指定默认图路径：

- `require`（**推荐**）: 加载本地默认图
- `uri`（**不建议，安卓端可能有内存问题**）: 加载网络默认图或者 base64 格式默认图
  
> 注意：安卓端默认图不支持动图和 base64 格式

示例：
```js
 <KwaiImage
    style={{height:100,width:100}}
    source={{uri: 'https://img-blog.csdnimg.cn/20190805161609203.png'}}
    defaultSource={require('test.png')}
 />
```
详细 demo 参考 [defaultSourceExample](./example/source/DefaultSourceExample.tsx)

---
### `refreshCache?: boolean（iOS）`
`true` 表示强制发起图片请求并刷新缓存文件，默认值为 `false`.

---

### `requestUseCookie?: boolean（iOS）`
`true` 表示请求需要处理 cookie，默认值为 `false`.

---

### `cropSize: object`
图片裁剪，用于减少图片内存占用，可用于一些大图场景

示例:
```js
  <KwaiImage 
      style={{height:200,width:200}}
      source={{uri:'https://img-blog.csdnimg.cn/20190805161609203.png'}}
      cropSize={{width:100, height:100}} # 必须指定裁剪的宽度和高度
   />
```
> 在安卓上, 如果你对网络图片使用 `cropSize`, 那么 `resizeMethod` 属性将被设置为 `resize`.

---
### `useDefaultCacheKey?: boolean（iOS）`
图片缓存文件的 key, 通常是一个 url，例如有一 url 为： `http://tx3.a.yximgs.com/upic/2020/11/16/10/BMjAyMDExMTYxMDE5MDVfNDAzMDAwNDVfMzkzMTI0NTQwMThfMF8z_hd_B9673129efd57cb943de385b472b5e18b.kpg?tag=1-1605528664-h-0-mq7bxsicmf-321fd2d0d937a1e7&di=45ac5fa2&bp=10252`, 该 url 的缓存文件 key 为： `/upic/2020/11/16/10/BMjAyMDExMTYxMDE5MDVfNDAzMDAwNDVfMzkzMTI0NTQwMThfMF8z_hd_B9673129efd57cb943de385b472b5e18b.kpg`.
注意, **如果路径相同，则图片相同**

如果设置为 `false`, 整个 url 字符串将作为缓存文件的 key.
默认值是 `true`.

---
### `resizeMode?: enum`
缩放模式，共有以下四种值：

-   `KwaiImage.resizeMode.contain` - 均匀缩放图片使得宽度和高度正好小于等于视图的宽高
-   `KwaiImage.resizeMode.cover` **(默认)** - 均匀缩放图片使得宽度和高度正好大于等于视图的宽高
-   `KwaiImage.resizeMode.stretch` - 拉伸宽度和高度到充满整个视图，可能会改变原图的纵横比
-   `KwaiImage.resizeMode.center` - 不进行缩放，使图片位于中间

参考 [resizeMode demo](./example/source/ResizeModeExample.tsx)

---

### `resizeMethod?: enum (Android)`
缩放方法，共有以下三种值：

- `KwaiImage.resizeMethod.auto` **默认** -使用 `heuristics` 算法在 `resize` 和 `scale`之间挑选
- `KwaiImage.resizeMethod.resize` - 在解码之前更改内存中的编码图像，通常在图片比视图大很多时使用
- `KwaiImage.resizeMethod.scale` - 缩放图像，通常在图片小于或者稍大于视图时使用

### `progressiveRenderingEnabled?: boolean（Android）`

表示是否开启渐进式渲染 JPEG 图像，可参考 [fresco Progressive JPEGs](https://frescolib.org/docs/progressive-jpegs.html)

---

### `fadeDuration: number（Android）`

动画淡入淡出的持续时间(单位：`ms`) 

---
### `onLoadStart?: () => void`

图片开始加载时的回调

---

### `onProgress?: (event) => void`

图片加载时的回调

例如 `onProgress={e => console.log(e.nativeEvent.loaded / e.nativeEvent.total)}`

---

### `onLoad?: (event) => void`

当图片加载成功时的回调，会返回图片的宽度，高度以及`是否为动图`等信息

例如 `onLoad={e => console.log(e.nativeEvent.width, e.nativeEvent.height, e.nativeEvent.isAnimatedImage)}`

---

### `onError?: () => void`

图片加载错误时的回调

---

### `onLoadEnd?: () => void`

图片结束加载时的回调，无论加载成功或者失败

---

### `onGifPlayEnd?: () => void`

动图播放最后一帧时的回调

---

### `onAnimatedFrame?: (event) => void`(仅 Android)

动图每一帧的回调，返回`总帧数`和`当前帧数`等信息。

例如 `onAnimatedFrame={e => console.log(e.nativeEvent.totalFrameCount, e.nativeEvent.currentFrame)}`

---

### `style`

React Native 样式. 支持 `borderRadius`.

---

### `fallback: boolean`

该属性表示是否降级为 RN 官方的图片组件 `Image`，默认值为 `false`

---

### `tintColor?: number | string`

图片颜色属性，将图片所有的`非透明像素`设置为给定的颜色

---

### `playAnimatedImage?: boolean`

控制动图播放/暂停的属性，默认是 `true`

```js
<KwaiImage
  style={{height:100,width:100}}
  source={require('test.gif')}
  playAnimatedImage={false} // 暂停动图的播放
 />
```

---

### `imageWarningThreshold?: object`

图片的内存和大小警告阈值设置

示例：
```js
<KwaiImage 
  style = {{width:100, height:100}}
  source = {require('test.jpg')}
  imageWarningThreshold = {{
    imageSizeWarningThreshold: -1, // 关闭图片大小告警
    imageMemoryWarningThreshold: -1, // 关闭图片内存告警
  }}
/>
```

`imageSizeWarningThreshold` 和 `imageMemoryWarningThreshold` 的类型为 `number`，你可以传递 `number` 类型的值 `value`，注意：

- `value < 0`: 关闭警告(推荐设置为 `-1`)
- `value > 0`: 将使用 `value` 作为最终的阈值。对于 `imageSizeWarningThreshold`, `value` 表示 `imageView` 和 `image` 尺寸的比例, 通常设置为 2,3,4,....,e.g. 对于 `imageMemoryWarningThreshold`, `value` 表示图片内存告警阈值, 通常设置为 1x1024(1024kb),2x1024(2048kb),3x1024(3072kb),....,e.g

> 如果你没有设置 `value` 或者 设置 `value = 0`, 将使用 `native` 侧默认的阈值


### `animatedLoopCount?: number`

设置动图循环播放次数，默认是`无限循环播放`。

> 注意：<= 0 的数值都表示无限循环播放

```js
<KwaiImage
  style={{height:100,width:100}}
  source={require('test.gif')}
  animatedLoopCount={1} // 循环播放一次
 />
```

---

## 方法

### `KwaiImage.preload: (sources: Source[]) => Promise<Response>`

图片预加载，可以传递一个 `source` 类型的数组作为参数，如下：

```js
KwaiImage.preload([
    {
        uri: 'https://facebook.github.io/react/img/logo_og.png',
        headers: { Authorization: 'someAuthToken' },
    },
    {
        uri: 'https://facebook.github.io/react/img/logo_og.png',
        headers: { Authorization: 'someAuthToken' },
    },
]).then((msg) => {
    console.log(msg);
})
  .catch((error) => {
    console.log(error);
  })
```

### `KwaiImage.getSize: (uri: string) => Promise<ImageSizeResponse>`

获取网络图片尺寸，只支持单 url 类型参数。如下：

```js
KwaiImage.getSize('https://facebook.github.io/react/img/logo_og.png')
.then(msg) => {
  console.log('图片宽高为：', msg.width, msg.height);
}, (error) => {
  console.log(error);
})
```

### `KwaiImage.resolveAssetSource: (source: ImageSourcePropType) => ImageResolvedAssetSource;`

可对本地图片资源等进行处理得到资源的以下信息：
- height: number;
- width: number;
- scale: number;
- uri: string;
  
如下：
```js
KwaiImage.resolveAssetSource(require('./test.jpg'))
```

## 常见问题速查

参考[图片常见问题](./docs/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98.md)
## 迭代记录

可前往 [CHANGELOG](./CHANGELOG.md) 查看组件的版本迭代记录

## Licenses

-  SDWebImage - `MIT`
-  Fresco - BSD, part MIT and Apache 2.0. See the [LICENSE](https://github.com/facebook/fresco/blob/master/LICENSE) file for details.

[package]: https://npm.corp.kuaishou.com/-/web/detail/@kds/image
[version-badge]: https://npm.corp.kuaishou.com/-/static/93df1ce974e744e7d98f5d842da74ba0.svg
[KSWebImage]:https://git.corp.kuaishou.com/ios/kswebimage
[KwaiImage]:https://git.corp.kuaishou.com/android/kwaiimage
[SDWebImage]:https://git.corp.kuaishou.com/ios/SDWebImage
[CdnURLs Demo]:./example/src/PriorityExample.tsx
[Single Url Demo]:./example/src/PriorityExample.tsx
[More Demo]:./example/src/index.tsx


