/*
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

package com.facebook.react.turbomodule.core;

import com.facebook.proguard.annotations.DoNotStrip;
import com.facebook.react.bridge.ReactMarker;
import com.facebook.react.bridge.ReactMarkerConstants;
import com.facebook.react.reactperflogger.NativeModulePerfLogger;
import com.facebook.soloader.SoLoader;

import javax.annotation.Nullable;

@DoNotStrip
public class TurboModulePerfLogger {
  @Nullable private static NativeModulePerfLogger sNativeModulePerfLogger = null;
  private static boolean sIsSoLibraryLoaded = false;
  private static boolean sEnabled = false;

  @DoNotStrip
  public static void moduleDataCreateStart(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleDataCreateStart.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleDataCreateStart(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleDataCreateEnd(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleDataCreateEnd.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleDataCreateEnd(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleCreateStart(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleCreateStart.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleCreateStart(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleCreateCacheHit(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleCreateCacheHit.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleCreateCacheHit(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleCreateConstructStart(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleCreateConstructStart.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleCreateConstructStart(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleCreateConstructEnd(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleCreateConstructEnd.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleCreateConstructEnd(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleCreateSetUpStart(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleCreateSetUpStart.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleCreateSetUpStart(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleCreateSetUpEnd(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleCreateSetUpEnd.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleCreateSetUpEnd(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleCreateEnd(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleCreateEnd.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleCreateEnd(moduleName, id);
    }
  }

  @DoNotStrip
  public static void moduleCreateFail(String moduleName, int id) {
    markTMM(ReactMarkerConstants.moduleCreateFail.name(), moduleName, id);
    if (sNativeModulePerfLogger != null) {
      sNativeModulePerfLogger.moduleCreateFail(moduleName, id);
    }
  }

  private static native void jniEnableCppLogging(NativeModulePerfLogger perfLogger);
  private static native void jniSetEnabled(boolean enabled);

  private static synchronized void maybeLoadSoLibrary() {
    if (!sIsSoLibraryLoaded) {
      SoLoader.loadLibrary("turbomodulejsijni");
      sIsSoLibraryLoaded = true;
    }
  }

  private static void markTMM(String marker, String moduleName, int id) {
    if (sEnabled) {
      ReactMarker.logTMMMarker(marker, moduleName, null, id);
    }
  }

  public static void setEnabled(boolean enabled) {
    maybeLoadSoLibrary();
    sEnabled = true;
    jniSetEnabled(enabled);
  }

  public static void enableLogging(NativeModulePerfLogger perfLogger) {
    if (perfLogger != null) {
      sNativeModulePerfLogger = perfLogger;
      maybeLoadSoLibrary();
      jniEnableCppLogging(perfLogger);
    }
  }
}
