/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the LICENSE
 * file in the root directory of this source tree.
 */

#include "V8ExecutorFactory.h"

#include <thread>

#include "V8Runtime.h"
#include "V8RuntimeFactory.h"
#include "cxxreact/MessageQueueThread.h"
#include "cxxreact/SystraceSection.h"

using namespace facebook::jsi;

namespace facebook {
namespace react {

namespace {

std::unique_ptr<Runtime> makeV8RuntimeSystraced(
    const std::string &timezoneId,
    std::shared_ptr<ExecutorDelegate> delegate,
    const std::string &traceFilename,
    bool enableStartupTrace) {
  SystraceSection s("V8ExecutorFactory::makeV8RuntimeSystraced");
  return createV8Runtime(timezoneId, delegate, traceFilename, enableStartupTrace);
}

} // namespace

std::unique_ptr<JSExecutor> V8ExecutorFactory::createJSExecutor(
    std::shared_ptr<ExecutorDelegate> delegate,
    std::shared_ptr<MessageQueueThread> jsQueue,
    int uniqueId) {
  std::unique_ptr<Runtime> v8Runtime = makeV8RuntimeSystraced(
      timezoneId_, delegate, traceFilename_, enableStartupTrace_);

  // Add js engine information to Error.prototype so in error reporting we
  // can send this information.
  auto errorPrototype = v8Runtime->global()
                            .getPropertyAsObject(*v8Runtime, "Error")
                            .getPropertyAsObject(*v8Runtime, "prototype");
  errorPrototype.setProperty(*v8Runtime, "jsEngine", "v8");

  return std::make_unique<V8Executor>(
      std::move(v8Runtime),
      delegate,
      jsQueue,
      timeoutInvoker_,
      runtimeInstaller_,
      uniqueId);
}

V8Executor::V8Executor(
    std::shared_ptr<jsi::Runtime> runtime,
    std::shared_ptr<ExecutorDelegate> delegate,
    std::shared_ptr<MessageQueueThread> jsQueue,
    const JSIScopedTimeoutInvoker &timeoutInvoker,
    RuntimeInstaller runtimeInstaller, int uniqueId)
    : JSIExecutor(runtime, delegate, timeoutInvoker, runtimeInstaller, uniqueId) {}

bool V8Executor::encodeEvaluateParameters(std::string &sourceURL, int hash) {
  return V8Runtime::encodeEvaluateParameters(sourceURL, hash);
}

} // namespace react
} // namespace facebook
