import{AppState}from"react-native";var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},e=function(){return(e=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function r(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,i,r=n.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(o=r.next()).done;)a.push(o.value)}catch(e){i={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}return a}function o(e,t,n){if(n||2===arguments.length)for(var o,i=0,r=t.length;i<r;i++)!o&&i in t||((o=o||Array.prototype.slice.call(t,0,i))[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}var l,f$1,i="ksurl.cn/csHfgepO",a=console,s$1=(a.log.bind(a,i+", radar:"),a.warn.bind(a,i+", radar:")),u$1=a.error.bind(a,i+", radar:"),p=function(){function e(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.middlewares=[],(e=this.middlewares).push.apply(e,o([],r(t),!1))}return e.prototype.use=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=this.middlewares.pop();(e=this.middlewares).push.apply(e,o([],r(t),!1)),this.middlewares.push(i)},e.prototype.invoke=function(e){return a=this.middlewares,o=e,r=-1,function e(t){if(t<=r)return new Error("`next` 被重复调用");var n=a[r=t];if(n=t===a.length?i:n)try{return n(o,e.bind(null,t+1))}catch(t){return t}}(0);var o,i,r,a},e}(),d$1=((f$1=l=l||{}).LOAD="load",f$1.RES="resource",f$1.API="api",f$1.ERROR="error",f$1.SDK_ERROR="sdk_error",f$1.CUSTOM="custom",f$1.BATCH="batch",f$1.EVENT="event",f$1.BLOOD="blood",function(){function t(e){void 0===e&&(e={});var t=this;this.broadcastSampleFb=function(){var e=t.getSample(t.baseOptions.sampling);e!==t.sampling&&(t.sampling=e,t.sampling&&(t.isHit=t.samplingControl(t.sampling)))},void 0===e&&De("100"),e.key||De("101"),!e.core||"object"==typeof e.core.sampleData&&"function"==typeof e.core.collect||De("121"),this.baseOptions=e,this.key=e.key,this.version=e.version,this.name=e.name,this.isHit=!1,e.core&&this.updateCore(e.core)}return t.prototype.updateCore=function(e){var t;"object"==typeof e.sampleData&&"function"==typeof e.collect||De("121"),null!=(t=this.core)&&t.broadcastSample.off(this.broadcastSampleFb),this.core=e,this.sampling=this.getSample(this.baseOptions.sampling),this.sampling&&(this.isHit=this.samplingControl(this.sampling)),null!=(e=null==(t=this.core)?void 0:t.broadcastSample)&&e.on(this.broadcastSampleFb)},t.prototype.getSample=function(e){var t=null!=(t=null==(t=this.core)?void 0:t.sampleData.core)?t:1;if(this.key===l.LOAD)return t;if("number"!=typeof(e=void 0===e?1:e)||e<0||1<e)return s$1("102","".concat(this.key,"，采用Core的采样率").concat(null==(n=this.core)?void 0:n.sampleData.core)),t;var n=null!=(n=this.core)&&n.isInYoda?void 0===(null==(n=this.core)?void 0:n.sampleData[this.key])?1:this.core.sampleData[this.key]:e;return t&&t<n?(s$1("115","".concat(this.key)),t):n},t.prototype.samplingControl=function(e){var t;return!(null==(t=this.core)||!t.sampleData.isHit)&&(null==(t=this.core)?void 0:t.samplingControl(e/this.core.sampleData.core))},t.prototype.baseCollect=function(t){if(this.core){if(this.isHit){var o=t.value||{},o=Object.keys(o).filter(function(e){return null!==o[e]&&void 0!==o[e]}).reduce(function(t,n){return e(e({},t),((t={})[n]=o[n],t))},{});try{this.core.collect(t.key||this.key,e(e({collect_version:this.version,collect_name:this.name},t.dimension),{sample_rate:this.sampling}),o)}catch(t){s$1("126")}}}else s$1("110","".concat(this.key))},t}()),m=window,_="__radarSeedStore__",x="isRuning",E="event",k="Queue",A=E+k;function W(t){return"object"==typeof t&&Object.keys(t).every(function(e){return"number"==typeof t[e]})}function ae(){var n=[];function t(e){-1!==(e=n.indexOf(e))&&n.splice(e,1)}function e(e){return n.push(e),t.bind(void 0,e)}return{on:e,off:t,once:function(t){var n=e(function(e){t(e),n()});return n},emit:function(t){n.forEach(function(e){return e(t)})}}}function he(e){var t=e.value;return e=e.dimension.name,!(void 0!==t&&!W(t)||!e)}function ye(e){var t=e.sessionId,n=e.bundleId,o=e.bundleVersionCode,i=e.bundleVersion,r=e.componentName,a=e.jsExecutor;return e=e.scheme,"string"!=typeof t||""==t.trim()||"string"!=typeof n||""==n.trim()?"missingRequired":"number"==typeof o&&"string"==typeof i&&"string"==typeof r&&"string"==typeof a&&"string"==typeof e}function Re(e,t){var n;return null!=(n=null==m?void 0:m[_])&&n[e],null!=(n=null==m?void 0:m[_])&&n[x]?m[_][e]:void 0===t?null:t}function Oe(e,t){try{m[_][e]=t}catch(e){u$1("1000")}}function Te(e){return JSON.parse(JSON.stringify(e))}function De(e){throw new Error("radar error "+e)}var c=function(){return(c=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},h={sessionId:{originKey:"SessionId",defaultValue:""},bundleId:{originKey:"bundleId",defaultValue:""},bundleVersionCode:{originKey:"BundleVersionCode",defaultValue:0},bundleVersion:{originKey:"BundleVersion",defaultValue:""},componentName:{originKey:"componentName",defaultValue:""},jsExecutor:{originKey:"JsExecutor",defaultValue:""},scheme:{originKey:"scheme",defaultValue:""}},d=function(){function e(n){var e,r=this,o=(this.webloggerEventType="CUSTOM_EVENT",this.krnCustomEventKey="krn_custom_event",this.biz="RADAR",this.queueConfig={wait:1e3,maxBatchLength:200},this.logQueue=[],this.batchTimer=0,this.runtimeIdMap={},this.shouldCollect=!0,this.randomSampling=Math.random(),this.sampleData={isHit:!0,core:1},this.isInYoda=!1,this.sampling=1,this.radarSessionId="",this.ignoreList=[],this.broadcastSample=ae(),this.collect=function(e,t,n){var o=Te({key:e,dimension:t=void 0===t?{}:t,value:n=void 0===n?{}:n});if(!he(o))return u$1("107, key: ".concat(o.key)),void r.collect(l.EVENT,{message:"radar上报日志类型错误",name:"radar_log_error",extra_info:JSON.stringify(o)},{});Object.keys(o.value).forEach(function(e){o.value[e]=o.value[e].toString()});var i=r.getCommonData();if((e=new p(function(e,t){return c(c(c({},e),i),{event_client_timestamp:Date.now()})})).use(function(e,t){return e.key&&(e.dimension=c(c({},e.dimension),{other_session_increase_id:r.genSessionIncreaseId("OTHER_SESSION_INCREASE_ID")})),t()}),(o=e.invoke(o))instanceof Error)throw o;if(r.weblog&&r.logQueue.push(o),r.logQueue.length>r.queueConfig.maxBatchLength-1)return r.flush(),clearTimeout(r.batchTimer),void(r.batchTimer=0);r.batchTimer||(r.batchTimer=window.setTimeout(function(){r.flush(),clearTimeout(r.batchTimer),r.batchTimer=0},r.queueConfig.wait))},this.flush=function(){r.weblog?r.logQueue.length<=0||(r.reportByBridge(),r.logQueue=[]):s$1("128","weblogger is undefined")},this.appStateChange=function(e){"active"!==e&&r.flush(),"destroy"===e&&AppState.removeEventListener("change",r.appStateChange)},"object"==typeof n&&null!==n||De("108"),n),i=n.props;n.props&&n.props.constructor===Object||(i={}),Object.keys(h).forEach(function(e){var t;o[e]=null!=(t=null!=(t=i[h[e].originKey])?t:n[e])?t:h[e].defaultValue}),"missingRequired"==ye(o)?(this.shouldCollect=!1,s$1("125","sessionId 或 bundleId 传入错误，SDK 将不进行上报")):ye(o)||s$1("127"),this.config=o,this.bindWeblogger(null!=(e=o.weblog)?e:o.weblogger),AppState.addEventListener("change",this.appStateChange)}return e.prototype.samplingControl=function(e){return null!==e&&"number"==typeof e&&this.randomSampling<e},e.prototype.setDimensions=function(e){},e.prototype.bindWeblogger=function(e){null!=e&&("object"!=typeof e&&De("106"),this.weblog?s$1("122"):this.weblog=e)},e.prototype.genSessionIncreaseId=function(e){return this.runtimeIdMap[e]||(this.runtimeIdMap[e]=0),this.runtimeIdMap[e]++},e.prototype.getCommonData=function(){var e;return{h5_extra_attr:JSON.stringify(c({},null==(e=null==(e=this.weblog)?void 0:e.commonPackage)?void 0:e.h5_extra_attr))}},e.prototype.reportByBridge=function(){var e,t;try{this.shouldCollect&&this.logQueue.length&&(t={key:this.krnCustomEventKey,value:{session_id:this.config.sessionId,bundle_id:this.config.bundleId,bundle_version:this.config.bundleVersion,bundle_version_code:this.config.bundleVersionCode,component_name:this.config.componentName,js_executor:this.config.jsExecutor,scheme:this.config.scheme,data:this.logQueue},biz:this.biz},null!=(e=this.weblog)&&e.collect(this.webloggerEventType,t))}catch(e){s$1("128",e)}},e}(),f=function(e,t){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},s=function(){return(s=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},u=function(n){function e(e){var t=n.call(this,{core:e.core,sampling:e.sampling,key:l.EVENT,version:"1.2.5",name:"RadarEventCollect"})||this;return t.action={start:function(e){t._checkActionDimension(e),t.event({name:e.name,extra_info:e.extra_info,event_type:"radar_action_start"})},end:function(e){t._checkActionDimension(e),t.event({name:e.name,extra_info:e.extra_info,result_type:e.result_type,event_type:"radar_action_end"})}},t.parseSeedLog(),t}var t=e,o=n;if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function i(){this.constructor=t}return f(t,o),t.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i),e.prototype.parseSeedLog=function(){var n=this,e=Re(A,[]);e.length&&(e.map(function(e){var t=e.dimension;e=e.value,n.event(t,e)}),Oe(A,[]))},e.prototype.event=function(e,t){var n;this.isHit?(e||De("402"),void 0!==e.name&&"string"==typeof e.name||De("402"),127<e.name.length&&(u$1("403"),e.name=e.name.slice(0,127)),e.is_official=1,t&&void 0!==t.duration&&("number"!=typeof t.duration||t.duration<0)&&De("404"),t&&void 0!==t.event_count&&("number"!=typeof t.event_count||t.event_count<0)&&De("405，".concat(t.event_count)),n={dimension:e,value:t},e&&e.extra_info&&"object"==typeof e.extra_info&&(n={dimension:s(s({},e),{extra_info:JSON.stringify(e.extra_info)}),value:t}),this.baseCollect(n)):s$1("401")},e.prototype.destroy=function(){this.event=function(){s$1("407")},this.action={start:function(){s$1("407")},end:function(){s$1("407")}}},e.prototype._checkActionDimension=function(e){if(!e)throw Error("408");void 0===e.extra_info||e.extra_info instanceof Object||De("406")},e}(d$1),RadarKrn=function(){function e(e){this.core=new d(__assign(__assign({},e),{sampling:1})),this.eventCollect=new u({core:this.core}),this.action=this.eventCollect.action}return e.prototype.apply=function(e){this.bindWeblogger(e)},e.prototype.bindWeblogger=function(e){this.weblog=e,this.core.bindWeblogger(this.weblog)},e.prototype.event=function(e,t){this.eventCollect.event(e,t)},e.prototype.destroy=function(){var e;null!=(e=this.eventCollect)&&e.destroy()},e.key="radar_krn_plugin",e.version="0.0.1",e}();export{RadarKrn as default};
