!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("react-native")):"function"==typeof define&&define.amd?define(["react-native"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).Radar=t(e.reactNative)}(this,function(l){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},o=function(){return(o=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function i(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,i,r=n.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(o=r.next()).done;)a.push(o.value)}catch(e){i={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}return a}function r(e,t,n){if(n||2===arguments.length)for(var o,i=0,r=t.length;i<r;i++)!o&&i in t||((o=o||Array.prototype.slice.call(t,0,i))[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}var c,e="ksurl.cn/csHfgepO",n=console,u=(n.log.bind(n,e+", radar:"),n.warn.bind(n,e+", radar:")),p=n.error.bind(n,e+", radar:"),f=(s.prototype.use=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var o=this.middlewares.pop();(e=this.middlewares).push.apply(e,r([],i(t),!1)),this.middlewares.push(o)},s.prototype.invoke=function(e){return a=this.middlewares,o=e,r=-1,function e(t){if(t<=r)return new Error("`next` 被重复调用");var n=a[r=t];if(n=t===a.length?i:n)try{return n(o,e.bind(null,t+1))}catch(t){return t}}(0);var o,i,r,a},s),e=((n=c={}).LOAD="load",n.RES="resource",n.API="api",n.ERROR="error",n.SDK_ERROR="sdk_error",n.CUSTOM="custom",n.BATCH="batch",n.EVENT="event",n.BLOOD="blood",a.prototype.updateCore=function(e){var t;"object"==typeof e.sampleData&&"function"==typeof e.collect||v("121"),null!=(t=this.core)&&t.broadcastSample.off(this.broadcastSampleFb),this.core=e,this.sampling=this.getSample(this.baseOptions.sampling),this.sampling&&(this.isHit=this.samplingControl(this.sampling)),null!=(e=null==(t=this.core)?void 0:t.broadcastSample)&&e.on(this.broadcastSampleFb)},a.prototype.getSample=function(e){var t=null!=(t=null==(t=this.core)?void 0:t.sampleData.core)?t:1;if(this.key===c.LOAD)return t;if("number"!=typeof(e=void 0===e?1:e)||e<0||1<e)return u("102","".concat(this.key,"，采用Core的采样率").concat(null==(n=this.core)?void 0:n.sampleData.core)),t;var n=null!=(n=this.core)&&n.isInYoda?void 0===(null==(n=this.core)?void 0:n.sampleData[this.key])?1:this.core.sampleData[this.key]:e;return t&&t<n?(u("115","".concat(this.key)),t):n},a.prototype.samplingControl=function(e){var t;return!(null==(t=this.core)||!t.sampleData.isHit)&&(null==(t=this.core)?void 0:t.samplingControl(e/this.core.sampleData.core))},a.prototype.baseCollect=function(e){if(this.core){if(this.isHit){var n=e.value||{},n=Object.keys(n).filter(function(e){return null!==n[e]&&void 0!==n[e]}).reduce(function(e,t){return o(o({},e),((e={})[t]=n[t],e))},{});try{this.core.collect(e.key||this.key,o(o({collect_version:this.version,collect_name:this.name},e.dimension),{sample_rate:this.sampling}),n)}catch(e){u("126")}}}else u("110","".concat(this.key))},a);function a(e){void 0===e&&(e={});var t=this;this.broadcastSampleFb=function(){var e=t.getSample(t.baseOptions.sampling);e!==t.sampling&&(t.sampling=e,t.sampling&&(t.isHit=t.samplingControl(t.sampling)))},void 0===e&&v("100"),e.key||v("101"),!e.core||"object"==typeof e.core.sampleData&&"function"==typeof e.core.collect||v("121"),this.baseOptions=e,this.key=e.key,this.version=e.version,this.name=e.name,this.isHit=!1,e.core&&this.updateCore(e.core)}function s(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.middlewares=[],(e=this.middlewares).push.apply(e,r([],i(t),!1))}var h=window,d="__radarSeedStore__",m="eventQueue";function g(e){var t,n=e.value;return e=e.dimension.name,(void 0===n||"object"==typeof(t=n)&&Object.keys(t).every(function(e){return"number"==typeof t[e]}))&&e}function y(e){var t=e.sessionId,n=e.bundleId,o=e.bundleVersionCode,i=e.bundleVersion,r=e.componentName,a=e.jsExecutor;return e=e.scheme,"string"!=typeof t||""==t.trim()||"string"!=typeof n||""==n.trim()?"missingRequired":"number"==typeof o&&"string"==typeof i&&"string"==typeof r&&"string"==typeof a&&"string"==typeof e}function v(e){throw new Error("radar error "+e)}var b=function(){return(b=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},_={sessionId:{originKey:"SessionId",defaultValue:""},bundleId:{originKey:"bundleId",defaultValue:""},bundleVersionCode:{originKey:"BundleVersionCode",defaultValue:0},bundleVersion:{originKey:"BundleVersion",defaultValue:""},componentName:{originKey:"componentName",defaultValue:""},jsExecutor:{originKey:"JsExecutor",defaultValue:""},scheme:{originKey:"scheme",defaultValue:""}},w=(O.prototype.samplingControl=function(e){return null!==e&&"number"==typeof e&&this.randomSampling<e},O.prototype.setDimensions=function(e){},O.prototype.bindWeblogger=function(e){null!=e&&("object"!=typeof e&&v("106"),this.weblog?u("122"):this.weblog=e)},O.prototype.genSessionIncreaseId=function(e){return this.runtimeIdMap[e]||(this.runtimeIdMap[e]=0),this.runtimeIdMap[e]++},O.prototype.getCommonData=function(){var e;return{h5_extra_attr:JSON.stringify(b({},null==(e=null==(e=this.weblog)?void 0:e.commonPackage)?void 0:e.h5_extra_attr))}},O.prototype.reportByBridge=function(){var e,t;try{this.shouldCollect&&this.logQueue.length&&(t={key:this.krnCustomEventKey,value:{session_id:this.config.sessionId,bundle_id:this.config.bundleId,bundle_version:this.config.bundleVersion,bundle_version_code:this.config.bundleVersionCode,component_name:this.config.componentName,js_executor:this.config.jsExecutor,scheme:this.config.scheme,data:this.logQueue},biz:this.biz},null!=(e=this.weblog)&&e.collect(this.webloggerEventType,t))}catch(e){u("128",e)}},O);function O(n){var e,o,r=this,i=(this.webloggerEventType="CUSTOM_EVENT",this.krnCustomEventKey="krn_custom_event",this.biz="RADAR",this.queueConfig={wait:1e3,maxBatchLength:200},this.logQueue=[],this.batchTimer=0,this.runtimeIdMap={},this.shouldCollect=!0,this.randomSampling=Math.random(),this.sampleData={isHit:!0,core:1},this.isInYoda=!1,this.sampling=1,this.radarSessionId="",this.ignoreList=[],this.broadcastSample=(o=[],{on:s,off:t,once:function(t){var n=s(function(e){t(e),n()});return n},emit:function(t){o.forEach(function(e){return e(t)})}}),this.collect=function(e,t,n){t={key:e,dimension:t=void 0===t?{}:t,value:n=void 0===n?{}:n};var o=JSON.parse(JSON.stringify(t));if(!g(o))return p("107, key: ".concat(o.key)),void r.collect(c.EVENT,{message:"radar上报日志类型错误",name:"radar_log_error",extra_info:JSON.stringify(o)},{});Object.keys(o.value).forEach(function(e){o.value[e]=o.value[e].toString()});var i=r.getCommonData();if((e=new f(function(e,t){return b(b(b({},e),i),{event_client_timestamp:Date.now()})})).use(function(e,t){return e.key&&(e.dimension=b(b({},e.dimension),{other_session_increase_id:r.genSessionIncreaseId("OTHER_SESSION_INCREASE_ID")})),t()}),(o=e.invoke(o))instanceof Error)throw o;if(r.weblog&&r.logQueue.push(o),r.logQueue.length>r.queueConfig.maxBatchLength-1)return r.flush(),clearTimeout(r.batchTimer),void(r.batchTimer=0);r.batchTimer||(r.batchTimer=window.setTimeout(function(){r.flush(),clearTimeout(r.batchTimer),r.batchTimer=0},r.queueConfig.wait))},this.flush=function(){r.weblog?r.logQueue.length<=0||(r.reportByBridge(),r.logQueue=[]):u("128","weblogger is undefined")},this.appStateChange=function(e){"active"!==e&&r.flush(),"destroy"===e&&l.AppState.removeEventListener("change",r.appStateChange)},"object"==typeof n&&null!==n||v("108"),n),a=n.props;function t(e){-1!==(e=o.indexOf(e))&&o.splice(e,1)}function s(e){return o.push(e),t.bind(void 0,e)}n.props&&n.props.constructor===Object||(a={}),Object.keys(_).forEach(function(e){var t;i[e]=null!=(t=null!=(t=a[_[e].originKey])?t:n[e])?t:_[e].defaultValue}),"missingRequired"==y(i)?(this.shouldCollect=!1,u("125","sessionId 或 bundleId 传入错误，SDK 将不进行上报")):y(i)||u("127"),this.config=i,this.bindWeblogger(null!=(e=i.weblog)?e:i.weblogger),l.AppState.addEventListener("change",this.appStateChange)}var S=function(e,t){return(S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},C=function(){return(C=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},k=function(n){function e(e){var t=n.call(this,{core:e.core,sampling:e.sampling,key:c.EVENT,version:"1.2.5",name:"RadarEventCollect"})||this;return t.action={start:function(e){t._checkActionDimension(e),t.event({name:e.name,extra_info:e.extra_info,event_type:"radar_action_start"})},end:function(e){t._checkActionDimension(e),t.event({name:e.name,extra_info:e.extra_info,result_type:e.result_type,event_type:"radar_action_end"})}},t.parseSeedLog(),t}var t=e,o=n;if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function i(){this.constructor=t}return S(t,o),t.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i),e.prototype.parseSeedLog=function(){var e,n=this,t=(i=m,e=[],null!=(t=null==h?void 0:h[d])&&t[i],null!=(t=null==h?void 0:h[d])&&t.isRuning?h[d][i]:void 0===e?null:e);if(t.length){t.map(function(e){var t=e.dimension;e=e.value,n.event(t,e)});var o=m,i=[];try{h[d][o]=i}catch(o){p("1000")}}},e.prototype.event=function(e,t){var n;this.isHit?(e||v("402"),void 0!==e.name&&"string"==typeof e.name||v("402"),127<e.name.length&&(p("403"),e.name=e.name.slice(0,127)),e.is_official=1,t&&void 0!==t.duration&&("number"!=typeof t.duration||t.duration<0)&&v("404"),t&&void 0!==t.event_count&&("number"!=typeof t.event_count||t.event_count<0)&&v("405，".concat(t.event_count)),n={dimension:e,value:t},e&&e.extra_info&&"object"==typeof e.extra_info&&(n={dimension:C(C({},e),{extra_info:JSON.stringify(e.extra_info)}),value:t}),this.baseCollect(n)):u("401")},e.prototype.destroy=function(){this.event=function(){u("407")},this.action={start:function(){u("407")},end:function(){u("407")}}},e.prototype._checkActionDimension=function(e){if(!e)throw Error("408");void 0===e.extra_info||e.extra_info instanceof Object||v("406")},e}(e);function E(e){this.core=new w(t(t({},e),{sampling:1})),this.eventCollect=new k({core:this.core}),this.action=this.eventCollect.action}return E.prototype.apply=function(e){this.bindWeblogger(e)},E.prototype.bindWeblogger=function(e){this.weblog=e,this.core.bindWeblogger(this.weblog)},E.prototype.event=function(e,t){this.eventCollect.event(e,t)},E.prototype.destroy=function(){var e;null!=(e=this.eventCollect)&&e.destroy()},E.key="radar_krn_plugin",E.version="0.0.1",E});
