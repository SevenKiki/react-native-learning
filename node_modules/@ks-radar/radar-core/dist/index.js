!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@ks-radar/radar-util")):"function"==typeof define&&define.amd?define(["@ks-radar/radar-util"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).radar=t(e.radarUtil)}(this,(function(e){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,o=1,i=arguments.length;o<i;o++)for(var n in t=arguments[o])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},o=["c_dimension1","c_dimension2","c_dimension3","release_tag","product_version","sub_app"];function i(o){var i=this,n=(this.queueConfig={wait:1e3,maxBatchLength:200},this.logQueue=[],this.preStoredLogQueue=[],this.batchTimer=0,this.eventName="onpagehide"in window?"pagehide":"beforeunload",this.customDimension={},this.runtimeIdMap={},this.randomSampling=Math.random(),this.commonDimension={},this.isInYoda=!1,this.sampleData={isHit:!0,core:1},this.ignoreList=["https://web-trace.ksapisrv.com/ktrace/collect"],this.broadcastSample=e.eventFactory(),this.didRate=void 0,this.collect=function(o,n,r){var a=e.deepClone({key:o,dimension:n=void 0===n?{}:n,value:r=void 0===r?{}:r});if(!i.sampleData||!1!==i.sampleData.isHit){if(!e.verify(a))return e.consoleError("107","key: ".concat(a.key)),void i.collect(e.RADAR_KEY.EVENT,{sample_rate:n.sample_rate,message:"radar上报日志类型错误",name:"radar_log_error",extra_info:JSON.stringify(a)},{});Object.keys(a.value).forEach((function(e){a.value[e]=a.value[e].toString()})),i.decorateLog(a);var s=i.getCommonData(),l=s.app_version_name;o=(delete s.app_version_name,new e.MiddlewareManager((function(e,o){e.dimension.app_version_name=l,e.dimension.did_rate=i.didRate;var n=(null==(n=null==e?void 0:e.dimension)?void 0:n.event_client_timestamp)||Date.now(),r=(null==(r=null==e?void 0:e.dimension)?void 0:r.radar_session_id)||i.radarSessionId;return t(t(t({},e),s),{event_client_timestamp:n,event_trigger_source:"H5",radar_session_id:r})})));if(o.use((function(o,n){return o.key&&"load"===o.key&&(o.dimension=t(t({},o.dimension),{load_device_increase_id:e.genDeviceIncreaseId("LOAD_DEVICE_INCREASE_ID"),load_session_increase_id:i.genSessionIncreaseId("LOAD_SESSION_INCREASE_ID")})),o.key&&"load"!==o.key&&(o.dimension=t(t({},o.dimension),{other_device_increase_id:e.genDeviceIncreaseId("OTHER_DEVICE_INCREASE_ID"),other_session_increase_id:i.genSessionIncreaseId("OTHER_SESSION_INCREASE_ID")})),n()})),(a=o.invoke(a))instanceof Error)throw a;try{window.dispatchEvent(new CustomEvent("get-radar-next-data",{detail:{kv:e.deepClone(a)}}))}catch(o){}if(delete a.dimension.broadcast_info,i.weblog?i.logQueue.push(a):(a.base_href=location.href,i.preStoredLogQueue.push(a)),e.radarWarnLog("radarLogNext",JSON.parse(JSON.stringify(a))),i.logQueue.length>i.queueConfig.maxBatchLength-1)return i.flush(),clearTimeout(i.batchTimer),void(i.batchTimer=0);i.batchTimer||(i.batchTimer=window.setTimeout((function(){i.flush(),clearTimeout(i.batchTimer),i.batchTimer=0}),i.queueConfig.wait))}},this.flush=function(){var e;i.logQueue.length<=0||(e=null,(e=i.config.httpReportFirst?e:i.reportByBridge())&&!i.config.httpReportFirst||i.reportByHttp(),i.logQueue=[])},"object"==typeof o&&null!==o||e.throwError("108"),"string"!=typeof o.projectId&&e.throwError("109"),e.storeGet(e.RADAR_SESSION_ID));this.radarSessionId=null!=n?n:e.uuid(),this.config=o,this.sampling="number"==typeof(n=null!=(n=this.config.sampling)?n:1)&&0<=n&&n<=1?n:(e.consoleError("110"),1),this.bindWeblogger(o.weblogger),null!=(n=this.config)&&n.ignoreList&&Array.isArray(null==(o=this.config)?void 0:o.ignoreList)&&(this.ignoreList=this.ignoreList.concat(this.config.ignoreList.map((function(e){return e.replace(/^(https?:)?\/\//,"")})))),this.queueConfig=t(t({},this.queueConfig),null!=(n=this.config)&&n.queueConfig?this.config.queueConfig:{}),null!=(o=this.config)&&o.customDimensions&&this.setDimensions(null==(n=this.config)?void 0:n.customDimensions),e.addMonitor(window,this.eventName,this.flush),"undefined"!=typeof window&&window.yodaCollectErrorDataDestroy&&window.yodaCollectErrorDataDestroy()}return i.prototype.genSessionIncreaseId=function(e){return this.runtimeIdMap[e]||(this.runtimeIdMap[e]=0),this.runtimeIdMap[e]++},i.prototype.bindWeblogger=function(o){var i,n=this;if(null!=o&&"object"!=typeof o)e.throwError("106");else{if(this.weblog)return void e.consoleWarn("122");this.weblog=o,this.updateUrlPackage(),void 0!==(null==(i=null==o?void 0:o.logger)?void 0:i.radarUrl)&&this.ignoreList.push(null==(i=null==o?void 0:o.logger)?void 0:i.radarUrl),void 0!==(null==(i=null==o?void 0:o.logger)?void 0:i.url)&&this.ignoreList.push(null==(i=null==o?void 0:o.logger)?void 0:i.url),this.isInYoda=!(null==(i=null==(o=this.weblog)?void 0:o.Utils)||!i.yoda),this.getSampleData()}0<this.preStoredLogQueue.length&&(this.preStoredLogQueue.forEach((function(o){if(void 0!==(i=n.sampleData["load"===o.key?"core":o.key])&&(o.dimension.sample_rate=i),"load"===o.key?n.sampleData.core:o.dimension.sample_rate*n.sampleData.core>=n.randomSampling){var i=n.getCommonData(),r=(o.dimension.app_version_name=i.app_version_name,o.h5_extra_attr=JSON.stringify(t(t({},null==(i=n.weblog.commonPackage)?void 0:i.getH5ExtraAttr()),JSON.parse(o.h5_extra_attr))),e.getUrlAndQueryFromUrl(o.base_href)),a=null==(i=n.weblog.logConfig)?void 0:i.urlMap;i={};if("function"==typeof a)try{var s=a(r);"string"==typeof s?i={page:s}:"object"==typeof s&&(i={page:s.page,params:s.params})}catch(o){}else if("object"==typeof a){var l,c="";for(l in a)if(-1<(r.page||r.url||"").indexOf(l)){c=a[l];break}c&&(i={page:c})}o.url_package={page:i&&i.page||r.page},s=n.referUrlPackage&&n.referUrlPackage.toJSON(),o.refer_url_package=s,delete o.base_href,n.logQueue.push(o)}})),this.preStoredLogQueue=[],this.flush())},i.prototype.getSampleData=function(){var t,o,i=this;this.isInYoda?(this.sampleData={isHit:!0,core:this.sampling,api:1,resource:.1,error:1,event:1},o=window.updateYodaSampleRateWithParams,window.updateYodaSampleRateWithParams=function(t){e.consoleLog("104",t),i.updateYodaSampleRate(t),i.broadcastSample.emit(i.sampleData),o&&o(t)},window.__yodaCommonDataObject__&&window.__yodaCommonDataObject__.sampleData?(this.updateYodaSampleRate(window.__yodaCommonDataObject__.sampleData),this.collect(e.RADAR_KEY.EVENT,{name:"客户端采样率注入成功",event_type:"radar_sample_inject_success"},{})):"function"==typeof(null==(t=null==(t=null==(t=this.weblog)?void 0:t.Utils)?void 0:t.yoda)?void 0:t.getWebviewLoadPerf)&&null!=(t=this.weblog)&&t.Utils.yoda.getWebviewLoadPerf().then((function(e){null!=e&&e.sampleData&&i.updateYodaSampleRate(e.sampleData)}))):this.sampleData={isHit:this.samplingControl(this.sampling),core:this.sampling}},i.prototype.updateYodaSampleRate=function(t){var o=this,i=null;try{var n=t;i="string"==typeof n?JSON.parse(n):n}catch(t){return void e.consoleLog("error: ",t)}i&&Object.keys(i).forEach((function(e){"load"===e?o.sampleData.core=i[e]:"did_rate"===e?o.didRate=i[e]:o.sampleData[e]=i[e]}))},i.prototype.updateUrlPackage=function(){var e;null!=(e=this.weblog)&&e.currentUrlPackage&&(this.currentUrlPackage=this.weblog.currentUrlPackage,this.referUrlPackage=this.weblog.referUrlPackage)},i.prototype.setDimensions=function(t){var i=this,n=Object.keys(t);n.some((function(e){return-1===o.indexOf(e)}))&&e.consoleError("113","".concat(n.join("、"))),n.forEach((function(e){null==t[e]?delete i.customDimension[e]:i.customDimension[e]=t[e]}))},i.prototype.setCommonDimension=function(e,t,o){this.commonDimension[e]=(o=void 0===o||o)||null==(o=this.commonDimension[e])?t:o},i.prototype.decorateLog=function(e){this.currentUrlPackage||this.updateUrlPackage(),0<Object.keys(this.customDimension).length&&Object.assign(e.dimension,this.customDimension),0<Object.keys(this.commonDimension).length&&Object.assign(e.dimension,this.commonDimension),this.currentUrlPackage&&this.currentUrlPackage.page!==(null==(e=null==(e=this.weblog)?void 0:e.currentUrlPackage)?void 0:e.page)&&(this.flush(),this.updateUrlPackage())},i.prototype.samplingControl=function(e){return null!==e&&"number"==typeof e&&this.randomSampling<e},i.prototype.getCommonData=function(){var o,i=null==(i=null==(i=null==(i=this.weblog)?void 0:i.commonPackage)?void 0:i.app_package)?void 0:i.version_name;i={h5_extra_attr:JSON.stringify(t(t({},null==(o=null==(o=this.weblog)?void 0:o.commonPackage)?void 0:o.getH5ExtraAttr()),{app_version_name:i,url:location.href,hash:location.hash,online:null===navigator||void 0===navigator?void 0:navigator.onLine,downlink:null==(o=null===navigator||void 0===navigator?void 0:navigator.connection)?void 0:o.downlink,rtt:null==(o=null===navigator||void 0===navigator?void 0:navigator.connection)?void 0:o.rtt})),url_package:this.currentUrlPackage&&this.currentUrlPackage.toJSON(),refer_url_package:this.referUrlPackage&&this.referUrlPackage.toJSON(),app_version_name:i,project_id:null==(o=this.config)?void 0:o.projectId};return"1"===e.getSwitchFromCookie("radar_report_test")&&(i.is_report_test=!0),i},i.prototype.reportByHttp=function(){var e=this.getCommonData(),t=(e={project_id:this.config.projectId,radar_session_id:this.radarSessionId,h5_extra_attr:e.h5_extra_attr},this.logQueue.filter((function(e){return"load"===e.key}))),o=this.logQueue.filter((function(e){return"load"!==e.key}));Array.isArray(t)&&t.length&&this.collectLog(e,t,"radarSDK"),Array.isArray(o)&&o.length&&this.collectLog(e,o,"radarSDKSupplement")},i.prototype.collectLog=function(o,i,n){var r;"function"!=typeof(null==(r=this.weblog)?void 0:r.collect)&&"function"!=typeof(null==(r=this.weblog)?void 0:r.sendByHttp)?e.consoleError("114"):(this.weblog.sendByHttp||this.weblog.collect).call(this.weblog,"RADAR",{name:"radar_log",params:t(t({},o),{data:function(e,t,o){if(o||2===arguments.length)for(var i,n=0,r=t.length;n<r;n++)!i&&n in t||((i=i||Array.prototype.slice.call(t,0,n))[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))}([],function(e,t){var o="function"==typeof Symbol&&e[Symbol.iterator];if(!o)return e;var i,n,r=o.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(i=r.next()).done;)a.push(i.value)}catch(e){n={error:e}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(n)throw n.error}}return a}(i),!1)}),serviceName:n})},i.prototype.reportByBridge=function(){var t=null==(i=null==(i=this.weblog)?void 0:i.Utils)?void 0:i.yoda;if(!t)return!1;var o,i=this.logQueue.filter((function(e){return"load"===e.key})),n=this.logQueue.filter((function(e){return"load"!==e.key}));try{return i.forEach((function(o){"function"==typeof(null==(o=t.sendSummarizedLog({key:"h5_load",data:o}))?void 0:o.catch)&&o.catch((function(t){e.consoleError("123",t)}))})),n.length&&"function"==typeof(null==(o=t.sendRadarLog({data:n}))?void 0:o.catch)&&o.catch((function(t){e.consoleError("124",t)})),!0}catch(o){return!1}},i}));
