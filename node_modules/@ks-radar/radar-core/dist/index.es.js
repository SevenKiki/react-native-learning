import{consoleError as e,throwError as t,consoleWarn as i,getUrlAndQueryFromUrl as o,consoleLog as n,RADAR_KEY as a,getSwitchFromCookie as r,eventFactory as s,deepClone as l,verify as c,MiddlewareManager as u,genDeviceIncreaseId as d,radarWarnLog as p,storeGet as g,RADAR_SESSION_ID as h,uuid as m,addMonitor as f}from"@ks-radar/radar-util";var v=function(){return(v=Object.assign||function(e){for(var t,i=1,o=arguments.length;i<o;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function _(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var o,n,a=i.call(e),r=[];try{for(;(void 0===t||0<t--)&&!(o=a.next()).done;)r.push(o.value)}catch(e){n={error:e}}finally{try{o&&!o.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}return r}function y(e,t,i){if(i||2===arguments.length)for(var o,n=0,a=t.length;n<a;n++)!o&&n in t||((o=o||Array.prototype.slice.call(t,0,n))[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))}var b=["c_dimension1","c_dimension2","c_dimension3","release_tag","product_version","sub_app"];var w=function(){function w(i){var o=this,n=(this.queueConfig={wait:1e3,maxBatchLength:200},this.logQueue=[],this.preStoredLogQueue=[],this.batchTimer=0,this.eventName="onpagehide"in window?"pagehide":"beforeunload",this.customDimension={},this.runtimeIdMap={},this.randomSampling=Math.random(),this.commonDimension={},this.isInYoda=!1,this.sampleData={isHit:!0,core:1},this.ignoreList=["https://web-trace.ksapisrv.com/ktrace/collect"],this.broadcastSample=s(),this.didRate=void 0,this.collect=function(t,i,n){var r=l({key:t,dimension:i=void 0===i?{}:i,value:n=void 0===n?{}:n});if(!o.sampleData||!1!==o.sampleData.isHit){if(!c(r))return e("107","key: ".concat(r.key)),void o.collect(a.EVENT,{sample_rate:i.sample_rate,message:"radar上报日志类型错误",name:"radar_log_error",extra_info:JSON.stringify(r)},{});Object.keys(r.value).forEach((function(e){r.value[e]=r.value[e].toString()})),o.decorateLog(r);var s=o.getCommonData(),g=s.app_version_name;t=(delete s.app_version_name,new u((function(e,t){e.dimension.app_version_name=g,e.dimension.did_rate=o.didRate;var i=(null==(i=null==e?void 0:e.dimension)?void 0:i.event_client_timestamp)||Date.now(),n=(null==(n=null==e?void 0:e.dimension)?void 0:n.radar_session_id)||o.radarSessionId;return v(v(v({},e),s),{event_client_timestamp:i,event_trigger_source:"H5",radar_session_id:n})})));if(t.use((function(e,t){return e.key&&"load"===e.key&&(e.dimension=v(v({},e.dimension),{load_device_increase_id:d("LOAD_DEVICE_INCREASE_ID"),load_session_increase_id:o.genSessionIncreaseId("LOAD_SESSION_INCREASE_ID")})),e.key&&"load"!==e.key&&(e.dimension=v(v({},e.dimension),{other_device_increase_id:d("OTHER_DEVICE_INCREASE_ID"),other_session_increase_id:o.genSessionIncreaseId("OTHER_SESSION_INCREASE_ID")})),t()})),(r=t.invoke(r))instanceof Error)throw r;try{window.dispatchEvent(new CustomEvent("get-radar-next-data",{detail:{kv:l(r)}}))}catch(t){}if(delete r.dimension.broadcast_info,o.weblog?o.logQueue.push(r):(r.base_href=location.href,o.preStoredLogQueue.push(r)),p("radarLogNext",JSON.parse(JSON.stringify(r))),o.logQueue.length>o.queueConfig.maxBatchLength-1)return o.flush(),clearTimeout(o.batchTimer),void(o.batchTimer=0);o.batchTimer||(o.batchTimer=window.setTimeout((function(){o.flush(),clearTimeout(o.batchTimer),o.batchTimer=0}),o.queueConfig.wait))}},this.flush=function(){var e;o.logQueue.length<=0||(e=null,(e=o.config.httpReportFirst?e:o.reportByBridge())&&!o.config.httpReportFirst||o.reportByHttp(),o.logQueue=[])},"object"==typeof i&&null!==i||t("108"),"string"!=typeof i.projectId&&t("109"),g(h));this.radarSessionId=null!=n?n:m(),this.config=i,this.sampling=function(t){return"number"==typeof t&&0<=t&&t<=1?t:(e("110"),1)}(null!=(n=this.config.sampling)?n:1),this.bindWeblogger(i.weblogger),null!=(n=this.config)&&n.ignoreList&&Array.isArray(null==(i=this.config)?void 0:i.ignoreList)&&(this.ignoreList=this.ignoreList.concat(this.config.ignoreList.map((function(e){return e.replace(/^(https?:)?\/\//,"")})))),this.queueConfig=v(v({},this.queueConfig),null!=(n=this.config)&&n.queueConfig?this.config.queueConfig:{}),null!=(i=this.config)&&i.customDimensions&&this.setDimensions(null==(n=this.config)?void 0:n.customDimensions),f(window,this.eventName,this.flush),"undefined"!=typeof window&&window.yodaCollectErrorDataDestroy&&window.yodaCollectErrorDataDestroy()}return w.prototype.genSessionIncreaseId=function(e){return this.runtimeIdMap[e]||(this.runtimeIdMap[e]=0),this.runtimeIdMap[e]++},w.prototype.bindWeblogger=function(e){var n,a=this;if(null!=e&&"object"!=typeof e)t("106");else{if(this.weblog)return void i("122");this.weblog=e,this.updateUrlPackage(),void 0!==(null==(n=null==e?void 0:e.logger)?void 0:n.radarUrl)&&this.ignoreList.push(null==(n=null==e?void 0:e.logger)?void 0:n.radarUrl),void 0!==(null==(n=null==e?void 0:e.logger)?void 0:n.url)&&this.ignoreList.push(null==(n=null==e?void 0:e.logger)?void 0:n.url),this.isInYoda=!(null==(n=null==(e=this.weblog)?void 0:e.Utils)||!n.yoda),this.getSampleData()}0<this.preStoredLogQueue.length&&(this.preStoredLogQueue.forEach((function(e){if(void 0!==(t=a.sampleData["load"===e.key?"core":e.key])&&(e.dimension.sample_rate=t),"load"===e.key?a.sampleData.core:e.dimension.sample_rate*a.sampleData.core>=a.randomSampling){var t=a.getCommonData(),i=(e.dimension.app_version_name=t.app_version_name,e.h5_extra_attr=JSON.stringify(v(v({},null==(t=a.weblog.commonPackage)?void 0:t.getH5ExtraAttr()),JSON.parse(e.h5_extra_attr))),o(e.base_href)),n=null==(t=a.weblog.logConfig)?void 0:t.urlMap;t={};if("function"==typeof n)try{var r=n(i);"string"==typeof r?t={page:r}:"object"==typeof r&&(t={page:r.page,params:r.params})}catch(e){}else if("object"==typeof n){var s,l="";for(s in n)if(-1<(i.page||i.url||"").indexOf(s)){l=n[s];break}l&&(t={page:l})}e.url_package={page:t&&t.page||i.page},r=a.referUrlPackage&&a.referUrlPackage.toJSON(),e.refer_url_package=r,delete e.base_href,a.logQueue.push(e)}})),this.preStoredLogQueue=[],this.flush())},w.prototype.getSampleData=function(){var e,t,i=this;this.isInYoda?(this.sampleData={isHit:!0,core:this.sampling,api:1,resource:.1,error:1,event:1},t=window.updateYodaSampleRateWithParams,window.updateYodaSampleRateWithParams=function(e){n("104",e),i.updateYodaSampleRate(e),i.broadcastSample.emit(i.sampleData),t&&t(e)},window.__yodaCommonDataObject__&&window.__yodaCommonDataObject__.sampleData?(this.updateYodaSampleRate(window.__yodaCommonDataObject__.sampleData),this.collect(a.EVENT,{name:"客户端采样率注入成功",event_type:"radar_sample_inject_success"},{})):"function"==typeof(null==(e=null==(e=null==(e=this.weblog)?void 0:e.Utils)?void 0:e.yoda)?void 0:e.getWebviewLoadPerf)&&null!=(e=this.weblog)&&e.Utils.yoda.getWebviewLoadPerf().then((function(e){null!=e&&e.sampleData&&i.updateYodaSampleRate(e.sampleData)}))):this.sampleData={isHit:this.samplingControl(this.sampling),core:this.sampling}},w.prototype.updateYodaSampleRate=function(e){var t=this,i=null;try{var o=e;i="string"==typeof o?JSON.parse(o):o}catch(e){return void n("error: ",e)}i&&Object.keys(i).forEach((function(e){"load"===e?t.sampleData.core=i[e]:"did_rate"===e?t.didRate=i[e]:t.sampleData[e]=i[e]}))},w.prototype.updateUrlPackage=function(){var e;null!=(e=this.weblog)&&e.currentUrlPackage&&(this.currentUrlPackage=this.weblog.currentUrlPackage,this.referUrlPackage=this.weblog.referUrlPackage)},w.prototype.setDimensions=function(t){var i=this,o=Object.keys(t);o.some((function(e){return-1===b.indexOf(e)}))&&e("113","".concat(o.join("、"))),o.forEach((function(e){null==t[e]?delete i.customDimension[e]:i.customDimension[e]=t[e]}))},w.prototype.setCommonDimension=function(e,t,i){this.commonDimension[e]=(i=void 0===i||i)||null==(i=this.commonDimension[e])?t:i},w.prototype.decorateLog=function(e){this.currentUrlPackage||this.updateUrlPackage(),0<Object.keys(this.customDimension).length&&Object.assign(e.dimension,this.customDimension),0<Object.keys(this.commonDimension).length&&Object.assign(e.dimension,this.commonDimension),this.currentUrlPackage&&this.currentUrlPackage.page!==(null==(e=null==(e=this.weblog)?void 0:e.currentUrlPackage)?void 0:e.page)&&(this.flush(),this.updateUrlPackage())},w.prototype.samplingControl=function(e){return null!==e&&"number"==typeof e&&this.randomSampling<e},w.prototype.getCommonData=function(){var e,t=null==(t=null==(t=null==(t=this.weblog)?void 0:t.commonPackage)?void 0:t.app_package)?void 0:t.version_name;t={h5_extra_attr:JSON.stringify(v(v({},null==(e=null==(e=this.weblog)?void 0:e.commonPackage)?void 0:e.getH5ExtraAttr()),{app_version_name:t,url:location.href,hash:location.hash,online:null===navigator||void 0===navigator?void 0:navigator.onLine,downlink:null==(e=null===navigator||void 0===navigator?void 0:navigator.connection)?void 0:e.downlink,rtt:null==(e=null===navigator||void 0===navigator?void 0:navigator.connection)?void 0:e.rtt})),url_package:this.currentUrlPackage&&this.currentUrlPackage.toJSON(),refer_url_package:this.referUrlPackage&&this.referUrlPackage.toJSON(),app_version_name:t,project_id:null==(e=this.config)?void 0:e.projectId};return"1"===r("radar_report_test")&&(t.is_report_test=!0),t},w.prototype.reportByHttp=function(){var e=this.getCommonData(),t=(e={project_id:this.config.projectId,radar_session_id:this.radarSessionId,h5_extra_attr:e.h5_extra_attr},this.logQueue.filter((function(e){return"load"===e.key}))),i=this.logQueue.filter((function(e){return"load"!==e.key}));Array.isArray(t)&&t.length&&this.collectLog(e,t,"radarSDK"),Array.isArray(i)&&i.length&&this.collectLog(e,i,"radarSDKSupplement")},w.prototype.collectLog=function(t,i,o){var n;"function"!=typeof(null==(n=this.weblog)?void 0:n.collect)&&"function"!=typeof(null==(n=this.weblog)?void 0:n.sendByHttp)?e("114"):(this.weblog.sendByHttp||this.weblog.collect).call(this.weblog,"RADAR",{name:"radar_log",params:v(v({},t),{data:y([],_(i),!1)}),serviceName:o})},w.prototype.reportByBridge=function(){var t=null==(o=null==(o=this.weblog)?void 0:o.Utils)?void 0:o.yoda;if(!t)return!1;var i,o=this.logQueue.filter((function(e){return"load"===e.key})),n=this.logQueue.filter((function(e){return"load"!==e.key}));try{return o.forEach((function(i){"function"==typeof(null==(i=t.sendSummarizedLog({key:"h5_load",data:i}))?void 0:i.catch)&&i.catch((function(t){e("123",t)}))})),n.length&&"function"==typeof(null==(i=t.sendRadarLog({data:n}))?void 0:i.catch)&&i.catch((function(t){e("124",t)})),!0}catch(i){return!1}},w}();export{w as default};
