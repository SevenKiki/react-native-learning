!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("@ks-radar/radar-util")):"function"==typeof define&&define.amd?define(["@ks-radar/radar-util"],r):(e="undefined"!=typeof globalThis?globalThis:e||self).radar=r(e.radarUtil)}(this,(function(e){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])})(e,t)},t=function(){return(t=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)},n=Object.assign({},e.BASE_PER_MAP,{duration:{end:"responseEnd",start:"fetchStart"},cached_type:{custom:function(e,r){var t="hit_browser";if(0===r.transferSize||0===r.duration)return t;if(null==r.transferSize&&(0===r.domainLookupStart||r.responseStart===r.fetchStart))return t;if(r.serverTiming&&r.serverTiming.some((function(e){return"cdn"===e.name}))){if(r.serverTiming.some((function(e){return"miss"===e.name})))return"miss_cdn";if(r.serverTiming.some((function(e){return"hit"===e.name})))return"hit_cdn"}return"miss_browser"},crossOriginSkip:!0},cdn_duration:{custom:function(e,r){return r.serverTiming&&r.serverTiming.some((function(e){return"cdn"===e.name}))?null==(r=null==(r=r.serverTiming)?void 0:r.find((function(e){return"total-timing"===e.name})))?void 0:r.duration:null},crossOriginSkip:!0,cachedSkip:!0},cdn_ip:{custom:function(e,r){if(r.serverTiming&&r.serverTiming.some((function(e){return"cdn"===e.name})))return null==(r=r.serverTiming.find((function(e){return"miss"===e.name||"hit"===e.name})))?void 0:r.description},crossOriginSkip:!0,cachedSkip:!0}}),o={fetch_start_time:"fetchStart",redirect_start:"redirectStart",redirect_end:"redirectEnd",dns_start:"domainLookupStart",dns_end:"domainLookupEnd",connect_start:"connectStart",connect_end:"connectEnd",ssl_start:"secureConnectionStart",request_start:"requestStart",response_start:"responseStart",response_end:"responseEnd"},i=e.BaseCollect,s=u,c=i;if("function"!=typeof c&&null!==c)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");function a(){this.constructor=s}function u(r){var s,c=this;return(c=i.call(this,{core:null==r?void 0:r.core,sampling:null!=(s=null==r?void 0:r.sampling)?s:.1,version:"1.2.5",key:e.RADAR_KEY.RES,name:"RadarResourceCollect"})||this).ignoreList=e.DEFAULT_IGNORE_LIST,c.broadcastJs=e.eventFactory(),c.onResError=function(r,t){var n;e.isScriptError(r)||(n=(r.target.src||r.target.href||"").toString(),r={failed:!0,file:n="function"!=typeof r.target.getAttribute||""!==r.target.getAttribute("src")&&""!==r.target.getAttribute("href")?n:"",res_path:(n=r&&r.path||r&&r.composedPath&&r.composedPath(),Array.isArray(n)?n.map((function(e){var r=void 0===(r=e.tagName)?"":r,t=e.id;e=e.getAttribute?e.getAttribute("class"):e.className||"",r=r.toLowerCase();return t&&(r+="#".concat(t)),e&&(r+=e.split(/\s+/g).map((function(e){return".".concat(e)})).join("")),r})).filter((function(e){return e})).join(","):"")},c.collect(r,t),c.broadcastJs.emit(r))},c.observeResource=function(r){r.getEntriesByType("resource").forEach((function(r){var i,s,a;if(0===r.name.indexOf("data:")||e.isInUrlList(r.name,c.ignoreList)||e.isInUrlList(r.name,(null==(i=c.core)?void 0:i.ignoreList)||[]))return!1;"resource"===e.getPerformanceObserverEntryType(r)&&(i=e.perfMapTiming(n,r),s={encoded_body_size:r.encodedBodySize,decoded_body_size:r.decodedBodySize},Object.keys(o).forEach((function(e){s[e]=Number(r[o[e]]+performance.timing.navigationStart)})),a=t(t({failed:!1},i),s),c.collect(a),setTimeout((function(){c.broadcastJs.emit(a)})))}))},c.resourceHook=r.resourceHook,void 0!==r.ignoreList&&(Array.isArray(r.ignoreList)||e.throwError("802"),r.ignoreList.forEach((function(r){"string"!=typeof r&&e.throwError("802")})),c.ignoreList=c.ignoreList.concat(r.ignoreList)),c.init(),c}return r(s,c),s.prototype=null===c?Object.create(c):(a.prototype=c.prototype,new a),u.prototype.init=function(){var r,t=this;try{this.observeResource(performance),this.observer=new PerformanceObserver((function(e){return t.observeResource(e)})),this.observer.observe({entryTypes:["resource"]})}catch(t){e.consoleError("801"),null!=(r=this.core)&&r.collect("event",{name:"radar_error",message:"PerformanceObserver 不存在无法收集数据",category:e.RADAR_KEY.RES})}e.addMonitor(window,"error",(function(e){return t.onResError(e)}),!0),this.parseSeedLog()},u.prototype.parseSeedLog=function(){var r=this,t=e.storeGet(e.RESOURCE_ERROR_QUEUE,[]);t.length&&(t.map((function(e){var t=e.data;e=e.dimension||{};r.onResError(t,e)})),e.storeSet(e.RESOURCE_ERROR_QUEUE,[]))},u.prototype.collect=function(r,n){var o=r.cached,i=r.failed,s=r.file,c=r.protocol,a=r.res_type,u=r.res_path,d=r.cached_type,l=r.cdn_ip,f=r.has_timing_allow;r=function(e,r){var t={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&r.indexOf(o)<0&&(t[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,o=Object.getOwnPropertySymbols(e);n<o.length;n++)r.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(t[o[n]]=e[o[n]]);return t}(r,["cached","failed","file","protocol","res_type","res_path","cached_type","cdn_ip","has_timing_allow"]);try{var p=this.resourceHook&&this.resourceHook({file:s,cached:o,protocol:c,res_type:a,failed:i});if(null!=p&&p.intercept_report)return}catch(r){e.consoleError("803",r)}this.baseCollect({value:r,dimension:t({cached:o,failed:i,file:s,protocol:c,res_type:a,res_path:u,sample_rate:this.sampling,is_official:1,cached_type:d,cdn_ip:l,has_timing_allow:f},n)})},u.prototype.destroy=function(){this.isHit&&(e.removeMonitor(window,"error",this.onResError,!0),this.observer&&this.observer.disconnect())},u}));
