import{BASE_PER_MAP as e,consoleError as r,RADAR_KEY as t,addMonitor as n,storeGet as o,RESOURCE_ERROR_QUEUE as i,storeSet as s,removeMonitor as c,DEFAULT_IGNORE_LIST as a,eventFactory as u,isScriptError as d,isInUrlList as f,getPerformanceObserverEntryType as l,perfMapTiming as p,throwError as m,BaseCollect as h}from"@ks-radar/radar-util";var g=function(e,r){return(g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])})(e,r)};var _=function(){return(_=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};var y=Object.assign({},e,{duration:{end:"responseEnd",start:"fetchStart"},cached_type:{custom:function(e,r){var t="hit_browser";if(0===r.transferSize||0===r.duration)return t;if(null==r.transferSize&&(0===r.domainLookupStart||r.responseStart===r.fetchStart))return t;if(r.serverTiming&&r.serverTiming.some((function(e){return"cdn"===e.name}))){if(r.serverTiming.some((function(e){return"miss"===e.name})))return"miss_cdn";if(r.serverTiming.some((function(e){return"hit"===e.name})))return"hit_cdn"}return"miss_browser"},crossOriginSkip:!0},cdn_duration:{custom:function(e,r){return r.serverTiming&&r.serverTiming.some((function(e){return"cdn"===e.name}))?null==(r=null==(r=r.serverTiming)?void 0:r.find((function(e){return"total-timing"===e.name})))?void 0:r.duration:null},crossOriginSkip:!0,cachedSkip:!0},cdn_ip:{custom:function(e,r){if(r.serverTiming&&r.serverTiming.some((function(e){return"cdn"===e.name})))return null==(r=r.serverTiming.find((function(e){return"miss"===e.name||"hit"===e.name})))?void 0:r.description},crossOriginSkip:!0,cachedSkip:!0}}),v={fetch_start_time:"fetchStart",redirect_start:"redirectStart",redirect_end:"redirectEnd",dns_start:"domainLookupStart",dns_end:"domainLookupEnd",connect_start:"connectStart",connect_end:"connectEnd",ssl_start:"secureConnectionStart",request_start:"requestStart",response_start:"responseStart",response_end:"responseEnd"};function b(e){return Array.isArray(e)?e.map((function(e){var r=void 0===(r=e.tagName)?"":r,t=e.id;e=e.getAttribute?e.getAttribute("class"):e.className||"",r=r.toLowerCase();return t&&(r+="#".concat(t)),e&&(r+=e.split(/\s+/g).map((function(e){return".".concat(e)})).join("")),r})).filter((function(e){return e})).join(","):""}var S=function(e){function h(r){var n,o=this;return(o=e.call(this,{core:null==r?void 0:r.core,sampling:null!=(n=null==r?void 0:r.sampling)?n:.1,version:"1.2.5",key:t.RES,name:"RadarResourceCollect"})||this).ignoreList=a,o.broadcastJs=u(),o.onResError=function(e,r){var t;d(e)||(t=(e.target.src||e.target.href||"").toString(),t={failed:!0,file:t="function"!=typeof e.target.getAttribute||""!==e.target.getAttribute("src")&&""!==e.target.getAttribute("href")?t:"",res_path:b(e&&e.path||e&&e.composedPath&&e.composedPath())},o.collect(t,r),o.broadcastJs.emit(t))},o.observeResource=function(e){e.getEntriesByType("resource").forEach((function(e){var r,t,n;if(0===e.name.indexOf("data:")||f(e.name,o.ignoreList)||f(e.name,(null==(r=o.core)?void 0:r.ignoreList)||[]))return!1;"resource"===l(e)&&(r=p(y,e),t={encoded_body_size:e.encodedBodySize,decoded_body_size:e.decodedBodySize},Object.keys(v).forEach((function(r){t[r]=Number(e[v[r]]+performance.timing.navigationStart)})),n=_(_({failed:!1},r),t),o.collect(n),setTimeout((function(){o.broadcastJs.emit(n)})))}))},o.resourceHook=r.resourceHook,void 0!==r.ignoreList&&(Array.isArray(r.ignoreList)||m("802"),r.ignoreList.forEach((function(e){"string"!=typeof e&&m("802")})),o.ignoreList=o.ignoreList.concat(r.ignoreList)),o.init(),o}return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function t(){this.constructor=e}g(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}(h,e),h.prototype.init=function(){var e,o=this;try{this.observeResource(performance),this.observer=new PerformanceObserver((function(e){return o.observeResource(e)})),this.observer.observe({entryTypes:["resource"]})}catch(n){r("801"),null!=(e=this.core)&&e.collect("event",{name:"radar_error",message:"PerformanceObserver 不存在无法收集数据",category:t.RES})}n(window,"error",(function(e){return o.onResError(e)}),!0),this.parseSeedLog()},h.prototype.parseSeedLog=function(){var e=this,r=o(i,[]);r.length&&(r.map((function(r){var t=r.data;r=r.dimension||{};e.onResError(t,r)})),s(i,[]))},h.prototype.collect=function(e,t){var n=e.cached,o=e.failed,i=e.file,s=e.protocol,c=e.res_type,a=e.res_path,u=e.cached_type,d=e.cdn_ip,f=e.has_timing_allow;e=function(e,r){var t={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&r.indexOf(o)<0&&(t[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,o=Object.getOwnPropertySymbols(e);n<o.length;n++)r.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(t[o[n]]=e[o[n]]);return t}(e,["cached","failed","file","protocol","res_type","res_path","cached_type","cdn_ip","has_timing_allow"]);try{var l=this.resourceHook&&this.resourceHook({file:i,cached:n,protocol:s,res_type:c,failed:o});if(null!=l&&l.intercept_report)return}catch(e){r("803",e)}this.baseCollect({value:e,dimension:_({cached:n,failed:o,file:i,protocol:s,res_type:c,res_path:a,sample_rate:this.sampling,is_official:1,cached_type:u,cdn_ip:d,has_timing_allow:f},t)})},h.prototype.destroy=function(){this.isHit&&(c(window,"error",this.onResError,!0),this.observer&&this.observer.disconnect())},h}(h);export{S as default};
