import{navigationTiming as t,addMonitor as e,consoleError as n,throwError as i,consoleWarn as a,deepClone as r,perfMapTiming as o,removeMonitor as s,RADAR_KEY as c,BaseCollect as m}from"@ks-radar/radar-util";var d=function(t,e){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};var p=function(){return(p=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)};function l(t,e){var n={};for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&e.indexOf(a)<0&&(n[a]=t[a]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,a=Object.getOwnPropertySymbols(t);i<a.length;i++)e.indexOf(a[i])<0&&Object.prototype.propertyIsEnumerable.call(t,a[i])&&(n[a[i]]=t[a[i]]);return n}var u={redirect:{end:"redirectEnd",start:"redirectStart"},dns:{end:"domainLookupEnd",start:"domainLookupStart"},dns_start:{end:"domainLookupEnd",start:"navigationStart"},tcp:{end:"connectEnd",start:"connectStart"},tcp_start:{end:"connectEnd",start:"navigationStart"},redirect_count:{custom:function(t,e){return e.redirectCount}},ssl:{custom:function(t,e){return e.connectEnd&&e.secureConnectionStart?e.connectEnd-e.secureConnectionStart:null}},ssl_start:{custom:function(t,e){return e.secureConnectionStart&&e.navigationStart?e.secureConnectionStart-e.navigationStart:null}},ttfb:{end:"responseStart",start:"requestStart"},request_start:{end:"requestStart",start:"navigationStart"},trans:{end:"responseEnd",start:"responseStart"},dom_parse:{end:"domInteractive",start:"responseEnd"},dom_parse_start:{end:"domInteractive",start:"navigationStart"},blank:{end:"domLoading",start:"navigationStart"},fb:{end:"responseStart",start:"navigationStart"},dom_ready:{end:"domContentLoadedEventEnd",start:"navigationStart"},total:{end:"loadEventStart",start:"navigationStart"},resource:{end:"loadEventStart",start:"domInteractive"},fp:{custom:function(){if("function"!=typeof performance.getEntries)return null;var t=performance.getEntries().filter((function(t){return"first-paint"===t.name}))[0];return t?Math.ceil(t.startTime+t.duration):null}},js_cost:{custom:function(){if("function"!=typeof performance.getEntries)return null;var e=t(),n=performance.getEntries(),i=performance.getEntries().filter((function(t){return"navigation"===t.initiatorType}))[0];n=n.filter((function(t){return"script"===t.initiatorType}))[0],i=i?i.domComplete:e.domComplete-e.navigationStart;return n&&i?i-n.fetchStart:null}},tti:{end:"domInteractive",start:"navigationStart"},protocol:{custom:function(t,e){return e.nextHopProtocol}},dom_num:{custom:function(){return"undefined"!=typeof document&&void 0!==document.all?document.all.length:null}}},f={main_api:{end:"apiEnd",start:"apiStart",notCatchIfUndefined:!0},main_api_offset:{end:"apiStart",start:"responseEnd",notCatchIfUndefined:!0},fmp:{end:"fmp_time",start:"navigationStart",notCatchIfUndefined:!0}},_={navigation_start_time:"navigationStart",fetch_start_time:"fetchStart",dns_start_time:"domainLookupStart",dns_end_time:"domainLookupEnd",connect_start_time:"connectStart",ssl_start_time:"secureConnectionStart",request_start_time:"requestStart",response_start_time:"responseStart",response_end_time:"responseEnd",dom_interactive_time:"domInteractive",dom_loading_time:"domLoading",dom_ready_time:"domContentLoadedEventEnd",load_event_time:"loadEventStart",connect_end_time:"connectEnd",load_event_end:"loadEventEnd",dom_complete:"domComplete",dom_content_loaded_event_start:"domContentLoadedEventStart",redirect_start:"redirectStart",redirect_end:"redirectEnd",radar_init_time:"radar_init_time",fmp_time:"fmp_time"};function h(t,e){if(!Array.isArray(e))return-1;var n=-1;return e.forEach((function(e,i){new RegExp(e).test(t)&&(n=i)})),n}var v=function(t){function m(e){var r=this;return(r=t.call(this,{core:null==e?void 0:e.core,key:c.LOAD,version:"1.2.5",name:"RadarNavigationCollect"})||this).hasFMP=!1,r.syncMetricNum=0,r.customKeys=[],r.custom_metric={},r.optionsMainAPI=[],r.mainAPIList=[],r.radarMainApiList=[],r.mainJSList=[],r.radarMainJSList=[],r.radarTiming={radar_init_time:void 0,fmp_time:void 0,fmp:void 0,apiStart:void 0,apiEnd:void 0},r.h5Load=function(){var t=r.getPerformanceData();r.collect(p({event_name:"h5_load"},t))},r.dealAPI=function(t){return r.cacheAndCalculateMainAPI(t),r.addMainApiResult(t),r.mainAPIList.filter((function(t){return!!t.url})).length!==r.mainAPIList.length||void 0===r.radarTiming.fmp},r.addMainJSResult=function(t){if(!r.mainJSList||0===r.mainJSList.length)return!1;var e,n,i,a,o,s,c,m,d,p,l,u,f,_,v,g=h((t.file||"").replace(/\?.+$/,""),r.mainJSList);return-1<g&&!r.radarMainJSList[g].file&&(e=t.file,n=t.cached,i=t.size,a=t.failed,o=t.res_type,s=t.protocol,c=t.fb,m=t.dns,d=t.tcp,p=t.ssl,l=t.ttfb,u=t.trans,f=t.total,_=t.fetch_start,v=t.duration,t=t.start_time,r.radarMainJSList[g]={file:e,cached:n,size:i,failed:a,res_type:o,protocol:s,fb:c,dns:m,tcp:d,ssl:p,ttfb:l,trans:u,total:f,fetch_start:_,duration:v,start_time:t,reg:r.mainJSList[g]}),r.radarMainJSList.filter((function(t){return!!t.file})).length!==r.mainJSList.length},e.core||i("212"),"string"==typeof e.mainApi?(r.optionsMainAPI.push(e.mainApi),r.mainAPIList.push({}),r.radarMainApiList.push({})):Array.isArray(e.mainApi)&&(e.mainApi.length>3&&a("207"),r.optionsMainAPI=e.mainApi.slice(0,3),r.optionsMainAPI.forEach((function(){r.mainAPIList.push({}),r.radarMainApiList.push({})}))),"string"==typeof e.mainJs?(r.mainJSList.push(e.mainJs),r.radarMainJSList.push({})):Array.isArray(e.mainJs)&&(e.mainJs.length>3&&a("211"),r.mainJSList=e.mainJs.slice(0,3),r.mainJSList.forEach((function(){return r.radarMainJSList.push({})}))),performance.timing?r.init():(null!=(e=r.core)&&e.collect("event",{name:"radar_error",message:"performance.timing 不存在无法收集数据",category:c.LOAD}),n("208")),r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}d(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(m,t),m.prototype.init=function(){this.radarTiming.radar_init_time=Date.now();var t,n=this.getPerformanceData();this.collect(p({event_name:"radar_init"},n)),null!=(t=null==(n=this.core)?void 0:n.setCommonDimension)&&t.call(n,"happen_stage","during_fmp"),0<performance.timing.loadEventStart?this.h5Load():e(window,"load",this.h5Load)},m.prototype.customStage=function(t,e){var a,r;void 0===e&&(e={sendTimeline:!0}),this.isHit?(void 0!==t&&"string"==typeof t&&""!==t||i("206"),this.isValidTimestamp(e.timestamp,"custom_stage "+t)&&(a=e.timestamp||Date.now(),r=this.customKeys.length-this.syncMetricNum,this.customKeys.includes(t)?n("204",t):e.sendTimeline&&2<this.syncMetricNum||!e.sendTimeline&&5<r?n("205",t):a&&(this.custom_metric[t+"_time"]=a,this.customKeys.push(t),!e||!0!==e.sendTimeline&&null!=e.sendTimeline||(r=this.getPerformanceData(),this.collect(p(p({},r),{stack:(new Error).stack,event_name:"h5_custom_metric",custom_metric_name:t,custom_metric_timestamp:a})),this.syncMetricNum++)))):n("200")},m.prototype.isValidTimestamp=function(t,e){var n;if(void 0===e&&(e="fmp"),void 0!==t&&"number"!=typeof t)i("201");else if(void 0!==t&&t<performance.timing.navigationStart)return a("210","".concat(e)),null!=(n=this.core)&&n.collect("event",{name:"radar_error",message:"【210】".concat(e),extra_info:{timestamp:t,navigationStart:performance.timing.navigationStart}}),!1;return!0},m.prototype.fmp=function(t){var e,n;this.isHit?this.isValidTimestamp(t)&&(t=t||Date.now(),this.hasFMP?a("202"):t&&performance.timing&&(null!=(n=null==(e=this.core)?void 0:e.setCommonDimension)&&n.call(e,"happen_stage","after_fmp"),this.hasFMP=!0,this.radarTiming.fmp_time=t,performance.timing.radarFmp=t,n=this.getPerformanceData(),performance.timing.fmp=this.radarTiming.fmp=n.fmp,this.collect(p({event_name:"fmp",stack:(new Error).stack},n)))):a("200")},m.prototype.getPerformanceData=function(){var t=p(p({},r(performance.timing)),this.radarTiming),e=o(p(p({},u),f),t);return Object.keys(_).forEach((function(n){0<=t[_[n]]&&(e[n]=t[_[n]])})),["radar_main_js_start","lcp","cls","fid","fcp"].forEach((function(t){var n=window.__RADAR_PERFORMANCE_TIMING_&&window.__RADAR_PERFORMANCE_TIMING_[t];!n&&0!==n||(e[t]=n)})),e},m.prototype.cacheAndCalculateMainAPI=function(t){var e;void 0===this.radarTiming.fmp&&(t.before_hook_time&&(e=this.radarTiming.apiStart,this.radarTiming.apiStart=e?Math.min(e,t.before_hook_time):t.before_hook_time),t.after_hook_time&&(e=this.radarTiming.apiEnd,this.radarTiming.apiEnd=e?Math.max(e,t.after_hook_time):t.after_hook_time))},m.prototype.addMainApiResult=function(t){var e,n,i,a,r,o,s,c,m,d,u,f,_,v,g,S,y,E,A=h((t.api||"").replace(/\?.+$/,""),this.optionsMainAPI);-1<A&&(null==(E=this.mainAPIList[A])||!E.url)&&(E=t.api,e=t.status,n=t.size,i=t.cached,a=t.method,c=t.perfTime,r=t.protocol,o=t.custom_failed,s=t.res_type,y=l(t,["api","status","size","cached","method","perfTime","protocol","custom_failed","res_type"]),this.mainAPIList[A]=p({url:E,status:e,size_radar:n,cached:i,method:a,perfTime:c,protocol:r,res_type:s,custom_failed:o},y),c=y.fb,m=y.dns,d=y.tcp,u=y.ssl,f=y.ttfb,_=y.trans,v=y.total,g=y.fetch_start,S=y.duration,y=y.start_time,this.radarMainApiList[A]={api:E,status:e,size:n,cached:i,method:a,protocol:r,fb:c,dns:m,tcp:d,ssl:u,ttfb:f,trans:_,total:v,fetch_start:g,duration:S,custom_failed:o,res_type:s,reg:this.optionsMainAPI[A],start_time:y},this.radarTiming.fmp_time&&t.after_hook_time&&t.after_hook_time<this.radarTiming.fmp_time&&(E=this.getPerformanceData(),this.collect(p({event_name:"main_api"},E))))},m.prototype.destroy=function(){s(window,"load",this.h5Load),this.customStage=this.fmp=function(){a("213")}},m.prototype.collect=function(t){var e=t.protocol,n=t.event_name,i=(t.custom_metric,t.custom_metric_name),a=t.stack;t.main_api_list,t=l(t,["protocol","event_name","custom_metric","custom_metric_name","stack","main_api_list"]);this.baseCollect({value:t,dimension:{protocol:e,event_name:n,custom_metric_name:i,custom_metric:JSON.stringify(this.custom_metric),main_api_list:this.mainAPIList,radar_main_api_list:this.radarMainApiList,radar_main_js_list:this.radarMainJSList,is_official:1,stack:a}}),null!=(t=this.core)&&t.flush()},m}(m);export{v as default};
