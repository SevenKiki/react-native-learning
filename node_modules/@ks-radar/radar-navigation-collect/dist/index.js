!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@ks-radar/radar-util")):"function"==typeof define&&define.amd?define(["@ks-radar/radar-util"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).radar=e(t.radarUtil)}(this,(function(t){"use strict";var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,n)},n=function(){return(n=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function i(t,e){var n={};for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]]);return n}var r={redirect:{end:"redirectEnd",start:"redirectStart"},dns:{end:"domainLookupEnd",start:"domainLookupStart"},dns_start:{end:"domainLookupEnd",start:"navigationStart"},tcp:{end:"connectEnd",start:"connectStart"},tcp_start:{end:"connectEnd",start:"navigationStart"},redirect_count:{custom:function(t,e){return e.redirectCount}},ssl:{custom:function(t,e){return e.connectEnd&&e.secureConnectionStart?e.connectEnd-e.secureConnectionStart:null}},ssl_start:{custom:function(t,e){return e.secureConnectionStart&&e.navigationStart?e.secureConnectionStart-e.navigationStart:null}},ttfb:{end:"responseStart",start:"requestStart"},request_start:{end:"requestStart",start:"navigationStart"},trans:{end:"responseEnd",start:"responseStart"},dom_parse:{end:"domInteractive",start:"responseEnd"},dom_parse_start:{end:"domInteractive",start:"navigationStart"},blank:{end:"domLoading",start:"navigationStart"},fb:{end:"responseStart",start:"navigationStart"},dom_ready:{end:"domContentLoadedEventEnd",start:"navigationStart"},total:{end:"loadEventStart",start:"navigationStart"},resource:{end:"loadEventStart",start:"domInteractive"},fp:{custom:function(){if("function"!=typeof performance.getEntries)return null;var t=performance.getEntries().filter((function(t){return"first-paint"===t.name}))[0];return t?Math.ceil(t.startTime+t.duration):null}},js_cost:{custom:function(){if("function"!=typeof performance.getEntries)return null;var e=t.navigationTiming(),n=performance.getEntries(),i=performance.getEntries().filter((function(t){return"navigation"===t.initiatorType}))[0];n=n.filter((function(t){return"script"===t.initiatorType}))[0],i=i?i.domComplete:e.domComplete-e.navigationStart;return n&&i?i-n.fetchStart:null}},tti:{end:"domInteractive",start:"navigationStart"},protocol:{custom:function(t,e){return e.nextHopProtocol}},dom_num:{custom:function(){return"undefined"!=typeof document&&void 0!==document.all?document.all.length:null}}},a={main_api:{end:"apiEnd",start:"apiStart",notCatchIfUndefined:!0},main_api_offset:{end:"apiStart",start:"responseEnd",notCatchIfUndefined:!0},fmp:{end:"fmp_time",start:"navigationStart",notCatchIfUndefined:!0}},o={navigation_start_time:"navigationStart",fetch_start_time:"fetchStart",dns_start_time:"domainLookupStart",dns_end_time:"domainLookupEnd",connect_start_time:"connectStart",ssl_start_time:"secureConnectionStart",request_start_time:"requestStart",response_start_time:"responseStart",response_end_time:"responseEnd",dom_interactive_time:"domInteractive",dom_loading_time:"domLoading",dom_ready_time:"domContentLoadedEventEnd",load_event_time:"loadEventStart",connect_end_time:"connectEnd",load_event_end:"loadEventEnd",dom_complete:"domComplete",dom_content_loaded_event_start:"domContentLoadedEventStart",redirect_start:"redirectStart",redirect_end:"redirectEnd",radar_init_time:"radar_init_time",fmp_time:"fmp_time"};function s(t,e){if(!Array.isArray(e))return-1;var n=-1;return e.forEach((function(e,i){new RegExp(e).test(t)&&(n=i)})),n}var c=t.BaseCollect,m=l,d=c;if("function"!=typeof d&&null!==d)throw new TypeError("Class extends value "+String(d)+" is not a constructor or null");function p(){this.constructor=m}function l(e){var i=this;return(i=c.call(this,{core:null==e?void 0:e.core,key:t.RADAR_KEY.LOAD,version:"1.2.5",name:"RadarNavigationCollect"})||this).hasFMP=!1,i.syncMetricNum=0,i.customKeys=[],i.custom_metric={},i.optionsMainAPI=[],i.mainAPIList=[],i.radarMainApiList=[],i.mainJSList=[],i.radarMainJSList=[],i.radarTiming={radar_init_time:void 0,fmp_time:void 0,fmp:void 0,apiStart:void 0,apiEnd:void 0},i.h5Load=function(){var t=i.getPerformanceData();i.collect(n({event_name:"h5_load"},t))},i.dealAPI=function(t){return i.cacheAndCalculateMainAPI(t),i.addMainApiResult(t),i.mainAPIList.filter((function(t){return!!t.url})).length!==i.mainAPIList.length||void 0===i.radarTiming.fmp},i.addMainJSResult=function(t){if(!i.mainJSList||0===i.mainJSList.length)return!1;var e,n,r,a,o,c,m,d,p,l,u,f,_,h,g,v=s((t.file||"").replace(/\?.+$/,""),i.mainJSList);return-1<v&&!i.radarMainJSList[v].file&&(e=t.file,n=t.cached,r=t.size,a=t.failed,o=t.res_type,c=t.protocol,m=t.fb,d=t.dns,p=t.tcp,l=t.ssl,u=t.ttfb,f=t.trans,_=t.total,h=t.fetch_start,g=t.duration,t=t.start_time,i.radarMainJSList[v]={file:e,cached:n,size:r,failed:a,res_type:o,protocol:c,fb:m,dns:d,tcp:p,ssl:l,ttfb:u,trans:f,total:_,fetch_start:h,duration:g,start_time:t,reg:i.mainJSList[v]}),i.radarMainJSList.filter((function(t){return!!t.file})).length!==i.mainJSList.length},e.core||t.throwError("212"),"string"==typeof e.mainApi?(i.optionsMainAPI.push(e.mainApi),i.mainAPIList.push({}),i.radarMainApiList.push({})):Array.isArray(e.mainApi)&&(3<e.mainApi.length&&t.consoleWarn("207"),i.optionsMainAPI=e.mainApi.slice(0,3),i.optionsMainAPI.forEach((function(){i.mainAPIList.push({}),i.radarMainApiList.push({})}))),"string"==typeof e.mainJs?(i.mainJSList.push(e.mainJs),i.radarMainJSList.push({})):Array.isArray(e.mainJs)&&(3<e.mainJs.length&&t.consoleWarn("211"),i.mainJSList=e.mainJs.slice(0,3),i.mainJSList.forEach((function(){return i.radarMainJSList.push({})}))),performance.timing?i.init():(null!=(e=i.core)&&e.collect("event",{name:"radar_error",message:"performance.timing 不存在无法收集数据",category:t.RADAR_KEY.LOAD}),t.consoleError("208")),i}return e(m,d),m.prototype=null===d?Object.create(d):(p.prototype=d.prototype,new p),l.prototype.init=function(){this.radarTiming.radar_init_time=Date.now();var e,i=this.getPerformanceData();this.collect(n({event_name:"radar_init"},i)),null!=(e=null==(i=this.core)?void 0:i.setCommonDimension)&&e.call(i,"happen_stage","during_fmp"),0<performance.timing.loadEventStart?this.h5Load():t.addMonitor(window,"load",this.h5Load)},l.prototype.customStage=function(e,i){var r,a;void 0===i&&(i={sendTimeline:!0}),this.isHit?(void 0!==e&&"string"==typeof e&&""!==e||t.throwError("206"),this.isValidTimestamp(i.timestamp,"custom_stage "+e)&&(r=i.timestamp||Date.now(),a=this.customKeys.length-this.syncMetricNum,this.customKeys.includes(e)?t.consoleError("204",e):i.sendTimeline&&2<this.syncMetricNum||!i.sendTimeline&&5<a?t.consoleError("205",e):r&&(this.custom_metric[e+"_time"]=r,this.customKeys.push(e),!i||!0!==i.sendTimeline&&null!=i.sendTimeline||(a=this.getPerformanceData(),this.collect(n(n({},a),{stack:(new Error).stack,event_name:"h5_custom_metric",custom_metric_name:e,custom_metric_timestamp:r})),this.syncMetricNum++)))):t.consoleError("200")},l.prototype.isValidTimestamp=function(e,n){var i;if(void 0===n&&(n="fmp"),void 0!==e&&"number"!=typeof e)t.throwError("201");else if(void 0!==e&&e<performance.timing.navigationStart)return t.consoleWarn("210","".concat(n)),null!=(i=this.core)&&i.collect("event",{name:"radar_error",message:"【210】".concat(n),extra_info:{timestamp:e,navigationStart:performance.timing.navigationStart}}),!1;return!0},l.prototype.fmp=function(e){var i,r;this.isHit?this.isValidTimestamp(e)&&(e=e||Date.now(),this.hasFMP?t.consoleWarn("202"):e&&performance.timing&&(null!=(r=null==(i=this.core)?void 0:i.setCommonDimension)&&r.call(i,"happen_stage","after_fmp"),this.hasFMP=!0,this.radarTiming.fmp_time=e,performance.timing.radarFmp=e,r=this.getPerformanceData(),performance.timing.fmp=this.radarTiming.fmp=r.fmp,this.collect(n({event_name:"fmp",stack:(new Error).stack},r)))):t.consoleWarn("200")},l.prototype.getPerformanceData=function(){var e=n(n({},t.deepClone(performance.timing)),this.radarTiming),i=t.perfMapTiming(n(n({},r),a),e);return Object.keys(o).forEach((function(t){0<=e[o[t]]&&(i[t]=e[o[t]])})),["radar_main_js_start","lcp","cls","fid","fcp"].forEach((function(t){var e=window.__RADAR_PERFORMANCE_TIMING_&&window.__RADAR_PERFORMANCE_TIMING_[t];!e&&0!==e||(i[t]=e)})),i},l.prototype.cacheAndCalculateMainAPI=function(t){var e;void 0===this.radarTiming.fmp&&(t.before_hook_time&&(e=this.radarTiming.apiStart,this.radarTiming.apiStart=e?Math.min(e,t.before_hook_time):t.before_hook_time),t.after_hook_time&&(e=this.radarTiming.apiEnd,this.radarTiming.apiEnd=e?Math.max(e,t.after_hook_time):t.after_hook_time))},l.prototype.addMainApiResult=function(t){var e,r,a,o,c,m,d,p,l,u,f,_,h,g,v,y,S,E,A=s((t.api||"").replace(/\?.+$/,""),this.optionsMainAPI);-1<A&&(null==(E=this.mainAPIList[A])||!E.url)&&(E=t.api,e=t.status,r=t.size,a=t.cached,o=t.method,p=t.perfTime,c=t.protocol,m=t.custom_failed,d=t.res_type,S=i(t,["api","status","size","cached","method","perfTime","protocol","custom_failed","res_type"]),this.mainAPIList[A]=n({url:E,status:e,size_radar:r,cached:a,method:o,perfTime:p,protocol:c,res_type:d,custom_failed:m},S),p=S.fb,l=S.dns,u=S.tcp,f=S.ssl,_=S.ttfb,h=S.trans,g=S.total,v=S.fetch_start,y=S.duration,S=S.start_time,this.radarMainApiList[A]={api:E,status:e,size:r,cached:a,method:o,protocol:c,fb:p,dns:l,tcp:u,ssl:f,ttfb:_,trans:h,total:g,fetch_start:v,duration:y,custom_failed:m,res_type:d,reg:this.optionsMainAPI[A],start_time:S},this.radarTiming.fmp_time&&t.after_hook_time&&t.after_hook_time<this.radarTiming.fmp_time&&(E=this.getPerformanceData(),this.collect(n({event_name:"main_api"},E))))},l.prototype.destroy=function(){t.removeMonitor(window,"load",this.h5Load),this.customStage=this.fmp=function(){t.consoleWarn("213")}},l.prototype.collect=function(t){var e=t.protocol,n=t.event_name,r=(t.custom_metric,t.custom_metric_name),a=t.stack;t.main_api_list,t=i(t,["protocol","event_name","custom_metric","custom_metric_name","stack","main_api_list"]);this.baseCollect({value:t,dimension:{protocol:e,event_name:n,custom_metric_name:r,custom_metric:JSON.stringify(this.custom_metric),main_api_list:this.mainAPIList,radar_main_api_list:this.radarMainApiList,radar_main_js_list:this.radarMainJSList,is_official:1,stack:a}}),null!=(t=this.core)&&t.flush()},l}));
