# 雷达 Event 采集器

Event 采集器为雷达官方采集器，负责进行自定义事件上报，上报数据可以在[雷达平台](https://radar-plus.corp.kuaishou.com/projects)查看。

## 前置需求

需要提前按照 @ks/weblogger @ks-radar/radar-core 两个包

## 接入教程

### 安装依赖

```bash
npm install @ks/weblogger
npm install @ks-radar/radar-core
npm install @ks-radar/radar-navigation-collect
```

### 初始化插件

```typescript
import { Weblog } from '@ks/weblogger';
import RadarCore from '@ks-radar/radar-core';
import RadarNavigationCollect from '@ks-radar/radar-navigation-collect';

const weblog = new Weblog();

// 初始化core 用于采集公共数据，上报日志，需要在采集器初始化时传入，以供采集器使用
const core = new RadarCore({
    weblogger: weblog, // 传入weblogger实例
    projectId: '*****', // 传入项目id
});

const navigationCollect = new RadarNavigationCollect({
    core,
});
```

# 配置

| 属性    | 类型             | 说明                                                                         | 是否必传 |
| ------- | ---------------- | ---------------------------------------------------------------------------- | -------- |
| core    | RadarCore        | @ks-radar/radar-core 实例                                                    | 是       |
| mainApi | string\|string[] | 主接口，主接口的信息会随性能上报一起上报，最多上报 3 个，超出部分直接抛弃    | 否       |
| mainJs  | string\|string[] | 主 Js，主 JS 的性能数据汇总性能上报一起上报，最多上报 3 个，超出部分直接抛弃 | 否       |

# API

## fmp

上报 fmp，首次有效绘制，在快手意为有效首屏时间，即首屏数据全部渲染成功时的打点指标，目前由各业务主动上报。

**上报时机建议：**

CSR（客户端渲染）下主接口返回后，执行完成第一个任务上报 FMP 的；

SSR（服务端渲染）下在 dom ready 时上报 FMP。

```typescript
navigationCollect.fmp();
```

## customStage

上报自定义性能指标，一次访问最多上报 3 次，同名指标只有第一次能正常上报。

```typescript
/**
* 上报自定义性能指标
* @param key 自定义性能指标的名称
* @param options 自定义性能指标配置：sendTimeline 是否仅随其他性能指标一起上报
* @returns
*/
customStage(key: string, options?: {sendTimeline?: boolean;})
```

sendTimeline 是否上报一条汇总日志，默认为 true，如果配置了 sendTimeline 为 false，则不发送汇总事件，在下次汇总上报时携带一起上报，不会有单独的一条日志上报。

没有上报将丢失数据。

## dealAPI

将接口性能添加到 mainApiResult，添加到 mainApiResult 的数据如果匹配上 mainApi 配置会随性能上报一起上报。

```typescript
/**
 * 将接口性能添加到 mainApiResult
 * @param item
 * @returns 是否继续调用
 */
dealAPI: (item: MainApi) => boolean;
```

## addMainJSResult

将接口性能添加到 mainJSResult，添加到 mainJSResult 的数据如果匹配上 mainJs 配置会随性能上报一起上报。

```typescript
/**
 * 将接口性能添加到 mainJSResult
 * @param item
 * @returns 是否继续调用
 */
addMainJSResult = (item: ResourceLog) => boolean;
```
