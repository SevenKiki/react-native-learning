# 雷达 API 采集器

​ API 采集器为雷达官方采集器，负责收集 API 相关的性能数据。该采集器通过对 xhr、fetch 进行 Hook 和监听 Performance，自动收集页面 API 相关的性能数据进行上报。上报后的数据可以在[雷达平台](https://radar-plus.corp.kuaishou.com/projects)查看。

## 前置需求

需要提前按照 @ks/weblogger @ks-radar/radar-core 两个包

## 接入教程

### 安装依赖

```bash
npm install @ks/weblogger
npm install @ks-radar/radar-core
npm install @ks-radar/radar-api-collect
```

### 初始化插件

```typescript
import { Weblog } from '@ks/weblogger';
import RadarCore from '@ks-radar/radar-core';
import ApiCollect from '@ks-radar/radar-api-collect';

const weblog = new Weblog();

// 初始化core 用于采集公共数据，上报日志，需要在采集器初始化时传入，以供采集器使用
const core = new RadarCore({
    weblogger: weblog, // 传入weblogger实例
    projectId: '*****', // 传入项目id
    sampling: 1,
});

const api = new ApiCollect({
    core,
});
```

# 配置

支持初始化时配置如下参数

| 属性                      | 是否必填 | 类型      | 说明                                                                                                                                                                                                             |
| ------------------------- | -------- | --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| core                      | 是       | RadarCore | @ks/radar-core 的实例                                                                                                                                                                                            |
| sampling                  | 否       | number    | 采样率，默认为 1                                                                                                                                                                                                 |
| ignoreList                | 否       | string[]  | 上报忽略 URI 列表，有的 API 不想被监控，可以在这里忽略，不进行收集                                                                                                                                               |
| ignoreXHR                 | 否       | boolean   | 忽略 xhr 方式请求的 API， 配置将不在对 XHR 进行 Hook                                                                                                                                                             |
| ignoreFetch               | 否       | boolean   | 忽略 fetch 方式请求的 API， 配置将不在对 fetch 进行 Hook                                                                                                                                                         |
| APIHook                   | 否       | Function  | [提供 hook api 能力方案](https://docs.corp.kuaishou.com/d/home/fcADeUsenQKpz2G56zaard_yi#section=vodka.7xv7p7wajmwc) [SDK 上报数据 hook 的完善](https://docs.corp.kuaishou.com/d/home/fcAAseHILm8YsKJVD_MXDlHPN) |
| isIgnoreInvalidStatusCode | 否       | Function  | 异步回调拦截 API 日志上报，只支持在接口响应的 status 为 0 时进行处理，返回 true 时将拦截日志上报，支持设置设置异步函数                                                                                           |

## 备注

### isIgnoreInvalidStatusCode

在初始化采集器时提供配置 `isIgnoreInvalidStatusCode` 函数，该函数用于在 status 为 0 的时候异步拦 API 日志的上报，这里支持使用异步函数拦截，且如果异步函数没有在 **2s** 内返回，日志将直接上报。

> 提供这个配置是为了解决，部分业务只支持在内网访问，期望在 API 请求出现超时或其他错误时，使用其他接口来判断是否链接了内网，认为连接了内网才是真实的错误，未连接内网，则不认为这个是一个错误进而拦截这部分数据的上报，我们对这个函数加了比较强的限制，希望可以尽量避免滥用问题。使用方式如下：

```typescript
...
new ApiCollect({
    core,
    isIgnoreInvalidStatusCode: async(data){
    // 进行判断，返回是否需要拦截上报
      return true
    }
});
```

这里 `isIgnoreInvalidStatusCode` 函数的得到的入参 data 是一个包含所有雷达采集到会上报数据的对象，具体参数如下

```typescript
interface isIgnoreInvalidStatusCodeData {
    duration: number;
    logTime: number;
    status: 0;
    size: 0;
    api: string;
    method: string;
    intercept_report?: boolean;
    response_code?: string | number;
    response_msg?: any; // 业务定义的接口返回code的语义化解释
    custom_failed?: boolean;
    [key: string]: any;
}
```

**注意：**如果在`isIgnoreInvalidStatusCode` 中调用接口来判断是否需要上报，需要把这个接口配置到`ignoreList` 中，避免出现该接口的 status 为 0 导致循环调用的问题。

# API

获取采集到的 API 性能数据

```typescript
api.broadcastApi.on(item => {
    // item 为 api 采集器收集到的数据
});
```
