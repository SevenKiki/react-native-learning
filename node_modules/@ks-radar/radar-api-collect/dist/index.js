!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@ks-radar/radar-util")):"function"==typeof define&&define.amd?define(["@ks-radar/radar-util"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).radar=t(e.radarUtil)}(this,(function(e){"use strict";var t=function(e,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])})(e,o)},o=function(){return(o=Object.assign||function(e){for(var t,o=1,r=arguments.length;o<r;o++)for(var n in t=arguments[o])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function r(e,t){var o={};for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(o[n[r]]=e[n[r]]);return o}var n=e.BASE_PER_MAP,i={navigation_start:"startTime",redirect_start:"redirectStart",redirect_end:"redirectEnd",dns_start:"domainLookupStart",dns_end:"domainLookupEnd",connect_start:"connectStart",connect_end:"connectEnd",ssl_start:"secureConnectionStart",request_start:"requestStart",response_start:"responseStart",response_end:"responseEnd"};function s(e,t){if(e)return"function"==typeof e.get?e.get(t):e[t.toLowerCase()]}function a(e){var t="";if("string"==typeof e)t=e;else try{t=JSON.stringify(e)}catch(o){t=String(e)}for(var o=0,r=0;r<t.length;r++){var n=t.charCodeAt(r);o+=n<128?1:n<2048?2:n<65536?3:n<1<<21?4:n<1<<26?5:n<1<<31?6:Number.NaN}return o}var c=e.BaseCollect,u=d,l=c;if("function"!=typeof l&&null!==l)throw new TypeError("Class extends value "+String(l)+" is not a constructor or null");function p(){this.constructor=u}function d(t){var n=c.call(this,{core:null==(t=void 0===t?{}:t)?void 0:t.core,sampling:null==t?void 0:t.sampling,key:e.RADAR_KEY.API,version:"1.2.5",name:"RadarAPICollect"})||this;return n.ignoreList=e.DEFAULT_IGNORE_LIST,n.queue=[],n.logList=[],n.perfList=[],n.broadcastApi=e.eventFactory(),n.initiatorTypeList=[],n.beforeHook=function(t){var o,r,i;0===(null==(o=t.url)?void 0:o.indexOf("data:"))||e.isInUrlList(t.url,n.ignoreList)||e.isInUrlList(t.url,(null==(o=n.core)?void 0:o.ignoreList)||[])||"js"===e.suffix(t.url)||"css"===e.suffix(t.url)||(r={api:(o=t.url,r=(i=document.location).protocol,i=i.host,0===o.indexOf("//")?r+o:0===o.indexOf("/")?"".concat(r,"//").concat(i).concat(o):o),method:t.method,request:t,startTime:Date.now()},n.queue.push(r))},n.afterHook=function(t,i){var c=n.queue.find((function(e){return e.request===t}));if(c){delete c.request;var u=c.startTime,l=(c=r(c,["startTime"]),Date.now()),p=l-u,d=i.status;if("function"==typeof n.customizeRadarStatus)try{d=n.customizeRadarStatus(i)}catch(i){console.error(i)}var f=n.customHook({request:t,response:i,duration:p}),_=+s(i.headers,"Content-Length")||0,h=e.parseServerTiming(s(i.headers,"Server-Timing"));_=o(o(o({duration:p,logTime:Date.now(),status:d,size:+_,content_type:(p=i.headers)?"function"==typeof p.get?p.get("Content-Type"):p["content-type"]:null,custom_failed:!(200<=d&&d<300)},c),f),{before_hook_time:u,after_hook_time:l,trace_id:t.trace_id,server_timing:h});2===(null==(d=null==(p=s(i.headers,"Intercept-Result"))?void 0:p.split(";"))?void 0:d.length)&&null!=(c=n.core)&&c.setCommonDimension&&(n.core.setCommonDimension("intercept_result",d[0],!1),n.core.setCommonDimension("intercept_result_code",d[1],!1),_.api_intercept_result=d[0],_.api_intercept_result_code=d[1]),i.finalUrl&&(_.api=i.finalUrl),"string"==typeof i.text&&(_.responseData=i.text),0!==o(o({},i),{status:_.status}).status||f.intercept_report?n.mergeAPIPerf(void 0,_)||n.logList.push(_):(_.size&&0!=_.size||!_.responseData||(_.size=a(_.responseData)),delete _.responseData,delete _.server_timing,n.collect(_)),n.queue=n.queue.filter((function(e){return e.request&&e.request!==t}))}},void 0!==(n.option=t)&&null!=t&&t.core||e.throwError("310"),void 0!==t.ignoreList&&(Array.isArray(t.ignoreList)||e.throwError("309"),t.ignoreList.forEach((function(t){"string"!=typeof t&&e.throwError("309")})),n.ignoreList=n.ignoreList.concat(t.ignoreList)),n.APIHook=t.APIHook,n.customizeRadarStatus=t.customizeRadarStatus,n.init(),n}return t(u,l),u.prototype=null===l?Object.create(l):(p.prototype=l.prototype,new p),d.prototype.init=function(){var t,o=this;try{this.observer=new PerformanceObserver((function(e){return o.observeAPI(e)})),this.observer.observe({entryTypes:["resource"]}),this.initiatorTypeList=[],!0!==this.option.ignoreXHR&&(this.initiatorTypeList.push("xmlhttprequest"),this.unhookXML=e.hookXML((function(e){return o.beforeHook(e)}),(function(e,t){return o.afterHook(e,t)}))),!0!==this.option.ignoreFetch&&(this.initiatorTypeList.push("fetch"),this.unhookFetch=e.hookFetch((function(e){return o.beforeHook(e)}),(function(e,t){return o.afterHook(e,t)})))}catch(o){e.consoleError("308"),null!=(t=this.core)&&t.collect("event",{name:"radar_error",message:"PerformanceObserver 不存在无法收集数据",category:e.RADAR_KEY.API})}},d.prototype.customHook=function(t){var o={};if(void 0===this.APIHook)return o;if("function"!=typeof this.APIHook)return e.consoleWarn("300"),o;var r={};try{r=this.APIHook(t)}catch(t){return e.consoleWarn("301",t),{}}if(!r)return e.consoleWarn("302"),o;t=r.response_msg;var n=r.response_code,i=r.status,s=r.custom_failed,a=r.intercept_report;r=r.broadcast_info;if(!0===Boolean(a)&&(o.intercept_report=!0),void 0!==t)try{var c=JSON.stringify(t);100<c.length&&e.consoleWarn("307"),o.response_msg=c.slice(0,100)}catch(t){o.response_msg="response_msg返回结果异常",e.consoleWarn("303")}return void 0!==n&&(a=Number(n),isNaN(a)?e.consoleWarn("304"):o.response_code=a),void 0!==i&&(t=Number(i),isNaN(t)?e.consoleWarn("305"):o.status=t),void 0!==s&&(!0===s||!1===s?o.custom_failed=s:e.consoleWarn("306")),o.broadcast_info=r,o},d.prototype.observeAPI=function(t){var r=this;t.getEntriesByType("resource").forEach((function(t){var s,a,c;if(0===(null==(c=t.name)?void 0:c.indexOf("data:"))||e.isInUrlList(t.name,r.ignoreList)||e.isInUrlList(t.name,(null==(c=r.core)?void 0:c.ignoreList)||[]))return!1;"api"===e.getPerformanceObserverEntryType(t)&&((c=e.perfMapTiming(n,t)).perfTime=Date.now(),null!=(s=null==(s=t.serverTiming)?void 0:s.map((function(e){return{name:e.name,duration:e.duration,description:e.description||void 0}})))&&s.length||(s=void 0),a={encoded_body_size:t.encodedBodySize,decoded_body_size:t.decodedBodySize},Object.keys(i).forEach((function(e){a[e]=Number(t[i[e]]+performance.timing.navigationStart)})),c=o(o(o(o({},c),{api:c.file}),a),{server_timing:s}),r.mergeAPIPerf(c)||r.perfList.push(c))}))},d.prototype.destroy=function(){this.unhookXML&&this.unhookXML(),this.unhookFetch&&this.unhookFetch(),this.observer&&this.observer.disconnect()},d.prototype.mergeAPIPerf=function(e,t){if(e?t=this.takeItem(e,this.logList):t&&(e=this.takeItem(t,this.perfList)),!e||!t)return!1;if(!0===t.intercept_report)return!0;var o,r=Object.assign({},t,e,{size:e.size||t.size});return(t=(delete r.file,r.size&&0!=r.size||!r.responseData||(r.size=a(r.responseData)),delete r.responseData,t.server_timing||e.server_timing))&&(o=null,t.map((function(e){"total-timing"===e.name&&(o=null!=(e=e.duration)?e:null)})),r.total_server_timing=o,r.server_data_list=JSON.stringify(t)),delete r.server_timing,this.collect(r),!0},d.prototype.takeItem=function(e,t){var o,r=(e.api||"").replace(/\?.+$/,"");if(-1!==(e=t.findIndex((function(e){return e=(e.api||"").replace(/\?.+$/,""),r===e}))))return o=t[e],t.splice(e,1),o},d.prototype.collect=function(t){var o=this,n=t.res_type,i=t.protocol,s=t.api,a=t.custom_failed,c=t.status,u=t.cached,l=t.method,p=t.response_code,d=t.response_msg,f=(t.has_fmp,t.server_data_list),_=t.content_type,h=t.broadcast_info,m=t.before_hook_time,v=t.after_hook_time,g=t.api_intercept_result,y=t.api_intercept_result_code,b={dimension:{before_hook_time:m,after_hook_time:v,res_type:n,protocol:i,api:s,custom_failed:a,status:c,cached:u,method:l,response_code:p,response_msg:d,content_type:_,broadcast_info:h,is_official:1,server_data_list:f,trace_id:t.trace_id,api_intercept_result:g,api_intercept_result_code:y,has_timing_allow:t.has_timing_allow},value:r(t,["res_type","protocol","api","custom_failed","status","cached","method","response_code","response_msg","has_fmp","server_data_list","content_type","broadcast_info","before_hook_time","after_hook_time","api_intercept_result","api_intercept_result_code","trace_id","has_timing_allow"])};this.broadcastApi.emit(e.deepClone(t)),0===c&&e.isFunction(this.option.isIgnoreInvalidStatusCode)?new Promise((function(r,n){var i,s;o.option.isIgnoreInvalidStatusCode&&(i=o.option.isIgnoreInvalidStatusCode(t),e.isPromise(i)?(s=setTimeout((function(){return r(!1)}),2e3),i.then((function(e){clearTimeout(s),r(!0===e)}),n)):r(!0===i))})).then((function(t){t?e.consoleWarn("异步拦截日志"):o.baseCollect(b)}),(function(t){o.baseCollect(b),e.consoleError(t)})):this.baseCollect(b)},d}));
