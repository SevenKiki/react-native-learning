import{BASE_PER_MAP as e,hookXML as t,hookFetch as r,consoleError as o,RADAR_KEY as n,consoleWarn as i,isInUrlList as s,getPerformanceObserverEntryType as a,perfMapTiming as c,deepClone as u,isFunction as p,isPromise as l,DEFAULT_IGNORE_LIST as f,eventFactory as d,suffix as _,parseServerTiming as m,throwError as h,BaseCollect as v}from"@ks-radar/radar-util";var g=function(e,t){return(g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};var y=function(){return(y=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function b(e,t){var r={};for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]]);return r}var k=e,L={navigation_start:"startTime",redirect_start:"redirectStart",redirect_end:"redirectEnd",dns_start:"domainLookupStart",dns_end:"domainLookupEnd",connect_start:"connectStart",connect_end:"connectEnd",ssl_start:"secureConnectionStart",request_start:"requestStart",response_start:"responseStart",response_end:"responseEnd"};function O(e,t){if(e)return"function"==typeof e.get?e.get(t):e[t.toLowerCase()]}function I(e){var t="";if("string"==typeof e)t=e;else try{t=JSON.stringify(e)}catch(r){t=String(e)}for(var r=0,o=0;o<t.length;o++){var n=t.charCodeAt(o);r+=n<128?1:n<2048?2:n<65536?3:n<1<<21?4:n<1<<26?5:n<1<<31?6:Number.NaN}return r}function P(e){var t=(r=document.location).protocol,r=r.host;return 0===e.indexOf("//")?t+e:0===e.indexOf("/")?"".concat(t,"//").concat(r).concat(e):e}function S(e){return e?"function"==typeof e.get?e.get("Content-Type"):e["content-type"]:null}var A=function(e){function v(t){var r=e.call(this,{core:null==(t=void 0===t?{}:t)?void 0:t.core,sampling:null==t?void 0:t.sampling,key:n.API,version:"1.2.5",name:"RadarAPICollect"})||this;return r.ignoreList=f,r.queue=[],r.logList=[],r.perfList=[],r.broadcastApi=d(),r.initiatorTypeList=[],r.beforeHook=function(e){var t;0===(null==(t=e.url)?void 0:t.indexOf("data:"))||s(e.url,r.ignoreList)||s(e.url,(null==(t=r.core)?void 0:t.ignoreList)||[])||"js"===_(e.url)||"css"===_(e.url)||(t={api:P(e.url),method:e.method,request:e,startTime:Date.now()},r.queue.push(t))},r.afterHook=function(e,t){var o=r.queue.find((function(t){return t.request===e}));if(o){delete o.request;var n=o.startTime,i=(o=b(o,["startTime"]),Date.now()),s=i-n,a=t.status;if("function"==typeof r.customizeRadarStatus)try{a=r.customizeRadarStatus(t)}catch(t){console.error(t)}var c=r.customHook({request:e,response:t,duration:s}),u=function(e){return+O(e,"Content-Length")||0}(t.headers),p=m(O(t.headers,"Server-Timing"));s=y(y(y({duration:s,logTime:Date.now(),status:a,size:+u,content_type:S(t.headers),custom_failed:!(200<=a&&a<300)},o),c),{before_hook_time:n,after_hook_time:i,trace_id:e.trace_id,server_timing:p});2===(null==(a=null==(u=O(t.headers,"Intercept-Result"))?void 0:u.split(";"))?void 0:a.length)&&null!=(o=r.core)&&o.setCommonDimension&&(r.core.setCommonDimension("intercept_result",a[0],!1),r.core.setCommonDimension("intercept_result_code",a[1],!1),s.api_intercept_result=a[0],s.api_intercept_result_code=a[1]),t.finalUrl&&(s.api=t.finalUrl),"string"==typeof t.text&&(s.responseData=t.text),function(e){return 0===e.status}(y(y({},t),{status:s.status}))&&!c.intercept_report?(s.size&&0!=s.size||!s.responseData||(s.size=I(s.responseData)),delete s.responseData,delete s.server_timing,r.collect(s)):r.mergeAPIPerf(void 0,s)||r.logList.push(s),r.queue=r.queue.filter((function(t){return t.request&&t.request!==e}))}},void 0!==(r.option=t)&&null!=t&&t.core||h("310"),void 0!==t.ignoreList&&(Array.isArray(t.ignoreList)||h("309"),t.ignoreList.forEach((function(e){"string"!=typeof e&&h("309")})),r.ignoreList=r.ignoreList.concat(t.ignoreList)),r.APIHook=t.APIHook,r.customizeRadarStatus=t.customizeRadarStatus,r.init(),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}g(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(v,e),v.prototype.init=function(){var e,i=this;try{this.observer=new PerformanceObserver((function(e){return i.observeAPI(e)})),this.observer.observe({entryTypes:["resource"]}),this.initiatorTypeList=[],!0!==this.option.ignoreXHR&&(this.initiatorTypeList.push("xmlhttprequest"),this.unhookXML=t((function(e){return i.beforeHook(e)}),(function(e,t){return i.afterHook(e,t)}))),!0!==this.option.ignoreFetch&&(this.initiatorTypeList.push("fetch"),this.unhookFetch=r((function(e){return i.beforeHook(e)}),(function(e,t){return i.afterHook(e,t)})))}catch(t){o("308"),null!=(e=this.core)&&e.collect("event",{name:"radar_error",message:"PerformanceObserver 不存在无法收集数据",category:n.API})}},v.prototype.customHook=function(e){var t={};if(void 0===this.APIHook)return t;if("function"!=typeof this.APIHook)return i("300"),t;var r={};try{r=this.APIHook(e)}catch(e){return i("301",e),{}}if(!r)return i("302"),t;e=r.response_msg;var o=r.response_code,n=r.status,s=r.custom_failed,a=r.intercept_report;r=r.broadcast_info;if(!0===Boolean(a)&&(t.intercept_report=!0),void 0!==e)try{var c=JSON.stringify(e);100<c.length&&i("307"),t.response_msg=c.slice(0,100)}catch(e){t.response_msg="response_msg返回结果异常",i("303")}return void 0!==o&&(a=Number(o),isNaN(a)?i("304"):t.response_code=a),void 0!==n&&(e=Number(n),isNaN(e)?i("305"):t.status=e),void 0!==s&&(!0===s||!1===s?t.custom_failed=s:i("306")),t.broadcast_info=r,t},v.prototype.observeAPI=function(e){var t=this;e.getEntriesByType("resource").forEach((function(e){var r,o,n;if(0===(null==(n=e.name)?void 0:n.indexOf("data:"))||s(e.name,t.ignoreList)||s(e.name,(null==(n=t.core)?void 0:n.ignoreList)||[]))return!1;"api"===a(e)&&((n=c(k,e)).perfTime=Date.now(),null!=(r=null==(r=e.serverTiming)?void 0:r.map((function(e){return{name:e.name,duration:e.duration,description:e.description||void 0}})))&&r.length||(r=void 0),o={encoded_body_size:e.encodedBodySize,decoded_body_size:e.decodedBodySize},Object.keys(L).forEach((function(t){o[t]=Number(e[L[t]]+performance.timing.navigationStart)})),n=y(y(y(y({},n),{api:n.file}),o),{server_timing:r}),t.mergeAPIPerf(n)||t.perfList.push(n))}))},v.prototype.destroy=function(){this.unhookXML&&this.unhookXML(),this.unhookFetch&&this.unhookFetch(),this.observer&&this.observer.disconnect()},v.prototype.mergeAPIPerf=function(e,t){if(e?t=this.takeItem(e,this.logList):t&&(e=this.takeItem(t,this.perfList)),!e||!t)return!1;if(!0===t.intercept_report)return!0;var r,o=Object.assign({},t,e,{size:e.size||t.size});return(t=(delete o.file,o.size&&0!=o.size||!o.responseData||(o.size=I(o.responseData)),delete o.responseData,t.server_timing||e.server_timing))&&(r=null,t.map((function(e){"total-timing"===e.name&&(r=null!=(e=e.duration)?e:null)})),o.total_server_timing=r,o.server_data_list=JSON.stringify(t)),delete o.server_timing,this.collect(o),!0},v.prototype.takeItem=function(e,t){var r,o=(e.api||"").replace(/\?.+$/,"");if(-1!==(e=t.findIndex((function(e){return e=(e.api||"").replace(/\?.+$/,""),o===e}))))return r=t[e],t.splice(e,1),r},v.prototype.collect=function(e){var t=this,r=e.res_type,n=e.protocol,s=e.api,a=e.custom_failed,c=e.status,f=e.cached,d=e.method,_=e.response_code,m=e.response_msg,h=(e.has_fmp,e.server_data_list),v=e.content_type,g=e.broadcast_info,y=e.before_hook_time,k=e.after_hook_time,L=e.api_intercept_result,O=e.api_intercept_result_code,I={dimension:{before_hook_time:y,after_hook_time:k,res_type:r,protocol:n,api:s,custom_failed:a,status:c,cached:f,method:d,response_code:_,response_msg:m,content_type:v,broadcast_info:g,is_official:1,server_data_list:h,trace_id:e.trace_id,api_intercept_result:L,api_intercept_result_code:O,has_timing_allow:e.has_timing_allow},value:b(e,["res_type","protocol","api","custom_failed","status","cached","method","response_code","response_msg","has_fmp","server_data_list","content_type","broadcast_info","before_hook_time","after_hook_time","api_intercept_result","api_intercept_result_code","trace_id","has_timing_allow"])};this.broadcastApi.emit(u(e)),0===c&&p(this.option.isIgnoreInvalidStatusCode)?new Promise((function(r,o){var n,i;t.option.isIgnoreInvalidStatusCode&&(n=t.option.isIgnoreInvalidStatusCode(e),l(n)?(i=setTimeout((function(){return r(!1)}),2e3),n.then((function(e){clearTimeout(i),r(!0===e)}),o)):r(!0===n))})).then((function(e){e?i("异步拦截日志"):t.baseCollect(I)}),(function(e){t.baseCollect(I),o(e)})):this.baseCollect(I)},v}(v);export{A as default};
