# @krn/cli

## Install

```shell
# 注意：需要先设置npm私有镜像
[npm/yarn] config set registry https://npm.corp.kuaishou.com

npm i @krn/cli -g
// or
yarn global add @krn/cli
```

## KRN-CLI 提供以下命令:

<!-- commands -->
* [`krn autocomplete [SHELL]`](#krn-autocomplete-shell)
* [`krn build`](#krn-build)
* [`krn bundle-visualizer`](#krn-bundle-visualizer)
* [`krn create [BUNDLEID]`](#krn-create-bundleid)
* [`krn debug`](#krn-debug)
* [`krn doctor`](#krn-doctor)
* [`krn help [COMMAND]`](#krn-help-command)
* [`krn init [NAME] [DIRECTORY]`](#krn-init-name-directory)
* [`krn start`](#krn-start)
* [`krn start-webpack`](#krn-start-webpack)
* [`krn update`](#krn-update)

## `krn autocomplete [SHELL]`

display autocomplete installation instructions

```
USAGE
  $ krn autocomplete [SHELL]

ARGUMENTS
  SHELL  shell type

OPTIONS
  -r, --refresh-cache  Refresh cache (ignores displaying instructions)

EXAMPLES
  $ krn autocomplete
  $ krn autocomplete bash
  $ krn autocomplete zsh
  $ krn autocomplete --refresh-cache
```

_See code: [@oclif/plugin-autocomplete](https://github.com/oclif/plugin-autocomplete/blob/v0.3.0/src/commands/autocomplete/index.ts)_

## `krn build`

打包命令

```
USAGE
  $ krn build

OPTIONS
  -b, --bundleId=Demo            (required) BundleId
  -d, --dev=true                 [default: false] 打DEBUG包
  -i, --ignore-size              是否忽略文件体积的限制
  -p, --platform=ios             (required) 打包平台
  -r, --reset-cache              是否清除打包缓存
  -u, --upload                   是否上传bundle
  -v, --version=1                (required) [default: 0] 版本号
  --accurate-test-istanbul       精准测试代码插桩
  --auto-test-id                 自动插入 testID
  --config=./metro.config.js     metro配置文件路径
  --deploy                       本地部署预览，只能用于本地测试使用

  --deploy-scheme=deploy-scheme  部署后，扫码下载的自定义跳转参数，类似 Keep 打包时的参数，默认值为
                                 kwai://krn?bundleId=$BUNDLE_ID&componentName=，其中 $BUNDLE_ID
                                 会在生成二维码的时候自动替换为实际的 bundleId

  --minify=true                  [default: true] 是否压缩bundle

  --use-webpack                  使用webpack构建

  --verbose                      是否输出打包日志

EXAMPLE
  krn build --bundleId=Demo --dev=true --platform=ios --version=1 --upload
```

## `krn bundle-visualizer`

打包可视化

```
USAGE
  $ krn bundle-visualizer

EXAMPLE
  krn bundle-visualizer ./foo.bundle ./foo.js.map
```

## `krn create [BUNDLEID]`

创建Bundle

```
USAGE
  $ krn create [BUNDLEID]
```

## `krn debug`

调试模式

```
USAGE
  $ krn debug

OPTIONS
  -b, --bundleId=Demo         BundleId
  -e, --entry=./index.ts      entryFile
  -f, --force                 强制启动，如果启动端口被占用，会杀死占用端口的进程
  -n, --name=Demo             registerComponent name
  -p, --port=8081             端口号
  -r, --reset-cache           是否清除打包缓存
  --config=./metro.config.js  CLI configuration file
  --debug                     开启debug调试
  --disable-klp               禁止安装klp工具
  --ip=127.0.0.1              IP地址
  --no-check-global           禁用global变量检测

EXAMPLE
  krn start
```

## `krn doctor`

诊断修复工具

```
USAGE
  $ krn doctor

OPTIONS
  --fix  是否进行修复

EXAMPLE
  krn doctor
```

## `krn help [COMMAND]`

display help for krn

```
USAGE
  $ krn help [COMMAND]

ARGUMENTS
  COMMAND  command to show help for

OPTIONS
  --all  see all commands in CLI
```

_See code: [@oclif/plugin-help](https://github.com/oclif/plugin-help/blob/v3.2.18/src/commands/help.ts)_

## `krn init [NAME] [DIRECTORY]`

初始化项目命令

```
USAGE
  $ krn init [NAME] [DIRECTORY]

OPTIONS
  --directory=directory         项目路径，不包括项目名称
  --name=KRNDemo                项目名称
  --no-install                  只初始化模板，不安装依赖
  --template=@krn/foo-template  自定义模板，请上传模板代码到@krn/<name>-template

EXAMPLE
  krn init Demo
```

## `krn start`

调试模式

```
USAGE
  $ krn start

OPTIONS
  -b, --bundleId=Demo         BundleId
  -e, --entry=./index.ts      entryFile
  -f, --force                 强制启动，如果启动端口被占用，会杀死占用端口的进程
  -n, --name=Demo             registerComponent name
  -p, --port=8081             端口号
  -r, --reset-cache           是否清除打包缓存
  --config=./metro.config.js  CLI configuration file
  --debug                     开启debug调试
  --disable-klp               禁止安装klp工具
  --ip=127.0.0.1              IP地址
  --no-check-global           禁用global变量检测

EXAMPLE
  krn start
```

## `krn start-webpack`

使用 webpack 调试模式

```
USAGE
  $ krn start-webpack

OPTIONS
  -b, --bundleId=Demo           BundleId
  -e, --entry=./index.ts        entryFile
  -f, --force                   强制启动，如果启动端口被占用，会杀死占用端口的进程
  -n, --name=Demo               registerComponent name
  -p, --port=8081               端口号
  -r, --reset-cache             是否清除打包缓存
  --config=./webpack.config.js  CLI configuration file
  --debug                       开启debug调试
  --disable-klp                 禁止安装klp工具
  --ip=127.0.0.1                IP地址
  --no-check-global             禁用global变量检测

EXAMPLE
  krn start-webpack
```

## `krn update`

升级CLI

```
USAGE
  $ krn update

EXAMPLE
  krn update
```
<!-- commandsstop -->

## 其他说明

### 调试 CLI

```shell
git clone `<This Repository>`
cd krn-cli
yarn link
cd `<Your Workspace>`
yarn link krn-cli
krn
```

### 自定义 build 打包

build 的时候会设置一些环境变量，以下是列表：

- `KRN_BUILD_TYPE`，打包类型，`'WEBPACK'` 或 `'METRO'`，默认是 `'METRO'`；
- `KRN_DEV_BUILD_MODE`，是否是 DEV 打包，值为 `'true'` 或 `'false'`；
- `KRN_BUNDLE_DIR_PATH`，打包工作目录，里面会存放所有的临时产物、打包产物，例如 `config.json`，打包压缩后的 png 文件、zip 包等等；
- `KRN_BUNDLE_OUTPUT_DIR_PATH`，打包时的输出产物目录、包含 bundle 文件、图片资源等，不包含其他临时产物，此目录最终会被打包为 png、zip包供客户端使用；
- `KRN_BUNDLE_WEBPACK_ASSET_DIR_PATH`，webpack 打包时的资源目录，存放图片资源等，最目录最终会被复制到 `KRN_BUNDLE_OUTPUT_DIR_PATH`；
- `KRN_SOURCE_MAP_FILE_NAME`，打包的 sourcemap 文件名；
- `KRN_PLATFORM`，打包平台，`'android'` 或 `'ios'`；
- `KRN_PROJECT_ROOT`，打包时的项目根目录；
- `KRN_ENTRY`，打包入口文件路径；
- `KRN_BUNDLE_ID`，打包时的 bundleId；

build 的时候支持一些钩子命令，使用户对产物做一些处理，如果想执行钩子，需要在 `krn.config.json` 中添加以下信息:

``` json
{
  // 其他字段
  "hooks": {
    "prebuild": "echo 'prebuild'",
    "prepack": "echo 'prepack'",
    "postbuild": "echo 'postbuild'",
    "failbuild": "echo 'failbuild'"
  }
}
```

其中每个钩子执行的时机如下：

- prebuild，打包之前执行，此时打包的工作目录还没有创建；
- prepack，打包已经完成，产物已经生成，但是还没有生成 png 文件、打 zip 压缩包，如果相对产物做处理，此时时最佳时机；
- postbuild，整个打包工作已经完成了，包括 构建产物、上传产品库；
- failbuild，打包失败时执行；

> 如果希望在钩子执行失败时，终止整个打包流程，可以在脚本中出错时，抛出进程退出码为 33，例如 shell 中的  `exit 33`，CLI 捕捉到后，会终止打包进程。


### 自定义启动

在运行 start 命令启动后，会生成一个二维码，代表着一个跳转链接，一般的链接是这样的，`kwai://krn?bundleId=DEBUG_BUNDLE&debugMode=1&componentName=KdsSnackRuntime&debugServer=http://192.168.0.101:8081`，但是如果此时想定制这个链接呢？

这个能力 CLI 也是有的，需要你在项目的 `krn.config.json` 中指定 `scheme` 和 `schemeParams`，这两个参数含义如下：

- `scheme` 代表生成二维码链接的协议，一般默认为 `'kwai://'`，如果你想指定为其他 APP 的协议，可以设置此参数；
- `schemeParams` 代表生成二维码链接的参数，有时我们需要在进入的时候携带一些额外参数去请求接口，通过设置此参数可以达到目的，这个参数有两种格式：
  - `string` 类型，直接将参数的键值对字符串拼接在二维码链接后面，例如 `'a=1&b=2'`
  - `object` 类型，有时候我们的项目中有多个 componentName，我们希望根据不同的 componentName 来设置参数，这时候就可以穿入一个对象来实现，例如 `{ "componentName1": "a1=1&b1=2", "componentName2": "a2=1&b2=2" }`

- `schemeTemplate` schemeUrl 的模板，可以用来完全自定义 schemeUrl 逻辑，会在模板中注入 `$BUNDLE_ID`、`$COMPONENT_NAME`、`$DEBUG_SERVER`、`$IP`、`$PORT`变量，这里这样使用： `"kwai://krn?bundleid=$BUNDLE_ID&debugMode=1&componentname=$COMPONENT_NAME&debugServer=$DEBUG_SERVER"`

> 本地开发时，`krn.config.json` 中的 `entry` 最好为一个对象，其中对象的 key 声明为 bundleId，否则会使用默认的 bundleId （DEBUG_BUNDLE）。由于默认的 bundleId 中含有 `DEBUG` 关键字，在一些 krn 容器中扫一扫扫描二维码可能无法识别。

### 自定义初始化

当使用 krn init 初始化项目时，一般都只有官方的模板列表，有的同学会有使用自定义模板的需求，目前这种能力也是具备的，通过 `krn init --template=@krn/foo-template` 指定自定义模板，模板是一个 npm 包（@krn/foo-template），因为大家可以将自己的模板发布到 npm 上，然后初始化的时候用对应的 npm 包名，就可以实现自定义模板初始化，大家也可以根据我们目前的 KRN CLI 的 [官方模板]（https://git.corp.kuaishou.com/kds/tools/krn-cli/-/tree/master/packages/templates）做一些修改，然后发布到 npm 上作为自己的模板。

如果有的同学已经有了自己的模板，想添加到官方初始化的模板列表中，可以 KIM 联系 lixuan12 添加。

### 本地打包部署测试

`0.14.0` 版本及其以上本地打包时支持直接部署到云端，然后使用手机扫描二维码进行预览测试，具体方法是使用 `krn build` 或 `yarn build` 本地打包时加上 `--deploy` 或 `--deploy-scheme` 参数，这两个参数说明如下：

- `--deploy` 选项是告诉 CLI 开启本地打包完成后部署功能
- `--deploy-scheme` 选项是一个字符串，用来指定扫码下载后自定义跳转参数，和 Keep 打包时的自定义跳转参数类似，默认值为
                    kwai://krn?bundleId=$BUNDLE_ID&componentName=，其中 $BUNDLE_ID 会在生成二维码的时候自动替换为实际的 bundleId，如果指定此参数，可以省略 `--deploy` 选项

> 本地使用 webpack 打包，只需要 `krn build --use-webpack --deploy` 或 `yarn build --use-webpack --deploy` 即可

下面是两个使用示例：

1、业务有自己的特定入口，不需要自定义跳转参数：

```
yarn build --deploy
```

2、业务没有入口，需要自定义跳转参数：

```
yarn build --deploy-scheme='kwai://krn?bundleId=$BUNDLE_ID&componentName=demo&aaa=1'
```

> 由于每个人的机器环境不一样，因此打包结果可能有差异，如果觉得产物有问题，可以提交到 Keep 上打包进行再次确认

> 本地打包时，如果发现代码效果未生效，可能是有打包缓存，build 时加上 `--reset-cache` 选项

### 使用 webpack 调试模式（试用中）

为了保证 Keep 打包和本地调试的一致性，我们从 1.0.0 开始支持本地使用 webpack 进行开发调试，用法如下：

- 使用 `yarn global add @krn/cli@next` 或 `npm i -g @krn/cli@next` 升级全局 CLI 至试用版本
- 升级本地 `@krn/inline-require-webpack-plugin` 至 `0.4.0` 以上（否则导致缓存不生效）
- 使用 `krn start-webpack` 开始开发，选项与原来的 `krn start` 相同
