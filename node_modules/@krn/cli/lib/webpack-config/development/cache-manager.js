"use strict";
const path = require('path');
const os = require('os');
const fs = require('fs-extra');
const md5 = require('md5');
const CACHE_DIR = path.join(os.tmpdir(), '.krn-cli-webpack-cache');
module.exports = {
    init() {
        fs.ensureDirSync(CACHE_DIR);
        const cacheDir = this.getCacheDir();
        fs.ensureDirSync(cacheDir);
    },
    reset() {
        const cacheDir = this.getCacheDir();
        fs.removeSync(cacheDir);
        fs.ensureDirSync(cacheDir);
    },
    getCacheDir() {
        const currentDir = process.cwd();
        const lastSecLevel = currentDir.split(path.sep).slice(-3).join('~');
        return path.join(CACHE_DIR, lastSecLevel);
    },
    getCacheVersion() {
        const webpackConfigPath = process.env.KRN_CONFIG_PATH;
        const webpackBabelConfigPath = path.resolve('babel-webpack.config.js');
        const oldBabelConfigPath = path.resolve('babel.config.js');
        const cacheVersionFactors = [];
        if (fs.existsSync(webpackConfigPath)) {
            cacheVersionFactors.push(fs.readFileSync(webpackConfigPath, 'utf8'));
        }
        if (fs.existsSync(webpackBabelConfigPath)) {
            cacheVersionFactors.push(fs.readFileSync(webpackBabelConfigPath, 'utf8'));
        }
        if (fs.existsSync(oldBabelConfigPath)) {
            cacheVersionFactors.push(fs.readFileSync(oldBabelConfigPath, 'utf8'));
        }
        return md5(cacheVersionFactors.join(''));
    },
};
