"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.diagnoseWithBuildErrorMessage = exports.diagnose = void 0;
const yarn_lock_1 = require("./symptoms/yarn-lock");
const yarn_lock_ignore_1 = require("./symptoms/yarn-lock-ignore");
const react_native_community_cli_tools_version_1 = require("./symptoms/react-native-community-cli-tools-version");
const react_native_community_cli_debugger_ui_1 = require("./symptoms/react-native-community-cli-debugger-ui");
const metro_react_native_babel_preset_version_1 = require("./symptoms/metro-react-native-babel-preset-version");
const utils_1 = require("./utils");
const logger_1 = require("../logger");
const Listr = require("listr");
const react_native_version_1 = require("./symptoms/react-native-version");
const ks_eact_native_version_1 = require("./symptoms/ks-eact-native-version");
const diagnoseLocal = async (fixed) => {
    const symptoms = [
        yarn_lock_1.default,
        yarn_lock_ignore_1.default,
        ks_eact_native_version_1.default,
        react_native_community_cli_tools_version_1.default,
        react_native_community_cli_debugger_ui_1.default,
        metro_react_native_babel_preset_version_1.default,
    ];
    logger_1.Logger.log('è¯Šæ–­ä¸­...');
    const errors = [];
    await new Listr(symptoms.map((symptom) => {
        return {
            title: symptom.desc,
            task: async () => {
                try {
                    const checked = await symptom.check();
                    if (checked === false) {
                        errors.push(symptom);
                        return Promise.reject(new Error(symptom.advice));
                    }
                    return true;
                }
                catch (err) {
                    return true;
                }
            },
        };
    }), {
        concurrent: true,
        exitOnError: false,
    })
        .run()
        // eslint-disable-next-line @typescript-eslint/no-empty-function
        .catch(() => { });
    if (!errors.length) {
        logger_1.Logger.log('ğŸš€ğŸš€ğŸš€ è¯Šæ–­å®Œæˆï¼Œå…¨éƒ¨æ­£å¸¸');
        return;
    }
    if (fixed) {
        logger_1.Logger.log('ä¿®å¤ä¸­...');
        await new Listr(errors.map((symptom) => {
            return {
                title: symptom.desc,
                task: async () => {
                    try {
                        const fixed = await symptom.fix();
                        if (fixed === false) {
                            return Promise.reject(new Error('æš‚æ—¶æ— æ³•ä¿®å¤ï¼Œè¯·å‚è€ƒè¯Šæ–­å»ºè®®æ‰‹åŠ¨ä¿®å¤'));
                        }
                        return true;
                    }
                    catch (err) {
                        return true;
                    }
                },
            };
        }), {
            concurrent: true,
        })
            .run()
            // eslint-disable-next-line @typescript-eslint/no-empty-function
            .catch(() => { });
        logger_1.Logger.log('ğŸš€ğŸš€ğŸš€ ä¿®å¤å®Œæˆï¼Œå¦‚æœå‘ç° package.json æˆ– yarn.lock æ–‡ä»¶æœ‰æ›´æ–°ï¼Œè¯·è¿è¡Œ yarn å‘½ä»¤é‡æ–°å®‰è£…ä¾èµ–');
        logger_1.Logger.log('å‚è€ƒå¸¸è§é—®é¢˜æ–‡æ¡£ï¼šhttps://docs.corp.kuaishou.com/d/home/fcADu59zi4Aw00EKR8_qXX1G6');
    }
    else {
        logger_1.Logger.log('è¯·æ‰‹åŠ¨è¿è¡Œ krn doctor --fix è¿›è¡Œä¿®å¤');
        logger_1.Logger.log('å‚è€ƒå¸¸è§é—®é¢˜æ–‡æ¡£ï¼šhttp://ksurl.cn/7I9SswCn');
    }
};
const diagnoseCIOrMonitor = async (fixed) => {
    const normalSymptoms = [react_native_version_1.default]; // ä¿®å¤ react-native ä¸ºå®˜æ–¹ç‰ˆæœ¬
    logger_1.Logger.log('è¯Šæ–­ä¸­...');
    const errors = [];
    await new Listr([
        ...normalSymptoms.map((symptom) => {
            return {
                title: symptom.desc,
                task: async () => {
                    try {
                        const checked = await symptom.check();
                        if (checked === false) {
                            errors.push(symptom);
                            return Promise.reject(new Error(symptom.advice));
                        }
                        return true;
                    }
                    catch (err) {
                        return true;
                    }
                },
            };
        }),
    ], {
        concurrent: true,
    })
        .run()
        // eslint-disable-next-line @typescript-eslint/no-empty-function
        .catch(() => { });
    if (!errors.length) {
        logger_1.Logger.log('ğŸš€ğŸš€ğŸš€ è¯Šæ–­å®Œæˆï¼Œå…¨éƒ¨æ­£å¸¸');
        return;
    }
    if (fixed) {
        logger_1.Logger.log('ä¿®å¤ä¸­...');
        await new Listr(errors.map((symptom) => {
            return {
                title: symptom.desc,
                task: async () => {
                    try {
                        const fixed = await symptom.fix();
                        if (fixed === false) {
                            return Promise.reject(new Error('æš‚æ—¶æ— æ³•ä¿®å¤ï¼Œè¯·å‚è€ƒè¯Šæ–­å»ºè®®æ‰‹åŠ¨ä¿®å¤ï¼Œæˆ–å‚è€ƒå¸¸è§é—®é¢˜æ–‡æ¡£ï¼šhttp://ksurl.cn/7I9SswCn'));
                        }
                        return true;
                    }
                    catch (err) {
                        return true;
                    }
                },
            };
        }), {
            concurrent: true,
            exitOnError: false,
        })
            .run()
            // eslint-disable-next-line @typescript-eslint/no-empty-function
            .catch(() => { });
        logger_1.Logger.log('ğŸš€ğŸš€ğŸš€ ä¿®å¤å®Œæˆ');
    }
    else {
        logger_1.Logger.log('å‚è€ƒå¸¸è§é—®é¢˜æ–‡æ¡£ï¼šhttp://ksurl.cn/7I9SswCn');
    }
};
const diagnose = async (fixed) => {
    const env = (0, utils_1.getEnv)();
    switch (env) {
        case 'local': {
            await diagnoseLocal(fixed);
            break;
        }
        case 'ci':
        case 'monitor': {
            await diagnoseCIOrMonitor(fixed);
            break;
        }
    }
};
exports.diagnose = diagnose;
const diagnoseWithBuildErrorMessage = async (errorMessage) => {
    const buildSymptoms = [metro_react_native_babel_preset_version_1.default];
    let advice = '';
    for (const symptom of buildSymptoms) {
        const checked = await symptom.checkWithBuildErrorMessage(errorMessage);
        if (checked === false) {
            advice = symptom.advice;
        }
    }
    if (advice) {
        logger_1.Logger.log(`ã€å‚è€ƒä¿®æ”¹å»ºè®®ã€‘ï¼š${advice}`);
    }
    logger_1.Logger.log(`ã€æ‰“åŒ…å¸¸è§é—®é¢˜å‚è€ƒæ–‡æ¡£ã€‘ï¼šhttps://docs.corp.kuaishou.com/d/home/fcADu59zi4Aw00EKR8_qXX1G6`);
};
exports.diagnoseWithBuildErrorMessage = diagnoseWithBuildErrorMessage;
