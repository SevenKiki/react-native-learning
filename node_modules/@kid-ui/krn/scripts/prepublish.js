const child_process = require('child_process');
const semver = require('semver');

const whoami = child_process.execSync('whoami').toString().trim();

if (whoami !== 'jenkins') {
  console.error('DO NOT publish locally');
  process.exit(1);
}

const currentBranch = child_process.execSync('git rev-parse --abbrev-ref HEAD').toString().trim();
const version = require('../package.json').version;
const isPrerelease = semver.parse(version).prerelease.length > 0;
const hasTag = process.env.NPM_TAG && process.env.NPM_TAG !== 'latest';

if (currentBranch === 'master') {
  if (isPrerelease) {
    console.error('DO NOT publish prerelease on master branch');
    process.exit(1);
  }
} else if (!isPrerelease || !hasTag) {
  console.error('Only a prelease version can be published to a tag on non-master branch');
  process.exit(1);
}

process.exit(0);
