!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).AutoPV=t()}(this,(function(){"use strict";var e=function(t,a){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])})(t,a)};var t=function(){function e(){}return e.prototype.apply=function(e){this.weblog=e},e}();function a(e,t,a,o){return"attachEvent"in e?e.attachEvent("on"+t,a):e.addEventListener(t,a,o)}function o(e,t,a,o){return"attachEvent"in e?e.detachEvent("on"+t,a):e.removeEventListener(t,a,o)}function n(e){for(var t={},a=0,o=e.split("&");a<o.length;a++){var n=o[a].split("="),i=n[0],r=n[1];i in t?t[i]instanceof Array?t[i].push(r):t[i]=[t[i],r]:t[i]=r}return t}var i=function(e,t){var a=e.url,o=e.page,i=e.params,r=e.pageId;if(!o&&"string"==typeof a){var l=function(e){void 0===e&&(e=location.href);var t=e.lastIndexOf("?");return-1===t?{page:e}:{page:e.slice(0,t),params:n(e.slice(t+1))}}(a);o=l.page,i=l.params}if("function"==typeof t)try{var u=t({url:a,page:o,params:i});"string"==typeof u?o=u:"object"==typeof u&&(u.page&&(o=u.page),u.params&&(i=u.params),u.pageId&&(r=u.pageId))}catch(e){}else if("object"==typeof t){var c="";for(var p in t)if((a||o||"").indexOf(p)>-1){c=t[p];break}c&&(o=c)}return{page:o,params:i,pageId:r}},r=!1,l="hashchange";return function(t){function n(e,a){var o=t.call(this)||this;return o.beginTime=(new Date).valueOf(),o.oldPushState=history.pushState,o.oldReplaceState=history.replaceState,o.visibilityChange=function(){var e=document.visibilityState;"visible"===e&&(r=!1),o.weblog&&!r&&o.autoPVFilter(location.href,null,e)&&("hidden"!==e&&"visible"!==e||("visible"===e&&(o.beginTime=(new Date).valueOf()),o.weblog.sendImmediately("PV",{type:e,auto:!0,beginTime:o.beginTime})))},o.proxyPushState=function(e,t,a){return o.urlChange(),o.oldPushState.call(history,e,t,a)},o.proxyReplaceState=function(e,t,a){return o.urlChange(),o.oldReplaceState.call(history,e,t,a)},o.urlChange=function(){o.weblog&&setTimeout((function(){var e=i({url:location.href},o.weblog.logConfig.urlMap),t=e.page,a=e.params;t&&t===o.weblog.currentUrlPackage.page?o.weblog.currentUrlPackage.update(t,a):(o.autoPVFilter(location.href,o.weblog.currentUrlPackage.page,"leave")&&o.weblog.sendImmediately("PV",{type:"leave",auto:!0,beginTime:o.beginTime,urlPage:o.weblog.currentUrlPackage.toJSON()}),o.autoPVFilter(location.href,o.weblog.currentUrlPackage.page,"enter")&&(o.weblog.updateReferUrlPackage(o.weblog.currentUrlPackage),o.weblog.updateCurrentUrlPackage(location.href),o.weblog.currentUrlPackage.page.indexOf("http"),o.beginTime=(new Date).valueOf(),o.weblog.sendImmediately("PV",{type:"enter",auto:!0})))}),0)},o.beforeUnload=function(){r=!0,o.weblog&&o.autoPVFilter(location.href,null,"leave")&&o.weblog.sendImmediately("PV",{type:"leave",auto:!0,beginTime:o.beginTime})},o.autoPVFilter=function(){return!0},e&&("function"==typeof e?o.autoPVFilter=e:"function"==typeof(null==e?void 0:e.collect)?((null==a?void 0:a.autoPVFilter)&&(o.autoPVFilter=a.autoPVFilter),o.apply(e)):"autoPVFilter"in e&&"function"==typeof e.autoPVFilter&&(o.autoPVFilter=e.autoPVFilter)),a&&"function"==typeof a.autoPVFilter&&(o.autoPVFilter=a.autoPVFilter),history.pushState=o.proxyPushState,history.replaceState=o.proxyReplaceState,o}return function(t,a){if("function"!=typeof a&&null!==a)throw new TypeError("Class extends value "+String(a)+" is not a constructor or null");function o(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(o.prototype=a.prototype,new o)}(n,t),n.prototype.apply=function(e){if(e&&e.sendImmediately){this.weblog=e,this.autoPVFilter(location.href,null,"enter")&&this.weblog.sendImmediately("PV",{type:"enter",auto:!0});var t=e.Utils.ua.supportsPushState;l=t()?"popstate":"hashchange",a(window,l,this.urlChange),a(document,"visibilitychange",this.visibilityChange)}},n.prototype.destroy=function(){o(window,l,this.urlChange),o(document,"visibilitychange",this.visibilityChange),history.pushState=this.oldPushState,history.replaceState=this.oldReplaceState},n.key="autoPV",n}(t)}));
