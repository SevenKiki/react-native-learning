# Weblogger
Weblogger 是快手 web 端统一埋点 SDK，目前支持 `PC`、`H5（端内、端外）`、`Node`、`React-Native`、`SSR` 等环境。

- [文档地址](https://component.corp.kuaishou.com/docs/weblogger/)
- [联系我们](kim://username?username=shaoxiaokang)

## 工程目录

├── demo // 自测 demo 目录
│   ├── brwoser // 浏览器 demo
│   │   ├── bridge.ejs // H5 桥上报 demo
│   │   ├── browser.ejs // H5 非桥上报 demo
│   │   └── server.js // 本地服务，可用于测试埋点接口、压缩等功能
│   ├── krn // KRN demo
│   ├── mina // 小程序 demo
│   └── README.md // demo 说明
├── docs // 使用文档目录
│   └── .vuepress // 文档站目录，基于 vuepress 生成文档站
├── src // 工程主目录
│   ├── config // 配置项
│   │   ├── apis.ts // 埋点发送接口配置
│   │   ├── types.ts // 旧版类型声明，改造中...
│   │   └── index.ts // Weblogger 默认初始化配置
│   ├── core // 核心层，主要用于埋点数据组装，统一适配 v2、v3
│   │   ├── common.ts // 埋点公共字段管理类 CommonPackage
│   │   ├── url-package.ts // 埋点页面信息管理类 UrlPackage
│   │   ├── custom-stat-event.ts // 自定义事件生成函数
│   │   ├── show-event.ts // 页面、元素曝光事件生成函数
│   │   ├── task-event.ts // 任务、点击事件生成函数
│   │   ├── video-stat-event.ts // 播放时间生成函数
│   │   ├── log.ts // 埋点事件构造器
│   │   ├── logger.ts // 埋点发送器基类
│   │   └── index.ts // Weblog 埋点接口基类
│   ├── entries // 入口层，提供给 rollup 打包的入口文件
│   │   ├── bootstrap.ts // 启动脚本，用于异步加载 script
│   │   ├── bridge.ts // H5 纯桥接
│   │   ├── browser-full.ts // 浏览器带插件
│   │   ├── browser.ts // 浏览器不c带插件
│   │   ├── core.ts // node 
│   │   ├── hybrid-full.ts // 端内桥上报，端外 http 上报，带插件
│   │   ├── hybrid.ts //  端内桥上报，端外 http 上报，不带插件
│   │   ├── krn.ts // krn http 上报
│   │   ├── krnbridge.ts // krn 桥上报
│   │   ├── lite.ts // 组件、库埋点上报轻量级
│   │   ├── mina.ts // 小程序
│   │   └── pure.ts // 快应用等其他 JS 环境 
│   ├── io // 埋点发送工具函数目录
│   │   ├── beacon.ts // 浏览器 sendBeacon 发送
│   │   ├── mina.ts // 小程序 request 发送
│   │   ├── node.ts // node https.request 发送
│   │   ├── xhr.ts // 浏览器 XMLHttpRequest 发送
│   │   ├── gzip.ts // gzip 压缩发送
│   │   ├── worker // worker 子进程压缩脚本
│   │   └── index.ts // 浏览器适发送方法配函数
│   ├── plugins // 插件目录
│   │   ├── autoPV // H5 自动发送 PV 插件
│   │   ├── autoShow // H5 自动发送元素曝光插件
│   │   ├── autoTrack // H5 全埋点插件
│   │   ├── crashMonitor // 根据内存统计崩溃插件
│   │   ├── entryTag // 旧版自动染色插件
│   │   ├── fpsMonitor // FPS 统计插件
│   │   ├── entryTag // 旧版自动染色插件
│   │   ├── radar // 雷达插件，这里只做旧版兼容打包入口，实际雷达已迁出
│   │   ├── riskMgt // 风控插件
│   │   └── timingMonitor // performance timing 相关统计
│   ├── proto // 埋点信息 PB 类型声明
│   │   ├── v2 // v2 PB 声明
│   │   └──v3 // v3 PB 声明
│   ├── types // 新版事件、接口类型声明 
│   └── util // 工具函数库，（仅列了部分主要的文件）
│       ├── compatibility.ts // ssr 兼容
│       ├── ua.ts // ua 信息解析
│       └── yodav2.ts // yoda SDK 2.0 调用封装
├── test // 单元测试
│   ├── platform // 多平台单元测试目录
│   └── ui // 无头浏览器测试入口，模拟实际页面打开时场景，测试埋点压缩、全埋点、页面关闭前埋点丢失等
├── publish.sh // 流水线 npm 发包脚本
├── rollup.config.js // 兼容旧版编译脚本 
├── rollup.lib.config.js // 新版编译脚本
├── kim.js // 正式发版群消息推送
├── cdn.js // 正式版打包后的 scripts 推送到 CDN
├── tsconfig.json // ts 配置
├── package.json // 项目配置
├── CHANGELOG.md // SDK 版本变更记录
└── README.md // 工程使用说明

## 分支管理

- 使用 `master` 分支发布正式版本，目前正式版本为 3.10.x。
- 使用 `dev` 发布 beta 版本。
-【废弃，基本不维护】分支 `v3` 为 3.7.x 版本分支，一般情况不再更新维护。

## 开始开发

### 启动项目

```
yarn dev
```

### 查看示例

```
yarn demo
```

### 查看文档

```
yarn docs:dev
```

## npm 发版

需要先更新 CHANGELOG.md 添加版本变更信息
### ksp 发布 npm 包服务

[ksp 部署](http://ksp.corp.kuaishou.com/?#/ci/pipeline/info) 搜索 `weblogger-npm-publish`，直接构建

- 选择 `dev` 分支，会自动发布 `beta` 包
- 选择 `master` 分支，会自动发布正式包

其他标签发包使用本地命令行手动发包
### 本地命令行发版

```bash
# beta 版本
npm run pub:beta
# or
npm version prerelease --preid=beta && npm publish --tag beta

# 自定义 tag 版本
npm version prerelease --preid=MyTag && npm publish --tag MyTag
```
### 使用文档更新

1. 提交代码
2. [ksp 部署](http://ksp.corp.kuaishou.com/?#/ci/pipeline/info) 搜索 `ks-fe-weblogger`
<img src="https://static.yximgs.com/udata/pkg/ks-track-platform-new/docs/ksp-docs-01.png">
<img src="https://static.yximgs.com/udata/pkg/ks-track-platform-new/docs/ksp-docs-02.png">

## 上报服务器地址

### v3
- web 接口： /rest/wd/common/log/collect/misc2
- web 雷达接口：/rest/wd/common/log/collect/radar
- PB 结构 https://git.corp.kuaishou.com/ks/app-logsdk-common-proto/tree/master/src/main/proto/log
- 域名：
    - 国内正式环境：log-sdk.ksapisrv.com
    - 国内测试环境：vela3.test.gifshow.com
    - 国内开发环境：log-sdk.ksapisrv.com
    - logger 环境：logger-v2-backend.corp.kuaishou.com
    - 新加坡环境：
        - snack 产品：g-logsdk.snackvideo.com，aws-logsdk.snackvideo.com
        - kwaipro, kwaime 产品：logsdk.kwai-pro.com
    - 美东环境：api.zynn.us

### v2
- web 接口：/rest/kd/log/collect?_json=1&biz=  （_json 是为了跨域时候不发option请求；biz为了kafka双写，一般为空）
- PB 结构 https://git.corp.kuaishou.com/data-platform/kuaishou-common-log-proto/-/tree/master/src/main/proto/kuaishou/log/client_log
- 域名（用于分流）：
    - wlog.ksapisrv.com
    - wlog.gifshow.com

## v2 和 v3 PB 异同

### common_package
两者 common_package 基本相同，都包含了：
- app_package
- device_package
- indentity_package
- network_package
- h5_extra_attr

差异点在 `app_package.product`，v2 是必填，v3 则选填取而代之的是 `product_name` 为必填，两者 `product` 相同的值对应的产品也有区别。

### 桥接接口
https://docs.corp.kuaishou.com/d/home/fcABi1jhrd8r8SP9OTyQPGjUq

快手主站客户端上报接口：

- /rest/n/log/client/collect
- /rest/n/log/client/realtime/collect

### KRN 接口
https://wiki.corp.kuaishou.com/pages/viewpage.action?pageId=797024147

## 发布 token 获取
在 npm 平台获取 token，然后在自己电脑 terminal npm login 后
cat ~/.npmrc
