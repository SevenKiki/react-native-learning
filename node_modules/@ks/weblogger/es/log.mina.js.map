{"version":3,"file":"log.mina.js","sources":["../src/plugins/base.ts","../node_modules/tslib/tslib.es6.js","../src/config/global.ts","../src/core/url-package.ts","../src/util/console.ts","../src/util/index.ts","../src/util/events.ts","../src/core/index.ts","../src/config/index.ts","../src/util/mina/global.ts","../src/util/mina/storage.ts","../src/config/types.ts","../src/util/mina/store.ts","../src/util/mina/did.ts","../src/util/mina/page.ts","../src/platform/mina/url-package.ts","../src/config/apis.ts","../src/core/logger.ts","../src/util/mina/types.ts","../src/io/util.ts","../src/util/test.ts","../src/platform/mina/logger.ts","../src/io/mina.ts","../src/util/mina/systeminfo.ts","../src/plugins/minaAutoPV/app.ts","../src/util/mina/increment-id.ts","../src/plugins/minaAutoPV/heart-beat.ts","../src/util/mina/utils.ts","../src/plugins/minaAutoPV/lifecycle-proxy/app.ts","../src/plugins/minaAutoPV/lifecycle-proxy/utils.ts","../src/plugins/minaAutoPV/index.ts","../src/proto/base.ts","../src/proto/v3/client_event.ts","../src/proto/v2/client_event.ts","../src/core/show-event.ts","../src/platform/mina/log.ts","../src/core/task-event.ts","../src/core/custom-stat-event.ts","../src/core/video-stat-event.ts","../src/platform/mina/entry-tag.ts","../src/core/common.ts","../src/util/mina/cookie.ts","../src/platform/mina/common.ts","../src/platform/mina/index.ts"],"sourcesContent":["import type { BaseWeblogInstance } from '@/types/index';\n\nexport abstract class BasePlugin {\n    declare weblog: BaseWeblogInstance;\n    abstract destroy(): void;\n    apply(weblog: BaseWeblogInstance) {\n        this.weblog = weblog;\n    }\n    /**\n     * 统一由 weblog 在页面关闭前调用的生命周期函数\n     */\n    beforeUnload?: (event: Event) => void;\n    static key: string;\n}\n\nexport interface BasePluginConstructor {\n    new(options?: any): any;\n    new(weblogger?: any, options?: any): any;\n    key: string;\n}\n/**\n * 在 bootstrap 环境下自动注册插件\n * @param Plugin\n * @param optionKey\n */\nexport const autoRegister = (Plugin: any, optionKey?: string) => {\n    if (\n        typeof window === 'undefined' ||\n        typeof window._GLOBAL_KS_WEBLOGGER_ === 'undefined' ||\n        typeof Plugin !== 'function') return;\n    const { weblog, config } = window._GLOBAL_KS_WEBLOGGER_;\n    let option = optionKey ? config.plugins[optionKey]?.options : undefined;\n    weblog.addPluginInstance(new Plugin(option));\n}\n","/******************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    if (typeof b !== \"function\" && b !== null)\r\n        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    var desc = Object.getOwnPropertyDescriptor(m, k);\r\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\r\n        desc = { enumerable: true, get: function() { return m[k]; } };\r\n    }\r\n    Object.defineProperty(o, k2, desc);\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n});\r\n\r\nexport function __exportStar(m, o) {\r\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\r\n\r\nexport function __spreadArray(to, from, pack) {\r\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\r\n        if (ar || !(i in from)) {\r\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\r\n            ar[i] = from[i];\r\n        }\r\n    }\r\n    return to.concat(ar || Array.prototype.slice.call(from));\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nvar __setModuleDefault = Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, state, kind, f) {\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\r\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, state, value, kind, f) {\r\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\r\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\r\n}\r\n\r\nexport function __classPrivateFieldIn(state, receiver) {\r\n    if (receiver === null || (typeof receiver !== \"object\" && typeof receiver !== \"function\")) throw new TypeError(\"Cannot use 'in' operator on non-object\");\r\n    return typeof state === \"function\" ? receiver === state : state.has(receiver);\r\n}\r\n","\n/**\n * 全局配置，可用于所有模块中\n */\ninterface Config {\n    sessionId: string;\n    [key: string]: any;\n};\n\nconst GlobalConfig:Config = {\n    sessionId: '',\n    // 小程序专用\n    appDevicePackageReady: false, // 公参app_package device_package是否设置完成，在getNetwork 成功后会被设为true\n    identityPackageReady: false, // identity数据是否设置完成，调用setPublicParam后 设置完成。\n};\n\nexport const updateConfig = (key: string, value: any) => {\n    GlobalConfig[key] = value;\n};\n\nexport const updateConfigs = (configs: {[key: string]: any}) => {\n    Object.assign(GlobalConfig, configs);\n}\n\nexport default GlobalConfig;","import type { UrlObj, PageTypeKey } from '@/config/types';;\nexport default class UrlPackage {\n    // 一级页面。参考埋点需求填写即可\n    page: string = '';\n    // 参数列表参考埋点需求填写，并转成 json 字符串格式\n    params?: {[key: string]: any};\n    // 实例的全局唯一标识，使用UUID即可\n    identity: string = '';\n    // 应用页面类型\n    page_type: 1 | 2 | 3 | 0;\n    // 是否是半屏页\n    coPage?: boolean;\n    // 桥接新添加字段\n    category?: string;\n    constructor(url: UrlObj, pageType?: PageTypeKey) {\n        switch (pageType) {\n            case 'web':\n                this.page_type = 2;\n                break;\n            case 'native':\n                this.page_type = 1;\n                break;\n            case 'mina':\n                this.page_type = 3;\n                break;\n            default:\n                this.page_type = 0; // unknown\n        }\n        this.update(url.page, url.params);\n    }\n\n    // 更新urlPackage\n    update(page: string = '', params?: any) {\n        if (page && page !== this.page) {\n            this.page = page;\n            this.identity = this.generatePageId(page);\n        }\n        if (params) {\n            this.params = Object.assign(this.params || {}, params);\n        }\n    }\n    toJSON() {\n        return {\n            page: this.page,\n            identity: this.identity,\n            page_type: this.page_type,\n            params: JSON.stringify(this.params),\n            category: this.category,\n        };\n    }\n    /**\n     * 生成页面唯一id\n     * 未自定义页面唯一ID生成方法，请自行添加后重新尝试\n     * @param page\n     */\n    generatePageId(page: string) {\n        return page + new Date().getTime();\n    }\n}\n","export function log(...args: any[]) {\n    try {\n        const log = console?.log;\n        return log && log.call(console, ...args);\n    } catch (e) {\n        return;\n    }\n}\n\nexport function warn(...args: any[]) {\n    try {\n        const warn = console?.warn;\n        return warn && warn.call(console, ...args);\n    } catch (e) {\n        return;\n    }\n}\nconst sdkName: string = '__SDK_NAME__';\nexport function error(...args: any[]) {\n    try {\n        const error = sdkName === 'webLogger_krn' ? console?.log : console?.error;\n        return error && error.call(console, ...args);\n    } catch (e) {\n        return;\n    }\n}\n","import { ksAppList } from './const';\nimport { getCookie } from '@/util/cookie';\nimport type { UrlMapFn, UrlMap, UrlMapFnParam } from '../config/types';\nimport { error } from './console';\n\n/**\n * 获取 localStorage 缓存\n */\nexport function getLocalStorageItem(key: string) {\n    try {\n        if (window && window.localStorage) {\n            const value = window.localStorage.getItem(key);\n            if (value) {\n                try {\n                    return JSON.parse(value);\n                } catch (err) {\n                    return value;\n                }\n            }\n        }\n    } catch (err) {\n        return null;\n    }\n    return null;\n\n}\n/**\n * 设置 localStorage 缓存\n */\nexport function setLocalStorageItem(key: string, value: any) {\n    try {\n        if (window && window.localStorage) {\n            window.localStorage.setItem(key, JSON.stringify(value));\n            return true;\n        }\n    } catch (err) {\n        return false;\n    }\n    return false;\n}\n\n/**\n * 判断item是否在目标数组arr中\n * @param {*} arr   目标数组\n * @param {*} item  item\n */\nexport function inArray(arr: any[], item: any) {\n    return arr.indexOf(item) > -1;\n}\n/**\n * 从目标arr中删除item\n * @param {*} arr  目标数组\n * @param {*} item  item\n */\nexport function deleteArray(arr: any[], item: any) {\n    const index = arr.indexOf(item);\n\n    if (index > -1) {\n        arr.splice(index, 1);\n    }\n}\n\n/**\n * 事件监听兼容处理\n * @param {*} evtTarget  事件监听目标\n * @param {*} evtName   事件名\n * @param {*} callback  回调函数\n * @param {*} options  相关参数设置\n */\nexport function addMonitor(\n    evtTarget: Element | Window | Document,\n    evtName: string,\n    callback: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions,\n) {\n    if ('attachEvent' in evtTarget) {\n        return evtTarget.attachEvent('on' + evtName, callback);\n    }\n    return evtTarget.addEventListener(evtName, callback, options);\n}\n\n/**\n * 事件监听解绑兼容处理\n * @param {*} evtTarget  事件监听目标\n * @param {*} evtName   事件名\n * @param {*} callback  事件回调\n */\nexport function removeMonitor(\n    evtTarget: Element | Window | Document,\n    evtName: string,\n    callback: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions,\n) {\n    if ('attachEvent' in evtTarget) {\n        return evtTarget.detachEvent('on' + evtName, callback);\n    }\n    return evtTarget.removeEventListener(evtName, callback, options);\n}\n\nexport function leftPad(str: string, len: number, ch = ' ') {\n    len = len - str.length;\n    if (len <= 0) {\n        return str;\n    }\n    let pad = '';\n    while (len) {\n        if (len & 1) {\n            pad += ch;\n        }\n        len >>= 1;\n        ch += ch;\n    }\n    return pad + str;\n}\n\n/**\n * 是否是快手系APP\n */\nexport const isInApp = (ua = window.navigator.userAgent.toLowerCase()) => {\n    try {\n        for (let i = 0; i < ksAppList.length; i++) {\n            if (ua.indexOf(ksAppList[i]!.toLowerCase()) > -1) {\n                return true;\n            }\n        }\n    } catch (err) {\n        return false;\n    }\n};\n\nexport function parseQueryString(queryString: string) {\n    const result: any = {};\n    const queries = queryString.split('&');\n    for (const query of queries) {\n        const [key, value] = query.split('=');\n        if (!(key! in result)) {\n            result[key!] = value;\n            continue;\n        }\n        if (result[key!] instanceof Array) {\n            result[key!].push(value);\n            continue;\n        }\n        result[key!] = [result[key!], value];\n    }\n    return result;\n}\n\nexport function stringifyQuery(paramsString: any) {\n    const params = typeof paramsString === 'string' ? JSON.parse(paramsString) : paramsString;\n    const queries: string[] = [];\n    Object.keys(params).forEach(key => {\n        if (params[key] instanceof Array) {\n            for (const val of params[key]) {\n                queries.push(`${key}=${val}`);\n            }\n        } else if (typeof params[key] === 'object' && params[key] !== null) {\n            queries.push(`${key}=${JSON.stringify(params[key])}`);\n        } else {\n            queries.push(`${key}=${params[key]}`);\n        }\n    });\n    return queries.join('&');\n}\n\n// 参考：https://codereview.stackexchange.com/questions/37512/count-byte-length-of-string\nexport function getStringBytes(data: any) {\n    let dataStr = '';\n\n    // Force string type\n    if (typeof data === 'string') {\n        dataStr = data;\n    } else {\n        try {\n            dataStr = JSON.stringify(data);\n        } catch (e) {\n            dataStr = String(data);\n        }\n    }\n\n    let byteLen = 0;\n    for (let i = 0; i < dataStr.length; i++) {\n        const c = dataStr.charCodeAt(i);\n        byteLen += c < (1 << 7) ? 1 :\n            c < (1 << 11) ? 2 :\n                c < (1 << 16) ? 3 :\n                    c < (1 << 21) ? 4 :\n                        c < (1 << 26) ? 5 :\n                            c < (1 << 31) ? 6 : Number.NaN;\n    }\n    return byteLen;\n}\n\n/**\n * lodash 的 pick 方法\n */\nexport function pick(data: any, paths: string[]) {\n    let index = -1;\n    const length = paths.length;\n    const result: any = {};\n\n    while (++index < length) {\n        const path = paths[index];\n        const value = data[path!];\n        result[path!] = value;\n    }\n\n    return result;\n}\n\n/**\n * lodash的omit方法\n * @param data\n * @param paths\n */\nexport function omit(data: any, paths: string[]) {\n    const result: any = {};\n\n    for (const i in data) {\n        if (data.hasOwnProperty(i)) {\n            if (Array.isArray(paths) && paths.indexOf(i) === -1) {\n                result[i] = data[i];\n            }\n        }\n    }\n\n    return result;\n}\n\n/**\n * 检查依赖版本号是否不小于推荐版本\n */\nexport function checkVersion(recommendVersion: string, version: string) {\n    if (!version) return false;\n    if (version.indexOf('alpha') !== -1) return false;\n    if (version.indexOf('beta') !== -1) return false;\n    try {\n        let matches = recommendVersion.match(/\\d+\\.\\d+\\.\\d+/);\n        recommendVersion = matches?.[0] || '';\n        if (!recommendVersion) return true;\n\n        matches = version.match(/\\d+\\.\\d+\\.\\d+/);\n        version = matches?.[0] || '';\n        if (!version) return false;\n\n        const [rMajor, rMinor, rPatch] = recommendVersion.split('.').map((i: string) => Number(i));\n        const [major, minor, patch] = version.split('.').map((i: string) => Number(i));\n\n        if (major! < rMajor!) return false;\n        if (major! > rMajor!) return true;\n\n        if (minor! < rMinor!) return false;\n        if (minor! > rMinor!) return true;\n\n        if (patch! < rPatch!) return false;\n\n        return true;\n    } catch (err) {\n        return false;\n    }\n}\n\nexport function checkSupportCloseCoPage() {\n    const version = getCookie('appver', undefined, true);\n    return version && checkVersion('10.8.30', version);\n}\n/**\n * 获取元素xpath\n * @param element 元素\n */\nexport function getXpathFromNode(element: HTMLElement): string {\n    // if (element && element.id !== '')\n    //     return 'id(\"' + element.id + '\")';\n    if (element === document.body)\n        return 'HTML/' + element.tagName;\n\n    let ix = 0;\n    if (element && element.parentNode) {\n        const siblings = element.parentNode.childNodes;\n        for (let i = 0; i < siblings.length; i++) {\n            const sibling = siblings[i] as HTMLElement;\n            if (sibling === element)\n                return getXpathFromNode(element.parentNode as HTMLElement) + '/' + element.tagName + '[' + (ix + 1) + ']';\n            if (sibling.nodeType === 1 && sibling.tagName === element.tagName)\n                ix++;\n        }\n    }\n    return '';\n}\n\n/**\n * url中获取path和query\n */\nexport function getPathAndQueryFromUrl() {\n    const { protocol, host, pathname, search, href } = window.location;\n    const pageUrl = href;\n    const pagePath = protocol + host + pathname;\n    const pageParams = parseQueryString(search.slice(1));\n    return { pageUrl, pagePath, pageParams };\n}\n\nexport function getUrlAndQueryFromUrl(url = location.href) {\n    const queryIndex = url.lastIndexOf('?');\n    if (queryIndex === -1) {\n        return {\n            page: url\n        };\n    }\n    const page = url.slice(0, queryIndex);\n    const queryString = url.slice(queryIndex + 1);\n    return {\n        page,\n        params: parseQueryString(queryString),\n    };\n};\n\nexport const getMappingPage = (urlPackage: UrlMapFnParam, urlMap?: UrlMap | UrlMapFn) => {\n    let { url, page, params, pageId } = urlPackage;\n    if (!page && typeof url === 'string') {\n        const parsed = getUrlAndQueryFromUrl(url);\n        page = parsed.page;\n        params = parsed.params;\n    }\n    if (typeof urlMap === 'function') {\n        try {\n            const res = urlMap({ url, page, params });\n            if (typeof res === 'string') {\n                page = res;\n            } else if (typeof res === 'object') {\n                if (res.page) {\n                    page = res.page;\n                }\n                if (res.params) {\n                    params = res.params;\n                }\n                if (res.pageId) {\n                    pageId = res.pageId;\n                }\n            }\n        } catch (err) { }\n    } else if (typeof urlMap === 'object') {\n        let mappingPage = '';\n        for (const key in urlMap) {\n            if ((url || page || '').indexOf(key) > -1) {\n                mappingPage = urlMap[key]!;\n                break;\n            }\n        }\n        if (mappingPage) {\n            page = mappingPage;\n        }\n    }\n    return {\n        page,\n        params,\n        pageId\n    };\n};\n\nexport function cloneDeep(obj: [] | {}): [] | {} {\n    if (typeof obj !== 'object') return {};\n    const newObj = obj instanceof Array ? [] : {};\n    for (const key in obj) {\n        if (obj.hasOwnProperty(key)) {\n            // @ts-ignore\n            newObj[key] = typeof obj[key] === 'object' ? cloneDeep(obj[key]) : obj[key];\n        }\n    }\n    return newObj;\n}\n\n/**\n * 非空纯对象判定\n * @param obj\n * @returns\n */\n const isObj = (obj: any) => obj && typeof obj === 'object' && !Array.isArray(obj);\n /**\n  * 对象打平赋值\n  * @param target\n  * @param options\n  * @returns\n  */\n export const flattenAssign = (target: any, options: any) => {\n    if (!isObj(target) || !isObj(options)) return;\n    const merge = (obj1: any, obj2: any, key: string) => {\n        if (isObj(obj1[key]) && isObj(obj2[key])) {\n            Object.assign(obj1[key], obj2[key]);\n        } else if (!isObj(obj1[key]) && !isObj(obj2[key])){\n            obj1[key] = obj2[key];\n        }\n    }\n    for (const key in options) {\n        if (target.hasOwnProperty(key)) {\n            merge(target, options, key);\n            continue;\n        }\n        for (const deepKey in target) {\n            if (isObj(target[deepKey]) && target[deepKey].hasOwnProperty(key)) {\n                merge(target[deepKey], options, key);\n            }\n        }\n    }\n}\n\nexport function pageUrlValidate(page: string) {\n    // 对于上报到v2，page为url的埋点，给予警告\n    if (page && /^(https?:)?\\/\\//.test(page)) {\n        error('[error 108]',`请注意当前埋点页面信息为 ${page}，不符合规范，上报失败！`);\n        return false;\n    }\n    return true;\n}\n\nexport const getResolution = (() => {\n    let resolution = '';\n    return () => {\n        if (resolution) {\n            return resolution;\n        }\n        try {\n            const ratio = window.devicePixelRatio || 1;\n            const width = Math.floor(screen.width * ratio); // 有的devicePixelRatio为小数，在此转为整数\n            const height = Math.floor(screen.height * ratio);\n            resolution = `${width}x${height}`;\n            return resolution;\n        } catch (err) {\n            return '';\n        }\n    };\n})();\n\n// 从vue-router里面拿的……\nexport function supportsPushState() {\n    const ua = window.navigator.userAgent;\n    if (\n        (ua.indexOf('Android 2.') !== -1 || ua.indexOf('Android 4.0') !== -1)\n        && ua.indexOf('Mobile Safari') !== -1\n        && ua.indexOf('Chrome') === -1\n        && ua.indexOf('Windows Phone') === -1\n    ) {\n        return false;\n    }\n    return window.history && 'pushState' in window.history;\n}\n\nexport function deleteUrlQueryAndReturnFullUrl(url: string, deleteKeyArray: string[]) {\n    const { page, params } = getUrlAndQueryFromUrl(url);\n    if (Array.isArray(deleteKeyArray) && deleteKeyArray.length) {\n        deleteKeyArray.forEach(key => {\n            delete params[key];\n        });\n        let paramsString = '';\n        for (const i in params) {\n            if (params.hasOwnProperty(i)) {\n                paramsString += paramsString ? '&' : '';\n                paramsString += `${i}=${params[i]}`;\n            }\n        }\n        return paramsString ? `${page}?${paramsString}` : page;\n    }\n    return url;\n}\n\ninterface TypeQueryMap {\n    [key: string]: string | number;\n}\n\n/**\n * 设置url中的参数，并返回完整url\n * @param url\n * @param configQueryMap\n */\nexport function setUrlQueryAndReturnFullUrl(url: string, configQueryMap: TypeQueryMap): string {\n    if (typeof configQueryMap !== 'object') {\n        return url;\n    }\n    let paramsString = '';\n    for (const i in configQueryMap) {\n        if (configQueryMap.hasOwnProperty(i)) {\n            const paramString = `${i}=${configQueryMap[i]}`;\n            paramsString += paramsString ? `&${paramString}` : paramString;\n        }\n    }\n    let partUrl;\n    const lastChar = url[url.length - 1];\n    if (url.indexOf('?') === -1) {\n        // 不存在变量\n        partUrl = `?${paramsString}`;\n    } else if (lastChar === '?' || lastChar === '&') {\n        // 处理最后一个字符是 ? 以及 & 的特殊情况\n        partUrl = paramsString;\n    } else {\n        // 正常添加变量\n        partUrl = `&${paramsString}`;\n    }\n    return url + partUrl;\n}\n\nexport function isMobileAndIpad() {\n    const ua = window?.navigator?.userAgent || '';\n    const isMobile = /mobile|tablet|ip(ad|hone|od)|android|(windows phone)/i.test(ua);\n    // 兼容最新版本 ipad 版本 ua 判断\n    const isiPad = window?.navigator.platform === 'MacIntel' && window?.navigator?.maxTouchPoints > 1;\n    return isMobile || isiPad;\n}\n\n/**\n * 是否支持 worker gzip 压缩\n * @returns\n */\nexport const enableAsyncGzip = () => !!(\n    window?.Worker // 可以新建 worker\n    && window?.Uint8Array // 支持二进制存储\n    && window.URL // 可以创建文件路径\n    && window.Promise // 可以使用 promise\n    && !isMobileAndIpad() // 移动端禁止使用压缩\n);\n\n/**\n * 返回正整数数值\n * @param value\n */\nexport const getPositiveInteger = (value: number) => {\n    try {\n        return Math.abs(Math.floor(value));\n    } catch (e) {\n        return value;\n    }\n};\n\nexport function stringifyParams(params: string | any) {\n    return typeof params === 'string' ? params : typeof params === 'object' ? JSON.stringify(params) : '';\n}\n","// 为了减少点代码体积，自己搞一个简易的EventEmitter\nimport { deleteArray } from '.';\n\nexport default class EventEmitter {\n    private events: {\n        [key: string]: Array<(...args: any[]) => void>;\n    } = {};\n    on(eventName: string, callback: (...args: any[]) => void) {\n        if (callback && typeof callback === 'function') {\n            this.events[eventName] = this.events[eventName] || [];\n            this.events[eventName]?.push(callback);\n        }\n    }\n    off(eventName: string, callback?: (...args: any[]) => void) {\n        if (!this.events[eventName]) {\n            return;\n        }\n        if (callback && typeof callback === 'function') {\n            const array = this.events[eventName]\n            if (array) {\n                deleteArray(array, callback);\n            }\n        }\n        if (!callback) {\n            this.events[eventName] = [];\n        }\n    }\n    emit(eventName: string, ...args: any[]) {\n        if (!this.events[eventName]) {\n            return;\n        }\n        this.events[eventName]?.forEach(callback => {\n            callback(...args);\n        });\n    }\n}\n","import type { LogPackage, BatchLog as Logger } from './logger';\nimport type { BasePlugin, BasePluginConstructor } from '@/plugins/base';\nimport type { ClientLog as ClientLogV3 } from '../proto/v3/client_log';\nimport type { CommonPackage, CommonPackageOptions } from './common';\nimport type { HttpCommonPackage, CommonConfig, UrlObj, PageTypeKey } from '@/types/configuration';\nimport Global from '../config/global';\nimport UrlPackage from './url-package';\nimport EventEmitter from '../util/events';\nimport initConfig from '@/config';\nimport { error } from '@/util/console';\nimport type {\n    EventType as IEventType,\n    EventOptions as IEventOptions,\n    ImmediatelyEventOptions\n} from '@/types/event';\n\nlet pluginIndex = 0;\n\nexport default class Weblog extends EventEmitter {\n    static __instance: Weblog;\n    version: string = '__VERSION__';\n    currentUrlPackage!: UrlPackage;\n    referUrlPackage?: UrlPackage;\n    baseOption: HttpCommonPackage;\n    logConfig: CommonConfig;\n    // 核心日志发送\n    logger!: Logger;\n    commonPackage!: CommonPackage;\n    // 插件\n    plugins: {\n        [key: string]: BasePlugin | any;\n    } = {};\n    /**\n     * @param {?object} logConfig Logger初始化配置\n     * @param {object=} options 额外配置参数\n     *                    - base 公参的覆盖\n     */\n    constructor(\n        logConfig: CommonConfig,\n        base?: HttpCommonPackage,\n    ) {\n        super();\n        // 初始化初始化参数配置和埋点基础信息配置\n        this.baseOption = { ...base };\n        this.logConfig = initConfig(logConfig);\n        // 初始化页面信息\n        this.initUrlPackage();\n        // 记录首个实例\n        if (!Weblog.__instance) {\n            Weblog.__instance = this;\n        }\n    }\n\n    get sessionId() {\n        return Global.sessionId;\n    }\n\n    initUrlPackage() {\n        this.updateCurrentUrlPackage();\n    }\n\n    /**\n     * 更新当前 url 信息\n     * @param url\n     * @param type\n     */\n    updateCurrentUrlPackage(url: UrlObj | string = {}, type: PageTypeKey = 'web') {\n         // 该接口不改变 refer 信息\n        if (typeof url === 'object' && url.page) {\n            if (this.currentUrlPackage && url.page === this.currentUrlPackage.page) {\n                return this.currentUrlPackage.update(url.page, url.params);\n            }\n        }\n        this.currentUrlPackage = new UrlPackage(url as UrlObj, type);\n    }\n\n    /**\n     * 更新 refer url 信息\n     * @param url\n     * @param type\n     */\n    updateReferUrlPackage(url: UrlObj | UrlPackage | string = this.currentUrlPackage, type: PageTypeKey = 'web') {\n        if (url instanceof UrlPackage) {\n            this.referUrlPackage = url;\n        } else {\n            this.referUrlPackage = new UrlPackage(url as UrlObj, type);\n        }\n    }\n    /**\n     * 重设 common_package 信息\n     * @param base\n     */\n    updateBase(base: HttpCommonPackage) {\n        this.updateCommonPackage(base);\n    }\n    /**\n     * 更新现有 common_package 信息\n     */\n    updateCommonPackage(options: HttpCommonPackage | CommonPackageOptions) {\n        if (typeof options !== 'object') return;\n        this.commonPackage.update(options);\n    }\n\n    /**\n     * 初始化插件\n     * @param plugins\n     */\n    addPlugins() {\n        if (!this.logConfig.plugins || !this.logConfig.plugins.length) return;\n        // 类似 webpack plugins 的实例数组\n        this.logConfig.plugins.forEach((plugin: any) => {\n            if (typeof plugin === 'object' && typeof plugin.apply === 'function') {\n                this.addPluginInstance(plugin);\n            }\n        });\n    }\n    /**\n     * 加载插件实例\n     */\n    addPluginInstance(pluginInstance: any) {\n        if (pluginInstance) {\n            const key = pluginInstance.key || pluginInstance.constructor && pluginInstance.constructor.key || `plugin_auto_key_${pluginIndex++}`;\n            if (typeof pluginInstance.apply === 'function'\n                && (!pluginInstance.weblog || pluginInstance.weblog !== this)\n            ) {\n                pluginInstance.apply(this);\n            }\n            this.plugins[key] = pluginInstance;\n        }\n    }\n    /**\n     * 加载插件构造函数\n     * @param plugin\n     * @param pluginOptions\n     */\n    plug(plugin: BasePluginConstructor, pluginOptions?: any) {\n        if (this.plugins[plugin.key]) {\n            return error('[code 301]', `${plugin.key} 插件重复加载！`)\n        }\n        this.addPluginInstance(new plugin(this, pluginOptions));\n    }\n\n    unplug(name: string) {\n        const plugin = this.plugins[name];\n        if (plugin) {\n            plugin.destroy();\n            delete this.plugins[name];\n        }\n    }\n\n    unplugAll() {\n        for (const key in this.plugins) {\n            if (this.plugins[key]) {\n                this.unplug(key);\n            }\n        }\n    }\n\n    public flush = () => {\n        this.logger.flush();\n    }\n    /**\n     * 扩展类实现\n     * @param eventType \n     * @param eventOptions \n     * @returns \n     */\n    generateLog<T extends IEventType>(\n        eventType: T,\n        eventOptions?: IEventOptions<T>\n    ) {\n        return {};\n    }\n    send<T extends IEventType>(type: T, options: IEventOptions<T>, immediately?: boolean) {\n        const log = this.generateLog(type.toUpperCase() as T, options) as ClientLogV3.ReportEvent;\n        // @ts-ignore\n        if (typeof this.beforeSend === 'function') {\n            // @ts-ignore\n            this.beforeSend(type, options, log);\n        }\n        return this.logger.send(log, !!immediately, (options as ImmediatelyEventOptions<T>).callback);\n    }\n    /**\n     * 收集上报\n     * @param type \n     * @param options \n     * @returns \n     */\n    collect<T extends IEventType>(type: T, options: IEventOptions<T>): void {\n        this.send(type, options);\n    }\n\n    sendImmediately<T extends IEventType>(type: T, options: IEventOptions<T>): void {\n        this.send(type, options, true);\n    }\n\n    sendPackage(data: LogPackage, callback?: (error?: any) => void) {\n        this.logger.sendPackage(data, callback);\n    }\n\n    destroy() {\n        this.unplugAll();\n    }\n}\n","import type { HybridWeblogInitParams } from '@/types/configuration';\n\nexport default (options?: HybridWeblogInitParams[0]): HybridWeblogInitParams[0] => {\n    const logConfig: HybridWeblogInitParams[0] = {\n        env: 'production',\n        proto: 'v3',\n        timeout: 30000,\n        wait: 1000,\n        maxBatchLength: 50,\n        sampleRate: 1,\n        // 尝试从全局中获取 yoda\n        yoda: typeof window !== 'undefined' && (window as any).yoda,\n        forbidV2HttpUrlPage: true,\n        ...(options || {})\n    };\n    return logConfig;\n};\n\nexport type LogConfig =  HybridWeblogInitParams[0];\n\nexport type BridgeLogConfig = {\n    /**\n     * 是否禁止 PV，用于将 H5 作为端内元素上报，不会上报 PV 事件\n     */\n    disablePV?: boolean;\n\n    /**\n     * 自定义事件所属的业务线，如 LIVE、ESHOP 等\n     */\n    biz?: string;\n    /**\n     * 是否在 bridge 模式下同时开启 HTTP 上报\n     */\n    openHttpSender?: boolean;\n}","type MPType = 'MP_WECHAT' | 'MP_ALIPAY' | 'MP_BAIDU' | 'MP_KUAISHOU';\n\ntype KeyType = 'WECHART' | 'ALIPAY' | 'BAIDU' | 'KUAISHOU';\n\nexport const MP: {[key in KeyType]: MPType} = {\n    WECHART: 'MP_WECHAT',\n    ALIPAY: 'MP_ALIPAY',\n    BAIDU: 'MP_BAIDU',\n    KUAISHOU: 'MP_KUAISHOU',\n};\n\nexport function getMpContainer(): MPType {\n    try {\n        // @ts-ignore\n        if (typeof wx === 'object' && Object.keys(wx).length) {\n            return MP.WECHART;\n        }\n        // @ts-ignore\n        if (typeof my === 'object' && Object.keys(my).length) {\n            return MP.ALIPAY;\n        }\n        // @ts-ignore\n        if (typeof swan === 'object' && Object.keys(swan).length) {\n            return MP.BAIDU;\n        }\n        // @ts-ignore\n        if (typeof ks === 'object' && Object.keys(ks).length) {\n            return MP.KUAISHOU;\n        }\n        return MP.WECHART;\n    } catch (e) {\n        return MP.WECHART;\n    }\n}\n\nexport function getMpObject() {\n    if (typeof wx === 'object') {\n        return wx;\n    }\n    // @ts-ignore\n    if (typeof my === 'object') {\n        // @ts-ignore\n        return my;\n    }\n    // @ts-ignore\n    if (typeof swan === 'object') {\n        // @ts-ignore\n        return swan;\n    }\n    // @ts-ignore\n    if (typeof ks === 'object') {\n        // @ts-ignore\n        return ks;\n    }\n    return wx;\n};\n\nexport const mp = getMpObject();\n\nexport const isAlipay = getMpContainer() === MP.ALIPAY;\n","/**\n * 将相对时间转换为时间戳\n * 年(y), 月(M)、日(d)、小时(h)、分(m)、秒(s)\n * 如传入 '23h-59m-59s' 会返回调用函数开始后 23 小时 50 分 59 秒后的时间戳\n *\n * @param {string} relativeTime 相对时间\n * @return {number} 转换后的时间戳\n */\nimport { mp, isAlipay } from './global';\n\nconst relativeTimeToTimestamp = function () {\n    const validUnit = 'yMdhms'; // 不考虑精度要求非常严格的情况，如需要，另外写方法\n\n    const yearTimeNumber = 31536000; // 1y = 60 * 60 * 24 * 365，精度要求没有那么严格，所以年都按 365 天算\n\n    const monthTimeNumber = 2592000; // 1m = 60 * 60 * 24 * 30，精度要求没有那么严格，所以月都按 30 天算\n\n    const dayTimeNumber = 86400; // 1d = 60 * 60 *24\n\n    const hourTimeNumber = 3600; // 1h = 60 * 60\n\n    return function (relativeTime: string) {\n      if (typeof relativeTime !== 'string') {\n        throw Error(\"The relativeTime must be an string but received \".concat(relativeTime));\n      }\n\n      var currentTime = Date.now();\n      var timeCount = 0;\n      relativeTime.split('-').forEach(function (time) {\n        var timeNumber = parseInt(time.slice(0, -1), 10);\n        var timeUnit = time[time.length - 1]!;\n\n        if (/\\D/.test(time.slice(0, -1)) || typeof timeNumber !== 'number' || validUnit.indexOf(timeUnit) === -1) {\n          throw Error(\"The releated time you passed '\" + relativeTime + \"' is not valid. It should use '-' as the separator, and should be number except the last char which should be y|M|d|h|m|s of each item\");\n        }\n\n        switch (timeUnit) {\n          case 'y':\n            timeCount += yearTimeNumber * timeNumber;\n            break;\n\n          case 'M':\n            timeCount += monthTimeNumber * timeNumber;\n            break;\n\n          case 'd':\n            timeCount += dayTimeNumber * timeNumber;\n            break;\n\n          case 'h':\n            timeCount += hourTimeNumber * timeNumber;\n            break;\n\n          case 'm':\n            timeCount += 60 * timeNumber;\n            break;\n\n          case 's':\n            timeCount += timeNumber;\n            break;\n        }\n      });\n      return currentTime + timeCount * 1000;\n    };\n}();\n// 抹平小程序接口差异\nconst getStorageSync = (key: string) => {\n    if (isAlipay) {\n        const res = mp.getStorageSync({ key });\n        // 支付宝平台会返回一个 success 值，但是目前测试的结果这个始终是 true。当没有存储数据的时候，其它平台会返回空字符串。\n        return res.data !== null ? res.data : '';\n    } else {\n        const res = mp.getStorageSync(key);\n        return res;\n    }\n};\n\nconst setStorageSync = (key: string, data: any) => {\n    if (isAlipay) {\n        mp.setStorageSync({\n            key,\n            data,\n        });\n    } else {\n        mp.setStorageSync(key, data);\n    }\n}\n\nconst prefix = 'ks_storage_';\n/*\n * @Author: AndySong\n * @Date: 2018-07-30 22:26:21\n * @LastEditors: AndySong\n * @LastEditTime: 2018-08-02 02:48:52\n * @Description: 本地存储包装\n */\nclass Storage {\n    cache: { [key: string]: any } = {}\n    /**\n     *\n     * 获取 storage 完整信息\n     * @param {*} key\n     */\n    getCompleteStorage(key: string) {\n        let item = null;\n        const fullKey = prefix + key;\n        try {\n            // cache 中没有就同步到 cache\n            if (this.cache[fullKey] == null) {\n                this.cache[fullKey] = getStorageSync(fullKey);\n            }\n            item = this.cache[fullKey];\n        } catch (e) {\n            console.error(`getCompleteStorage('${fullKey}')`, e);\n        }\n\n        return item;\n    }\n\n    /**\n     *\n     * 获取 storage value\n     * @param {*} key\n     */\n    get(key: string) {\n        let value = null;\n\n        try {\n            const item = this.getCompleteStorage(key);\n            if (typeof item === 'object' && item.isSDKStorage) {\n                const { value: realValue, expirationTime } = item;\n\n                // 过期删除\n                if (expirationTime && hasExpried(expirationTime)) {\n                    this.remove(key);\n                } else {\n                    value = realValue;\n                }\n            } else {\n                value = item;\n            }\n        } catch (e) {\n            console.error(`get('${prefix + key}')`, e);\n        }\n\n        return value;\n    }\n\n    /**\n     *\n     * 设置 storage value\n     * @param {string} key 设置的key\n     * @param {*} value 设置的值\n     * @param {number} [expirationTime] 过期时间，超过后这个 key 会清空，value 为 null\n     * @param {boolean} [sync] 是否同步设置storage\n     */\n    set(key: string, value: any, expirationTime?: string | number, sync = false) {\n        let status = false;\n        const fullKey = prefix + key;\n        try {\n            expirationTime =\n                expirationTime &&\n                (isAllNumber(expirationTime)\n                    ? Number(expirationTime)\n                    : relativeTimeToTimestamp(expirationTime + ''));\n\n            const storage = {\n                value,\n                isSDKStorage: true,\n                expirationTime,\n            };\n            // 性能优化: 无更新的「基本数据类型值」不需要 set;「引用数据类型值」需要调用方处理优化\n            const valueNoChange =\n                ['number', 'string', 'boolean'].indexOf(typeof value) > -1 &&\n                value === this.get(key);\n            if (!valueNoChange) {\n                if (sync) {\n                    setStorageSync(fullKey, storage);\n                } else {\n                    mp.setStorage({\n                        key: fullKey,\n                        data: storage,\n                        fail: (e: Error) => {\n                            // fail 情况下, cache 和 storage 不同步, 上报\n                            console.error(\n                                'mp.setStorage failed: ',\n                                { key: fullKey, value },\n                                e\n                            );\n                        },\n                    });\n                }\n                this.cache[fullKey] = storage;\n            }\n            status = true;\n        } catch (e) {\n            console.error('set(...), arguments: ', { key: fullKey, value }, e);\n        }\n\n        return status;\n    }\n\n    /**\n     *\n     * 删除 storage\n     * @param {string} key\n     */\n    remove(key: string) {\n        let status = false;\n        const fullKey = prefix + key;\n        try {\n            delete this.cache[fullKey];\n            mp.removeStorage({\n                key: fullKey,\n                fail: (e: Error) => {\n                    // fail 情况下, cache 和 storage 不同步, 上报\n                    console.error('mp.removeStorage failed', e);\n                },\n            });\n            status = true;\n        } catch (e) {\n            console.error(`remove('${fullKey}')`, e);\n        }\n\n        return status;\n    }\n\n    /**\n     *\n     * 清除 storage\n     */\n    clear() {\n        let status = false;\n\n        try {\n            this.cache = {};\n            mp.clearStorage({\n                fail: (e: Error) => {\n                    // fail 情况下, cache 和 storage 不同步, 上报\n                    console.error('mp.clearStorage failed', e);\n                },\n            });\n            status = true;\n        } catch (e) {\n            console.error(`clear('${prefix}')`, e);\n        }\n\n        return status;\n    }\n}\n\nfunction hasExpried(expirationTime: string | number) {\n\n    if (expirationTime === undefined || /\\D/.test(expirationTime + '')) {\n        return true;\n    }\n\n    return expirationTime < Date.now();\n}\n\nfunction isAllNumber(value: string | number) {\n    if (typeof value === 'number') {\n        value = '' + value;\n    }\n\n    return !/\\D/.test(value);\n}\n\nexport default new Storage();\n","import type { Base } from '../proto/base';\nimport type { ClientEvent as ClientEventV3 } from '../proto/v3/client_event';\n\nexport interface UrlObj {\n    page?: string;\n    params?: any;\n    pageId?: string;\n    force?: boolean;\n}\n\nexport interface UrlMapFnParam {\n    url?: string;\n    page?: string;\n    params?: any;\n    pageId?: string;\n}\n\n/**\n * 全局附加属性\n */\nexport type GlobalAttr = {\n    entry_tag?: EntryTagType[];\n    [key: string]: any;\n}\n\nexport type UrlMapFn = (param: UrlMapFnParam) => (UrlObj | string);\nexport type BaseOptions = {\n    /**\n     * did\n     */\n    device_id?: string;\n    /**\n     * 预留字段, 端内页面不可缺省，服务端需解密\n     */\n    global_id?: string;\n    /**\n     * 用户唯一标志\n     */\n    user_id?: string;\n    /**\n     * 标识调用方,产品线（新注册时自动增加）,找韩小龙要\n     * 默认是0，表示产品未被注册= =\n     */\n    product?: number;\n    /**\n     * 来源\n     */\n    channel?: string;\n    /**\n     * 版本名\n     */\n    version_name?: string;\n    /**\n     * 应用包名\n     */\n    package_name?: string;\n    /**\n     * 代替app_product参数上报具体接入的app，具体值请联系韩小龙分配\n     */\n    product_name?: string;\n    /**\n     * 各端设备识的备用参数，例如微信小程序端上报微信内部用户的唯一标识\n     */\n    union_id?: string;\n    /**\n     * 网络类型\n     */\n    network_type?: keyof typeof networkType;\n    /**\n     * 区分平台\n     */\n    container?: Container;\n    /**\n     * 中台服务名称，比如积木、im sdk等，如果业务log未使用中台服务，该字段置空\n     */\n    service_name?: string;\n    /**\n     * 子业务场景\n     */\n    sub_biz?: string;\n    /**\n     * 是否需要加密\n     */\n    need_encrypt?: boolean;\n    /**\n     * 防盗链id\n     */\n    safety_id?: string;\n    /**\n     * AB实验\n     */\n    experiment?: Base.Experiment[];\n    /**\n     * H5 附加参数\n     */\n    h5_extra_attr?: H5ExtraAttr;\n    /**\n     * 表示宿主平台环境，默认是 PC 端 web 页面\n     */\n    platform?: number;\n    /**\n     * 表示页面会话 id\n     */\n    session_id?: string;\n    /**\n     * 全局参数，可用来设置染色参数\n     */\n    global_attr?: GlobalAttr;\n}\n\n// 小程序需要的参数\nexport type MinaBaseOption = BaseOptions & {\n    // 公参的app product字段\n    appProduct?: string;\n    // 批量上报的时间间隔\n    batchReportInterval?: number;\n    // 是否上报都等待一次业务中公参的设定\n    isReportUtilBizPublicParamsBeSet?: boolean;\n    [key: string]: string | boolean | number | undefined;\n};\n\n/**\n * 事件\n */\n// 网络类型\nexport const networkType = {\n    unknown: 0,\n    none: 1,\n    wifi: 2,\n    '4g': 3,\n    '3g': 4,\n    '2g': 5,\n    '5g': 7,\n    'slow-2g': 5,\n};\n\n// 任务事件类型\nexport enum TaskOperations {\n    CLICK = 'CLICK',\n    DOUBLE_CLICK = 'DOUBLE_CLICK',\n    TRIPLE_CLICK = 'TRIPLE_CLICK',\n    LONG_PRESS = 'LONG_PRESS',\n    PULL = 'PULL',\n    DRAG = 'DRAG',\n    SCALE = 'SCALE',\n    PULL_DOWN = 'PULL_DOWN',\n    PULL_UP = 'PULL_UP',\n    AUTO = 'AUTO',\n}\n\n// 事件类型\nexport enum EventTypes {\n    PV = 'PV',\n    SHOW = 'SHOW',\n    VIDEO = 'VIDEO',\n    // Costume\n    CUSTOM = 'CUSTOM',\n    CUSTOM_EVENT = 'CUSTOM_EVENT',\n    RADAR = 'RADAR',\n}\n\nexport type StatusTypes = keyof typeof Base.ActionStatus;\n\nexport type OperationDirectionTypes = keyof typeof Base.Direction;\n\nexport type TaskStatusTypes = keyof typeof Base.TaskStatus;\n\nexport interface OtherEventOptions {\n    name: string;\n    params?: any;\n    referUrlPackage?: Base.UrlPackage;\n    currentUrlPackage: Base.UrlPackage;\n    contentPackage?: ContentPackage;\n    status?: TaskStatusTypes;\n    taskType?: TaskEventTypeStrings;\n    eventId?: string;\n    operationDirection?: OperationDirectionTypes;\n}\n\n// H5 附加参数\nexport interface H5ExtraAttr {\n    // 主要用于 bridge 模式下，将当前产品的 product_name 透传\n    product_name?: string;\n    // 描述实际埋点对应的产品名称。比如一个h5的产品A，嵌入到产品B中使用，则product_name = A\n    host_product?: string;\n    // 宿主客户端版本号\n    app_version_name?: string;\n    seq_id?: number;\n    http_seq_id?: number;\n    domain?: string;\n    [key: string]: any;\n}\n\n/**\n * 染色参数\n *  page_name: 页面标识，\n *  element_action: 元素标识，\n *  stid：策略id（格式由小分队提供），\n *  pos：位置信息1，\n *  params:{元素参数1}\n */\nexport interface EntryTagType {\n    page_name?: string;\n    element_action?: string;\n    stid?: string;\n    pos?: number;\n    params?: {[key: string]: any};\n}\n\nexport type PageTypeKey = 'web' | 'native' | 'mina';\n\nexport type Container = 'NATIVE' | 'REACT_NATIVE' | 'H5' | 'MP_WECHAT' | 'MP_ALIPAY' | 'MP_BAIDU' | 'MP_KUAISHOU' | 'WEB';\n\nexport interface UrlMap {\n    [key: string]: string;\n}\n\nexport type ContentPackage = string | {[key: string]: any};\n\nexport interface ShowEventOptions {\n    type?: string;\n    referUrlPackage?: Base.UrlPackage;\n    currentUrlPackage: Base.UrlPackage;\n    action: 'enter' | 'leave' | 'hidden' | 'visible';\n    beginTime?: number;\n    name?: string;\n    timeCost?: number;\n    params?: any;\n    contentPackage?: ContentPackage;\n    status?: StatusTypes;\n    operationDirection?: OperationDirectionTypes;\n    actionType?: keyof typeof Base.ActionType;\n    auto?: boolean;\n    eventId?: string;\n    disablePV?: boolean;\n    /**\n     * 向客户端透传的日志信息，如 stid\n     */\n    feedLogCtx?: {\n        stidContainer?: string;\n        [key: string]: any;\n    };\n}\n\nexport interface ShowEventProps {\n    referUrlPackage?: Base.UrlPackage;\n    currentUrlPackage: Base.UrlPackage;\n    type: 'enter' | 'leave' | 'hidden' | 'visible';\n    beginTime?: number;\n    name: string;\n    params?: any;\n    contentPackage?: ContentPackage;\n    status?: StatusTypes;\n    eventId?: string;\n    operationDirection?: OperationDirectionTypes;\n    actionType?: keyof typeof Base.ActionType;\n    auto?: boolean;\n}\n\nexport type TaskEventTypeStrings = keyof typeof ClientEventV3.TaskEventType;\n\nexport type TaskEventOperationTypes = keyof typeof Base.OperationType;\nexport interface TaskEventOptions {\n    sessionId?: string;\n    referUrlPackage?: Base.UrlPackage;\n    currentUrlPackage: Base.UrlPackage;\n    name: string;\n    params?: any;\n    type: TaskOperations;\n    contentPackage?: ContentPackage;\n    status?: StatusTypes;\n    taskType?: string;\n    operationDirection?: keyof typeof Base.Direction;\n    eventId?: string;\n    disablePV?: boolean;\n}\n\nexport interface CustomStatEventOptions {\n    name: string;\n    params: any;\n    currentUrlPackage: Base.UrlPackage;\n    referUrlPackage?: Base.UrlPackage;\n    [key: string]: any;\n    eventId?: string;\n}\n\nexport interface Weblogger {\n    logConfig: any;\n    collect: (type: string, ...params: any) => void;\n    sendImmediately: (type: string, ...params: any) => void;\n    plug: (params: any, options?: any) => void;\n    addPluginInstance: (plugin: any) => void;\n    unplug: (name: string) => void;\n    updateBase: (options: BaseOptions) => void;\n    updateCommonPackage: (options: BaseOptions) => void;\n    updateReferUrlPackage: (url?: string | UrlObj, type?: 'web' | 'native' | 'mina') => void;\n    updateCurrentUrlPackage: (url: string | UrlObj, type?: 'web' | 'native' | 'mina') => void;\n    flush: () => void;\n    logger: any;\n    currentUrlPackage: Base.UrlPackage & { getRealUrlPackage: Function, update: (page: string, params: any, pageId?: string) => void, toJSON: () => void; };\n    referUrlPackage?: Base.UrlPackage & { getRealUrlPackage: Function };\n    commonPackage: any;\n    baseOption: any;\n    plugins: {[key: string]: any};\n    bridge?: any;\n    yoda?: any;\n    entryTag?: any;\n    sessionId: string;\n    SampledPageMap?: { [key: string]: boolean | { radar: { [key: string]: number; }; }; };\n    Utils: {\n        [key: string]: any;\n    };\n    beforeUnload: (event: Event) => void;\n    initBuildInPlugins?: (option?: any) => any;\n    addPlugins: () => void;\n    unplugAll: () => void;\n    on: (event: 'event', handler: (e: {type: string, action: string; data: any}) => void) => void;\n    off: (event: 'event', handler: (e?: any) => void) => void;\n    generateLog: (\n        type: string | SendConfig,\n        name: string | PVOptions | ShowOptions | TaskOptions | CustomOptions | OtherEventOptions,\n        params?: any,\n        contentPackage?: ContentPackage,\n        factory?: (type: string, data: any) => any,\n    ) => any;\n    getEntryTags?: () => Base.EntryTagType[];\n    setEntryTag?: (entryTag: Base.EntryTagType) => void;\n    consumeEntryTag?: (identity: string) => Base.EntryTagType[];\n    clearEntryTag?: (identity: string, containSelf: boolean) => void;\n    sendByHttp?: (type: string, ...params: any) => void;\n}\n\nexport type WeblogClass = {\n    __instance: Object;\n};\n\nexport type AutoPVFilter = (newUrl: string, oldUrl: string | null, type: 'enter' | 'leave' | 'hidden' | 'visible') => boolean;\n\n/**\n * PV 类型参数\n */\nexport interface PVOptions {\n    page?: string;\n    identity?: string;\n    pageId?: string;\n    pageType?: string;\n    params?: string | any;\n    contentPackage?: ContentPackage;\n    currentUrlPackage?: Base.UrlPackage;\n    status?: StatusTypes;\n    type?: 'enter' | 'leave' | 'hidden' | 'visible';\n    beginTime?: number;\n    eventId?: string;\n    auto?: boolean;\n    name?: string; // 小程序专用\n    timeCost?: number;\n    /**\n     * 是否是半屏页面\n     */\n    coPage?: boolean;\n    callback?: (error?: any) => void;\n    feedLogCtx?: {\n        stidContainer?: string;\n        [key: string]: any;\n    };\n}\n\nexport interface UrlPage {\n    page: string; // url_package.page 当前 page 的 name\n    identity?: string;\n    params?: any;\n    coPage?: boolean;\n}\n\n/**\n * Show 类型参数\n */\nexport interface ShowOptions {\n    action: string;\n    params?: any;\n    contentPackage?: ContentPackage;\n    currentUrlPackage?: Base.UrlPackage;\n    eventId?: string;\n    urlPage?: UrlPage;\n    disablePV?: boolean;\n    /**\n     * 向客户端透传的日志信息，如 stid\n     */\n    feedLogCtx?: {\n        stidContainer?: string;\n        [key: string]: any;\n    };\n    callback?: (error?: any) => void;\n}\n\n/**\n * TASK 类型参数\n */\nexport interface TaskOptions {\n    action: string;\n    params?: any;\n    contentPackage?: ContentPackage;\n    currentUrlPackage?: Base.UrlPackage;\n    type?: TaskEventTypeStrings;\n    status?: TaskStatusTypes;\n    eventId?: string;\n    urlPage?: UrlPage;\n    disablePV?: boolean;\n    /**\n     * 向客户端透传的日志信息，如 stid\n     */\n    feedLogCtx?: {\n        stidContainer?: string;\n        [key: string]: any;\n    };\n    callback?: (error?: any) => void;\n}\n\nexport interface ClickOptions {\n    action: string;\n    params?: any;\n    contentPackage?: ContentPackage;\n    currentUrlPackage?: Base.UrlPackage;\n    type?: TaskEventTypeStrings;\n    status?: TaskStatusTypes;\n    eventId?: string;\n    urlPage?: UrlPage;\n    disablePV?: boolean;\n    /**\n     * 染色参数\n     */\n    entryTag?: EntryTagType;\n    /**\n     * 向客户端透传的日志信息，如 stid\n     */\n    feedLogCtx?: {\n        stidContainer?: string;\n        [key: string]: any;\n    };\n    callback?: (error?: any) => void;\n}\n\n/**\n * CUSTOM 类型参数\n */\nexport interface CustomOptions {\n    key: string;\n    value?: any;\n    biz?: string;\n    eventId?: string;\n    urlPage?: UrlPage;\n    disablePV?: boolean;\n    currentUrlPackage?: Base.UrlPackage;\n    callback?: (error?: any) => void;\n}\n\nexport interface VideoEventOptionsParams {\n    duration?: number;\n    played_duration?: number;\n    downloaded?: boolean;\n    prepare_duration?: number;\n    enter_time?: number;\n    leave_time?: number;\n    video_type?: string;\n    play_video_type?: string;\n    photo_id?: number;\n    leave_action?: string;\n    average_fps?: number;\n    media_type?: string;\n    s_photo_id?: number;\n    video_qos_json?: string;\n    click_to_first_frame_duration?: number;\n    rssi?: number;\n    enter_player_action?: string;\n    summary?: string;\n    board_platform?: string;\n    collect_before_status?: string;\n    collect_after_status?: string;\n    session_uuid?: string;\n    soc_name?: string;\n}\n\nexport interface VideoEventOptions {\n    params: VideoEventOptionsParams;\n    callback?: (error?: any) => void;\n    urlPage?: UrlPage;\n    currentUrlPackage?: Base.UrlPackage;\n}\n\nexport type v3Env = 'production' | 'test' | 'development';\nexport type SendCallback = (error?: any) => void;\nexport type LoggerSender = (data: {url: string, data: any, [key: string]: any}, callback?: (error?: any) => void) => void;\n/**\n * 发送埋点接口参数\n */\nexport type EventOptions = PVOptions | ShowOptions | TaskOptions | CustomOptions | VideoEventOptions | ClickOptions;\n/**\n * 支持的事件类型\n */\nexport type SupportTypes = keyof typeof EventTypes | keyof typeof TaskOperations;\nexport interface SendConfig {\n    type: SupportTypes;\n    async?: boolean;\n}\n","import Storage from './storage';\n\nconst STORE_KEY = 'weblogger_store';\nconst INIT_STORE_DATA = {};\n\nconst initStore = () => {\n    const store = Storage.get(STORE_KEY);\n\n    if (!store) {\n        Storage.set(STORE_KEY, INIT_STORE_DATA);\n    }\n};\n\nconst setStore = (key: string, val: string | number) => {\n    const store = Storage.get(STORE_KEY);\n    if (store) {\n        if (typeof val === 'object' && !Array.isArray(val)) {\n            const t: { [key: string]: any } = {};\n            Object.keys(val).forEach((k: string) => {\n                t[k] = val[k];\n            });\n\n            store[key] = { ...(store[key] || {}), ...t };\n        } else {\n            store[key] = val;\n        }\n        Storage.set(STORE_KEY, store);\n    }\n};\n\nconst getStore = (key: string) => {\n    try {\n        return Storage.get(STORE_KEY)[key];\n    } catch (e) {\n        console.warn('get storage error', e);\n        return null;\n    }\n};\n\nexport {\n    initStore,\n    getStore,\n    setStore,\n};\n","import { setStore, getStore } from './store';\n\nconst KS_MINA_DID = 'ks_mina_did';\n\n\nexport const didPrefix = 'wxo_';\n\nexport const generateDid = () => didPrefix + randomHex(36);\n\nexport const randomHex = (length: number) => {\n    let res = '';\n    for (let i = 0; i < length; i++) {\n        res += (Math.random() * 16 | 0).toString(16);\n    }\n    return res;\n};\n\nexport const initDid = () => {\n    let did = getDid();\n    // did前缀修改成wxo了，老的需要重新设置\n    if (!did || did.indexOf(didPrefix) === -1) {\n        did = generateDid();\n        setDid(did);\n    }\n    return did;\n};\n\nexport const getDid = () => getStore(KS_MINA_DID);\n\nexport const setDid = (did: string) => did && setStore(KS_MINA_DID, did);\n\nexport const generateSessionId = (did?: string) => {\n    const realDid = did ? did : getDid();\n    if (!realDid) {\n        return '';\n    }\n    return realDid + Date.now();\n};\n","import { getDid } from './did';\n\nconst emptyPage = {\n    route: '',\n    options: {},\n};\n// 获取当前页面实例\n// 后面的空对象是为了兼容怪异手机上微信拿不到页面实例的Bug，使之不报错\nexport const getCurrentPageInstance = () => getCurrentPages()[getCurrentPages().length - 1] || emptyPage;\n\nexport const genUrlIdentity = (url: string) => `${url}_${Date.now()}_${getDid()}`;","import type { UrlObj, PageTypeKey } from '@/config/types';\nimport BaseUrlPackage from '@/core/url-package';\nimport {\n    genUrlIdentity,\n} from '@/util/mina/page';\nexport default class UrlPackage extends BaseUrlPackage {\n    constructor(url: UrlObj, pageType: PageTypeKey) {\n        super(url, pageType);\n        this.identity = this.page ? this.generatePageId(this.page) : '';\n    }\n    override generatePageId(page: string) {\n        return genUrlIdentity(page);\n    }\n}","import type { v3Env } from '@/config/types';\nimport env = Tachikoma.env;\n\nexport const dataTrackHost = 'https://data-track.corp.kuaishou.com';\nexport const overseaDataTrackHost = 'https://data-track-sgp.corp.kuaishou.com';\nconst testHost = dataTrackHost + '/';\n\nexport const PROD = 'production';\nconst TEST = 'test';\nconst DEV = 'development';\nconst OVERSEA = 'oversea';\nexport const LOGGER = 'logger';\nexport const LOGGER_SGP = 'logger-oversea';\n\nconst v3Api = 'rest/wd/common/log/collect/';\nexport const Envs = [PROD, TEST, DEV, LOGGER, OVERSEA];\nconst overseaHost = 'https://logsdk.kwai-pro.com/';\nexport const Apis = {\n    // v2 接口一定要带上 _json=1 参数，不然服务端会解析失败\n    v2: `rest/kd/log/collect?_json=1&biz=`,\n    v3: `${v3Api}misc2`,\n    // 雷达都上报到 v3\n    radar: `${v3Api}radar`\n};\n\nexport const Hosts = {\n    v2: {\n        // 正式环境随机域名分流\n        production: ['https://wlog.ksapisrv.com/', 'https://wlog.gifshow.com/'][Math.round(Math.random())],\n        development: testHost,\n        test: testHost,\n        oversea: overseaHost\n    },\n    v3: {\n        production: 'https://log-sdk.ksapisrv.com/',\n        development: testHost,\n        test: testHost,\n        oversea: overseaHost\n    }\n};\n\nexport const NodeHosts = {\n    v2: {\n        // 正式环境随机域名分流\n        production: ['https://wlog.ksapisrv.com/', 'https://wlog.gifshow.com/'][Math.round(Math.random())],\n        development: testHost,\n        test: testHost,\n        oversea: overseaHost\n    },\n    v3: {\n        production: 'https://log-sdk-internal.corp.kuaishou.com/',\n        development: testHost,\n        test: testHost,\n        oversea: overseaHost\n    }\n}\n\nexport const buildUrl = (\n    env: string = PROD,\n    radar = false,\n    proto: 'v2' | 'v3' = 'v3',\n) => {\n    if (Envs.indexOf(env) === -1) {\n        return env + Apis[proto];\n    }\n    if (radar && Hosts.v3[env as v3Env]) {\n        return Hosts.v3[env as v3Env] + Apis.radar;\n    }\n    if (Hosts[proto][env as v3Env] && Apis[proto]) {\n        return Hosts[proto][env as v3Env] + Apis[proto];\n    }\n    return Hosts.v3.production + Apis.v3;\n};\n\nexport const nodeBuildUrl = (\n    env: string = PROD,\n    radar = false,\n    proto: 'v2' | 'v3' = 'v3',\n) => {\n    if (Envs.indexOf(env) === -1) {\n        return env + Apis[proto];\n    }\n    if (radar && NodeHosts.v3[env as v3Env]) {\n        return NodeHosts.v3[env as v3Env] + Apis.radar;\n    }\n    if (NodeHosts[proto][env as v3Env] && Apis[proto]) {\n        return NodeHosts[proto][env as v3Env] + Apis[proto];\n    }\n    return NodeHosts.v3.production + Apis.v3;\n}\n\nexport const formatUrlQuery = (url: string, querys: string) => {\n    if (!querys) return url;\n    let reg = /\\?(.+?)$/;\n    try {\n        return reg.test(url) ? url.replace(/\\?(.+?)$/, `?${querys}&$1`) : url + `?${querys}`;\n    } catch (err) {\n        return url;\n    }\n};\n","import type { ClientLog as ClientLogV3 } from '../proto/v3/client_log';\nimport type { ClientLog as ClientLogV2} from '../proto/v2/client_log';\nimport type { CommonPackage } from './common';\nimport type { CommonConfig } from '@/types/configuration';\nimport type { SendCallback, LoggerSender } from '@/config/types';\nimport { buildUrl, formatUrlQuery, Apis, Hosts } from '@/config/apis';\n\nexport type LogPackage = (ClientLogV3.ReportPackage | ClientLogV2.ReportPackage) & { seqid?: number };\nexport type ReportEvent = ClientLogV3.ReportEvent | ClientLogV2.ReportEvent;\n\nexport class BatchLog {\n    // 立即发送队列\n    asyncQueue: ReportEvent[] = [];\n    // 存储待发送的消息\n    throttleQueue: ReportEvent[] = [];\n    // 存储失败或者超时的数据\n    errorQueue: LogPackage[] = [];\n    sendingQueue: {[key: string]: LogPackage} = {};\n    // 延迟发送定时器\n    protected batchWaitTimer: any;\n    // 延时补报日志定时器\n    private compensateTimer: any;\n    commonPackage: CommonPackage;\n    config!: CommonConfig;\n    url: string = '';\n    isV2 = false;\n    isDebug = false;\n    radarUrl: string = '';\n    drained: boolean = false; // 是否未排干日志队列\n    baseSendData!: LoggerSender;\n    batchCount: number = 50;\n    isSetSamplingResult = false;\n    // 有值时阻塞日志发送\n    sendingYield?: Promise<any> | null = null;\n    constructor(config: any, commonPackage: CommonPackage) {\n        this.config = config;\n        if (this.config.maxBatchLength && this.config.maxBatchLength > 1) {\n            this.batchCount = Math.min(50, this.config.maxBatchLength);\n        }\n        this.commonPackage = commonPackage;\n        this.isDebug = this.config.logger || this.config.env === 'logger';\n        this.isV2 = this.config.proto === 'v2';\n        this.updateUrls();\n    }\n    sendData(data: {url: string, data: any, [key: string]: any}, callback?: SendCallback) {\n        if (typeof this.config.sender === 'function') {\n            return this.config.sender(data, callback);\n        }\n        return this.baseSendData(data, callback);\n    }\n    get responseSamplingStorageKey() {\n        const { product_name, product } = this.commonPackage.app_package;\n        const { device_id } = this.commonPackage.identity_package;\n        // tslint:disable-next-line:max-line-length\n        return `RESPONSE_SAMPLING_STORAGE_KEY_${product_name || product}_${device_id}`;\n    }\n\n    /**\n     * 根据配置生成上报的 url 地址\n     */\n    updateUrls() {\n        const { env } = this.config;\n        // 线上地址 -> 抓包查找工具后端，用以测试后端\n        // 兼容方式：若小程序里有扫码工具，扫码后直接进行切换\n        if (env && /^(https?:)?\\/\\//.test(env)) {\n            this.url = env;\n        } else {\n            this.url = buildUrl(env);\n        }\n        this.formatUrl();\n    }\n\n    formatUrl() {\n        if (!this.radarUrl) {\n            this.radarUrl = this.url.replace(this.url.indexOf(Apis.v2) !== -1 ? Apis.v2 : Apis.v3, Apis.radar);\n            // v2 域名不能上报雷达事件\n            if (this.radarUrl.indexOf(Hosts.v2.production || '') !== -1) {\n                this.radarUrl.replace(Hosts.v2.production || '', Hosts.v3.production);\n            }\n        }\n        const { product_name, product } = this.commonPackage.app_package;\n        const querys = `v=__VERSION__&kpn=${product_name || product}`;\n        this.url = formatUrlQuery(this.url, querys);\n        this.radarUrl = formatUrlQuery(this.radarUrl, querys);\n    }\n    /**\n     * 之所以使用 JSON 而不是 commonPackage 对象，是因为对象可能会变化，而 JSON 则是当时的一个快照，一旦生成不会变化\n     */\n    getCommonPackageJSON() {\n        return this.commonPackage.toJSON();\n    }\n    /**\n     * 进入发送流程\n     * @param data\n     * @param immediate\n     * @param callback 用户自定义 callback\n     * @returns\n     */\n    send(data: ReportEvent, immediate = false, callback?: SendCallback) {\n        // 有回调的立即上报\n        if (callback || this.drained) {\n            return this.sendLogs([data], callback);\n        }\n        if (immediate) {\n            this.sendAsync(data, callback);\n            return;\n        }\n        this.sendThrottle(data);\n    }\n    /**\n     * 短时异步上报\n     */\n    async sendAsync(data: ReportEvent, callback?: SendCallback) {\n        this.asyncQueue.push(data);\n        if (this.asyncQueue.length >= this.batchCount) {\n            this.flush();\n            return;\n        }\n        // 用一个微任务包裹，减少同时触发的 sendImmediately 对性能影响，TODO：丢失率影响\n        if (this.sendingYield) {\n            await this.sendingYield;\n            this.sendingYield = null;\n        }\n        try {\n            await Promise.resolve();\n        } catch (err) {}\n        if (!this.asyncQueue.length) return;\n        this.flush();\n    }\n    /**\n     * 节流上报\n     */\n    sendThrottle(data: ReportEvent) {\n        this.throttleQueue.push(data);\n        // 积攒超过最大\n        if (this.throttleQueue.length >= this.batchCount) {\n            this.flush();\n            return;\n        }\n\n        // debounce逻辑\n        clearTimeout(this.batchWaitTimer);\n        this.batchWaitTimer = setTimeout(() => {\n            this.flush();\n        }, this.config.wait);\n    }\n    /**\n     * 批量发送日志\n     * @param logs\n     * @param callback 用户自定义 callback\n     */\n    sendLogs(logs: ReportEvent[], callback?: SendCallback): void | Boolean {\n        if (!logs || !logs.length) {\n            return typeof callback === 'function' && callback();\n        }\n        const data: LogPackage = this.buildLogPackage(logs, this.url);\n        // 网络发送错误回调\n        const callbackFn = (error?: any) => {\n            // 如果网络异常，日志发送失败，则将错误日志缓存，在网络恢复时清空一次错误队列\n            if (error) {\n                this.errHandler(data);\n            } else {\n                this.flushErrorLogs();\n            }\n            typeof callback === 'function' && callback(error);\n        }\n        this.sendPackage(data, callbackFn);\n    }\n    /**\n     * 将日志包通过接口发送\n     * @param data\n     * @param callback\n     */\n    sendPackage(data: LogPackage, callback?: SendCallback) {\n        const { timeout } = this.config;\n        try {\n            // 如果业务方配置了 sender\n            this.sendData({\n                ...data,\n                isDebug: this.isDebug,\n                isDrained: this.drained,\n                timeout\n            }, callback);\n        } catch (err) {\n            typeof callback === 'function' && callback(err);\n        }\n    }\n\n    /**\n     * 每个 logPackage 包含了所有上报所需的信息，上报地址和上报数据\n     * @param logs\n     * @param url\n     */\n    buildLogPackage(logs: ReportEvent[], url: string) {\n        if (this.isV2) {\n            return this.buildV2Package(logs as ClientLogV2.ReportEvent[], url);\n        }\n        return this.buildV3Package(logs as ClientLogV3.ReportEvent[], url);\n    }\n    buildV2Package(logs: ClientLogV2.ReportEvent[], url: string): ClientLogV2.ReportPackage {\n        return {\n            url,\n            data: {\n                log: {\n                    event: logs\n                }\n            }\n        }\n    }\n    buildV3Package(logs: ClientLogV3.ReportEvent[], url: string, commonPackageOptions?: {[key: string]: any}): ClientLogV3.ReportPackage {\n        const common = this.getCommonPackageJSON();\n        commonPackageOptions && Object.assign(common, commonPackageOptions);\n        return {\n            url,\n            data: {\n                common,\n                logs\n            }\n        }\n    }\n    /**\n     * 清空当前日志队列\n     * @param callback\n     */\n    flush = (callback?: SendCallback) => {\n        this.sendLogs(this.throttleQueue.concat(this.asyncQueue), callback);\n        this.throttleQueue = [];\n        this.asyncQueue = [];\n    }\n    /**\n     * 页面关闭前排干所有未发送的和发送失败的日志\n     */\n    drain = () => {\n        this.drained = true;\n        this.flush();\n        this.flushErrorLogs();\n        // 处理 beforunload 中断，实际页面未退出的情况\n        setTimeout(() => {\n            this.drained = false;\n        }, 1000);\n    }\n\n    /**\n     * 日志上报出错处理，一般为网络异常\n     * @param logPackage\n     */\n    errHandler(logPackage: LogPackage) {\n        if (this.isV2) {\n            this.errorQueue.unshift(logPackage);\n            return;\n        }\n        const { data } = logPackage as ClientLogV3.ReportPackage;\n        if (!data.logs.length) return;\n        // http_seq_id 和 client_timestamp 不是必须的，合并时删除\n        delete data.common.h5_extra_attr.http_seq_id;\n        delete data.common.h5_extra_attr.client_timestamp;\n\n        // 尝试合并相同 url 和 common 的请求\n        let merged = false;\n        for (let i = 0; i < this.errorQueue.length; i++) {\n            const currentLog = this.errorQueue[i]  as ClientLogV3.ReportPackage;\n            if (\n                currentLog.url === logPackage.url &&\n                currentLog.data.logs.length + data.logs.length <= 100 &&\n                JSON.stringify(currentLog.data.common) === JSON.stringify(data.common)\n            ) {\n                merged = true;\n                currentLog.data.logs.push(...data.logs);\n                break;\n            }\n        }\n        if (!merged) {\n            // 先进后出\n            // 最大错误数量限制为 5\n            if (this.errorQueue.length >= 5) {\n                this.errorQueue.pop();\n            }\n            this.errorQueue.unshift(logPackage);\n        }\n    }\n\n    // 当网络恢复时尝试一次上报\n    flushErrorLogs() {\n        this.errorQueue.forEach(logPackage => {\n            this.sendPackage(logPackage);\n        });\n        this.errorQueue = [];\n    }\n\n    destory() {\n        this.batchWaitTimer && clearTimeout(this.batchWaitTimer);\n        this.compensateTimer && clearTimeout(this.compensateTimer);\n    }\n    /**\n     * 雷达专用上报（雷达上报接口和其他事件上报接口做了区分，用于分流统计）\n     * @param radar\n     */\n    sendRadar(radar: ClientLogV3.ReportEvent, service_name?: string) {\n        const options = service_name ? { service_name } : undefined;\n        const radarPackage = this.buildV3Package([radar], this.radarUrl || this.url, options);\n        this.sendPackage(radarPackage);\n    }\n}\n","export const APP = 'App';\nexport const PAGE = 'Page';\n\nexport const STATE_KEY = {\n    APP_DEVICE_PACKAGE_READY: 'app_device_package_ready',\n    IDENTITY_PACKAGE_READY: 'identityPackageReady',\n    EXTRA_INFO: 'h5_extra_attr',\n};\n\nexport const PUBLIC_PARAM = {\n    DEVICE_ID: 'device_id',\n    USER_ID: 'user_id',\n    GLOBAL_ID: 'global_id',\n    UNION_ID: 'union_id',\n    OPEN_ID: 'open_id',\n    IU_ID: 'iu_id',\n    VERSION_CODE: 'version_code',\n    VERSION_NAME: 'version_name',\n    SAFETY_ID: 'safety_id',\n    SESSION_ID: 'sessionId',\n};\n\nexport const PAGE_INSTANCE_ATTR = {\n    URL: '_log_pageUrl',\n    URL_IDENTITY: '_log_urlId',\n    SHOW_TIME: '_log_showTime',\n    HIDE_TIME: '_log_hideTime',\n    PAGE: '_log_pageAlias',\n    PAGE_PARAMS: '_log_pageParams',\n    PAGE_IDENTITY: '_log_pageId',\n    REFER_PAGE: '_log_referAlias',\n    REFER_PAGE_PARAM: '_log_referPageParam',\n    REFER_PAGE_IDENTITY: '_log_referPageId',\n    PAGE_STATUS: '_log_pageStatus',\n    PAGE_SUB_ACTION: '_log_subAction',\n};\n","import { error } from '@/util/console';\n\nexport const xhrErrorLog = (err: any, url: string, data: any) => error('[error 400]', '埋点上报接口请求报错', '\\nurl:', url, '\\ndata', data, '\\nerror:', err || 'server decode log failed');\n\nexport const logXhrResponseCheck = (status: number, response: string, url: string, data: any) => {\n    let err;\n    if (status < 200 || (status >= 300 && status !== 304)) {\n        const err = response || status || 'unknonw error';\n    } else {\n        try {\n            const { exception, result, error_msg } = JSON.parse(response);\n            if (exception) {\n                err = exception;\n            }\n            if (result !== 1) {\n                err = error_msg || `result is ${result}`\n            }\n        } catch (e){\n            err = (e as Error).message;\n        }\n    }\n    err && xhrErrorLog(err, url, data);\n    return err;\n}","import { dataTrackHost } from '@/config/apis';\nimport { log } from '@/util/console';\nexport const getReportUrl = (viewHost: string = dataTrackHost, reportHost: string, sessionId: string) => {\n    const loggerUrl = `${viewHost}/#/logger/index?sessionId=${sessionId}`;\n    log(`%c埋点抓包校验: %c${loggerUrl}`, 'color:#1abf89;font-size:1.2em;line-height:2.4em;', 'font-size:1.2em;');\n    return `${reportHost}/${sessionId}/`;\n};","import type { ReportEvent } from '@/core/logger';\nimport type { SendCallback, LoggerSender } from '@/config/types';\nimport type { TrackerConfig } from './types';\nimport type { CommonPackage } from './common';\n\nimport { BatchLog as BaseLogger } from '@/core/logger';\nimport { STATE_KEY } from '@/util/mina/types';\nimport { sendData } from '@/io/mina';\nimport Global from '@/config/global';\nimport { getDid } from '@/util/mina/did';\nimport { getReportUrl } from '@/util/test';\nimport { dataTrackHost, buildUrl, Apis } from '@/config/apis';\nimport type { ResponseType } from '@/io/types';\nimport { getStore, setStore } from '@/util/mina/store';\nimport { mp } from '@/util/mina/global';\n/**\n * env 为 logger 时上报的 url\n */\nconst getLoggerReportUrl = () => {\n    try {\n        let did = getDid();\n        did = did.includes('wxo') ? did.replace('wxo', 'web') : `web_${did}`;\n        mp.request({ url: `${dataTrackHost}/rest/${did}`, method: 'GET' });\n        return getReportUrl(dataTrackHost, `${dataTrackHost}/rest`, did);\n    } catch (err) {\n        console.warn('request error', err);\n    }\n};\n\nexport default class Logger extends BaseLogger {\n    continueSend: Boolean = false;\n    // 服务端控制的采样发送，可以发送合法时间，当前时间戳大于这个时间戳，才可以发送\n    sendEffectiveTime: undefined | number;\n    // 采样存储 key，作为实例化的一个键值，避免多实例互相干扰\n    override baseSendData: LoggerSender = data => {\n        const sendPromise = sendData(data);\n        if (!this.isSetSamplingResult) {\n            this.setResponseSamplingConfig(sendPromise);\n            this.isSetSamplingResult = true;\n        }\n\n    }\n    constructor(config: any, commonPackage: CommonPackage) {\n        super(config, commonPackage);\n        this.getResponseSamplingStorage();\n    }\n\n    // 获取 storage 判断是否有过期时间\n    getResponseSamplingStorage() {\n        try {\n            const storageEffectiveTime = Number(getStore(this.responseSamplingStorageKey));\n            if (storageEffectiveTime && (Date.now() < storageEffectiveTime)) {\n                this.sendEffectiveTime = storageEffectiveTime;\n            } else if (storageEffectiveTime) {\n                // 如果采样已经过期，清除 storage\n                setStore(this.responseSamplingStorageKey, '');\n            }\n        } catch (e) {\n            console.error(e);\n        }\n    }\n\n    override sendLogs(logs: ReportEvent[], callback?: SendCallback): boolean {\n        if (this.shouldSendPackage()) {\n            super.sendLogs(logs, callback);\n            return true;\n        }\n        return false;\n    }\n    /**\n     * 根据配置生成上报的 url 地址\n     */\n    override updateUrls(url?: string) {\n        const { env, logger } = this.config;\n        if (logger || env === 'logger') {\n            if (url) {\n                mp.request({ url, method: 'GET' });\n                return this.url = url + Apis.v3;\n            }\n            const loggerEnv = getLoggerReportUrl();\n            if (loggerEnv) {\n                this.url = buildUrl(loggerEnv);\n            }\n        } else if (env && /^(https?:)?\\/\\//.test(env)) {\n            this.url = env;\n        } else {\n            this.url = buildUrl(env);\n        }\n        this.formatUrl();\n    }\n    shouldSendPackage() {\n        // IS_PUBLIC_PARAM_INIT_READY 公共参数是否设置完成 （网络 项目配置等）\n        const commonPackageDone = !!Global[STATE_KEY.APP_DEVICE_PACKAGE_READY];\n        // IS_BIZ_PUBLIC_PARAM_READY 账号等必要参数是否设置完成（uid unionid session_key等）\n        // 配置sendUtilIdentityDone: false 则不等待\n        const identityPackageDone = (\n            Global[STATE_KEY.IDENTITY_PACKAGE_READY] || !(this.config as TrackerConfig).sendUtilIdentityDone\n        );\n        return commonPackageDone && identityPackageDone;\n    }\n    setResponseSamplingConfig(responsePromise?: Promise<ResponseType | undefined>) {\n        responsePromise?.then(response => {\n            const expireSeconds = response?.expireSeconds;\n            if (expireSeconds) {\n                const effectiveTime = Date.now() + expireSeconds * 1000;\n                this.sendEffectiveTime = effectiveTime;\n                setStore(this.responseSamplingStorageKey, String(effectiveTime));\n            }\n        });\n    }\n\n    override flush = (callback?: SendCallback) => {\n        const clear = this.sendLogs(this.throttleQueue.concat(this.asyncQueue), callback);\n        if (clear) {\n            this.throttleQueue = [];\n            this.asyncQueue = [];\n        }\n    }\n\n    override send(data: ReportEvent, immediate = false, callback?: SendCallback) {\n        super.send(data, immediate, callback);\n    }\n\n    completeLog(log: any) {\n        log.session_id = Global.sessionId;\n        return log;\n    }\n}\n","import { xhrErrorLog } from './util';\nimport { error } from '@/util/console';\nimport type { ResponseType } from '@/io/types';\nimport { mp } from '@/util/mina/global';\n\ninterface DataOptions {\n    url: string;\n    data: any;\n    async?: boolean;\n    useBeacon?: boolean;\n    timeout?: number;\n    isV2?: boolean;\n}\n\nexport const sendData = async ({ url, data, timeout }: DataOptions,\n    callback?: (error?: any) => ResponseType,\n): Promise<ResponseType | undefined> => {\n    data = JSON.stringify(data);\n    try {\n        return new Promise(resolve => {\n            mp.request({\n                url,\n                data,\n                header: {\n                    'content-type': 'text/plain',\n                },\n                headers: {\n                    'content-type': 'text/plain',\n                },\n                method: 'POST',\n                timeout,\n                success(res: {\n                    data: ResponseType,\n                }) {\n                    resolve(res?.data);\n                },\n                fail(err: Error) {\n                    xhrErrorLog(err, url, data);\n                    resolve(undefined);\n                    callback && callback(err);\n                },\n            });\n        });\n\n    } catch (err) {\n        xhrErrorLog(err, url, data);\n        callback && callback(err);\n    }\n};\n\nexport const get = (url: string) => {\n    const errorHandler = (err: any) => error('[error 401]', `GET 请求出错 url: ${url}`, err);\n    try {\n        mp.request({\n            url,\n            method: 'GET',\n            header: {\n                'content-type': 'text/plain',\n            },\n            headers: {\n                'content-type': 'text/plain',\n            },\n            fail: errorHandler,\n        });\n    } catch (err) {\n        errorHandler(err);\n    }\n};\n","import { mp } from './global';\nimport { networkType } from '@/config/types';\n\ntype SystemInfo = {\n    model?: string;\n    system?: string;\n    platform?: number;\n    pixelRatio?: number;\n    screenHeight?: number;\n    screenWidth?: number;\n    windowHeight?: number;\n    windowWidth?: number;\n    language?: string;\n    brand?: string;\n    // 客户端(微信、支付宝、百度)版本\n    mpVersion?: string;\n    // 客户端基础库版本\n    mpSDKVersion?: string;\n};\n\nexport const getPlatformPB = (platform: 'ios' | 'android' | 'windows' | 'mac', model: string) => {\n    switch (platform?.toLocaleLowerCase()) {\n        case 'ios':\n            if (/ipad/i.test(model)) {\n                return 4; // iPad\n            }\n            return 3; // iPhone\n        case 'android':\n            return 1; // Android Phone\n        case 'mac':\n            return 5; // Mac PC\n        case 'windows':\n            return 5; // Windows PC\n    };\n};\n\nexport const getNetworkTypePB = (network: string) => {\n    network = network.toLocaleLowerCase();\n    return networkType[network as keyof typeof networkType] || networkType.unknown;\n};\n\nexport const getSystemInfo = (() => {\n    let info: SystemInfo;\n    return (callback:(param: any) => void) => {\n        if (info) {\n            callback(info);\n        };\n        try {\n            mp.getSystemInfo({\n                success(systemInfo: any = {}) {\n                    info = {\n                        ...systemInfo,\n                        mpVersion: systemInfo.version,\n                        mpSDKVersion: systemInfo.SDKVersion,\n                        platform: getPlatformPB(systemInfo.platform, systemInfo.model) || 0,\n                    };\n                },\n                complete() {\n                    callback(info);\n                },\n            });\n        } catch (err) {\n            callback(info);\n        }\n    };\n})();\n\nexport const getNetworkType = (() => {\n    let network: number;\n    return (callback:(param: number) => void) => {\n        if (network) {\n            callback(network);\n        }\n        try {\n            mp.getNetworkType({\n                success(res: any) {\n                    network = getNetworkTypePB(res.networkType);\n                },\n                complete() {\n                    callback(network);\n                }\n            });\n        } catch (err) {\n            callback(network);\n        }\n    };\n})();\n","import { appendParam } from '@/util/mina/utils';\nimport { getSystemInfo } from '@/util/mina/systeminfo';\nimport { initHeartBeatIncrementId } from '@/util/mina/increment-id';\n\nimport {\n    getStore,\n    setStore,\n} from '@/util/mina/store';\n\nimport * as HeartBeat from './heart-beat';\nimport { getPositiveInteger } from '@/util';\n\nenum STORE_KEY {\n    SHOW_TIME = 'app_show_time',\n    HIDE_TIME = 'app_hide_time',\n    STAY = 'stay_length',\n}\n\nenum STATUS {\n    C = 1,\n    H = 2,\n    E = 2,\n}\n\nenum EVENT_NAME {\n    L = 'LAUNCH_EVENT',\n    U = 'APP_USAGE_STAT_EVENT',\n    E = 'EXCEPTION_EVENT',\n    S = 'SHOW',\n    D = 'DEVICE_STAT_EVENT',\n}\n\nfunction genLaunchData(weblog: any, target: string, scene: any, cold: boolean) {\n    return {\n        cold,\n        target,\n        mode: cold ? STATUS.C : STATUS.H,\n        source: scene,\n        detail: JSON.stringify({ scene }),\n        event_name: EVENT_NAME.L,\n    };\n}\n\nlet isSendFirst = false;\n\nexport default (report: any, weblog: any, launchIntervalLimit: number = 30000, backgroundWaitingLimit: number = 0) => {\n    let appTimer: any = 0;\n    let heartBeatTimer: any = 0;\n    const result = {\n        onLaunch: [() => {\n            getSystemInfo((info) => {\n                if (!info) return;\n                const { system, model, screenWidth, screenHeight, batteryLevel } = info;\n                const log = {\n                    os_version: system,\n                    model,\n                    density_dpi: 0, // 暂时传0， 小程序获取不到dpi\n                    screen_width: getPositiveInteger(screenWidth),\n                    screen_height: getPositiveInteger(screenHeight),\n                    battery: batteryLevel,\n                    event_name: EVENT_NAME.D,\n                };\n                report(log);\n            });\n        }, () => {\n            // 设置初始timestamp\n            HeartBeat.setPrevTimestamp();\n            // 监听updateSessionId，重置心跳包自增id\n            weblog.on('updateSessionId', () => {\n                initHeartBeatIncrementId();\n            });\n            // 定时上报\n            heartBeatTimer = setInterval(() => {\n                const log = HeartBeat.getReportData();\n                report(log, 'App', true);\n                HeartBeat.setPrevTimestamp();\n            }, HeartBeat.INTERVAL);\n        }],\n        onShow: [(param: WechatMiniprogram.App.LaunchShowOption) => {\n            const { path, query, scene } = param;\n            // 清除判断两次启动时间间隔的定时器\n            clearTimeout(appTimer);\n            appTimer = 0;\n\n            // 计算两次启动相关，需要存在storage中，不能被清空，因为小程序被杀掉啥的，同样需要保留1\n            const currentTime = Date.now();\n            const showInterval = currentTime - getStore(STORE_KEY.SHOW_TIME);\n            setStore(STORE_KEY.SHOW_TIME, currentTime);\n\n            const enterPath = appendParam(path, query);\n            let log = null;\n            // 首次冷启动\n            // @ts-ignore\n            if (getCurrentPages().length === 0 || !isSendFirst) {\n                log = genLaunchData(weblog, enterPath, scene, true);\n                isSendFirst = true;\n            }\n            // 两次启动间隔大于一定值的热启动视为另一次启动\n            if (showInterval > launchIntervalLimit) {\n                weblog && weblog.updateSessionId && weblog.updateSessionId();\n                log = genLaunchData(weblog, enterPath, scene, false);\n            }\n            log && report(log);\n        }, () => {\n            // heartBeatTimer !== 0 说明onLaunch配置的定时任务还未被销毁，onShow时不需要重新执行。\n            if (heartBeatTimer !== 0) { return; }\n            HeartBeat.setPrevTimestamp();\n            heartBeatTimer = setInterval(() => {\n                const log = HeartBeat.getReportData();\n                report(log, 'App', true);\n                HeartBeat.setPrevTimestamp();\n            }, HeartBeat.INTERVAL);\n        }],\n        onHide: [() => {\n            const wait = +backgroundWaitingLimit || 0;\n            weblog && weblog.flush();\n\n            const appShowTime = getStore(STORE_KEY.SHOW_TIME);\n            const appHideTime = Date.now();\n\n            let stayLength = appHideTime - appShowTime;\n            stayLength = stayLength < 0 ? 0 : stayLength;\n\n            const prevStayLength = getStore(STORE_KEY.STAY);\n            const totalStayLength = prevStayLength ? prevStayLength + stayLength : stayLength;\n\n            setStore(STORE_KEY.HIDE_TIME, appHideTime);\n\n            setStore(\n                STORE_KEY.STAY,\n                totalStayLength,\n            );\n\n            // 一定时间内没回到前台 发送一次使用时长\n            appTimer = setTimeout(() => {\n                const reportStayLengthParam = {\n                    app_use_duration: getPositiveInteger(getStore(STORE_KEY.STAY)),\n                    event_name: EVENT_NAME.U,\n                    ...weblog.currentUrlPackage.toJSON(),\n                };\n                setStore(STORE_KEY.STAY, 0);\n                report(reportStayLengthParam);\n\n            }, wait);\n        }, () => {\n            const log = HeartBeat.getReportData();\n            report(log, 'App', true);\n            HeartBeat.setPrevTimestamp();\n            clearInterval(heartBeatTimer);\n            heartBeatTimer = 0;\n        }],\n        // onError(param: string) {\n        //     const errorStack = {\n        //         // @ts-ignore\n        //         msg: param ? param.message : undefined,\n        //         // @ts-ignore\n        //         stack: param ? param.stack : undefined,\n        //         err: JSON.parse(JSON.stringify(param, Object.getOwnPropertyNames(param))),\n        //     };\n        //     // 脚本出错或者api接口调用失败\n        //     const reportErrorEventParam = {\n        //         type: STATUS.E,\n        //         message: JSON.stringify(errorStack),\n        //         event_name: EVENT_NAME.E,\n        //         url_package: {\n        //             ...weblog.currentUrlPackage.toJSON(),\n        //         }\n        //     };\n\n        //     report(reportErrorEventParam);\n        // },\n    };\n\n    // 通过app.onUnhandledRejection 无效\n    // typeof wx.onUnhandledRejection === 'function' && wx.onUnhandledRejection((err) => {\n    //     result.onError(err.reason || {});\n    // });\n\n    return result;\n};\n","import { setStore, getStore } from './store';\n\nconst runtimeIdMap: { [key: string]: number } = {};\n\nexport const genId = (key: string) => {\n    // 自增 id 最大值\n    const maxId = 1e8;\n    try {\n        let id = Number(getStore(key)) || 0;\n        if (id + 1 > maxId) {\n            id = 0;\n        }\n        setStore(key, id + 1);\n        return id;\n    } catch (err) {\n        console.warn('setStore Error:', err);\n    }\n    if (!runtimeIdMap[key]) {\n        runtimeIdMap[key] = 0;\n    }\n    return runtimeIdMap[key]++;\n};\n\n// 常规业务事件自增 id key\nconst LOCAL_INCREAMENT_ID_KEY = 'WEBLOGGER_INCREAMENT_ID_KEY';\n// 自定义事件自增 id key\nconst LOCAL_CUSTOM_INCREAMENT_ID_KEY = 'WEBLOGGER_CUSTOM_INCREAMENT_ID_KEY';\n\n// heart_beat_event 自增id key\nconst HEART_BEAT_INCREAMENT_ID_KEY = 'WEBLOGGER_HEART_BEAT_INCREAMENT_ID_KEY';\n\n\n/**\n * 常规事件自增 id\n */\nexport const getNormalIncrementId = () => {\n    return genId(LOCAL_INCREAMENT_ID_KEY);\n};\n\n/**\n * 自定义事件自增 id\n */\nexport const getCustomIncrementId = () => {\n    return genId(LOCAL_CUSTOM_INCREAMENT_ID_KEY);\n};\n\n/**\n * 心跳事件自增 id\n */\nexport const getHeartBeatIncrementId = () => {\n    return genId(HEART_BEAT_INCREAMENT_ID_KEY);\n};\n\n/**\n * 心跳事件自增 id 初始化\n */\nexport const initHeartBeatIncrementId = () => {\n    setStore(HEART_BEAT_INCREAMENT_ID_KEY, 0);\n}\n\n","import { getHeartBeatIncrementId } from '@/util/mina/increment-id';\nimport { getPositiveInteger } from '@/util';\n\nlet prevTimestamp = 0;\n\nexport const setPrevTimestamp = (timestamp: number = Date.now()) => {\n    prevTimestamp = timestamp;\n};\n\nexport const INTERVAL = 2 * 60 * 1000;\n\nexport const getReportData = () => {\n    return {\n        upload_frequency: INTERVAL,\n        seq: getHeartBeatIncrementId() + 1,\n        app_use_duration: getPositiveInteger(Date.now() - prevTimestamp),\n        event_name: 'HEART_BEAT_EVENT',\n    };\n};\n","// 增加默认值，兼容一些怪异机型上微信拿不到对应属性的Bug\nexport const appendParam = (url = '', params: { [key: string]: any; } = {}) => {\n    const sp = url.indexOf('?') === -1 ? '?' : '&';\n    const arr = [];\n\n    for (const key of Object.keys(params)) {\n        const value = params[key] || '';\n        arr.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);\n    }\n\n    if (arr.length) {\n        url += sp + arr.join('&');\n    }\n    return url;\n};\n\nexport const getMappingPage = (page: Mina.PageInstance, urlMap?: any) => {\n    return {\n        page: page.route,\n        params: page.options,\n    };\n};\n","import { proxyLifeCycle, LifecycleConfig as Config, VoidFn } from './utils';\n\ntype AppLifeCycle =\n    'onLaunch' |\n    'onShow' |\n    'onHide' |\n    // 'onError' |\n    'onPageNotFound' |\n    'onUnhandledRejection';\n\nexport { LifecycleConfig } from './utils';\n\nexport function proxyApp(config: Config) {\n    if (App) {\n        const originApp = App;\n        App = function (appOptions: WechatMiniprogram.App.Option) {\n            proxyLifeCycle(config, appOptions);\n            return originApp(appOptions);\n        } as WechatMiniprogram.App.Constructor;\n    }\n}\n\nconst lifecycleConfig: Config = {};\n\nexport function use(lifecycle: AppLifeCycle, fn: VoidFn): void {\n    if (!lifecycleConfig[lifecycle]) {\n        lifecycleConfig[lifecycle] = [];\n    }\n\n    (lifecycleConfig[lifecycle] as VoidFn[]).push(fn);\n}\n\nexport function useOnLaunch(fn: VoidFn) {\n    if (!fn) { return; }\n    const key: AppLifeCycle = 'onLaunch';\n    use(key, fn);\n}\n\nexport function useOnShow(fn: VoidFn) {\n    if (!fn) { return; }\n    const key: AppLifeCycle = 'onShow';\n    use(key, fn);\n}\n\nexport function useOnHide(fn: VoidFn) {\n    if (!fn) { return; }\n    const key: AppLifeCycle = 'onHide';\n    use(key, fn);\n}\n\n// export function useOnError(fn: VoidFn) {\n//     if (!fn) { return; }\n//     const key: AppLifeCycle = 'onError';\n//     use(key, fn);\n// }\n\nexport function useOnPageNotFound(fn: VoidFn) {\n    if (!fn) { return; }\n    const key: AppLifeCycle = 'onPageNotFound';\n    use(key, fn);\n}\n\nexport function useOnUnHandleRejection(fn: VoidFn) {\n    if (!fn) { return; }\n    const key: AppLifeCycle = 'onUnhandledRejection';\n    use(key, fn);\n}\n\nexport function done() {\n    return proxyApp(lifecycleConfig);\n}\n","export interface AnyObject {\n    [key: string]: any;\n}\nexport function proxy(source: AnyObject, name: string, replacement: (...args: any[]) => any, isForced = false): void {\n    if (name in source || isForced) {\n        const original = source[name];\n        const wrapped = replacement(original);\n        if (typeof wrapped === 'function') {\n            source[name] = wrapped;\n        }\n    }\n}\n\nexport type VoidFn = (args: any) => void;\n\nexport interface LifecycleConfig {\n    [key: string]: VoidFn[] | VoidFn | undefined;\n}\nexport function proxyLifeCycle(config: LifecycleConfig, hostOptions: WechatMiniprogram.App.Option) {\n    for (const method in config) {\n        if (Object.prototype.hasOwnProperty.call(config, method)) {\n            let fnList = config[method];\n            proxy(\n                hostOptions,\n                method,\n                (originMethod?: VoidFn) => {\n                    return function (...args: any): void {\n                        if (fnList) {\n                            if (!Array.isArray(fnList)) {\n                                fnList = [fnList];\n                            }\n                            (fnList as VoidFn[])!.forEach(fn => {\n                                // @ts-ignore\n                                fn.apply(this, args);\n                            });\n                        }\n                        if (originMethod) {\n                            // @ts-ignore\n                            originMethod.apply(this, args);\n                        }\n                    };\n                },\n                true\n            );\n        }\n    }\n\n}\n","/**\n * @file mina-auto-pv.js\n * @author lijie14 (lijie14@kuaishou.com)\n * @created 2021-03-04\n */\nimport type { MinaWeblogInstance } from '@/types/index';\n\nimport { BasePlugin } from '../base';\nimport { APP } from '@/util/mina/types';\n\nimport genAppProxyConfig from './app';\nimport { proxyApp, LifecycleConfig as AppLifeCycleConfig } from './lifecycle-proxy/app';\n\ninterface Config {\n    launchIntervalLimit?: number;\n    backgroundWaitingLimit?: number;\n    App?: AppLifeCycleConfig;\n}\ninterface ReportMsg {\n    [key: string]: number | string | boolean;\n}\n\nconst defaultLifeHookTrackConfig: Config = {\n    launchIntervalLimit: 30000,\n    backgroundWaitingLimit: 0,\n};\n\nexport default class MinaAutoPV extends BasePlugin {\n\n    static override key = 'minaAutoPV';\n    private config: Config = {};\n\n    /**\n     * 兼容写法，如果在 Weblog 初始化设置 plugins 时，不需要设置 weblog\n     * @param weblog\n     */\n    constructor(weblog?: MinaWeblogInstance, localGlobal: any = global || {}, config: Config = defaultLifeHookTrackConfig) {\n        super();\n        this.config = config;\n        if (weblog) {\n            this.apply(weblog);\n        }\n        // 劫持小程序的生命周期\n        this.proxy();\n    }\n\n    proxy() {\n        // 劫持App生命周期\n        proxyApp(this.getAppConfig());\n\n    }\n\n    // 获取App生命周期的配置\n    getAppConfig() {\n        const appConfig = this.config.App ? this.config.App : genAppProxyConfig(\n            this.send.bind(this),\n            this.weblog,\n            this.config.launchIntervalLimit,\n            this.config.backgroundWaitingLimit,\n        );\n        return appConfig;\n    }\n\n    override apply(weblog: MinaWeblogInstance) {\n        if (!weblog?.collect) return;\n        this.weblog = weblog;\n    }\n\n    send(data: ReportMsg, type: string = APP, immediate: boolean = false) {\n        if (!data) { return; }\n        const eventName = data && data.event_name ? data.event_name as string : 'CUSTOM_STAT_EVENT';\n        const sendType = type === APP\n            ? eventName : 'SHOW';\n        delete data.event_name;\n        if (immediate) {\n            // @ts-ignore\n            this.weblog.sendImmediately(sendType, {\n                ...data,\n            });\n        } else {\n            // @ts-ignore\n            this.weblog.collect(sendType, {\n                ...data,\n            });\n        }\n    }\n\n    destroy() {\n        console.log('destroy');\n    }\n}\n","/**\n * v2、v3 PB 相同部分\n */\nexport namespace Base {\n    // 设备和用户Id\n    export interface IdentityPackage {\n        device_id?: string;  // 设备Id, 唯一标识一台设备\n        user_id?: string | number;  // 用户Id, 唯一标识一个用户\n        iu_id?: string;  // 数盟sdk获取到的设备Id, 唯一标识一台设备(仅用于安卓)\n        global_id?: string;  // 内部SDK生成的全局唯一id，识别多个app之间的相同设备\n        union_id?: string;  // 各端设备识的备用参数，例如微信小程序端上报微信内部用户的唯一标识\n        open_id?: string;  // 微信小程序open_id，需加解密\n    }\n\n    // 设备基础信息\n    export interface DevicePackage {\n        os_version?: string; // 操作系统版本\n        model?: string; // 机型\n        ua?: string; // user agent\n    }\n    export interface NetworkPackage {\n        type?: number; // 网络类型\n        isp?: string; // 运营商\n        ip?: string; // 外网IP地址\n        ipv6?: string; // ipv6地址\n    }\n\n    // 地理位置信息\n    export interface LocationPackage {\n        country?: string; // 国家\n        province?: string; // 省份/自治区/州\n        city?: string; // 城市\n        county?: string; // 县/区域\n        street?: string; // 街道\n        latitude?: number; // 纬度\n        longitude?: number; // 经度\n    }\n\n    // A/B测试实验\n    export interface Experiment {\n        name: string;  // 实验名称\n        value: string; // 实验分组\n    }\n    // 客户端日志额外的sequenceId，用来验证不同发送通道、不同类型的日志的丢失率等。\n    export interface AdditionalSeqIdPackage {\n        channel: number; // 数据发送通道类型\n        channel_seq_id: number; // 日志对应的发送通道的自增ID\n        custom_type: string; // 自定义类型\n        custom_seq_id: number; // 自定义类型的自增ID\n    }\n\n    // 应用基础信息\n    export interface AppPackage {\n        product?: number; // 产品名称, 不同产品独立进行统计分析(为了灵活接入新app，废弃该参数，新接入app请上报到参数8)\n        platform?: number; // 平台\n        language?: string; // 语言, 例: zh-cn\n        channel?: string; // 用户来源渠道\n        version_name?: string; // 版本名\n        version_code?: number; // 版本号\n        package_name?: string; // 应用包名\n        product_name?: string; // 产品名称(为了避免不同app参数值冲突，新接入app请到埋点平台注册，具体咨询宋萌)\n        hotfix_patch_version?: string; // 热更新的patch版本号, 用于相同版本号但是不同Patch的分析\n        container?: string; // 和platform组合使用。platfrom标识平台，container标识应用运行载体. 取值如下，NATIVE、H5、小程序（MP_WECHAT、MP_ALIPAY、MP_BAIDU）\n    }\n\n    // 所有 Event 都包含的数据\n    export interface CommonPackage {\n        identity_package: IdentityPackage; // 用户和设置Id\n        app_package: AppPackage; // 应用信息\n        device_package: DevicePackage; // 设备基本信息\n        network_package: NetworkPackage; // 网络信息\n        location_package?: LocationPackage; // 地理位置信息\n        experiment?: Experiment[]; // A/B测试实验\n        sdk_version?: string; // logsdk版本号\n        service_name?: string; // 中台服务名称，比如积木、im sdk等，如果业务log未使用中台服务，该字段置空\n        safety_id?: string; // 防盗链id\n        sub_biz?: string; // 多业务场景，同一中台可能存在多业务场景，比如评论sdk有 说说、作品评论等不同场景\n        style_type?: string; // 客户端UI模式，比如滑滑版/极速版/普通版\n        additional_seq_id_package?: AdditionalSeqIdPackage; // 客户端日志额外的sequenceId，用来验证不同发送通道、不同类型的日志的丢失率等。\n        need_encrypt?: boolean; // 标记此条数据是否需要做加密处理\n        global_attr?: {[key: string]: any}; // App内全局参数，json格式. 比如流量运营导流参数. 避免key冲突，key统一由埋点平台维护,最终上报 string\n        h5_extra_attr: {[key: string]: any}; // H5埋点专用扩展参数,json格式.\n    }\n\n    // 页面信息\n    export interface UrlPackage {\n        page: string; // 一级页面。参考埋点需求填写即可\n        params: string; // 参数列表参考埋点需求填写，并转成 json 字符串格式\n        identity: string; // 页面唯一标识，使用UUID即可\n        page_type?: number; // 应用页面类型\n        coPage?: boolean;\n        category?: string;\n    }\n\n    export enum ElementStatus {\n        UNKNOWN_STATUS = 0, // 未知\n        CHECKED = 1, // 选中\n        UNCHECKED = 2, // 未选中\n    }\n\n    // 页面元素详细信息\n    export interface ElementPackage {\n        action?: string;\n        action2?: string;\n        index?: number; // 废弃 元素位置, 从0开始 (备注：element补充参数统一定义到params中)\n        value?: number; // 废弃 元素的值, 用于求和, 求平均等 (备注：element补充参数统一定义到params中)\n        status?: ElementStatus; // 废弃 元素状态 (备注：element补充参数统一定义到params中)\n        params: string; // 参数列表参考埋点需求填写，并转成 json 字符串格式\n    }\n\n    // 页面曝光动作\n    export enum PageShowAction {\n        UNKNOWN_ACTION = 0, // 未知\n        ENTER = 1, // 进入页面\n        LEAVE = 2, // 离开页面\n        RESUME = 3, // 恢复页面, 也可以认为是热加载, 这种情况下不需要重新渲染\n    }\n\n    export enum ActionStatus {\n        UNKNOWN_STATUS = 0, // 未知\n        SUCCESS = 1, // 成功\n        FAIL = 2, // 失败\n    }\n\n    export enum ActionType {\n        UNKNOWN_ACTION_TYPE = 0, // 未知\n        CLICK = 1, // 点击进入或离开页面\n        LEFT_PULL = 2, // 左滑进入或离开页面\n        RIGHT_PULL = 3, // 右滑进入或离开页面\n        UP_PULL = 4, // 上滑进入或者离开页面\n        DOWN_PULL = 5, // 下滑进入或者离开页面\n    }\n\n    export enum SubAction {\n        UNKNOWN_SUB_ACTION = 0, // 未知\n        PAGE_ENTER = 1, // 进入页面\n        PAGE_LEAVE = 2, // 离开页面 退出页面\n        PAGE_RESUME = 3, // 恢复页面, 也可以认为是热加载, 这种情况下不需要重新渲染\n        PAGE_PAUSE = 4, // 页面暂停，用户进入下一级页面，当前页面被覆盖的情况\n    }\n\n    // 操作方向\n    export enum Direction {\n        UNKNOWN2 = 0,\n        UP = 1,\n        DOWN = 2,\n        LEFT = 3,\n        RIGHT = 4,\n    }\n\n    /**\n     * 染色参数\n     *  page_name: 页面标识，\n     *  element_action: 元素标识，\n     *  stid：策略id（格式由小分队提供），\n     *  pos：位置信息1，\n     *  params:{元素参数1}\n     */\n    export interface EntryTagType  {\n        page_name: string,\n        element_action: string,\n        stid?: string,\n        pos?: number,\n        params?: {[prop: string]: any}\n    }\n\n    export interface Event {\n        url_package?: UrlPackage; // 事件发生页面\n        refer_url_package?: UrlPackage; // 事件发生页面的来源页面\n        element_package?: ElementPackage; // 触发事件发生的行为\n        refer_element_package?: ElementPackage; // 触发事件发生的来源元素信息\n    }\n\n    // 曝光事件\n    export interface ShowEvent extends Event {\n        action?: PageShowAction; // 进入或离开\n        type?: number; // 页面类型\n        status?: ActionStatus; // 展现状态, 成功或者失败\n        action_type?: number; // 记录进入或离开页面的方式\n        show_type?: number; // 记录进入或离开页面的方式\n        time_cost?: number; // 页面加载, 刷新或离开时长, 单位: ms\n        stay_length?: number; // 页面停留时长, 单位: ms\n        url_package: UrlPackage; // 页面, 精确到页面级别, 控件级别的展现, 需填充 element_package\n        sub_page?: boolean; // 是否包含子页面，true为包含，false为不包含，所有页面enter事件均上报，统计加载时长数据时使用。\n        first_load?: boolean; // 记录是否是首个加载，true代表是，false代表不是，仅子页面加载事件中上报（非子页面不上报），统计加载时长数据时使用。\n        sub_action?: SubAction; // 页面进入或离开的类型细分\n    }\n\n    export enum TaskStatus {\n        UNKNOWN_STATUS = 0,\n        START = 1, // 开始\n        RETRY = 2, // 重试\n        PAUSE = 3, // 暂停\n        RESUME = 4, // 恢复\n        PENDING = 5, // 等待\n        PROCESSING = 6, // 进行中\n        SUCCESS = 7, // 成功\n        FAIL = 8, // 失败\n        CANCEL = 9, // 取消\n        FINISH = 10, // 完成，比如直播结束的，长链接关闭\n    }\n\n    export enum OperationType {\n        UNKNOWN_OPERATION = 0,\n        CLICK = 1, // 点击\n        DOUBLE_CLICK = 2, // 双击\n        TRIPLE_CLICK = 3, // 三击\n        LONG_PRESS = 4, // 长按\n        PULL = 5, // 滑动\n        DRAG = 6, // 拖拽\n        SCALE = 7, // 双指缩放\n        PULL_DOWN = 8, // 下拉刷新\n        PULL_UP = 9, // 上拉加载更多\n        RIGHT_CLICK = 10, // 鼠标右键点击\n        AUTO = 11, // 自动\n    }\n\n    // 任务事件\n    export interface TaskEvent extends Event {\n        status: TaskStatus // 任务状态\n        session_id?: string; // 任务的 session Id, 确保是全局唯一, 通常使用UUID即可, 连续 Action 相同的 task 保持一样的 session id\n        operation_type?: OperationType; // 用户操作类型\n        operation_direction?: Direction;\n        url_package: UrlPackage; // Task发生页面\n        element_package: ElementPackage; // 触发Task发生的行为\n    }\n\n    // 自定义弱类型事件\n    export interface CustomEvent {\n        key: string; // 自定义事件的key\n        value: string; // 自定义事件的value\n    }\n}\n","import type { Base } from '../base';\n\nexport namespace ClientEvent {\n    // 页面元素详细信息\n    export interface ElementPackage extends Base.ElementPackage {\n        action?: string; // 元素业务类型。参考埋点需求填写即可\n    }\n\n    // 页面信息\n    export interface UrlPackage extends Base.UrlPackage {\n        page: string; // 一级页面。参考埋点需求填写即可\n    }\n\n    // 曝光类型\n    export enum ShowType {\n        UNKNOWN_TYPE = 0, // 未知\n        PAGE_AUTO = 10, // sdk自动采集页面\n        PAGE_CUSTOM = 11, // 自定义页面\n        ELEMENT = 12, // 自定义元素\n    }\n\n    // 曝光事件\n    export interface ShowEvent extends Base.ShowEvent {\n        type?: ShowType;\n        element_package?: ElementPackage;\n        content_package?: string; // 相关内容。具体项目把具体业务要上报的参数转成 json 字符串格式\n    }\n\n    export enum TaskEventType {\n        UNKNOWN_TYPE = 0,\n        USER_OPERATION = 1, // 用户操作\n        STAY_LENGTH_STAT_EVENT = 2, // 非页面级别的停留时长统计事件，比如不同tab的停留时长\n        BACKGROUND_TASK_EVENT = 3, // 记录客户端发起的后台请求任务\n    }\n    // 任务事件\n    export interface TaskEvent extends Base.TaskEvent {\n        type: TaskEventType;\n        content_package?: string; // 相关内容。具体项目把具体业务要上报的参数转成 json 字符串格式\n    }\n\n    export interface CustomEvent {\n        custom_stat_event: Base.CustomEvent;\n    }\n\n    export interface EventPackage {\n        show_event?: ShowEvent;\n        task_event?: TaskEvent;\n        stat_package?: CustomEvent;\n    }\n}\n","import type { Base } from '../base';\n\nexport namespace ClientEvent {\n    // 页面信息\n    export interface UrlPackage extends Base.UrlPackage {\n        page2: string; // 一级页面。参考埋点需求填写即可\n    }\n\n    // 页面元素详细信息\n    export interface ElementPackage extends Base.ElementPackage {\n        action2: string; // 业务类型字符串版本\n    }\n\n    export interface LaunchEvent {\n        cold: boolean;\n        detail: string;\n        mode: number;\n        source: number;\n        target: string;\n    };\n    export interface AppUsageStatEvent {\n        last_url_package: Base.UrlPackage;\n        app_use_duration: number;\n    };\n    export interface DeviceStatEvent {\n        battery: number;\n        density_dpi: number;\n        model: string;\n        os_version: string;\n        screen_height: number;\n        screen_width: number;\n    };\n    export interface ExceptionEvent {\n        type: number;\n        message: string;\n        url_package: Base.UrlPackage;\n    };\n    export interface CustomStatEvent {\n        key: string;\n        value: string;\n    };\n    export interface StatPackage {\n        launch_event?: LaunchEvent;\n        app_usage_stat_event?: AppUsageStatEvent;\n        device_stat_event?: DeviceStatEvent;\n        custom_stat_event?: CustomStatEvent;\n    };\n\n    export enum ShowType {\n        UNKNOWN2 = 0, // 未知\n        PAGE = 1, // 页面\n    }\n\n    // 页面区域信息   页面+区域+元素\n    export interface AreaPackage {\n        name: string; // 区域名称\n        params: string; // 区域补充参数\n    }\n\n    // 曝光事件\n    export interface ShowEvent extends Base.ShowEvent {\n        type?: ShowType;\n        show_type?: number; // 记录进入或离开页面的方式\n        page_show_seq?: number; // 页面展示的Sequence id，每次展示一次页面就加1(页面展示事件才有意义)\n        content_wrapper?: string; // 上报业务相关信息，客户端将content_wrapper转成json上报\n        extra_message?: string; // 用于存放一些点击时候的额外信息，可以是 json, string 分割等，此字段仅限于客户端内部分析使用！\n        area_package?: AreaPackage; // 页面区域信息\n    }\n\n    // 任务事件\n    export interface TaskEvent extends Base.TaskEvent {\n        action2: string;\n        content_package?: any; // 相关内容，TODO: 比较复杂，暂时没写\n        content_wrapper?: string; // 上报业务相关信息，客户端将content_wrapper转成json上报\n    }\n\n    export interface ClickEvent extends Base.Event {\n        type: number; // 点击类型\n        direction: Base.Direction; // Action={PULL, DRAG}时有意义\n        url_package: Base.UrlPackage; // 页面\n        element_package: Base.ElementPackage; // 所操作的元素信息\n        content_package?: any; // 相关内容，TODO: 比较复杂，暂时没写\n        extra_message?: any; // 用于存放一些点击时候的额外信息，可以是 json, string 分割等，此字段仅限于客户端内部分析使用！\n        content_wrapper?: string; // 上报业务相关信息，客户端将content_wrapper转成json上报\n        area_package?: AreaPackage; // 页面区域信息\n    }\n\n    export interface CustomEvent extends Base.CustomEvent {\n\n    }\n\n    export interface EventPackage {\n        show_event?: ShowEvent;\n        click_event?: ClickEvent;\n        task_event?: TaskEvent;\n        custom_event?: CustomEvent;\n    }\n\n    export interface VideoStatEvent extends Base.Event {\n        video_stat_event: {\n            // 视频总时长\n            duration?: number;\n            // 播放时长\n            played_duration?: number;\n            // 是否已经下载\n            downloaded?: boolean;\n            //  从进入页面到开始播放准备的时长 单位ms\n            prepare_duration?: number;\n            // 进入视频播放详情页页面的时间戳 ms\n            enter_time?: number;\n            // 离开视频播放页面的时间戳\n            leave_time?: number;\n            // 视频的类型\n            video_type?: string;\n            // 播放的时候的类型, 由于有些机型不支持 H265，或者做 A/B test 的时候视频类型和播放类型不一致.\n            play_video_type?: string;\n            // 作品ID 废弃\n            photo_id?: number;\n            // 用户离开播放页面的方式\n            leave_action?: string;\n            // 视频播放的平均fps\n            average_fps?: number;\n            // 媒体类型：短视频、图片、图集等\n            media_type?: string;\n            // 作品ID\n            s_photo_id?: number;\n            // 记录当前页面及extra参数信息\n            url_package?: Base.UrlPackage;\n            // 记录来源页面相关参数，包括来源页面、exptag、llsid等\n            refer_url_package?: Base.UrlPackage;\n            // 播放器基本状态信息，用json串上报\n            video_qos_json?: string;\n            // 从点击feed到渲染第一帧总时长\n            click_to_first_frame_duration?: number;\n            // 信号强度，单位为dbm，wifi/4g/3g/2g下均需上报\n            rssi?: number;\n            // 用户进入播放器页面的方式\n            enter_player_action?: string;\n            // 用于记录该Event的其他附属字段，可以是普通字符串或json字段\n            summary?: string;\n            // 芯片名字\n            board_platform?: string;\n            // 用户观看视频前是否收藏\n            collect_before_status?: string;\n            // 用户观看视频后是否收藏\n            collect_after_status?: string;\n            session_uuid?: string;\n            // android soc的名字，比如Kirin 960\n            soc_name?: string;\n        };\n    }\n}\n","import type { ShowEventOptions } from '../config/types';\n\nimport { Base } from '../proto/base';\nimport { ClientEvent as ClientEventV3 } from '../proto/v3/client_event';\nimport { ClientEvent as ClientEventV2} from '../proto/v2/client_event';\nimport { getPositiveInteger } from '@/util';\n\n// TODO: 这两个变量有副作用，待优化\nlet firstLoad: boolean | undefined = true;\nlet enterTime: number = new Date().valueOf();\nexport default (options: ShowEventOptions, isV2: boolean = false): ClientEventV3.EventPackage | ClientEventV2.EventPackage => {\n    const {\n        type,\n        currentUrlPackage,\n        referUrlPackage,\n        name = '',\n        action,\n        beginTime,\n        params,\n        contentPackage,\n        status,\n        actionType, // 这值目前似乎没传进来\n        auto\n    } = options;\n    const commonInfo = {\n        status: status ? (Base.ActionStatus[status] || Base.ActionStatus.UNKNOWN_STATUS) : Base.ActionStatus.SUCCESS,\n        [isV2 ? 'show_type' : 'action_type']: actionType ? (Base.ActionType[actionType] || Base.ActionType.UNKNOWN_ACTION_TYPE) : Base.ActionType.CLICK,\n        url_package: currentUrlPackage,\n        refer_url_package: referUrlPackage,\n        [isV2 ? 'content_wrapper' : 'content_package']: contentPackage,\n    };\n    if (type === 'PV') {\n        let sub_action = Base.SubAction.PAGE_ENTER;\n        let actionPB = Base.PageShowAction.ENTER;\n        let first_load = firstLoad;\n        let stay_length = 0;\n        firstLoad = false;\n        switch (action) {\n            case 'leave':\n                actionPB = Base.PageShowAction.LEAVE;\n                sub_action = Base.SubAction.PAGE_LEAVE;\n                stay_length = getPositiveInteger(new Date().valueOf() - (beginTime || enterTime));\n                break;\n            case 'enter':\n                actionPB = Base.PageShowAction.ENTER;\n                sub_action = Base.SubAction.PAGE_ENTER;\n                enterTime = new Date().valueOf();\n                break;\n            case 'visible':\n                actionPB = Base.PageShowAction.RESUME;\n                sub_action = Base.SubAction.PAGE_RESUME;\n                enterTime = new Date().valueOf();\n                break;\n            case 'hidden':\n                actionPB = Base.PageShowAction.LEAVE;\n                sub_action = Base.SubAction.PAGE_PAUSE;\n                stay_length = getPositiveInteger(new Date().valueOf() - (beginTime || enterTime));\n                break;\n        }\n        let showType: ClientEventV3.ShowType | ClientEventV2.ShowType = auto ? ClientEventV3.ShowType.PAGE_AUTO : ClientEventV3.ShowType.PAGE_CUSTOM;\n        if (isV2) {\n            first_load = undefined;\n            showType = ClientEventV2.ShowType.PAGE;\n        }\n        return {\n            show_event: {\n                action: actionPB,\n                sub_action,\n                type: showType,\n                first_load,\n                time_cost: 0,\n                stay_length,\n                ...commonInfo\n            }\n        } as ClientEventV3.EventPackage | ClientEventV2.EventPackage\n    }\n    return {\n        show_event: {\n            action: isV2 ? 0 : Base.PageShowAction.ENTER,\n            type: isV2 ? 0 : ClientEventV3.ShowType.ELEMENT,\n            sub_action: isV2 ? 0 : Base.SubAction.PAGE_ENTER,\n            element_package: {\n                [isV2 ? 'action2': 'action']: name,\n                params: JSON.stringify(params),\n            },\n            ...commonInfo\n        }\n    }\n}\n","// TODO by shaoxiaokang: 临时从 core 中复制一份 log 代码，将 incrementId 改为小程序方法\nimport type { ClientEvent as ClientEventV3 } from '../../proto/v3/client_event';\nimport type { ClientEvent as ClientEventV2 } from '../../proto/v2/client_event';\nimport type {\n    OtherEventOptions,\n    ShowEventProps,\n    TaskOperations,\n    TaskEventOptions,\n} from '@/config/types';\nimport type { DeepPartial } from 'utility-types';\n\nimport ShowEvent from '../../core/show-event';\nimport TaskEvent from '../../core/task-event';\nimport CustomStatEvent from '../../core/custom-stat-event';\nimport VideoStatEvent from '../../core/video-stat-event';\nimport { leftPad, getPositiveInteger } from '@/util';\nimport { getCustomIncrementId, getNormalIncrementId } from '@/util/mina/increment-id';\nimport Global from '../../config/global';\n\nconst GMT = (() => {\n    const timeZoneGMTOffset = (new Date()).getTimezoneOffset() / 60;\n    return timeZoneGMTOffset <= 0\n        ? `GMT+${leftPad(-timeZoneGMTOffset + '', 2, '0')}:00`\n        : `GMT-${leftPad(timeZoneGMTOffset + '', 2, '0')}:00`;\n})();\n\n// 为防止每个传出都带common_package，所以用base保留大多数信息\n// 部分信息放到每个消息体内维护，比如client_timestamp\nexport class ReportEvent {\n    // uint64 客户端时间, Event或Stat发生时的时间, 而不是上传时的时间\n    client_timestamp = getPositiveInteger(new Date().valueOf());\n\n    // uint64 客户端自增Id, 每新增一条日志+1, 必须是连续的, 用于校检数据完整性\n    client_increment_id = 0;\n\n    // string 会话id，设备冷启动或者切到后台超过5分钟再切回前台时，重新生成一个id\n    // 端内页面不可缺省\n    // Tip: 小程序的global字段不一致\n    session_id = Global.sessionId;\n    time_zone?: string;\n    event_package?: ClientEventV3.EventPackage | ClientEventV2.EventPackage;\n    stat_package?: ClientEventV3.CustomEvent | ClientEventV2.VideoStatEvent;\n    // 埋点唯一主键， PB 中已不推荐使用\n    event_id = '';\n    constructor(options: DeepPartial<ReportEvent>, isV2: boolean = false) {\n        // v2 没有 time_zone 字段\n        if (!isV2) {\n            this.time_zone = GMT;\n        }\n        Object.assign(this, options);\n        this.genIncrementId();\n    }\n    // 设置自增 id，自定义事件和常规事件使用不同的 localStorage key\n    genIncrementId() {\n        this.client_increment_id = this.isCustomStatEvent() ? getCustomIncrementId() : getNormalIncrementId();\n    }\n    // 是否是自定义事件\n    isCustomStatEvent() {\n        return !!(this.stat_package && 'custom_stat_event' in this.stat_package);\n    }\n    // 获取埋点事件类型\n    getEventType() {\n        if (this.event_package) {\n            const {\n                task_event,\n                show_event,\n                click_event,\n                custom_event,\n            } = this.event_package as ClientEventV2.EventPackage;\n            if (show_event) return 'showEvent';\n            if (click_event) return 'clickEvent';\n            if (task_event) return 'taskEvent';\n            if (custom_event) return 'customEvent';\n        }\n        return 'customEvent';\n    }\n}\n// 微信小程序事件处理\nconst StatEvent = (eventOptions: any) => {\n    const { currentUrlPackage, referUrlPackage, taskType, ...event } = eventOptions;\n    return event;\n}\n\nexport function logFactory(type: string, data: ShowEventProps | OtherEventOptions, isV2: boolean = false) {\n    const { eventId: event_id, currentUrlPackage, referUrlPackage, contentPackage, name, params } = data;\n    if (isV2 && type !== 'RADAR' && type !== 'CUSTOM') {\n        if (currentUrlPackage) {\n            // @ts-ignore\n            currentUrlPackage.page2 = currentUrlPackage.page;\n            // @ts-ignore\n            delete currentUrlPackage.page;\n        }\n        if (referUrlPackage) {\n            // @ts-ignore\n            referUrlPackage.page2 = referUrlPackage.page;\n            // @ts-ignore\n            delete referUrlPackage.page;\n        }\n    }\n    switch (type) {\n        case 'PV':\n        case 'SHOW':\n            return new ReportEvent({\n                event_package: ShowEvent({\n                    type,\n                    status: (data as ShowEventProps).status,\n                    currentUrlPackage,\n                    referUrlPackage,\n                    action: (data as ShowEventProps).type,\n                    beginTime: (data as ShowEventProps).beginTime,\n                    actionType: (data as ShowEventProps).actionType,\n                    name,\n                    params,\n                    contentPackage,\n                    operationDirection: data.operationDirection,\n                    auto: (data as ShowEventProps).auto,\n                }, isV2),\n                event_id,\n            }, isV2);\n        case 'CUSTOM':\n        case 'CUSTOM_STAT_EVENT':\n            const customData = CustomStatEvent({\n                name,\n                params,\n                currentUrlPackage,\n                referUrlPackage,\n            });\n            return new ReportEvent(isV2 ?\n                {\n                    event_package: {\n                        custom_event: customData,\n                    },\n                    event_id,\n                }\n                :\n                {\n                    stat_package: {\n                        custom_stat_event: customData,\n                    },\n                    event_id,\n                }, isV2);\n        case 'RADAR':\n            return new ReportEvent({\n                stat_package: {\n                    custom_stat_event: CustomStatEvent({\n                        name,\n                        params,\n                        currentUrlPackage,\n                        referUrlPackage,\n                    }),\n                },\n                event_id,\n            }, isV2);\n        // 小程序自定义的事件名称\n        case 'HEART_BEAT_EVENT':\n        case 'LAUNCH_EVENT':\n        case 'APP_USAGE_STAT_EVENT':\n        case 'EXCEPTION_EVENT':\n        case 'DEVICE_STAT_EVENT':\n            return new ReportEvent({\n                stat_package: {\n                    [type.toLowerCase()]: StatEvent(data)\n                },\n            }, isV2);\n        case 'VIDEO':\n            if (isV2) {\n                return new ReportEvent({\n                    stat_package: VideoStatEvent({\n                        currentUrlPackage,\n                        referUrlPackage,\n                        options: params.params,\n                    }),\n                }, isV2);\n            }\n            return new ReportEvent({\n                event_package: TaskEvent({\n                    type: type as TaskOperations,\n                    status: (data as TaskEventOptions).status,\n                    taskType: (data as TaskEventOptions).taskType,\n                    sessionId: Global.sessionId,\n                    currentUrlPackage,\n                    referUrlPackage,\n                    name,\n                    params: params.params,\n                    contentPackage,\n                }, isV2),\n                event_id,\n            }, isV2);\n        default:\n            return new ReportEvent({\n                event_package: TaskEvent({\n                    type: type as TaskOperations,\n                    status: (data as TaskEventOptions).status,\n                    taskType: (data as TaskEventOptions).taskType,\n                    sessionId: Global.sessionId,\n                    currentUrlPackage,\n                    referUrlPackage,\n                    name,\n                    params,\n                    contentPackage,\n                }, isV2),\n                event_id,\n            }, isV2);\n    }\n}\n","import type { ClientEvent as ClientEventV2 } from '../proto/v2/client_event';\nimport type { TaskEventOptions } from '../config/types';\n\nimport { Base } from '../proto/base';\nimport { ClientEvent as ClientEventV3 } from '../proto/v3/client_event';\n\nexport default (options: TaskEventOptions, isV2: boolean = false): ClientEventV3.EventPackage | ClientEventV2.EventPackage => {\n    const {\n        sessionId,\n        currentUrlPackage,\n        referUrlPackage,\n        name,\n        params,\n        type,\n        contentPackage,\n        status,\n        taskType,\n        operationDirection,\n    } = options;\n    const commonInfo = {\n        url_package: currentUrlPackage,\n        refer_url_package: referUrlPackage,\n        element_package: {\n            [isV2 ? 'action2': 'action']: name,\n            params: JSON.stringify(params),\n        },\n        [isV2 ? 'content_wrapper' : 'content_package']: contentPackage\n    }\n    if (isV2) {\n        // v2 click_event 是一个单独的事件类型，v3 则属于 task_event\n        const isV2Click = taskType === 'USER_OPERATION' || type === 'CLICK' && !taskType;\n        const operationType = type && Base.OperationType[type as keyof typeof Base.OperationType] || Base.OperationType.CLICK;\n        if (isV2Click) {\n            return {\n                click_event: {\n                    type: operationType,\n                    direction: operationDirection && Base.Direction[operationDirection] || Base.Direction.UNKNOWN2,\n                    ...commonInfo,\n                }\n            }\n        }\n        return {\n            task_event: {\n                action2: name,\n                status: status && Base.TaskStatus[status] || Base.TaskStatus.UNKNOWN_STATUS,\n                ...commonInfo,\n            }\n        }\n    }\n    return {\n        task_event: {\n            type: taskType && ClientEventV3.TaskEventType[taskType as keyof typeof ClientEventV3.TaskEventType] || ClientEventV3.TaskEventType.USER_OPERATION,\n            status: status && Base.TaskStatus[status] || Base.TaskStatus.UNKNOWN_STATUS,\n            operation_type: Base.OperationType[type] || Base.OperationType.CLICK,\n            operation_direction: operationDirection && Base.Direction[operationDirection] || Base.Direction.UNKNOWN2,\n            session_id: sessionId,\n            ...commonInfo\n        }\n    }\n}","import type { Base } from '../proto/base';\nimport type { CustomStatEventOptions } from '../config/types';\n\n/**\n * 自定义事件上报\n */\nexport default (options: CustomStatEventOptions): Base.CustomEvent => {\n    const { name, params, currentUrlPackage, referUrlPackage, ...extra } = options;\n    return {\n        key: name,\n        value: JSON.stringify({\n            url_package: currentUrlPackage,\n            refer_url_package: referUrlPackage,\n            ...params,\n            ...extra,\n        })\n    };\n}\n","import type { ClientEvent } from '@/proto/v2/client_event';\nimport type { Base } from '@/proto/base';\nimport type { VideoEventOptionsParams } from '@/config/types';\n\ninterface Params {\n    currentUrlPackage: Base.UrlPackage;\n    referUrlPackage: Base.UrlPackage | undefined;\n    options: VideoEventOptionsParams;\n}\n\nexport default (params: Params): ClientEvent.VideoStatEvent => {\n    const { currentUrlPackage, referUrlPackage, options } = params;\n    return {\n        video_stat_event: {\n            ...options,\n            url_package: currentUrlPackage,\n            refer_url_package: referUrlPackage,\n        },\n    };\n}\n","import type { Weblogger, EntryTagType } from '@/config/types';\n\n// 原则： setEntryTag 之后必须 consumeEntryTag 否则染色信息不准确。\n\nexport default class EntryTag {\n    weblog: Weblogger;\n    private _tagQueue: EntryTagType[] = []; // 存放真实entrytag列表和顺序\n    private _stashQueue: EntryTagType[] = []; // 存放pending数据和顺序\n    private _identityQueue: string[] = []; // 存放identity信息和顺序\n    constructor(weblog: Weblogger) {\n        this.weblog = weblog;\n    }\n\n    /**\n     * 获取 entryTags 信息\n     */\n    getEntryTags() {\n        return this._tagQueue;\n    }\n\n    /**\n     * 设置 entryTag 信息\n     * @param entryTag\n     */\n    setEntryTag(entryTag: EntryTagType) {\n        return this._stashQueue.push(entryTag);\n    }\n\n    /**\n     * 判断是否能消费\n     * @param entryTag\n     */\n    private shouldConsume() {\n        return this._stashQueue.length > 0;\n    }\n\n    private pushState(identity: string) {\n        this._tagQueue.push(this._stashQueue.pop() as EntryTagType);\n        this._identityQueue.push(identity);\n    }\n    private ifIdentityEmpty(identity: string) {\n        if (!identity) {\n            throw new Error('Identity is required');\n        }\n    }\n    private ifIdentityRepeat(identity: string) {\n        if (this._identityQueue.indexOf(identity) > 0) {\n            throw new Error(`Identity ${identity} is already exist. Please change a new one.\\n Current identity list: ${this._identityQueue.join(', ')}`);\n        }\n    }\n    /**\n     * 消费 entryTags 信息\n     * @param identity\n     */\n    consumeEntryTag(identity: string) {\n\n        this.ifIdentityEmpty(identity);\n\n        this.ifIdentityRepeat(identity);\n\n        // 移除之前队列中的日志，防止entryTag变化\n        this.weblog.flush();\n\n        const shouldConsume = this.shouldConsume();\n        if (!shouldConsume) { return; }\n\n        this.pushState(identity);\n\n        this.updateCommonGlobalAttr();\n    }\n    private updateCommonGlobalAttr() {\n        const entryTag = this.getEntryTags();\n        if (entryTag.length) {\n            this.weblog.commonPackage.updateGlobalAttr({\n                entry_tag: entryTag,\n            });\n        }\n        return entryTag;\n    }\n    /**\n     * 清空 entryTags 信息\n     * @param identity\n     * @param containSelf\n     */\n    clearEntryTag(identity: string, containSelf: boolean = true) {\n        this.ifIdentityEmpty(identity);\n\n        let index = this._identityQueue.indexOf(identity);\n        if (index === -1) {\n            console.warn(`Identity ${identity} isn't exist`);\n            return;\n        }\n        index = !containSelf ? index + 1 : index;\n        let pos = this._identityQueue.length - index;\n        while (pos > 0) {\n            this._tagQueue.pop();\n            this._identityQueue.pop();\n            pos--;\n        }\n\n        this.updateCommonGlobalAttr();\n    }\n}\n","/**\n * @file 日志公参，基本确定不变的数据\n * @author <zhangshen@kuaishou.com>\n */\nimport type { Base } from '../proto/base';\nimport type { DeepPartial } from 'utility-types';\nimport { H5ExtraAttr, networkType, BaseOptions, GlobalAttr } from '@/config/types';\nimport { flattenAssign } from '@/util';\n\nexport type CommonPackageOptions = DeepPartial<Base.CommonPackage>;\nexport type ICommonPackage = typeof CommonPackage;\n\nexport class CommonPackage implements Base.CommonPackage {\n    // 默认值为 undefined 减小上报时字段\n    // 标识信息\n    identity_package: Base.IdentityPackage = {\n        device_id: undefined,\n        global_id: undefined,\n        user_id: undefined,\n        union_id: undefined,\n        open_id: undefined,\n        iu_id: undefined\n    };\n    // 应用信息\n    app_package: Base.AppPackage = {\n        product: undefined,\n        language: undefined,\n        platform: undefined,\n        container: 'H5',\n        package_name: undefined,\n        product_name: undefined,\n        version_name: undefined,\n        channel: undefined,\n        version_code: undefined,\n    };\n    experiment?: any[] = undefined;\n    service_name?: string = undefined;\n    safety_id?: string = undefined;\n    sub_biz?: string = undefined;\n    // 设备信息\n    device_package: Base.DevicePackage = {\n        os_version: undefined,\n        model: undefined,\n        ua: undefined,\n    };\n    need_encrypt: boolean = false;\n    network_package: Base.NetworkPackage = {\n        type: networkType.unknown,\n    };\n    // H5 附加参数\n    h5_extra_attr: H5ExtraAttr = {\n        // SDK 版本信息\n        sdk_name: '__SDK_NAME__',\n        sdk_version: '__VERSION__',\n        sdk_bundle: '__SDK_BUNDLE__',\n    };\n    global_attr: GlobalAttr = {\n        // 染色参数\n        entry_tag: [],\n    };\n    location_package?: Base.LocationPackage = {\n        country: undefined, // 国家\n        province: undefined, // 省份/自治区/州\n        city: undefined, // 城市\n        county: undefined, // 县/区域\n        street: undefined, // 街道\n        latitude: undefined, // 纬度\n        longitude: undefined, // 经度\n    };\n\n    constructor(options: CommonPackageOptions | BaseOptions) {\n        this.update(options);\n        if (this.app_package.version_name) {\n            const lastDotIndex = this.app_package.version_name.lastIndexOf('.');\n            this.app_package.version_code = +this.app_package.version_name.slice(lastDotIndex + 1) || 0;\n        }\n        if (!this.app_package.version_name) {\n            this.app_package.version_name = undefined;\n        }\n        if (!this.app_package.version_code) {\n            this.app_package.version_code = undefined;\n        }\n    }\n\n    getH5ExtraAttr(extraInfo?: {[key: string]: any}) {\n        return Object.assign({}, this.h5_extra_attr, extraInfo);\n    }\n    /**\n     * 更新 commonPackage 信息\n     * @param options\n     * @returns\n     */\n    update(options: CommonPackageOptions | BaseOptions) {\n        if (typeof options !== 'object') return;\n        flattenAssign(this, options);\n        // network type 特殊处理\n        const network = (options as BaseOptions).network_type;\n        if (network && (networkType as any)[network]) {\n            this.network_package.type = (networkType as any)[network];\n        }\n    }\n    /**\n     * 更新 global_attr 信息\n     * @param options\n     */\n    updateGlobalAttr(options: {[key: string]: any}) {\n        Object.assign(this.global_attr || {}, options);\n    }\n    /**\n     * 将 commonPackage 转换为 json 输出\n     * @returns\n     */\n    toJSON() {\n        // 处理 v2 空字符串接口会报错问题\n        if (!this.identity_package.user_id) {\n            this.identity_package.user_id = undefined;\n        }\n        const json: Base.CommonPackage = {\n            ...this,\n            toJSON() {\n                return {\n                    ...json,\n                    h5_extra_attr: JSON.stringify(json.h5_extra_attr),\n                    global_attr: JSON.stringify(json.global_attr),\n                };\n            }\n        };\n        json.global_attr = {...this.global_attr};\n        if (this.global_attr.entry_tag && this.global_attr.entry_tag.length) {\n            json.global_attr.entry_tag = this.global_attr.entry_tag.slice();\n        } else {\n            // 节省上报字段\n            delete json.global_attr.entry_tag;\n        }\n        if (!Object.keys(this.global_attr).length) {\n            // 节省上报字段\n            delete json.global_attr;\n        }\n        const location = this.location_package;\n        if (location) {\n            Object.keys(location).forEach((key) => {\n                if (typeof location[key as keyof Base.LocationPackage] === 'undefined') {\n                    delete location[key as keyof Base.LocationPackage];\n                }\n            });\n        }\n        return json;\n    }\n}\n","import storage from './storage';\n\nconst KEY_COOKIE = 'cookie';\n\nclass Cookie {\n    get cookie() {\n        return storage.get(KEY_COOKIE) || {};\n    }\n\n    /**\n     *\n     * 设置 cookie value\n     * @param {string} key 设置的key\n     * @param {*} value 设置的值\n     * @param {number} [expirationTime] 过期时间，超过后这个 key 会清空，value 为 null\n     * @param {boolean} [sync] 是否同步设置cookie\n     */\n    set(key: any, value: any, expirationTime?: number, sync?: boolean) {\n        // 性能优化: 无更新的值不 set\n        if (value === this.get(key)) {\n            return;\n        }\n\n        let newCookie = this.cookie;\n\n        if (typeof key === 'object') {\n            newCookie = {\n                ...newCookie,\n                ...key,\n            };\n        } else {\n            newCookie[key] = value;\n        }\n\n        storage.set(KEY_COOKIE, newCookie, expirationTime, sync);\n    }\n\n    get(key: string) {\n        return this.cookie[key];\n    }\n\n    remove(key: string) {\n        const { value, expirationTime } = storage.getCompleteStorage(KEY_COOKIE);\n        const result = value[key] && delete value[key];\n\n        storage.set(KEY_COOKIE, value, expirationTime);\n        return result;\n    }\n\n    toCookieString() {\n        const arr = [];\n\n        for (let key in this.cookie) {\n            let value;\n            try {\n                key = key.replace(/[^#$&+^`|]/g, encodeURIComponent);\n                key = key.replace(/\\(/g, '%28').replace(/\\)/g, '%29');\n                value = (this.cookie[key] + '').replace(\n                    /[^!#$&-+\\--:<-[\\]-~]/g,\n                    encodeURIComponent\n                );\n            } catch (e) {\n                // cookie 里的 value 可能会导致 encodeURIComponent 报错\n                // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Errors/Malformed_URI\n                // TODO 可以单独上报 error 的时候进行上报，暂时用 console.log 是为了防止呑错\n                console.log(e);\n                continue;\n            }\n\n            arr.push(key + '=' + value);\n        }\n\n        return arr.join('; ');\n    }\n}\n\nexport default new Cookie();\n","import type { CommonPackageOptions } from '@/core/common';\nimport { CommonPackage as BaseCommonPackage } from '@/core/common';\nimport Cookie from '@/util/mina/cookie';\nimport { getSystemInfo, getNetworkType } from '@/util/mina/systeminfo';\nimport { STATE_KEY } from '@/util/mina/types';\nimport { updateConfig } from '@/config/global';\nimport { error } from '@/util/console';\nimport { mp, getMpContainer } from '@/util/mina/global'\n\nexport class CommonPackage extends BaseCommonPackage {\n    constructor(options: CommonPackageOptions, logConfig: any) {\n        super({\n            container: getMpContainer(),\n            ...options\n        });\n        this.updateSystemInfo(options || {});\n    }\n    updateSystemInfo(options: CommonPackageOptions) {\n        getSystemInfo((systemInfo) => {\n            if (systemInfo) {\n                const { platform, language, system, model, brand, screenHeight, screenWidth, pixelRatio, mpSDKVersion, mpVersion } = systemInfo;\n                this.update({\n                    platform,\n                    app_package: {\n                        language,\n                    },\n                    device_package: {\n                        os_version: system,\n                        ua: '',\n                        model: JSON.stringify({\n                            model,\n                            brand,\n                        })\n                    },\n                    ...options,\n                    h5_extra_attr: {\n                        screen_with: Math.floor(screenWidth),\n                        screen_height: Math.floor(screenHeight),\n                        device_pixel_ratio: pixelRatio,\n                        resolution: `${Math.floor(screenWidth * pixelRatio)}x${Math.floor(screenHeight * pixelRatio)}`,\n                        mpSDKVersion,\n                        mpVersion,\n\n                        ...options.h5_extra_attr\n                    },\n                });\n            }\n            updateConfig(STATE_KEY.APP_DEVICE_PACKAGE_READY, true);\n        });\n        getNetworkType((networkType) => {\n            this.update({\n                network_package: {\n                    type: networkType\n                }\n            });\n        });\n    }\n    /**\n     * 检查必填参数\n     */\n    checkMustProps() {\n        if (typeof this.app_package.product_name !== 'string') {\n            error('请设置有效的 product_name 值!');\n        }\n    }\n\n    override toJSON() {\n        if (!this.identity_package.user_id) {\n            this.identity_package.user_id = Cookie.get('userId') || Cookie.get('userName') || '';\n        }\n        return super.toJSON();\n    }\n}\n","import type {\n    PageData,\n    ExtraInfo,\n    PublicParams,\n    TrackParams,\n    PVParams,\n    CustomParams,\n} from './types';\nimport type {\n    EventType as IEventType,\n    EventOptions as IEventOptions,\n    ImmediatelyEventOptions,\n} from '@/types/mina';\nimport type { HttpWeblogInitParamsMina } from '@/types/configuration';\n\nimport BaseWeblog from '@/core';\nimport UrlPackage from './url-package';\nimport Logger from './logger';\nimport { PAGE_INSTANCE_ATTR, PUBLIC_PARAM, STATE_KEY } from '@/util/mina/types';\nimport MinaAutoPV from '@/plugins/minaAutoPV';\nimport { logFactory } from './log';\nimport {\n    getDid,\n    didPrefix,\n    generateSessionId,\n    setDid,\n} from '@/util/mina/did';\n\nimport {\n    UrlObj,\n    BaseOptions,\n    Weblogger as WebloggerType,\n    EntryTagType,\n    SupportTypes,\n    TaskOperations,\n    PVOptions,\n    EventTypes,\n    ShowOptions,\n    TaskOptions,\n    CustomOptions,\n    EventOptions,\n    PageTypeKey,\n    ClickOptions\n} from '@/config/types';\n\nimport Global, { updateConfig } from '@/config/global';\nimport EntryTag from './entry-tag';\nimport { initDid } from '@/util/mina/did';\nimport { initStore } from '@/util/mina/store';\nimport { getCurrentPageInstance, genUrlIdentity } from '@/util/mina/page';\nimport { CommonPackage } from './common';\n\n\ntype MinaEventTypes = 'LAUNCH_EVENT' | 'HEART_BEAT_EVENT' | 'APP_USAGE_STAT_EVENT' | 'EXCEPTION_EVENT' | 'DEVICE_STAT_EVENT';\n\nexport default class Weblog extends BaseWeblog {\n    declare currentUrlPackage: UrlPackage;\n    declare referUrlPackage?: UrlPackage;\n    declare logger: Logger;\n    entryTag: EntryTag | null = null;\n    declare logConfig: HttpWeblogInitParamsMina[0];\n    override commonPackage: CommonPackage;\n    perennialExtra: {[key: string]: any} = {};\n    constructor(\n        logConfig: HttpWeblogInitParamsMina[0],\n        base?: HttpWeblogInitParamsMina[1],\n    ) {\n        super(logConfig, base);\n        this.commonPackage = new CommonPackage(this.baseOption, this.logConfig);\n        initStore(); // 初始化小程序的数据缓存\n        this.updateCommonPackage({\n            device_id: initDid()\n        }); // 初始化 did\n        this.logger = new Logger(this.logConfig, this.commonPackage);\n        this.entryTag = new EntryTag(this as unknown as WebloggerType);\n        this.initBuildInPlugins();\n        // 永久保存初始化时的h5_extra_attr，否则可能会被重置\n        this.setPerennialExtra(this.commonPackage.h5_extra_attr);\n        // 设置sessionId\n        this.updateSessionId(this.commonPackage.identity_package.device_id);\n        // 初始化urlPackage\n        this.initUrlPackage();\n        this.addPlugins();\n    }\n\n    override initUrlPackage() {\n        const currentPage = getCurrentPageInstance();\n        this.updateCurrentUrlPackage({\n            page: (currentPage as any)[PAGE_INSTANCE_ATTR.PAGE],\n            params: (currentPage as any)[PAGE_INSTANCE_ATTR.PAGE_PARAMS]\n        });\n    }\n\n    override updateCurrentUrlPackage(url: string | UrlObj = '', type: PageTypeKey = 'mina') {\n        if (typeof url === 'object' && !url.force && this.currentUrlPackage) {\n            const { page = this.currentUrlPackage.page, params = {} } = url;\n            if (page === this.currentUrlPackage.page) {\n                return this.currentUrlPackage.update(page, params);\n            }\n        }\n        this.currentUrlPackage = new UrlPackage(url as UrlObj, type);\n    }\n\n    override generateLog<T extends IEventType>(\n        eventType: T,\n        eventOptions: IEventOptions<T>,\n        factory: (type: string, data: any) => any = logFactory,\n    ) {\n        let { action, params, status, type, eventId, contentPackage, urlPage } = eventOptions as TaskOptions;\n        const referUrlPackage = this.referUrlPackage ? this.referUrlPackage?.toJSON() : undefined;\n        if (contentPackage) {\n            contentPackage = typeof contentPackage === 'string' ? contentPackage : JSON.stringify(contentPackage);\n        }\n        const commonInfo = {\n            currentUrlPackage: this.currentUrlPackage?.toJSON(),\n            referUrlPackage,\n            contentPackage\n        };\n        if (eventType === EventTypes.PV) {\n            // PV 类型\n            const { type } = eventOptions as PVOptions;\n            return factory(eventType, {\n                ...eventOptions as PVOptions,\n                type,\n                ...commonInfo\n            });\n        }\n        // 小程序页面飘移问题处理：页面离开时上报的埋点无法严格保证在 PV leave 前上报\n        if (typeof urlPage === 'object') {\n            const { page, identity, params: newParams } = urlPage;\n            if (page && commonInfo.currentUrlPackage.page !== page) {\n                commonInfo.currentUrlPackage = {\n                    page,\n                    identity: identity || genUrlIdentity(page),\n                    params: JSON.stringify(newParams),\n                    page_type: this.currentUrlPackage?.page_type,\n                    category: '',\n                };\n            } else if (newParams) {\n                this.currentUrlPackage?.update('', newParams);\n                commonInfo.currentUrlPackage = this.currentUrlPackage?.toJSON();\n                if (identity && commonInfo?.currentUrlPackage) {\n                    commonInfo.currentUrlPackage.identity = identity;\n                }\n            }\n        }\n\n        if (eventType === EventTypes.SHOW) {\n            // SHOW 类型\n            const { action } = eventOptions as ShowOptions;\n            return factory(eventType, {\n                ...eventOptions as ShowOptions,\n                name: action,\n                ...commonInfo\n            });\n        }\n\n        if ([EventTypes.CUSTOM, EventTypes.RADAR, EventTypes.CUSTOM_EVENT].indexOf(eventType as EventTypes) !== -1) {\n            // CUSTOM 类型\n            const { key, value, eventId } = eventOptions as CustomOptions;\n            return factory(EventTypes.CUSTOM, {\n                ...eventOptions,\n                params: value,\n                eventId,\n                name: key,\n                ...commonInfo\n            });\n        }\n\n        // Radar 日志特殊处理\n        if (eventType === EventTypes.RADAR) {\n            return factory(eventType, eventOptions);\n        }\n\n        // TASK 类型\n        return factory(eventType, {\n            ...eventOptions,\n            params,\n            status,\n            taskType: type,\n            eventId,\n            name: action,\n            ...commonInfo\n        });\n    }\n    /**\n     * 更新 refer url 信息\n     * @param url\n     * @param type\n     */\n    override updateReferUrlPackage(url: UrlObj | UrlPackage = this.currentUrlPackage, type: PageTypeKey = 'mina') {\n        super.updateReferUrlPackage(url, type);\n    }\n\n    /**\n     * 获取染色参数信息\n     */\n    getEntryTags() {\n        return this.entryTag && this.entryTag.getEntryTags();\n    }\n    /**\n     * 设置染色参数\n     * @param entryTag\n     */\n    setEntryTag(entryTag: EntryTagType) {\n        return this.entryTag && this.entryTag.setEntryTag(entryTag);\n    }\n\n    /**\n     * 消费 entryTags 信息\n     * @param subPage\n     */\n    consumeEntryTag(subPage: string) {\n        return this.entryTag && this.entryTag.consumeEntryTag(subPage);\n    }\n\n    /**\n     * 清空 entryTags 信息\n     * @param subPage\n     * @param containSelf\n     */\n    clearEntryTag(subPage: string, containSelf: boolean = true) {\n        return this.entryTag && this.entryTag.clearEntryTag(subPage, containSelf);\n    }\n    initBuildInPlugins() {\n        const {\n            minaAutoPV,\n        } = this.logConfig;\n        if (minaAutoPV) {\n            this.plug(MinaAutoPV);\n        }\n    }\n\n    init(logConfig: HttpWeblogInitParamsMina[0], base?: HttpWeblogInitParamsMina[1]) {\n        // 替换参数\n        if (logConfig.batchReportInterval) {\n            logConfig.wait = logConfig.batchReportInterval;\n            delete logConfig.batchReportInterval;\n        }\n        return new Weblog(logConfig, base);\n    }\n\n    track(params: TrackParams) {\n        const {\n            operation,\n            elementAction,\n            elementParam,\n            contentPackage,\n            status,\n            type,\n        } = params;\n        this.collect(operation as SupportTypes, {\n            action: elementAction!,\n            params: elementParam,\n            type,\n            status,\n            contentPackage,\n        } as IEventOptions<'CLICK'>);\n    }\n    sendPV(params: PVParams) {\n        const {\n            type,\n            actionType,\n            status,\n            elementAction,\n            elementParam,\n            contentPackage,\n        } = params;\n        const sendType = type === 'ELEMENT' ? 'SHOW' : 'PV';\n        this.collect(sendType, {\n            action: elementAction!,\n            actionType,\n            params: elementParam,\n            name: elementAction,\n            type,\n            status,\n            contentPackage,\n        } as IEventOptions<'PV'>);\n    }\n\n    setPage({ page, pageParam: params }: PageData) {\n        // 手动设置下referUrlpackage\n        if (this.currentUrlPackage?.page && this.currentUrlPackage?.page !== page) {\n            this.updateReferUrlPackage();\n        }\n        this.updateCurrentUrlPackage({\n            page,\n            params\n        });\n    }\n\n    sendCustomEvent(params: CustomParams) {\n        this.collect('CUSTOM', params);\n    }\n\n    private genWebloggerParams(params: PublicParams) {\n        const { did,\n            uid,\n            unionid,\n            openid } = params;\n        return {\n            device_id: did,\n            user_id: uid,\n            union_id: unionid,\n            open_id: openid,\n            ...params,\n        };\n    }\n\n    setPublicParam(params: PublicParams) {\n        const weblogParams = this.genWebloggerParams(params);\n        const { did } = weblogParams;\n\n        if (did) {\n            const preDid = getDid();\n\n            // preDid是webLogger生成的，在extraInfo里设置标识\n            if (preDid && preDid.indexOf(didPrefix) >= 0) {\n                this.setExtraInfo({\n                    ksminaDid: preDid,\n                }, true);\n            }\n            // 如果当前session_id是由webLogger生成的did拼接而成的，更新session_id，尽量减少不准确的数据。\n            // 在小程序App.onShow时，会触发session_id的更新。\n            // 使用方应该在登录成功后调用setPublicParam，更新common_package数据。\n            if (Global.sessionId && Global.sessionId.indexOf(didPrefix) >= 0) {\n                this.updateSessionId(did);\n            }\n            setDid(did);\n        }\n\n        // 更新common_package中的参数\n        for (const key in weblogParams) {\n            if (Object.prototype.hasOwnProperty.call(weblogParams, key)) {\n                const element = weblogParams[key as keyof typeof weblogParams];\n                const shouldUpdate = element !== undefined;\n                shouldUpdate && this.updateCommonPackage({\n                    [key]: element,\n                });\n            }\n        }\n\n        // identity_package中的数据设置完成\n        updateConfig(STATE_KEY.IDENTITY_PACKAGE_READY, true);\n    }\n\n    sendExceptionEvent(params: any) {\n        this.collect('EXCEPTION_EVENT' as SupportTypes, params);\n    }\n\n    setSystemInfo() {\n        // 兼容保留\n    }\n\n    setLoggerSessionUrl(url: string) {\n        this.logger.config.env = 'logger';\n        this.logger.updateUrls(url);\n    }\n\n    setExtraInfo(extraInfo: ExtraInfo, append: boolean = false) {\n        const extraAttr = {\n            ...this.perennialExtra,\n            ...extraInfo\n        }\n\n        if (append) {\n            // updateCommonPackage 默认是append\n            this.updateCommonPackage({ h5_extra_attr: extraAttr });\n            return;\n        }\n        // 非append 需要先清空h5_extra_attr\n        this.commonPackage.h5_extra_attr = {};\n        this.updateCommonPackage({ h5_extra_attr: extraAttr });\n    }\n\n    setPerennialExtra(extraInfo: ExtraInfo) {\n        this.perennialExtra = {\n            ...this.perennialExtra,\n            ...extraInfo\n        };\n        this.setExtraInfo({}, true);\n    }\n\n    updateSessionId(did?: string) {\n        updateConfig(PUBLIC_PARAM.SESSION_ID, generateSessionId(did));\n        this.emit('updateSessionId');\n    }\n\n    setCommonPackageReady() {\n        // identity_package中的数据设置完成\n        updateConfig(STATE_KEY.IDENTITY_PACKAGE_READY, true);\n    }\n    /**\n     * 事件发送前的处理\n     * @param type\n     * @param options\n     */\n    beforeSend<T extends IEventType>(type: T, options?: IEventOptions<T>) {\n        // 点击事件可以设置染色参数\n        if (type === 'CLICK') {\n            const entryTag = (options as ClickOptions)?.entryTag;\n            entryTag && this.setEntryTag({\n                page_name: this.currentUrlPackage?.page,\n                element_action: (options as IEventOptions<'CLICK'>)?.action,\n                ...entryTag\n            });\n        } else if (type === 'PV') {\n            const pvOption = options as PVOptions;\n            const pvType = pvOption?.type;\n            if (!pvType || pvType === 'enter') {\n                if (!this.currentUrlPackage?.page && pvOption?.page) {\n                    this.updateCurrentUrlPackage({\n                        page: pvOption.page,\n                        params: pvOption.params,\n                    });\n                }\n                const id = this.currentUrlPackage?.identity;\n                this.clearEntryTag(id);\n                this.consumeEntryTag(id);\n            }\n        }\n    }\n    /**\n     * 收集上报\n     * @param type\n     * @param options\n     * @returns\n     */\n     override collect<T extends IEventType>(type: T, options: IEventOptions<T> = {}): void {\n        this.send(type, options);\n    }\n\n    override sendImmediately<T extends IEventType>(type: T, options: ImmediatelyEventOptions<T> = {}): void {\n        this.send(type, options, true);\n    }\n\n    override send<T extends IEventType>(\n        type: T,\n        params: ImmediatelyEventOptions<T>,\n        immediately?: boolean,\n    ) {\n        this.beforeSend(type, params);\n        const log = this.generateLog(type, params);\n        // 雷达日志单独处理\n        if (type === 'RADAR') {\n            return this.logger.sendRadar(log, (params as ImmediatelyEventOptions<'RADAR'>)?.serviceName);\n        }\n        const callback = typeof params === 'object' && params.callback || undefined;\n        this.logger.send(log, !!immediately, callback);\n    }\n}\n"],"names":["BasePlugin","prototype","apply","weblog","this","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","call","__extends","TypeError","String","__","constructor","create","__assign","assign","t","s","i","n","arguments","length","__rest","e","indexOf","getOwnPropertySymbols","propertyIsEnumerable","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","rejected","result","adopt","done","then","__generator","body","f","y","g","_","label","sent","trys","ops","verb","Symbol","iterator","v","op","pop","push","__spreadArray","to","from","pack","ar","l","slice","concat","GlobalConfig","sessionId","appDevicePackageReady","identityPackageReady","updateConfig","key","UrlPackage","url","pageType","page","identity","page_type","update","params","generatePageId","toJSON","JSON","stringify","category","Date","getTime","error","args","_i","error_1","console","leftPad","str","len","ch","pad","isObj","obj","isArray","getPositiveInteger","Math","abs","floor","EventEmitter","events","on","eventName","callback","_a","off","array","item","index","arr","splice","emit","forEach","pluginIndex","Weblog","_super","logConfig","base","options","_this","version","plugins","flush","logger","baseOption","env","proto","timeout","wait","maxBatchLength","sampleRate","yoda","window","forbidV2HttpUrlPage","initUrlPackage","__instance","defineProperty","get","Global","updateCurrentUrlPackage","type","currentUrlPackage","updateReferUrlPackage","referUrlPackage","updateBase","updateCommonPackage","commonPackage","addPlugins","plugin","addPluginInstance","pluginInstance","plug","pluginOptions","unplug","name","destroy","unplugAll","generateLog","eventType","eventOptions","send","immediately","log","toUpperCase","beforeSend","collect","sendImmediately","sendPackage","data","MP","getMpContainer","wx","keys","my","swan","ks","mp","isAlipay","relativeTimeToTimestamp","relativeTime","Error","currentTime","now","timeCount","split","time","timeNumber","parseInt","timeUnit","test","TaskOperations","EventTypes","storage","Storage","cache","getCompleteStorage","fullKey","res","getStorageSync","isSDKStorage","realValue","expirationTime","undefined","hasExpried","remove","set","sync","status","isAllNumber","Number","setStorageSync","setStorage","fail","removeStorage","clear","clearStorage","INIT_STORE_DATA","setStore","val","store","t_1","k","getStore","randomHex","random","toString","initDid","did","getDid","setDid","emptyPage","route","genUrlIdentity","BaseUrlPackage","dataTrackHost","testHost","v3Api","Envs","Apis","v2","v3","radar","Hosts","production","round","development","oversea","buildUrl","formatUrlQuery","querys","replace","err","BatchLog","config","asyncQueue","throttleQueue","errorQueue","sendingQueue","isV2","isDebug","radarUrl","drained","batchCount","isSetSamplingResult","sendingYield","sendLogs","drain","flushErrorLogs","setTimeout","min","updateUrls","sendData","sender","baseSendData","app_package","product_name","product","device_id","identity_package","formatUrl","getCommonPackageJSON","immediate","sendAsync","sendThrottle","clearTimeout","batchWaitTimer","logs","buildLogPackage","errHandler","isDrained","buildV2Package","buildV3Package","event","commonPackageOptions","common","logPackage","unshift","h5_extra_attr","http_seq_id","client_timestamp","merged","currentLog","destory","compensateTimer","sendRadar","service_name","radarPackage","STATE_KEY","PUBLIC_PARAM","PAGE_INSTANCE_ATTR","xhrErrorLog","getReportUrl","viewHost","reportHost","loggerUrl","log_1","Logger","continueSend","sendPromise","request","header","content-type","headers","method","success","setResponseSamplingConfig","getResponseSamplingStorage","storageEffectiveTime","responseSamplingStorageKey","sendEffectiveTime","shouldSendPackage","loggerEnv","includes","getLoggerReportUrl","commonPackageDone","identityPackageDone","sendUtilIdentityDone","responsePromise","response","expireSeconds","effectiveTime","completeLog","session_id","BaseLogger","networkType","unknown","none","wifi","4g","3g","2g","5g","slow-2g","info","network","STORE_KEY","STATUS","EVENT_NAME","getPlatformPB","platform","model","toLocaleLowerCase","getSystemInfo","systemInfo","mpVersion","mpSDKVersion","SDKVersion","complete","getNetworkType","getNetworkTypePB","runtimeIdMap","genId","id","prevTimestamp","setPrevTimestamp","timestamp","getReportData","upload_frequency","seq","app_use_duration","event_name","genLaunchData","target","scene","cold","mode","C","H","source","detail","L","isSendFirst","genAppProxyConfig","report","launchIntervalLimit","backgroundWaitingLimit","appTimer","heartBeatTimer","onLaunch","system","screenWidth","screenHeight","batteryLevel","os_version","density_dpi","screen_width","screen_height","battery","D","HeartBeat.setPrevTimestamp","setInterval","HeartBeat.getReportData","onShow","param","path","query","showInterval","SHOW_TIME","enterPath","sp","encodeURIComponent","join","appendParam","getCurrentPages","updateSessionId","onHide","appShowTime","appHideTime","stayLength","prevStayLength","STAY","totalStayLength","HIDE_TIME","reportStayLengthParam","U","clearInterval","proxyApp","App","originApp_1","appOptions","hostOptions","fnList_1","replacement","isForced","wrapped","proxy","originMethod","fn","proxyLifeCycle","Base","ClientEvent","defaultLifeHookTrackConfig","MinaAutoPV","localGlobal","getAppConfig","bind","sendType","ElementStatus","PageShowAction","ActionStatus","ActionType","SubAction","Direction","TaskStatus","OperationType","ShowType","TaskEventType","timeZoneGMTOffset","firstLoad","enterTime","valueOf","ShowEvent","_c","action","beginTime","contentPackage","actionType","auto","commonInfo","UNKNOWN_STATUS","SUCCESS","UNKNOWN_ACTION_TYPE","CLICK","url_package","refer_url_package","sub_action","PAGE_ENTER","actionPB","ENTER","first_load","stay_length","LEAVE","PAGE_LEAVE","RESUME","PAGE_RESUME","PAGE_PAUSE","showType","ClientEventV3","PAGE_AUTO","PAGE_CUSTOM","ClientEventV2","PAGE","show_event","time_cost","ELEMENT","element_package","_b","TaskEvent","taskType","operationDirection","isV2Click","operationType","click_event","direction","UNKNOWN2","task_event","action2","USER_OPERATION","operation_type","operation_direction","CustomStatEvent","extra","VideoStatEvent","video_stat_event","GMT","getTimezoneOffset","ReportEvent","client_increment_id","event_id","time_zone","genIncrementId","isCustomStatEvent","stat_package","getEventType","event_package","custom_event","logFactory","eventId","page2","customData","custom_stat_event","toLowerCase","EntryTag","_tagQueue","_stashQueue","_identityQueue","getEntryTags","setEntryTag","entryTag","shouldConsume","pushState","ifIdentityEmpty","ifIdentityRepeat","consumeEntryTag","updateCommonGlobalAttr","updateGlobalAttr","entry_tag","clearEntryTag","containSelf","pos","CommonPackage","global_id","user_id","union_id","open_id","iu_id","language","container","package_name","version_name","channel","version_code","experiment","safety_id","sub_biz","device_package","ua","need_encrypt","network_package","sdk_name","sdk_version","sdk_bundle","global_attr","location_package","country","province","city","county","street","latitude","longitude","lastDotIndex","lastIndexOf","getH5ExtraAttr","extraInfo","merge","obj1","obj2","deepKey","flattenAssign","network_type","json","location","Cookie$1","Cookie","newCookie","cookie","toCookieString","updateSystemInfo","brand","pixelRatio","screen_with","device_pixel_ratio","resolution","checkMustProps","BaseCommonPackage","perennialExtra","initBuildInPlugins","setPerennialExtra","currentPage","force","factory","_f","urlPage","PV","type_1","newParams","_d","_e","SHOW","action_1","CUSTOM","RADAR","CUSTOM_EVENT","_g","eventId_1","subPage","init","batchReportInterval","track","operation","elementAction","elementParam","sendPV","setPage","pageParam","sendCustomEvent","genWebloggerParams","uid","unionid","openid","setPublicParam","weblogParams","preDid","setExtraInfo","ksminaDid","element","sendExceptionEvent","setSystemInfo","setLoggerSessionUrl","append","extraAttr","realDid","generateSessionId","setCommonPackageReady","page_name","element_action","pvOption","pvType","serviceName","BaseWeblog"],"mappings":"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"}