!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@yoda/bridge")):"function"==typeof define&&define.amd?define(["exports","@yoda/bridge"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Weblog={},e.KSYoda)}(this,(function(e,t){"use strict";var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};var r=function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function o(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function c(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}s((r=r.apply(e,t||[])).next())}))}function a(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function i(e,t,n){if(n||2===arguments.length)for(var r,o=0,a=t.length;o<a;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}function c(e,t,n){var r,o={};if(e.length>0)for(var a=t?decodeURIComponent:function(e){return e},i=e.split(/;\s/g),c=null,s=null,u=null,p=0,l=i.length;p<l;p++){if((u=null===(r=i[p])||void 0===r?void 0:r.match(/([^=]+)=/i))&&null!==u)try{c=decodeURIComponent(u[1]),s=a(i[p].substring(u[1].length+1))}catch(e){}else c=decodeURIComponent(i[p]),s="";null!==c&&(o[c]=s)}return o}var s,u={};function p(e,t,n){void 0===t&&(t={}),void 0===n&&(n=!1);try{if(!n&&e in u)return u[e];if(!(null===window||void 0===window?void 0:window.document))return;var r=document.cookie||"";return r===s?u[e]:(s=r,(u=c(r,!t.raw))[e])}catch(e){}}var l={getCookie:p,setCookie:function(e,t,n){void 0===n&&(n={});try{document.cookie=function(e,t,n,r){void 0===r&&(r={});var o="".concat(encodeURIComponent(e),"=").concat(n?encodeURIComponent(t):t),a=r.expires,i=r.path||"/",c=r.domain||"";return a instanceof Date&&(o+="; expires=".concat(a.toUTCString())),"number"==typeof a&&(o+="; max-age==".concat(a)),""!==i&&(o+="; path=".concat(i)),""!==c&&(o+="; domain=".concat(c)),!0===r.secure&&(o+="; secure"),o}(e,t,!n.raw,n),u[e]=t}catch(e){}},parseCookieString:c};function d(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{var n=null===console||void 0===console?void 0:console.error;return n&&n.call.apply(n,i([console],e,!1))}catch(e){return}}function f(e){for(var t={},n=0,r=e.split("&");n<r.length;n++){var o=r[n].split("="),a=o[0],i=o[1];a in t?t[a]instanceof Array?t[a].push(i):t[a]=[t[a],i]:t[a]=i}return t}function g(){var e=p("appver",void 0,!0);return e&&function(e,t){if(!t)return!1;if(-1!==t.indexOf("alpha"))return!1;if(-1!==t.indexOf("beta"))return!1;try{var n=e.match(/\d+\.\d+\.\d+/);if(!(e=(null==n?void 0:n[0])||""))return!0;if(n=t.match(/\d+\.\d+\.\d+/),!(t=(null==n?void 0:n[0])||""))return!1;var r=e.split(".").map((function(e){return Number(e)})),o=r[0],a=r[1],i=r[2],c=t.split(".").map((function(e){return Number(e)})),s=c[0],u=c[1],p=c[2];return!(s<o||!(s>o)&&(u<a||!(u>a)&&p<i))}catch(e){return!1}}("10.8.30",e)}function h(e){void 0===e&&(e=location.href);var t=e.lastIndexOf("?");return-1===t?{page:e}:{page:e.slice(0,t),params:f(e.slice(t+1))}}var v,y=(v="",function(){if(v)return v;try{var e=window.devicePixelRatio||1,t=Math.floor(screen.width*e),n=Math.floor(screen.height*e);return v="".concat(t,"x").concat(n)}catch(e){return""}});function m(){var e=window.navigator.userAgent;return(-1===e.indexOf("Android 2.")&&-1===e.indexOf("Android 4.0")||-1===e.indexOf("Mobile Safari")||-1!==e.indexOf("Chrome")||-1!==e.indexOf("Windows Phone"))&&(window.history&&"pushState"in window.history)}function b(e){return"string"==typeof e?e:"object"==typeof e?JSON.stringify(e):""}var w,_={},P=function(e){try{if(window&&window.localStorage&&"undefined"!=typeof Storage&&window.localStorage instanceof Storage){var t=Number(function(e){try{if(window&&window.localStorage){var t=window.localStorage.getItem(e);if(t)try{return JSON.parse(t)}catch(e){return t}}}catch(e){return null}return null}(e))||0;return t+1>1e8&&(t=0),function(e,t){try{if(window&&window.localStorage)return window.localStorage.setItem(e,JSON.stringify(t)),!0}catch(e){return!1}}(e,t+1),t}}catch(e){}return _[e]||(_[e]=0),_[e]++},k=function(e,t,n,r){var o;void 0===t&&(t={}),"string"!=typeof e&&(o=e.type),o=e.toUpperCase();var a={};if("string"==typeof t)a.contentPackage=r,"CUSTOM"===e?(a.key=t,a.value=n):(a.params=n,"PV"===e?a.page=t:a.action=t);else if(a=t,["CUSTOM","CUSTOM_EVENT"].includes(o)){var i=t;i.action&&!i.key&&(a.key=i.action),i.params&&!i.value&&(a.value=i.params)}return[o,a]};null===(w=null===window||void 0===window?void 0:window.navigator)||void 0===w||w.userAgent;var x,S=function(){};var O=function(e,t){return void 0===t&&(t="tool"),o(void 0,void 0,void 0,(function(){var n;return a(this,(function(r){switch(r.label){case 0:return void 0===x?[2,!1]:[4,x("tool.canIUse",{namespace:t,name:e})];case 1:return[2,(null==(n=r.sent())?void 0:n.canUse)||!1]}}))}))},U=function(e,t){return o(void 0,void 0,void 0,(function(){var n;return a(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,x("tool.setClientLog",{type:e,data:t})];case 1:return[2,r.sent()];case 2:return n=r.sent(),d("[error 206]","yoda.tool.setClientLog() 报错: ".concat(n.message)),[3,3];case 3:return[2]}}))}))},C={setClientLog:U,sendRadarLog:function(e){return o(void 0,void 0,void 0,(function(){var t;return a(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,x("tool.sendRadarLog",e)];case 1:return[2,n.sent()];case 2:return t=n.sent(),d("[error 207]","yoda.tool.sendRadarLog() 报错: ".concat(t.message)),[3,3];case 3:return[2]}}))}))},sendWebLog:function(e){return o(void 0,void 0,void 0,(function(){return a(this,(function(t){try{return[2,x("tool.sendWebLog",e)]}catch(e){d("[error 214]","yoda.tool.sendWebLog() 报错: ".concat(e.message))}return[2]}))}))},sendSummarizedLog:function(e){return o(void 0,void 0,void 0,(function(){var t;return a(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,x("tool.sendSummarizedLog",e)];case 1:return[2,n.sent()];case 2:return t=n.sent(),d("[error 208]","yoda.tool.sendSummarizedLog() 报错: ".concat(t.message)),[3,3];case 3:return[2]}}))}))},getWebviewLoadPerf:function(e,t){return void 0===e&&(e={}),o(void 0,void 0,void 0,(function(){var n;return a(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,x("webview.getPageLoadData",e,t)];case 1:return[2,r.sent()];case 2:return n=r.sent(),d("[error 209]","yoda.webview.getPageLoadData() 报错: ".concat(n.message)),[3,3];case 3:return[2]}}))}))},getKDSWebviewLoadPerf:function(e){return void 0===e&&(e={}),o(void 0,void 0,void 0,(function(){var t;return a(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,x("system.getPageLoadData",e)];case 1:return[2,n.sent()];case 2:return t=n.sent(),d("[error 209]","yoda.system.getPageLoadData() 报错: ".concat(t.message)),[3,3];case 3:return[2]}}))}))},isSupportBridgeLog:function(){return O("setClientLog")},isSupportBridge:O,invoke:x},E=function(e,t,n){return d("[error 400]","埋点上报接口请求报错","\nurl:",t,"\ndata",n,"\nerror:",e||"server decode log failed")};function I(e,t){var n=e.url,r=e.data,o=e.timeout;return new Promise((function(e){var a=new XMLHttpRequest;return a.open("POST",n),a.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),"object"!=typeof r||r instanceof Uint8Array||(r=JSON.stringify(r)),o&&(a.timeout=o),a.onload=function(){var o=function(e,t,n,r){var o;if(e<200||e>=300&&304!==e);else try{var a=JSON.parse(t),i=a.exception,c=a.result,s=a.error_msg;i&&(o=i),1!==c&&(o=s||"result is ".concat(c))}catch(e){o=e.message}return o&&E(o,n,r),o}(a.status,a.response,n,r);t&&t(o),e({error:o,response:o?void 0:a.response})},a.ontimeout=a.onerror=function(o){o&&E(o,n,r),t&&t(o?"networkTimeout":""),e({error:"networkTimeout"})},a.send(r),a}))}var T,N,L=function(e){function t(t,n,r){var o=e.call(this,{},n)||this;if("string"==typeof t){var a=h(t);o.page=a.page,o.params=a.params}else o.page=(t||{}).page||"",o.params=(t||{}).params||void 0;return o.identity=o.generatePageId(),r&&"string"==typeof t&&o.init(t,r),o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t.prototype.init=function(e,t){void 0===t&&(t={});var n=function(e,t){var n=e.url,r=e.page,o=e.params,a=e.pageId;if(!r&&"string"==typeof n){var i=h(n);r=i.page,o=i.params}if("function"==typeof t)try{var c=t({url:n,page:r,params:o});"string"==typeof c?r=c:"object"==typeof c&&(c.page&&(r=c.page),c.params&&(o=c.params),c.pageId&&(a=c.pageId))}catch(e){}else if("object"==typeof t){var s="";for(var u in t)if((n||r||"").indexOf(u)>-1){s=t[u];break}s&&(r=s)}return{page:r,params:o,pageId:a}}({url:e,page:this.page,params:this.params},t),r=n.page,o=n.params;this.update(r,o)},t.prototype.attachUrl=function(){if(this.params||(this.params={}),null===location||void 0===location?void 0:location.href){this.params.origin_url=this.params.origin_url||(null===location||void 0===location?void 0:location.href);var e=h(location.href).page,t=void 0===e?"":e;this.params.origin_pathname=t}},t.prototype.getRealUrlPackage=function(){var e=h(location.href),t=e.page,n=e.params;return{page:t,params:JSON.stringify(r({page_code:this.page,url:location.href,query:n},n)),page_type:this.page_type,identity:this.identity}},t.prototype.generatePageId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},t}(function(){function e(e,t){switch(this.page="",this.identity="",t){case"web":this.page_type=2;break;case"native":this.page_type=1;break;case"mina":this.page_type=3;break;default:this.page_type=0}this.update(e.page,e.params)}return e.prototype.update=function(e,t){void 0===e&&(e=""),e&&e!==this.page&&(this.page=e,this.identity=this.generatePageId(e)),t&&(this.params=Object.assign(this.params||{},t))},e.prototype.toJSON=function(){return{page:this.page,identity:this.identity,page_type:this.page_type,params:JSON.stringify(this.params),category:this.category}},e.prototype.generatePageId=function(e){return e+(new Date).getTime()},e}());T=t.invoke,x="function"==typeof T?T:T.invoke,function(e){e[e.INIT=-1]="INIT",e[e.CHECKING=0]="CHECKING",e[e.READY=1]="READY",e[e.DISABLED=2]="DISABLED"}(N||(N={}));var A=0,R=function(){function e(t,n){this.version="3.10.23",this.plugins={},this.entered="",this.logConfig=t,this.baseOption=n,this.commonPackage=new D(n),this.updateCurrentUrlPackage(),this.addPlugins(),e.__instance||(e.__instance=this)}return Object.defineProperty(e.prototype,"Utils",{get:function(){return{yoda:C,cookie:l,ua:{getDefaultKpn:function(){return p("kpn")},supportsPushState:m},io:{sendData:I}}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sessionId",{get:function(){return p("session_id")||p("sid")},enumerable:!1,configurable:!0}),e.prototype.addPlugins=function(){var e=this;this.logConfig.plugins&&this.logConfig.plugins.length&&this.logConfig.plugins.forEach((function(t){"object"==typeof t&&"function"==typeof t.apply&&e.addPluginInstance(t)}))},e.prototype.addPluginInstance=function(e){if(e){var t=e.key||e.constructor&&e.constructor.key||"plugin_auto_key_".concat(A++);"function"!=typeof e.apply||e.weblog&&e.weblog===this||e.apply(this),this.plugins[t]=e}},e.prototype.plug=function(e,t){if(this.plugins[e.key])return d("[code 301]","".concat(e.key," 插件重复加载！"));this.addPluginInstance(new e(this,t))},e.prototype.collect=function(e,t,n,r){var o=k(e,t,n,r),a=o[0],i=o[1];return this.send(a,i,!1)},e.prototype.sendImmediately=function(e,t,n,r){var o=k(e,t,n,r),a=o[0],i=o[1];return this.send(a,i,!0)},e.prototype.sendByBridge=function(e,t,n){var o=this.logConfig,a=o.disablePV,i=o.biz,c=t,s=c.contentPackage,u=c.disablePV,p=c.bridgeFields,l=void 0===p?{}:p,f=c.urlPage,h=a||u;s&&(s="string"==typeof s?s:JSON.stringify(s));var v="addTaskEvent",y="PV"===e;if(y){if(h)return;var m=t,w=m.page,_=m.type,P=m.params,k=m.coPage,x=m.category;if("leave"===_&&this.currentUrlPackage.coPage&&g())return void U("closeCoPage",r(r({},t),this.currentUrlPackage));if(_||(t.type=_="enter"),-1===["enter","visible"].indexOf(_))return;if("enter"===_?(P=w?P:this.currentUrlPackage.params,w=w||this.currentUrlPackage.page,this.updateCurrentUrlPackage({page:w,params:P,force:!0}),k&&(this.currentUrlPackage.coPage=k),x&&(this.currentUrlPackage.category=x),this.entered=w):w===this.entered&&this.currentUrlPackage.update(w,P),!function(e){return!e||!/^(https?:)?\/\//.test(e)||(d("[error 108]","请注意当前埋点页面信息为 ".concat(e,"，不符合规范，上报失败！")),!1)}(this.currentUrlPackage.page))return;v="setCurrentPage"}var O=!!this.currentUrlPackage.coPage,C=(null==f?void 0:f.page)&&!y?{page:f.page,identity:f.identity,params:b(f.params),page_type:this.currentUrlPackage.page_type}:this.currentUrlPackage.toJSON(),E=function(e,t){var n=t,o=n.action,a=n.params,i=n.eventId,c=n.contentPackage,s=n.currentUrlPackage,u=n.status,p=void 0===u?"SUCCESS":u;n.name;var l,d=n.feedLogCtx;if("PV"===e){var f=t,g=f.type,h=f.beginTime;return r(r({},s),{actionType:g,contentPackage:c,status:p,beginTime:h,eventId:i,pageType:S()?"NATIVE":"H5"})}if(s&&(l={page:s.page,params:s.params,identity:s.identity,coPage:s.coPage}),["RADAR","CUSTOM","CUSTOM_EVENT"].includes(e)){var v=t,y=v.key,m=v.value,b=v.biz;return{key:y,value:JSON.stringify(r(r({},m),{url_package:s})),biz:b,eventId:i,urlPage:l}}var w={action:o,params:JSON.stringify(a),contentPackage:c,feedLogCtx:d,eventId:i,urlPage:l};if("SHOW"!==e){var _=t.type;Object.assign(w,{type:_||"USER_OPERATION",status:p||"UNKNOWN_STATUS",operationType:e,operationDirection:"UNKNOWN2"})}return w}(e,r(r({biz:i},t),{contentPackage:s,currentUrlPackage:h?void 0:C})),I=-1!==["CUSTOM","RADAR","CUSTOM_EVENT"].indexOf(e);this.commonPackage.increaseH5SeqId(I);var T=this.baseOption||{},N=T.service_name,L=T.sub_biz,A=T.need_encrypt;E.h5ExtraAttr=JSON.stringify(this.commonPackage.getH5ExtraAttr({coPage:O})),E.realtime=!!n,E.serviceName=N||"",E.subBiz=L||"",E.needEncrypt=A||!1,E.container=S()?"REACT_NATIVE":"H5","SHOW"===e?v="addElementShowEvent":I&&(v="CUSTOM_EVENT"===e||this.logConfig.customStatToCustom?"addCustomEvent":"addCustomStatEvent"),U(v,r(r({},l),E))},e.prototype.send=function(e,t,n){void 0===t&&(t={}),e=e.toUpperCase(),this.sendByBridge(e,t,n)},e.prototype.updateCurrentUrlPackage=function(e,t){if(void 0===e&&(e=(null===location||void 0===location?void 0:location.href)||""),void 0===t&&(t="web"),"object"==typeof e&&!e.force&&this.currentUrlPackage){var n=e.page,r=void 0===n?this.currentUrlPackage.page:n,o=e.params,a=void 0===o?{}:o;if(!r||r===this.currentUrlPackage.page)return this.entered===r?void this.send("PV",{type:"visible",page:r,params:a},!0):void this.currentUrlPackage.update(r,a)}this.currentUrlPackage=new L(e,t,this.logConfig.urlMap),this.logConfig.attachUrl&&this.currentUrlPackage.attachUrl()},e.prototype.updateReferUrlPackage=function(e,t){void 0===e&&(e=this.currentUrlPackage),void 0===t&&(t="web"),this.referUrlPackage=e instanceof L?e:new L(e,t,this.logConfig.urlMap)},e.prototype.updateCommonPackage=function(e){this.commonPackage.update(e)},e.prototype.flush=function(){},e.prototype.on=function(){},e.prototype.emit=function(){},e}(),D=function(){function e(e){this.h5_extra_attr={sdk_name:"webLogger",sdk_version:"3.10.23",sdk_bundle:"log.bridge.js",host_product:p("kpn"),resolution:y(),domain:window.location.origin,app_version_name:p("appver")||"",bridge_info:t.version||!0},this.update(e)}return e.prototype.getVersionName=function(){var e;return null===(e=this.app_package)||void 0===e?void 0:e.version_name},e.prototype.update=function(e){Object.assign(this.h5_extra_attr,null==e?void 0:e.h5_extra_attr),this.container=null==e?void 0:e.container,this.service_name=null==e?void 0:e.service_name,this.sub_biz=null==e?void 0:e.sub_biz,this.need_encrypt=null==e?void 0:e.need_encrypt,this.app_package={version_name:this.h5_extra_attr.app_version_name,container:S()?"REACT_NATIVE":"H5"}},e.prototype.increaseH5SeqId=function(e){this.h5_extra_attr.client_timestamp=function(e){try{return Math.abs(Math.floor(e))}catch(t){return e}}(Date.now()),this.h5_extra_attr.seq_id=P(e?"WEBLOGGER_H5_CUSTOM_SEQ_ID":"WEBLOGGER_H5_SEQ_ID")},e.prototype.getH5ExtraAttr=function(e){return Object.assign({},this.h5_extra_attr,e)},e}(),j=function(){function e(){}return e.prototype.apply=function(e){this.weblog=e},e}();"undefined"!=typeof window&&(void 0!==window._GLOBAL_KS_WEBLOGGER_?window._GLOBAL_KS_WEBLOGGER_.Factory=R:window.Weblog=R),e.BasePlugin=j,e.Weblog=R,e.default=R,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=log.bridge.js.map
