/**
 * 主要是过滤不需要作为Dll的模块
 * @author linjinying
 */

const fsExtra = require('fs-extra');
class ManifestPlugin {
  constructor(options) {
    this.options = options;
  }
  apply(compiler) {
    compiler.hooks.done.tapAsync('ManifestPlugin', (stats, callback) => {
      const manifest = fsExtra.readJSONSync(this.options.manifest);
      const manifestFiltered = Object.keys(manifest.content)
        .filter((key) => this.options.regExp.test(key))
        .reduce((obj, key) => {
          obj[key] = manifest.content[key];
          return obj;
        }, {});
      fsExtra.writeJSONSync(this.options.manifest, {
        ...manifest,
        ...this.options.extraInfo,
        content: manifestFiltered,
      });
      callback();
    });
  }
}

module.exports.ManifestPlugin = ManifestPlugin;
