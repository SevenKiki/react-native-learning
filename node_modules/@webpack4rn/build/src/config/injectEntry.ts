import * as webpack from 'webpack';
import * as webpackChain from 'webpack-chain';
import { getNormalizedEntry, getEntryPoints } from '../util';

const polyfills = [
  'react-native/Libraries/polyfills/console.js',
  'react-native/Libraries/polyfills/error-guard.js',
  'react-native/Libraries/polyfills/Object.es7.js',
  'react-native/Libraries/Core/InitializeCore.js',
];

export const injectEntry = (
  config: webpackChain,
  webpackConfig: webpack.Configuration,
  env?: WebpackEnv,
) => {
  const normalizedEntry = getNormalizedEntry(webpackConfig);
  const entryPoints = getEntryPoints(webpackConfig);
  for (const entryPoint of entryPoints) {
    const originalEntry = normalizedEntry[entryPoint].import;
    const entry = config.entry(entryPoint);
    entry.merge(polyfills);
    entry.merge(originalEntry);
  }
};
