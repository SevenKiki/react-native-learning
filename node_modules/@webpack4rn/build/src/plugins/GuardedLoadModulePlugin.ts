import type * as webpack from 'webpack';
import { ConcatSource } from 'webpack-sources';
import * as JavascriptModulesPlugin from 'webpack/lib/javascript/JavascriptModulesPlugin';
import * as runtimeGlobals from 'webpack/lib/RuntimeGlobals';

export class GuardedLoadModulePlugin {
  apply(compiler: webpack.Compiler): void {
    compiler.hooks.thisCompilation.tap(
      'GuardedLoadModulePlugin',
      (compilation) => {
        const hooks = JavascriptModulesPlugin.getCompilationHooks(compilation);
        hooks.renderStartup.tap(
          'GuardedLoadModulePlugin',
          (source, module, StartupRenderContext) => {
            return new ConcatSource(
              `try {`,
              source,
              `} catch (e) {
              ${runtimeGlobals.global}.ErrorUtils.reportFatalError(e);
              }`,
            );
          },
        );
      },
    );
  }
}
