const fs = require('fs');
const path = require('path');
const debug = require('debug')('cdn-upload');
const chalk = require('chalk');
const { uploadMultiple } = require('./service');
const glob = require('glob-promise');
const promiseLimit = require('promise-limit');
const { formatCdnDir, getExitErrorCodes, mockLocalResponseError, formatInputFiles } = require('./utils/index');
const { checkFileExist, validateCdnDir, checkFileEmpty, checkFileNameValid } = require('./utils/validate');
const { requestWithRetry } = require('./utils/request');
const { ERROR_CODE_MAP, RADAR_MODE_MAP, RADAR_MODE_NAME_MAP, RADAR_MODE_TIP_MAP } = require('./utils/config.js');
const { jsonStringify } = require('./utils/util.js');
const radar = require('./utils/radar.js');
const { cacheToken } = require('./utils/token-cache');

/**
 * æ–‡ä»¶ä¸Šä¼ ç±»
 * @params {Object} options
 * @params {String} options.pid           // é¡¹ç›®pidã€‚åœ¨ https://kcdn.corp.kuaishou.com/dashboard/project-info é¡µé¢è·å–é¡¹ç›®Pid
 * @params {String} options.token         // é¡¹ç›®tokenã€‚åœ¨ https://kcdn.corp.kuaishou.com/dashboard/project-info é¡µé¢è·å–é¡¹ç›®Token
 * @params {String} options.uid           // ç”¨æˆ·idï¼Œé»˜è®¤: npm
 * @params {String} options.cdnDir        // æŒ‡å®šç›®æ ‡CDNè·¯å¾„ã€‚é»˜è®¤: æ ¹ç›®å½•
 * @params {String|Array} options.files   // æœ¬åœ°æ–‡ä»¶/æ–‡ä»¶å¤¹è·¯å¾„ã€‚æ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
 * @params {String} options.allowRewrite  // æ˜¯å¦å¼€å¯åŒåæ–‡ä»¶æ›´æ–°åŠŸèƒ½ã€‚'true': å¼€å¯ï¼Œ'false':ä¸å¼€å¯	
 * @params {String} options.allowHash     // æ˜¯å¦æ”¯æŒæ–‡ä»¶åhashã€‚ 'true': å¼€å¯ï¼Œ'false': ä¸å¼€å¯
 * @params {String} options.allowMD5      // æ˜¯å¦æ”¯æŒè¿”å›çš„headé‡Œæ·»åŠ md5ä¿¡æ¯ã€‚ 'true': å¼€å¯ï¼Œ'false': ä¸å¼€å¯
 * @params {String} options.exitOnApiError   // é€—å·åˆ†å‰²çš„å…·ä½“é”™è¯¯ç±»å‹ï¼Œå‘ç”Ÿé”™è¯¯åç›´æ¥é€€å‡ºè¿›ç¨‹ã€‚é»˜è®¤: unknownã€‚never: å¿½ç•¥æŠ¥é”™; duplicate: åŒåæ›´æ–°é”™è¯¯; unknown: æ ¡éªŒä¸é€šè¿‡ã€ä¸Šä¼ å¤±è´¥ã€æœªçŸ¥é”™è¯¯
 * @params {String} options.env           // æ–‡ä»¶ä¸Šä¼ çš„ç¯å¢ƒã€‚é»˜è®¤: production
 * 
 * @params {Boolean} options.showConsole       // æ˜¯å¦æ‰“å°æ—¥å¿—åˆ°æ§åˆ¶å°é¢æ¿ã€‚é»˜è®¤: true
 * @params {Boolean} options.maxRetryTime      // å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ 5æ¬¡
 * @params {Boolean} options.retryDelay        // å¤±è´¥é‡è¯•é—´éš”ï¼Œå•ä½msã€‚é»˜è®¤1s
 * 
 * @methods start() // å¼€å§‹ä¸Šä¼ æ–‡ä»¶ã€‚è¿”å›å·²ä¸Šä¼ çš„cdnUrlæ•°ç»„
 * 
 * @demo ä½¿ç”¨ä¾‹å­ï¼š
      const Upload = require('@kcdn/multi-upload');
      const upload = new Upload({
        pid: 'xxxxxxxx',
        token: '11379_xxxxxxxx',
        uid: 'dengzhirong',
        allowRewrite: 'true',
        allowHash: 'false',
        cdnDir: 'unit-test-002',
        files: ['debug-dir'],
      });
      upload.start();
 */
module.exports = class Upload {
  constructor(options = {}) {
    this.options = options;
    this.log('[kcdn-upload] ready to init');

    const { cdnDir = '', files = [], maxRetryTime = 5, retryDelay = 1000, exitOnApiError, env } = options;
    let { uid } = options;

    const formattedCdnDir = formatCdnDir(cdnDir); // cdnç›®æ ‡åœ°å€æ”¯æŒä½¿ç”¨ç¯å¢ƒå˜é‡å…¥å‚

    // è·å–æµæ°´çº¿ç¯å¢ƒå˜é‡ä¸­ï¼Œå½“å‰æ„å»ºçš„ç”¨æˆ·idï¼Œé»˜è®¤: npm
    if (!uid) {
      const { BUILD_USERNAME, BUILD_OWNER, GIT_COMMIT_AUTHOR, PIPELINE_OWNER, USER } = process.env || {};
      uid = BUILD_USERNAME || GIT_COMMIT_AUTHOR || BUILD_OWNER || PIPELINE_OWNER || USER || 'npm';
    }

    // uidå¸¦ä¸Šnpmåç¼€æ ‡è¯†
    uid = !/^.*\/npm$/.test(uid) ? `${uid}/npm` : uid;

    // æ˜¯å¦æ˜¯stagingç¯å¢ƒ
    const isStaging = env === 'staging' ? true : false;

    this.options = {
      ...options,
      uid,
      cdnDir: formattedCdnDir,
      exitOnApiError,
      maxRetryTime,
      retryDelay,
      isStaging,
    };

    this.cdnDir = formattedCdnDir;
    this.exitErrorCodes = getExitErrorCodes(exitOnApiError) || []; // é€€å‡ºè¿›ç¨‹çš„é”™è¯¯codeåˆ—è¡¨

    // å°†å¾…ä¸Šä¼ çš„æ–‡ä»¶ç›®å½•è½¬æ¢æˆæ•°ç»„ï¼Œå…¼å®¹ç»å¯¹è·¯å¾„çš„æƒ…å†µ
    this.files = formatInputFiles(files, process.cwd());

    this.log(`ğŸ‘‰ cdnDir: ${chalk.cyan(cdnDir)} to ${chalk.cyan(formattedCdnDir)} `);
    this.log(`ğŸ‘‰ files: ${chalk.cyan(jsonStringify(this.files))}`);
    this.log(`ğŸ‘‰ Upload Params: ${chalk.cyan(jsonStringify(this.options))}`);

    // æ ¡éªŒå…¥å‚æ˜¯å¦æ­£ç¡®
    try {
      this.validate();
    } catch (e) {
      // å‚æ•°æ ¡éªŒå¤±è´¥ï¼Œé€€å‡ºè¿›ç¨‹
      console.error(new Error(`å‚æ•°æ ¡éªŒå¤±è´¥, ${e.message || e}`));
      process.exit(100);
    }
  }

  // ä¸Šä¼ çš„å…¥å£æ–¹æ³•
  async start() {
    // æ¸…ç©ºä¸Šä¼ ç»“æœ
    this.resetResult();

    // ä¸Šä¼ æ–‡ä»¶
    return this.upload()
      .then(data => {
        this.radarTrack('SUCCESS'); // æ—¥å¿—ä¸ŠæŠ¥

        // ç¼“å­˜token
        const { pid, token } = this.options || {};
        cacheToken(pid, token);

        return data;
      })
      .catch(e => {
        console.error(e);
        process.exit(100);
      });
  }

  async upload() {
    this.log(`========================================`);
    this.startTime = Date.now(); // å¼€å§‹ä¸Šä¼ æ—¶é—´

    // 1. ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹
    const result = await this.uploadFiles(this.files);
    // debug('ã€æ–‡ä»¶ä¸Šä¼ ç»“æœã€‘', jsonStringify(result || ''));

    // 2. å±•ç¤ºæ–‡ä»¶ä¸Šä¼ æˆåŠŸåçš„æ–‡ä»¶åˆ—è¡¨
    const cdnUrlList = this.getCdnUrlList(result);
    this.log(`========================================`);
    this.log(
      `ğŸ‘» Successfully uploaded ${chalk.cyan(cdnUrlList && cdnUrlList.length)} files. ` +
        `The KCDN urls are as follows: \n${jsonStringify(cdnUrlList, undefined, 2)}`
    );

    // 3. å±•ç¤ºä¸Šä¼ æ€»æ¦‚å†µï¼šæ€»æ–‡ä»¶æ•°ã€æˆåŠŸ/å¤±è´¥/ä¸å­˜åœ¨çš„æ–‡ä»¶æ•°ã€æ€»è€—æ—¶ç­‰
    this.calcStatusCount(result);
    const { totalCount, successCount, failedCount, notExistCount, duration } = this.result;

    this.log(`========================================`);
    this.log(
      `${failedCount ? 'âŒ' : 'ğŸ‘Œ'} ` +
        `Total Files: ${chalk.cyan(totalCount)}, ` +
        `${chalk.green('âœ”')} Successfully uploaded ${chalk.cyan(successCount)} files! ` +
        `${chalk.red('âœ—ï¸')} Failed uploaded ${chalk.cyan(failedCount)} files!` +
        (notExistCount ? `${chalk.red('âœ—ï¸')} Not Exist ${chalk.cyan(notExistCount)} files !` : '')
    );
    this.log(`â° Uploaded Total Time: ${chalk.cyan(duration)} ms`);

    // 4. è¿”å›cdnUrlsåˆ—è¡¨
    return cdnUrlList;
  }

  /**
   * æ ¡éªŒå…¥å‚æ˜¯å¦æ­£ç¡®
   * @return new Error
   */
  validate() {
    const { files } = this;
    const { pid, token, cdnDir } = this.options;
    // 1. å¦‚æœpid/tokenä¸ºç©º
    const projectInfoUrl = 'https://kcdn.corp.kuaishou.com/dashboard/project-info';
    if (!pid) throw new Error(`pidä¸èƒ½ä¸ºç©ºã€‚è¯·ç™»å½•: ${projectInfoUrl} æŸ¥çœ‹æ‚¨é¡¹ç›®çš„ã€pidã€‘`);
    if (!token) throw new Error(`tokenä¸èƒ½ä¸ºç©ºã€‚è¯·ç™»å½•: ${projectInfoUrl} æŸ¥çœ‹æ‚¨é¡¹ç›®çš„ã€tokenã€‘`);

    // 2. å¦‚æœcdnè·¯å¾„ä¸ç¬¦åˆè§„èŒƒï¼Œä¸å…è®¸ä¸Šä¼ 
    if (!validateCdnDir(cdnDir)) throw new Error(`cdnç›®å½•æ ¡éªŒä¸é€šè¿‡ï¼Œä¸èƒ½ä»¥./æˆ–../å¼€å¤´ã€‚cdnDir: ${cdnDir}`);

    // 3. å¾…ä¸Šä¼ çš„æœ¬åœ°æ–‡ä»¶ä¸èƒ½ä¸ºç©º
    if (!files || !files.length) throw new Error('filesä¸èƒ½ä¸ºç©º');
  }

  resetResult() {
    this.result = {
      totalCount: 0,
      successCount: 0,
      failedCount: 0,
      notExistCount: 0,
      duration: 0,
    };
  }

  /**
   * è·å–æ–‡ä»¶ä¸Šä¼ çŠ¶æ€çš„ç»Ÿè®¡
   * @param {Array} result æ–‡ä»¶ä¸Šä¼ ç»“æœåˆ—è¡¨: [{ code, message, data: { success, fileResults: [{ status, message, cdnUrl }] } }]
   * @return {Object}  { successCount, failedCount, notExistCount }
   */
  calcStatusCount(result) {
    let successCount = 0,
      failedCount = 0,
      notExistCount = 0;

    result.map(item => {
      const { isExist, code, data } = item || {};
      if (isExist === false) {
        notExistCount += 1;
      } else if (!item || code !== 0 || !data || data.success !== true) {
        failedCount += 1;
      } else {
        successCount += 1;
      }
    });
    this.result = {
      ...this.result,
      successCount, // ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶æ•°
      failedCount, // ä¸Šä¼ å¤±è´¥çš„æ–‡ä»¶æ•°
      notExistCount, // ä¸å­˜åœ¨çš„æ–‡ä»¶æ•°
      totalCount: result.length, // æ€»æ–‡ä»¶æ•°
      duration: Date.now() - this.startTime, // ä¸Šä¼ æ€»è€—æ—¶
    };
    return this.result;
  }

  /**
   * æ‰¹é‡ä¸Šä¼ å¤šæ–‡ä»¶/æ–‡ä»¶å¤¹
   * @returns {Array} æ¥å£è¯·æ±‚Responseæ•°ç»„ï¼Œå¦‚ï¼š[{ code, message, data: { success, fileResults: [{ status, message, cdnUrl }] } }]
   */
  async uploadFiles() {
    let files = this.files || [];
    const limitNetwork = promiseLimit(10); // æœ€å¤§10ä¸ªå¹¶å‘è¯·æ±‚
    this.result = this.result || {};
    this.result.totalCount = this.result.totalCount || 0; // ç»Ÿè®¡æ€»æ–‡ä»¶æ•°

    // 1. ç”Ÿæˆè¯·æ±‚promiseæ•°ç»„
    let multiPromises = files.map(async filePath => {
      let stat = null;
      try {
        stat = fs.statSync(filePath);
      } catch (e) {
        const msg = `æ–‡ä»¶/æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨ã€‚file: ${chalk.cyan(filePath)}`;
        return this.quitProcess('unknown', { msg, file: filePath, code: 'LOCAL_QUIT_BY_NOT_FOUND_FILE' });
      }

      if (stat.isFile()) {
        // å¦‚æœæ˜¯æ–‡ä»¶ï¼Œç›´æ¥ä¸Šä¼ 
        const res = await glob(filePath, { nodir: true });
        const file = res && res[0];
        if (!file) {
          const msg = `æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨: ${chalk.cyan(filePath)}`;
          return this.quitProcess('unknown', { msg, file: filePath, code: 'LOCAL_QUIT_BY_NOT_FOUND_FILE' });
        }

        this.result.totalCount += 1;
        return limitNetwork(() => this.uploadSingleFile(file, ''));
      } else if (stat.isDirectory()) {
        // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œéå†æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åï¼Œå¹¶å‘æ‰¹é‡ä¸Šä¼ 
        const dirFiles = await glob(`${filePath}/**`, { nodir: true });
        const totalCount = dirFiles && dirFiles.length;
        this.log(`ğŸ”† resolving [${filePath}]: Total ${chalk.cyan(totalCount)} files`);
        debug(`[${filePath}]æ–‡ä»¶åˆ—è¡¨: ${jsonStringify(dirFiles, undefined, 2)}`);
        this.result.totalCount += totalCount;

        let promises = dirFiles.map(file =>
          limitNetwork(() => {
            const dir = path.relative(filePath, path.dirname(file)); // æ–‡ä»¶åŸºäºfilePathçš„ç›¸å¯¹è·¯å¾„
            return this.uploadSingleFile(file, dir);
          })
        );
        return Promise.all(promises);
      }
    });

    // 2. æ–‡ä»¶å¤¹ä¹‹é—´ä¸²è¡Œæ‰§è¡Œï¼Œæ–‡ä»¶å¤¹å†…éƒ¨å¹¶å‘ä¸Šä¼ 
    let result = [];
    for (let i = 0; i < multiPromises.length; i++) {
      result[i] = await multiPromises[i];
    }

    // 3. ä¸Šä¼ ç»“æœ: äºŒç»´æ•°ç»„ => ä¸€ç»´æ•°ç»„
    result = result.reduce((result, item) => [...result, ...(item instanceof Array ? item : [item])], []);
    return result;
  }

  /**
   * ä¸Šä¼ å•ä¸ªæ–‡ä»¶
   * @param {String} file     æ–‡ä»¶è·¯å¾„
   * @param {String} fileDir  æ–‡ä»¶çš„ç›¸å¯¹ç›®å½•è·¯å¾„
   * @returns {Object | Null} æˆåŠŸåˆ™è¿”å› objectï¼Œå¤±è´¥åˆ™è¿”å› nullï¼Œæ–‡ä»¶ä¸å­˜åœ¨åˆ™è¿”å› { isExist: false }
   */
  async uploadSingleFile(file, fileDir) {
    const { pid, token, uid, cdnDir, allowRewrite, allowHash, allowMD5, isStaging } = this.options;

    // æ–‡ä»¶è¦ä¸Šä¼ çš„ç›®æ ‡è·¯å¾„: cdnDir + å½“å‰æ–‡ä»¶çš„ç›¸å¯¹ç›®å½•è·¯å¾„
    let targetDir = path.join(cdnDir, fileDir);
    // å…¼å®¹windowsç³»ç»Ÿåæ–œæ é—®é¢˜
    targetDir = path.join(cdnDir, fileDir).split(path.sep).join('/');
    this.log(`uploading file: ${chalk.cyan(file)} to ${chalk.cyan(targetDir)} ...`);

    /**
     * 1. åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚ä¸å­˜åœ¨åˆ™ä¸ç»§ç»­ä¸Šä¼ 
     * è§£å†³åœºæ™¯ï¼šä¸Šä¼ ä¸æ–‡ä»¶åˆ é™¤å¹¶è¡Œæ‰§è¡Œçš„æƒ…å†µã€‚å¦‚ ç ”å‘äº‘æµæ°´çº¿ä¸­ï¼Œkcdnä¸Šä¼ æ’ä»¶ ä¸ é›·è¾¾sourceMapæ’ä»¶ å¹¶å‘è¿è¡Œæ—¶
     */
    const isExist = checkFileExist(file);
    if (!isExist) {
      this.log(`${chalk.yellowBright('â—‡')} Skipped nonexistent file: ${chalk.cyan(file)}`);
      return { isExist: false, file };
    }

    // 2. åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸ºç©º
    const isEmpty = await checkFileEmpty(file);
    if (isEmpty) {
      const msg = 'æ–‡ä»¶å¤§å°ä¸èƒ½ä¸ºç©º';
      const response = mockLocalResponseError(msg);
      return this.formatFileUploadResponse(response, file, targetDir);
    }

    // 3. éªŒè¯æ–‡ä»¶åè§„åˆ™æ˜¯å¦æ­£ç¡®ã€‚æ–‡ä»¶åä¸èƒ½å¸¦ä¸­æ–‡ï¼Œä¸”åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯æ•°å­—å’Œ-.~
    // å¤‡æ³¨ï¼šä¸šåŠ¡ä¹‹å‰ä½¿ç”¨ï¼Œå…è®¸å¸¦ @ ç‰¹æ®Šå­—ç¬¦ï¼Œæ‰€ä»¥æ’ä»¶ä¸åšæ–‡ä»¶åè§„åˆ™æ ¡éªŒ
    // const { isValid: isFileNameValid, message: fileNameErrorMsg } = checkFileNameValid(file);
    // if (!isFileNameValid) {
    //   const response = mockLocalResponseError(fileNameErrorMsg);
    //   return this.formatFileUploadResponse(response, file, targetDir);
    // }

    // 3. ä¸Šä¼ æ–‡ä»¶
    const params = { pid, token, uid, allowRewrite, allowHash, allowMD5, files: [file], dir: targetDir, isStaging };
    const response = await requestWithRetry({
      // æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
      request: () => uploadMultiple(params, { radarLog: false }),

      // å¤±è´¥é‡è¯•å‰çš„å¤„ç†å‡½æ•°
      beforeRetry: retryTime => {
        this.log(`ğŸ’ Failed retry time: ${chalk.cyan(retryTime)}, file: ${chalk.cyan(file)}`);
      },

      // è¯·æ±‚å®Œæˆåçš„å›è°ƒå‡½æ•°ã€‚å‡½æ•°è¿”å›falseï¼Œè¡¨ç¤ºä¸Šä¼ å¤±è´¥
      afterResponse: response => {
        return response && response.data && !!response.data.success;
      },

      maxRetryTime: this.maxRetryTime, // å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ 5æ¬¡
      retryDelay: this.retryDelay, // å¤±è´¥é‡è¯•é—´éš”ï¼Œå•ä½msã€‚é»˜è®¤1s
    });

    return this.formatFileUploadResponse(response, file, targetDir);
  }

  /**
   * è¿”å›æ–‡ä»¶ä¸Šä¼ çš„å¤„ç†ç»“æœ
   * @param {Object} response   ä¸Šä¼ æ¥å£Response: { code: 0, message: 'xxx', data: { success: true, fileResults: [ { status: 1, message: 'xxx', cdnUrl: 'https://xxxx' } ] } }
   * @param {String} file       æ–‡ä»¶è·¯å¾„
   * @param {String} targetDir  æ–‡ä»¶ä¸Šä¼ åˆ°kcdnçš„è·¯å¾„
   * @returns {Object | Null} æˆåŠŸåˆ™è¿”å› objectï¼Œå¤±è´¥åˆ™è¿”å› nullï¼Œæ–‡ä»¶ä¸å­˜åœ¨åˆ™è¿”å› { isExist: false }
   */
  formatFileUploadResponse(response, file, targetDir) {
    const { allowRewrite } = this.options;

    const { code, message = '', data: responseData } = response || {};
    const { success, fileResults } = responseData || {};
    const fileResult = Array.isArray(fileResults) ? fileResults[0] : {};
    const { status, message: fileResultMessage } = fileResult || {};
    const isSuccess = code === 0 && success && fileResult;

    // 1. ä¸Šä¼ æˆåŠŸ
    if (isSuccess && status === 1) {
      this.log(`${chalk.green('âœ”')} Successfully uploaded file: ${chalk.cyan(file)} to ${chalk.cyan(targetDir)} `);
      return response;
    }

    // 2. åŒåæ–‡ä»¶æ›´æ–°
    const isAllowRewite = allowRewrite === 'true' || allowRewrite === true;
    if (isSuccess && status === 3) {
      this.log(`${chalk.yellowBright('â—‡')} Skipped same name file: ${chalk.cyan(file)}`);

      // å¦‚æœä¸å…è®¸åŒåæ–‡ä»¶æ›´æ–°ï¼Œåˆ™æŠ¥é”™å¹¶é˜»å¡è¿›ç¨‹
      if (!isAllowRewite) {
        const msg = `file duplicate error, file: ${file}`;
        this.quitProcess('duplicate', { msg, file, code: 'API_QUIT_BY_FILE_IS_DUPLICATE' });
      }
      return response;
    }

    // 3. ä¸Šä¼ å¤±è´¥ï¼Œé€€å‡ºè¿›ç¨‹
    const errorMsg = fileResultMessage || message || ERROR_CODE_MAP[code] || '';
    const fullErrorMsg = `file: ${chalk.cyan(file)}, message: ${chalk.red(errorMsg)}`;
    this.log(`${chalk.red('âœ—ï¸')} ${fullErrorMsg}`);
    // this.log(`${chalk.red('âœ—ï¸')} Api Response: ${jsonStringify(response || '')}`);

    const msg = `unknown api error, ${fullErrorMsg}. Api Response: ${jsonStringify(response || '')}`;
    this.quitProcess('unknown', { msg, file, code: 'API_QUIT_BY_UPLOAD_ERROR' });
    return null;
  }

  /**
   * è·å–ä¸Šä¼ æˆåŠŸåçš„cdnUrlåˆ—è¡¨
   * @param {Array} result æ–‡ä»¶ä¸Šä¼ æ¥å£è¿”å›çš„Responseæ•°ç»„
   * @return undefined
   */
  getCdnUrlList(result) {
    return result
      .map(item => {
        const fileResults = item && item.data && item.data.fileResults;
        const fileResult = Array.isArray(fileResults) ? fileResults[0] : null;
        return fileResult && fileResult.cdnUrl;
      })
      .filter(i => i);
  }

  /**
   * é€€å‡ºè¿›ç¨‹
   * @param {String} existCode é€€å‡ºè¿›ç¨‹çš„ç±»å‹ã€‚unknown æœªçŸ¥é”™è¯¯ duplicate åŒåæ›´æ–°å¤±è´¥
   * @param {String} option.msg   é”™è¯¯ä¿¡æ¯
   * @param {String} option.code  é”™è¯¯ç 
   * @param {String} option.file  å‡ºé”™çš„æ–‡ä»¶è·¯å¾„
   */
  async quitProcess(existCode, { msg = '', code = '', file } = {}) {
    const { exitErrorCodes = [] } = this;

    // æœªçŸ¥é”™è¯¯: å‚æ•°æ ¡éªŒã€ä¸Šä¼ æ¥å£å¼‚å¸¸ã€æ–‡ä»¶åæ ¡éªŒä¸é€šè¿‡ã€ç©ºæ–‡ä»¶ç­‰
    if (existCode === 'unknown' && exitErrorCodes.includes('unknown')) {
      msg && console.error(new Error(`âŒ ${msg}`));

      await this.radarTrack(code, { msg, file }); // æ—¥å¿—ä¸ŠæŠ¥
      process.exit(100);
    }

    // åŒåæ–‡ä»¶æ›´æ–°å¤±è´¥
    if (existCode === 'duplicate' && exitErrorCodes.includes('duplicate')) {
      msg && console.error(new Error(`âŒ ${msg}`));

      await this.radarTrack(code, { msg, file }); // æ—¥å¿—ä¸ŠæŠ¥
      process.exit(100);
    }
  }

  // æ—¥å¿—æ‰“å°ã€‚å…¥å‚ä¸console.logä¸€è‡´
  log(...args) {
    const { showConsole } = this.options || {};
    if (showConsole === false || showConsole === 'false') return;
    console.log(...args);
  }

  // æ—¥å¿—ä¸ŠæŠ¥
  async radarTrack(code, response = {}, request = {}) {
    const uploadMode = this.getUploadMode(); // ä¸Šä¼ æ–¹å¼

    return Promise.all([
      // 1. æ–‡ä»¶ä¸Šä¼ æ—¥å¿—ä¸ŠæŠ¥
      this.trackLog(uploadMode, code, response, request),

      // 2. åŒåæ›´æ–°æ—¥å¿—åŸ‹ç‚¹ä¸ŠæŠ¥
      this.trackRewriteLog(code, uploadMode),
    ]).catch(e => {});
  }

  // æ–‡ä»¶ä¸Šä¼ æ—¥å¿—ä¸ŠæŠ¥
  trackLog(uploadMode, code, response = {}, request = {}) {
    const { uid } = this.options || {};
    return radar.track({
      user: uid,
      code: code || 'SUCCESS',
      api: RADAR_MODE_MAP[uploadMode] || uploadMode, // æ¥å£å
      mode: RADAR_MODE_NAME_MAP[uploadMode] || uploadMode, // ä¸»è°ƒæ¥å£æœåŠ¡
      request: jsonStringify({
        ...(this.options || {}),
        ...(typeof request === 'object' ? request : {}),
      }),
      response: this.formattedRaderLogResponse(code, response),
      duration: (this.result && this.result.duration) || 0,
    });
  }

  // åŒåæ›´æ–°çš„è¿œç¨‹æ—¥å¿—åŸ‹ç‚¹
  async trackRewriteLog(code, uploadMode) {
    const { allowRewrite, pid, uid } = this.options || {};
    const { totalCount, successCount } = this.result || {};

    // å¦‚æœæ˜¯åŒåæ›´æ–°ï¼Œæ·»åŠ è¿œç¨‹æ—¥å¿—æ‰“ç‚¹
    if ([true, 'true'].includes(allowRewrite) && [0, 'SUCCESS'].includes(code)) {
      return radar.log({
        user: uid,
        api: RADAR_MODE_MAP[uploadMode] || uploadMode || '',
        msg: `åŒåæ–‡ä»¶æ›´æ–°__æ€»æ–‡ä»¶æ•°: ${totalCount}__æˆåŠŸä¸Šä¼ æ–‡ä»¶æ•°: ${successCount}__é¡¹ç›®pid: ${pid}__ä¸Šä¼ è€…: ${uid}`,
      });
    }
  }

  // æ—¥å¿—ä¸ŠæŠ¥: è¯­ä¹‰åŒ–æ‰§è¡Œç»“æœ
  formattedRaderLogResponse(code, response = {}) {
    const { result = {}, options = {} } = this;
    const { uid, mode, allowRewrite, pid } = options || {};
    const { totalCount, successCount, failedCount, notExistCount, duration } = result || {};

    // ç§»é™¤chalkçš„é¢œè‰²æ ‡è¯†å ä½ç¬¦
    let msg = (response && response.msg) || '';
    msg = (msg + '')
      .replace(/\[3\d{1}m/gi, '')
      .replace(/\[3\d{1}m/gi, '')
      .replace(/\u001b/gi, '');

    const uploadMode = this.getUploadMode(); // ä¸Šä¼ æ–¹å¼

    let resultStr =
      `ä¸Šä¼ çŠ¶æ€ï¼š${['SUCCESS', 0].includes(code) ? 'æˆåŠŸ' : 'å¤±è´¥'}ï¼›\n` +
      `æ€»æ–‡ä»¶æ•°ï¼š${totalCount}, æˆåŠŸä¸Šä¼ çš„æ–‡ä»¶æ•°: ${successCount}, å¤±è´¥ä¸Šä¼ çš„æ–‡ä»¶æ•°: ${failedCount}, ä¸å­˜åœ¨è·³è¿‡çš„æ–‡ä»¶æ•°: ${notExistCount}ï¼›\n` +
      `æ€»è€—æ—¶: ${duration} msï¼›\n` +
      `é¡¹ç›®: ${pid}, æ˜¯å¦å…è®¸åŒåæ›´æ–°: ${allowRewrite}, ä¸Šä¼ è€…: ${uid}ï¼›\n` +
      `ä¸Šä¼ æ–¹å¼ï¼š${RADAR_MODE_TIP_MAP[uploadMode] || uploadMode || mode}ï¼›\n`;
    resultStr += msg ? `æŠ¥é”™ä¿¡æ¯: ${msg}ï¼›\n` : '';

    // æµæ°´çº¿ç›¸å…³ä¿¡æ¯
    const { CI_JOB_ID, BUILD_TAG, BUILD_OWNER } = process.env || {};
    if (CI_JOB_ID) {
      resultStr += `æµæ°´çº¿åœ°å€ï¼šhttps://halo.corp.kuaishou.com/devcloud/pipeline/history/${CI_JOB_ID}?back=all-pipelineï¼›\n`;
      resultStr += `æµæ°´çº¿æ„å»ºTagï¼šBUILD_TAG=${BUILD_TAG}ï¼Œæ„å»ºç”¨æˆ·: ${BUILD_OWNER}ï¼›\n`;
    }

    const responseStr = jsonStringify(
      {
        ...(result || {}),
        ...(typeof response === 'object' ? response : {}),
        msg,
        code,
      },
      undefined,
      2
    );
    resultStr += `\nå“åº”è¯¦æƒ…: \n${responseStr}`;

    return resultStr;
  }

  // æ—¥å¿—ä¸ŠæŠ¥: è·å–æ–‡ä»¶ä¸Šä¼ æ–¹å¼
  getUploadMode() {
    const { mode } = this.options || {};
    const { CI_JOB_ID } = process.env || {};
    const isPipeline = !!CI_JOB_ID;
    if (mode === 'cmd' && !isPipeline) return 'cmd';
    if (mode === 'cmd' && isPipeline) return 'pipelineCmd';

    if (!isPipeline) return 'pipelineCustom';
    return 'custom';
  }
};
