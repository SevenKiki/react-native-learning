const path = require('path');
const fs = require('fs');

const filePath = path.join(__dirname, '../../__token.json');

/**
 * 从本地缓存中获取token参数
 * @param {String} pid  项目pid
 * @returns {String}    项目token
 */
exports.getTokenFromCache = pid => {
  if (!pid) return '';

  const data = getTokenData() || {};
  return data[pid] || '';
};

/**
 * 获取缓存的所有token信息
 */
function getTokenData() {
  let data = {};
  try {
    const content = fs.readFileSync(filePath, 'utf8');
    if (!content) return '';
    data = JSON.parse(content.toString());
  } catch (e) {
    data = {};
  }
  return data || {};
}
exports.getTokenData = getTokenData;

/**
 * 将token配置写入缓存
 * @param {String} pid   项目pid
 * @param {String} token 项目token
 */
exports.cacheToken = (pid, token) => {
  if (!pid || !token) return '';
  try {
    let data = getTokenData() || {};
    data[pid] = token;
    fs.writeFileSync(filePath, JSON.stringify(data, undefined, 2));
  } catch (e) {}
};
