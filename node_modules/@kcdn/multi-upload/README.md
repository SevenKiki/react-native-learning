# @kcdn/multi-upload

上传文件到 [KCDN平台](https://kcdn.corp.kuaishou.com/dashboard/files/upload)

<!-- <p align="center">
  <a href="https://kcdn.corp.kuaishou.com/">
    <img src="https://s2-11378.kwimgs.com/kos/nlav11378/kcdn/img/logo.png">
  </a>
</p> -->

## npm安装

```bash
$ npm install @kcdn/multi-upload -g --registry https://npm.corp.kuaishou.com
```

```bash
$ yarn add @kcdn/multi-upload -g --registry https://npm.corp.kuaishou.com
```

## 使用

### 方式1. 使用命令行上传文件 <span style="font-size: 14px">(推荐)</span>

命令名称: `kcdn-upload`，命令格式如下：

```bash
kcdn-upload \
  [本地文件/文件夹，多目录用空格或英文逗号分隔] \
  --cdn-dir=<目标CDN路径> \
  --pid=<项目Pid> \
  --token=<项目Token> \
  --uid=<上传者，建议使用快手邮箱前缀。默认值: npm> \
  --allow-rewrite=<是否开启同名更新，默认值: false> \
  --allow-hash=<是否支持文件名Hash，默认值: false> \
  --exit-on-api-error=<接口错误时是否退出进程, 默认值: unknown>
```

示例：
```bash
# 上传本地debug-files目录 到 kcdn的 test 路径下：
kcdn-upload debug-files --cdn-dir=test --pid=test-dzr002 --token=12228_xxxxxx --uid=dengzhirong

# 上传本地dist目录 和 public/index.html，到 kcdn的 static 路径下：
kcdn-upload dist public/index.html --cdn-dir=static --pid=test-dzr002 --token=12228_xxxxxx --uid=dengzhirong
```

### 方式2. 在项目中批量上传文件/文件夹

```javascript
const path = require('path');
const Upload = require('@kcdn/multi-upload');

async function main() {
    const files = [
        path.join(__dirname, './debug-files/'),
        path.join(__dirname, './text.txt'),
    ];
    const upload = new Upload({
        pid: 'test-dzr002', // [必填] 项目pid
        token: '12228_xxxxxx', // [必填] 项目token
        cdnDir: '/npm-kcdn-upload/unit-test-index', // [必填] kcdn上传路径
        files, // [必填] 本地文件/文件夹数组

        uid: 'dengzhirong', // [选填] 上传者，建议使用快手邮箱前缀。默认值: npm
        allowRewrite: 'false', // [选填] 是否开启同名更新，默认值: false
        allowHash: 'false', // [选填] 是否开启文件hash，默认值: false
    });

    /**
     * 开始上传
     * @return {Array} cdnUrls 文件上传成功后，完整的cdn地址数组。例子: ['https://xxx/xxx/test-001.txt']
     */
    const cdnUrls = await upload.start();
    console.log(cdnUrls);
}
main();
```

### 方式3: 单文件自定义上传

```javascript
const path = require('path');
const kcdnUpload = require('@kcdn/multi-upload/service.js');

// npm上传多文件
kcdnUpload
    .uploadMultiple({
        pid: 'test-dzr002', // [必填] 项目pid
        token: '12228_xxxxxx', // [必填] 项目token
        dir: 'test-demo/test', // [必填] kcdn上传路径
        files: [path.join(__dirname, './debug-files/test.txt')], // [必填] 本地文件路径数组

        uid: 'dengzhirong', // [选填] 上传者，建议使用快手邮箱前缀。默认值: npm
        allowRewrite: 'false', // [选填] 是否开启同名更新，默认值: false
        allowHash: 'false', // [选填] 是否开启文件hash，默认值: false
    })
    .then(response => {
        /**
         * response: { code: 0, data: { success: true, fileResults: [ { status: 1, cdnUrl: 'https://xxxx' }, ... ] } }
         * 例子: { code: 0, data: { success: true, fileResults: [ { status: 1, cdnUrl: 'https://cdnfile.corp.kuaishou.com/kc/files/a/test-dzr002/dev001.txt' } ] } }
         * 上传成功: response.code === 0 && response.data.success === true
         * 上传失败: response.code !== 0 || response.data.success !== true
         */
        console.log(response);
    });
```

### 参数说明
| 字段名称 | 字段类型 | 字段解释 | 是否必填 | 默认值 |
| ------  | ------ | ------- | ----- | ----- |
| pid | String | 项目pid，在[KCDN->工作台->项目信息](https://kcdn.corp.kuaishou.com/dashboard/project-info)页面获取 | 是 | |
| token | String | 项目token，在[KCDN->工作台->项目信息](https://kcdn.corp.kuaishou.com/dashboard/project-info)页面获取 | 是 | |
| cdnDir | String | 指定目标的CDN路径 | **是** | '' |
| files | String | 本地文件目录/文件的绝对路径或相对路径 | **是** | '' |
| allowRewrite | String | 是否开启同名文件更新功能。'true'：开启，'false'：不开启 | 否 | 'false' |
| allowHash | String | 是否支持文件名hash。'true'：开启，'false'：不开启 | 否 | 'false' |
| exitOnApiError | String | 当接口错误时是否退出进程。'unkown'，未知报错直接退出进程; 'never' 从不报错; 'duplicate' 同名更新报错并退出进程。错误类型使用英文逗号(,)分隔 | 否 | 'unknown' |
| env | String | 文件上传环境。'production'：[线上环境](https://kcdn.corp.kuaishou.com/)；'staging'：[staging环境](https://kcdnconsole.staging.kuaishou.com/)，默认值：'production' | 否 | 'production' |

## 常见错误返回码表

| 错误码 | 错误类型 |
| ----- | ------ |
| 1000 | pid错误 |
| 1001 | token错误 |
| 2000 | 文件名格式错误 |
| 3000 | 后端接口请求错误 |
| 3001 | 后端接口返回错误 |
| 4000 | 文件超过1G |
| 4001 | 文件内容打开错误 |

## 命令行上传的面板输出

```shell
$ kcdn-upload dist --cdn-dir='/test/' --pid=test-dzr002 --token=12228_xxxxxx --uid=dengzhirong

👉 cdnDir: /test/
👉 files: ["dist"]
👉 Upload Params: {"exitOnApiError":"unknown","cdnDir":"/test/","pid":"test-dzr002","token":"12228_xxxxxx","allowRewrite":"true","allowHash":"false","files":["dist"],"uid":"dengzhirong"}
========================================
🔆 resolving [dist]: Total: 2 files
uploading file: dist/dev-inner/dev-inner-001.txt to /test/dev-inner...
uploading file: dist/dev001.txt to /test/...
✔ Successfully uploaded file: dist/dev-inner/dev-inner-001.txt to /test/dist/dev-inner/dev-inner-001.txt 
✔ Successfully uploaded file: dist/dev001.txt to /test/dist/dev001.txt 
========================================
👻 cdn urls of successfully uploaded files: [
  "https://cdnfile.corp.kuaishou.com/kc/files/a/test-dzr002/npm-kcdn-upload__normal/dev-inner/dev-inner-001.txt",
  "https://cdnfile.corp.kuaishou.com/kc/files/a/test-dzr002/npm-kcdn-upload__normal/dev001.txt",
]
========================================
👌 Total Files: 2, ✔ Successfully uploaded 2 files! ✗️ Failed uploaded 0 files!
⏰ Uploaded Total Time: 604 ms
```

## kcdn-upload命令参数

```bash
# 查看 @kcdn/multi-upload 版本
kcdn-upload -v
kcdn-upload --version

# 查看 帮助文档
kcdn-upload -h
kcdn-upload --help
```

## 问题反馈

- <a href="https://kcdn.corp.kuaishou.com/?create_consult_kim_group=true" target="blank">kcdn客服群</a>
- <a href="kim://username?usernamedengzhirong">联系作者</a>

## 其他：
- <a href="https://kcdn.corp.kuaishou.com/doc/#jianjie" target="blank">KCDN平台用户使用手册</a>
- <a href="https://kcdn.corp.kuaishou.com/dashboard/files/upload" target="blank">KCDN -> 文件上传</a>
- <a href="https://git.corp.kuaishou.com/cdn-team/kcdn/frontend/common/kcdn-sdk/kcdn-multi-upload" target="blank">GitLab</a>