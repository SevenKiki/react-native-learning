# @kcdn/multi-upload

ä¸Šä¼ æ–‡ä»¶åˆ° [KCDNå¹³å°](https://kcdn.corp.kuaishou.com/dashboard/files/upload)

<!-- <p align="center">
  <a href="https://kcdn.corp.kuaishou.com/">
    <img src="https://s2-11378.kwimgs.com/kos/nlav11378/kcdn/img/logo.png">
  </a>
</p> -->

## npmå®‰è£…

```bash
$ npm install @kcdn/multi-upload -g --registry https://npm.corp.kuaishou.com
```

```bash
$ yarn add @kcdn/multi-upload -g --registry https://npm.corp.kuaishou.com
```

## ä½¿ç”¨

### æ–¹å¼1. ä½¿ç”¨å‘½ä»¤è¡Œä¸Šä¼ æ–‡ä»¶ <span style="font-size: 14px">(æ¨è)</span>

å‘½ä»¤åç§°: `kcdn-upload`ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š

```bash
kcdn-upload \
  [æœ¬åœ°æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼Œå¤šç›®å½•ç”¨ç©ºæ ¼æˆ–è‹±æ–‡é€—å·åˆ†éš”] \
  --cdn-dir=<ç›®æ ‡CDNè·¯å¾„> \
  --pid=<é¡¹ç›®Pid> \
  --token=<é¡¹ç›®Token> \
  --uid=<ä¸Šä¼ è€…ï¼Œå»ºè®®ä½¿ç”¨å¿«æ‰‹é‚®ç®±å‰ç¼€ã€‚é»˜è®¤å€¼: npm> \
  --allow-rewrite=<æ˜¯å¦å¼€å¯åŒåæ›´æ–°ï¼Œé»˜è®¤å€¼: false> \
  --allow-hash=<æ˜¯å¦æ”¯æŒæ–‡ä»¶åHashï¼Œé»˜è®¤å€¼: false> \
  --exit-on-api-error=<æ¥å£é”™è¯¯æ—¶æ˜¯å¦é€€å‡ºè¿›ç¨‹, é»˜è®¤å€¼: unknown>
```

ç¤ºä¾‹ï¼š
```bash
# ä¸Šä¼ æœ¬åœ°debug-filesç›®å½• åˆ° kcdnçš„ test è·¯å¾„ä¸‹ï¼š
kcdn-upload debug-files --cdn-dir=test --pid=test-dzr002 --token=12228_xxxxxx --uid=dengzhirong

# ä¸Šä¼ æœ¬åœ°distç›®å½• å’Œ public/index.htmlï¼Œåˆ° kcdnçš„ static è·¯å¾„ä¸‹ï¼š
kcdn-upload dist public/index.html --cdn-dir=static --pid=test-dzr002 --token=12228_xxxxxx --uid=dengzhirong
```

### æ–¹å¼2. åœ¨é¡¹ç›®ä¸­æ‰¹é‡ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹

```javascript
const path = require('path');
const Upload = require('@kcdn/multi-upload');

async function main() {
    const files = [
        path.join(__dirname, './debug-files/'),
        path.join(__dirname, './text.txt'),
    ];
    const upload = new Upload({
        pid: 'test-dzr002', // [å¿…å¡«] é¡¹ç›®pid
        token: '12228_xxxxxx', // [å¿…å¡«] é¡¹ç›®token
        cdnDir: '/npm-kcdn-upload/unit-test-index', // [å¿…å¡«] kcdnä¸Šä¼ è·¯å¾„
        files, // [å¿…å¡«] æœ¬åœ°æ–‡ä»¶/æ–‡ä»¶å¤¹æ•°ç»„

        uid: 'dengzhirong', // [é€‰å¡«] ä¸Šä¼ è€…ï¼Œå»ºè®®ä½¿ç”¨å¿«æ‰‹é‚®ç®±å‰ç¼€ã€‚é»˜è®¤å€¼: npm
        allowRewrite: 'false', // [é€‰å¡«] æ˜¯å¦å¼€å¯åŒåæ›´æ–°ï¼Œé»˜è®¤å€¼: false
        allowHash: 'false', // [é€‰å¡«] æ˜¯å¦å¼€å¯æ–‡ä»¶hashï¼Œé»˜è®¤å€¼: false
    });

    /**
     * å¼€å§‹ä¸Šä¼ 
     * @return {Array} cdnUrls æ–‡ä»¶ä¸Šä¼ æˆåŠŸåï¼Œå®Œæ•´çš„cdnåœ°å€æ•°ç»„ã€‚ä¾‹å­: ['https://xxx/xxx/test-001.txt']
     */
    const cdnUrls = await upload.start();
    console.log(cdnUrls);
}
main();
```

### æ–¹å¼3: å•æ–‡ä»¶è‡ªå®šä¹‰ä¸Šä¼ 

```javascript
const path = require('path');
const kcdnUpload = require('@kcdn/multi-upload/service.js');

// npmä¸Šä¼ å¤šæ–‡ä»¶
kcdnUpload
    .uploadMultiple({
        pid: 'test-dzr002', // [å¿…å¡«] é¡¹ç›®pid
        token: '12228_xxxxxx', // [å¿…å¡«] é¡¹ç›®token
        dir: 'test-demo/test', // [å¿…å¡«] kcdnä¸Šä¼ è·¯å¾„
        files: [path.join(__dirname, './debug-files/test.txt')], // [å¿…å¡«] æœ¬åœ°æ–‡ä»¶è·¯å¾„æ•°ç»„

        uid: 'dengzhirong', // [é€‰å¡«] ä¸Šä¼ è€…ï¼Œå»ºè®®ä½¿ç”¨å¿«æ‰‹é‚®ç®±å‰ç¼€ã€‚é»˜è®¤å€¼: npm
        allowRewrite: 'false', // [é€‰å¡«] æ˜¯å¦å¼€å¯åŒåæ›´æ–°ï¼Œé»˜è®¤å€¼: false
        allowHash: 'false', // [é€‰å¡«] æ˜¯å¦å¼€å¯æ–‡ä»¶hashï¼Œé»˜è®¤å€¼: false
    })
    .then(response => {
        /**
         * response: { code: 0, data: { success: true, fileResults: [ { status: 1, cdnUrl: 'https://xxxx' }, ... ] } }
         * ä¾‹å­: { code: 0, data: { success: true, fileResults: [ { status: 1, cdnUrl: 'https://cdnfile.corp.kuaishou.com/kc/files/a/test-dzr002/dev001.txt' } ] } }
         * ä¸Šä¼ æˆåŠŸ: response.code === 0 && response.data.success === true
         * ä¸Šä¼ å¤±è´¥: response.code !== 0 || response.data.success !== true
         */
        console.log(response);
    });
```

### å‚æ•°è¯´æ˜
| å­—æ®µåç§° | å­—æ®µç±»å‹ | å­—æ®µè§£é‡Š | æ˜¯å¦å¿…å¡« | é»˜è®¤å€¼ |
| ------  | ------ | ------- | ----- | ----- |
| pid | String | é¡¹ç›®pidï¼Œåœ¨[KCDN->å·¥ä½œå°->é¡¹ç›®ä¿¡æ¯](https://kcdn.corp.kuaishou.com/dashboard/project-info)é¡µé¢è·å– | æ˜¯ | |
| token | String | é¡¹ç›®tokenï¼Œåœ¨[KCDN->å·¥ä½œå°->é¡¹ç›®ä¿¡æ¯](https://kcdn.corp.kuaishou.com/dashboard/project-info)é¡µé¢è·å– | æ˜¯ | |
| cdnDir | String | æŒ‡å®šç›®æ ‡çš„CDNè·¯å¾„ | **æ˜¯** | '' |
| files | String | æœ¬åœ°æ–‡ä»¶ç›®å½•/æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ | **æ˜¯** | '' |
| allowRewrite | String | æ˜¯å¦å¼€å¯åŒåæ–‡ä»¶æ›´æ–°åŠŸèƒ½ã€‚'true'ï¼šå¼€å¯ï¼Œ'false'ï¼šä¸å¼€å¯ | å¦ | 'false' |
| allowHash | String | æ˜¯å¦æ”¯æŒæ–‡ä»¶åhashã€‚'true'ï¼šå¼€å¯ï¼Œ'false'ï¼šä¸å¼€å¯ | å¦ | 'false' |
| exitOnApiError | String | å½“æ¥å£é”™è¯¯æ—¶æ˜¯å¦é€€å‡ºè¿›ç¨‹ã€‚'unkown'ï¼ŒæœªçŸ¥æŠ¥é”™ç›´æ¥é€€å‡ºè¿›ç¨‹; 'never' ä»ä¸æŠ¥é”™; 'duplicate' åŒåæ›´æ–°æŠ¥é”™å¹¶é€€å‡ºè¿›ç¨‹ã€‚é”™è¯¯ç±»å‹ä½¿ç”¨è‹±æ–‡é€—å·(,)åˆ†éš” | å¦ | 'unknown' |
| env | String | æ–‡ä»¶ä¸Šä¼ ç¯å¢ƒã€‚'production'ï¼š[çº¿ä¸Šç¯å¢ƒ](https://kcdn.corp.kuaishou.com/)ï¼›'staging'ï¼š[stagingç¯å¢ƒ](https://kcdnconsole.staging.kuaishou.com/)ï¼Œé»˜è®¤å€¼ï¼š'production' | å¦ | 'production' |

## å¸¸è§é”™è¯¯è¿”å›ç è¡¨

| é”™è¯¯ç  | é”™è¯¯ç±»å‹ |
| ----- | ------ |
| 1000 | pidé”™è¯¯ |
| 1001 | tokené”™è¯¯ |
| 2000 | æ–‡ä»¶åæ ¼å¼é”™è¯¯ |
| 3000 | åç«¯æ¥å£è¯·æ±‚é”™è¯¯ |
| 3001 | åç«¯æ¥å£è¿”å›é”™è¯¯ |
| 4000 | æ–‡ä»¶è¶…è¿‡1G |
| 4001 | æ–‡ä»¶å†…å®¹æ‰“å¼€é”™è¯¯ |

## å‘½ä»¤è¡Œä¸Šä¼ çš„é¢æ¿è¾“å‡º

```shell
$ kcdn-upload dist --cdn-dir='/test/' --pid=test-dzr002 --token=12228_xxxxxx --uid=dengzhirong

ğŸ‘‰ cdnDir: /test/
ğŸ‘‰ files: ["dist"]
ğŸ‘‰ Upload Params: {"exitOnApiError":"unknown","cdnDir":"/test/","pid":"test-dzr002","token":"12228_xxxxxx","allowRewrite":"true","allowHash":"false","files":["dist"],"uid":"dengzhirong"}
========================================
ğŸ”† resolving [dist]: Total: 2 files
uploading file: dist/dev-inner/dev-inner-001.txt to /test/dev-inner...
uploading file: dist/dev001.txt to /test/...
âœ” Successfully uploaded file: dist/dev-inner/dev-inner-001.txt to /test/dist/dev-inner/dev-inner-001.txt 
âœ” Successfully uploaded file: dist/dev001.txt to /test/dist/dev001.txt 
========================================
ğŸ‘» cdn urls of successfully uploaded files: [
  "https://cdnfile.corp.kuaishou.com/kc/files/a/test-dzr002/npm-kcdn-upload__normal/dev-inner/dev-inner-001.txt",
  "https://cdnfile.corp.kuaishou.com/kc/files/a/test-dzr002/npm-kcdn-upload__normal/dev001.txt",
]
========================================
ğŸ‘Œ Total Files: 2, âœ” Successfully uploaded 2 files! âœ—ï¸ Failed uploaded 0 files!
â° Uploaded Total Time: 604 ms
```

## kcdn-uploadå‘½ä»¤å‚æ•°

```bash
# æŸ¥çœ‹ @kcdn/multi-upload ç‰ˆæœ¬
kcdn-upload -v
kcdn-upload --version

# æŸ¥çœ‹ å¸®åŠ©æ–‡æ¡£
kcdn-upload -h
kcdn-upload --help
```

## é—®é¢˜åé¦ˆ

- <a href="https://kcdn.corp.kuaishou.com/?create_consult_kim_group=true" target="blank">kcdnå®¢æœç¾¤</a>
- <a href="kim://username?usernamedengzhirong">è”ç³»ä½œè€…</a>

## å…¶ä»–ï¼š
- <a href="https://kcdn.corp.kuaishou.com/doc/#jianjie" target="blank">KCDNå¹³å°ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ</a>
- <a href="https://kcdn.corp.kuaishou.com/dashboard/files/upload" target="blank">KCDN -> æ–‡ä»¶ä¸Šä¼ </a>
- <a href="https://git.corp.kuaishou.com/cdn-team/kcdn/frontend/common/kcdn-sdk/kcdn-multi-upload" target="blank">GitLab</a>